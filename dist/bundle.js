(()=>{"use strict";var e={d:(t,s)=>{for(var i in s)e.o(s,i)&&!e.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:s[i]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};function t(e){!function(e){console.log(`ステージ ${e} のデータを読み込み中...`)}(e),document.getElementById("stage-select").style.display="none",document.getElementById("game-container").style.display="block",function(e){console.log("ゲーム開始！"),T(e)}(e)}e.d({},{u:()=>T}),function(){const e=document.getElementById("game-container"),t=document.getElementById("stage-select");e&&(e.style.display="none"),t&&(t.style.display="block")}();const s=document.getElementById("stage1"),i=document.getElementById("stage2"),a=document.getElementById("stage3");s&&s.addEventListener("click",()=>t(1)),i&&i.addEventListener("click",()=>t(2)),a&&a.addEventListener("click",()=>t(3));const n=function(){const e=window.innerWidth,t=window.innerHeight;let s=e,i=t;return s=Math.max(320,s),i=Math.max(240,i),console.log("=== Game Dimensions ==="),console.log("Window Size:",e,"x",t),console.log("Game Size:",s,"x",i),{width:s,height:i}}(),o={type:Phaser.AUTO,width:n.width,height:n.height,backgroundColor:"#87CEEB",parent:"game-container",scale:{mode:Phaser.Scale.FIT,autoCenter:Phaser.Scale.CENTER_BOTH,expandParent:!0,fullscreenTarget:"game-container"},physics:{default:"arcade",arcade:{gravity:{y:0},debug:!1,fps:60,timeScale:1,skipQuadTree:!1,maxEntries:12,tileBias:16,forceX:!1,overlapBias:4}},render:{antialias:!1,pixelArt:!1,clearBeforeRender:!0,preserveDrawingBuffer:!1,failIfMajorPerformanceCaveat:!1,powerPreference:"default"}};class r{constructor(e){this.scene=e,this.map=null,this.layers=[],this.npcSprites=new Map}createMap(){this.map=this.scene.make.tilemap({key:"map"});try{const e=this.createTilesets();this.createLayers(e),this.placeObjects()}catch(e){console.error("Error creating tilesets/layers:",e),this.createFallbackMap()}}createTilesets(){const e=[],t={"[A]Grass1_pipo":"[A]Grass1_pipo",backgraund:"pipo-map001_at-kusa",GK_A2_C_autotile:"GK_A2_C_autotile",Preview_RPGMakerVXAce:"Preview_RPGMakerVXAce",Preview:"Preview",GK_JC_A5_2:"GK_JC_A5_2",GK_JC_B_2:"GK_JC_B_2",tiles:"tiles",tileset:"tiles",Tilemap:"Tilemap"},s=[{keyword:"GK_A2_C",texture:"GK_A2_C_autotile"},{keyword:"Preview_RPGMaker",texture:"Preview_RPGMakerVXAce"},{keyword:"GK_JC_A5",texture:"GK_JC_A5_2"},{keyword:"GK_JC_B",texture:"GK_JC_B_2"},{keyword:"Tilemap",texture:"Tilemap"}];return this.map.tilesets.forEach(i=>{let a=null;const n=i.name,o=i.tileWidth||32,r=i.tileHeight||32;let c=t[n];if(!c){const e=s.find(e=>n.includes(e.keyword));c=e?e.texture:"tiles",e||console.warn(`Unknown tileset: ${n}, using tiles.png as fallback`)}a=this.map.addTilesetImage(n,c,o,r),a&&e.push(a)}),e}createLayers(e){this.map.layers.forEach((t,s)=>{const i=this.map.createLayer(t.name,e,0,0);if(i){this.layers.push(i);const e=100*s-1e3;i.setDepth(e),i.setCollisionByProperty({collides:!0})}else console.error(`Failed to create layer: ${t.name}`)})}placeObjects(){this.objectGroup=this.scene.physics.add.staticGroup(),this.map.objects.forEach(e=>{e.objects.forEach(e=>{const t=e.name;if(this.scene.textures.exists(t)){const s=this.scene.add.sprite(e.x,e.y,t,1);s.setOrigin(0,0),s.setScale(1),"npc"===e.type&&this.npcSprites.set(e.name,s);let i=!1;if(e.properties&&Array.isArray(e.properties)){const t=e.properties.find(e=>"collides"===e.name);i=t&&!0===t.value}if(i){let t=e.type||"wall";this.scene.collisionManager.addObjectToCollision(s,{type:t,width:e.width||32,height:e.height||32,name:e.name})}}else console.warn(`Image not found: ${t} - スプライト作成をスキップします`)})})}createFallbackMap(){console.log("Trying fallback with single tileset...");try{const e=this.map.addTilesetImage("tileset","tiles",32,32),t=this.map.createLayer(0,e,0,0);t&&(this.layers.push(t),t.setDepth(-1),t.setCollisionByProperty({collides:!0}),console.log("Fallback layer created"))}catch(e){console.error("Fallback also failed:",e)}}getObjectGroup(){return this.objectGroup}getNpcSprite(e){return this.npcSprites.get(e)}makeNpcFacePlayer(e,t,s){const i=this.getNpcSprite(e);if(!i)return void console.warn(`NPC sprite not found: ${e}`);const a=t-i.x,n=s-i.y;let o,r;switch(o=Math.abs(a)>Math.abs(n)?a>0?"right":"left":n>0?"down":"up",o){case"down":default:r=1;break;case"left":r=4;break;case"right":r=7;break;case"up":r=10}i.setFrame(r)}}class c{constructor(e){this.scene=e,this.player=null,this.cursors=null,this.wasd=null,this.speed=300}createPlayer(e,t){this.scene.textures.exists("player_placeholder")||this.scene.textures.addBase64("player_placeholder","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg=="),this.player=this.scene.physics.add.sprite(e,t,"player_placeholder"),this.player.setDisplaySize(30,30),this.player.setTint(16711680),this.player.setCollideWorldBounds(!0),this.player.setBounce(0),this.player.setDrag(200)}setInputKeys(e,t){this.cursors=e,this.wasd=t}update(){if(!this.player||!this.cursors||!this.wasd)return;let e=0,t=0;this.cursors.left.isDown||this.wasd.A.isDown?e=-this.speed:(this.cursors.right.isDown||this.wasd.D.isDown)&&(e=this.speed),this.cursors.up.isDown||this.wasd.W.isDown?t=-this.speed:(this.cursors.down.isDown||this.wasd.S.isDown)&&(t=this.speed),this.player.setVelocityX(e),this.player.setVelocityY(t)}setVelocity(e,t){this.player&&(this.player.setVelocityX(e),this.player.setVelocityY(t))}getPosition(){return this.player?{x:this.player.x,y:this.player.y}:{x:0,y:0}}}class h{constructor(e,t){this.scene=e,this.player=t,this.touchStartX=0,this.touchStartY=0,this.isPointerDown=!1,this.targetX=0,this.targetY=0,this.setupVirtualGamepad()}setupVirtualGamepad(){const e=this.scene.scale.width-120,t=this.scene.scale.height-120;this.baseCircle=this.scene.add.circle(e,t,50,3355443,.6),this.baseCircle.setScrollFactor(0),this.baseCircle.setStrokeStyle(2,5592405),this.baseCircle.setDepth(1e3),this.stickCircle=this.scene.add.circle(e,t,20,8947848,.9),this.stickCircle.setScrollFactor(0),this.stickCircle.setStrokeStyle(2,11184810),this.stickCircle.setDepth(1001),this.centerX=e,this.centerY=t,this.maxDistance=40,this.currentInput={x:0,y:0},this.isStickActive=!1,this.currentPointerId=null;const s=this.scene.add.circle(e,t,80,0,.01);s.setScrollFactor(0),s.setDepth(999),s.setInteractive(),s.on("pointerdown",e=>{null===this.currentPointerId&&this.startStickControl(e)}),this.scene.input.on("pointermove",e=>{this.isStickActive&&e.id===this.currentPointerId&&this.updateStick(e.x,e.y)}),this.scene.input.on("pointerup",e=>{this.isStickActive&&e.id===this.currentPointerId&&this.endStickControl()}),this.scene.scale.on("resize",this.handleResize,this)}startStickControl(e){this.isStickActive=!0,this.currentPointerId=e.id,this.stickCircle.setAlpha(1),this.baseCircle.setAlpha(.8),this.updateStick(e.x,e.y)}endStickControl(){this.isStickActive=!1,this.currentPointerId=null,this.resetStick(),this.stickCircle.setAlpha(.9),this.baseCircle.setAlpha(.6)}handleResize(){const e=this.scene.scale.width,t=this.scene.scale.height;this.centerX=e-120,this.centerY=t-120,this.baseCircle.setPosition(this.centerX,this.centerY),this.stickCircle.setPosition(this.centerX,this.centerY)}updateStick(e,t){const s=e-this.centerX,i=t-this.centerY;let a=e,n=t;if(Math.sqrt(s*s+i*i)>this.maxDistance){const e=Math.atan2(i,s);a=this.centerX+Math.cos(e)*this.maxDistance,n=this.centerY+Math.sin(e)*this.maxDistance}this.stickCircle.x=a,this.stickCircle.y=n;const o=(a-this.centerX)/this.maxDistance,r=(n-this.centerY)/this.maxDistance;if(this.currentInput.x=o,this.currentInput.y=r,Math.sqrt(o*o+r*r)<.05)return this.player.setVelocityX(0),void this.player.setVelocityY(0);const c=450*o,h=450*r;this.player.setVelocityX(c),this.player.setVelocityY(h)}resetStick(){this.stickCircle.x=this.centerX,this.stickCircle.y=this.centerY,this.currentInput.x=0,this.currentInput.y=0,this.player.setVelocityX(0),this.player.setVelocityY(0)}getCurrentInput(){return{...this.currentInput}}destroy(){this.baseCircle&&this.baseCircle.destroy(),this.stickCircle&&this.stickCircle.destroy(),this.scene.scale.off("resize",this.handleResize,this)}}class l{constructor(){this.playerPosText=null}createUI(e){e.add.text(400,50,"★★★テスト中★★★bbbbb",{fontSize:"24px",fill:"#000000",fontWeight:"bold"}).setOrigin(.5),e.add.text(400,550,"矢印キーまたはWASDで移動！マップ上を歩いてみよう！",{fontSize:"16px",fill:"#000000"}).setOrigin(.5),this.playerPosText=e.add.text(10,10,"",{fontSize:"16px",fill:"#000000",backgroundColor:"#ffffff",padding:{x:5,y:5}})}updatePlayerPosition(e){(!this.lastPlayerX||!this.lastPlayerY||Math.abs(e.x-this.lastPlayerX)>1||Math.abs(e.y-this.lastPlayerY)>1)&&(this.lastPlayerX=e.x,this.lastPlayerY=e.y),this.playerPosText&&this.playerPosText.setText(`ひろかず位置: X=${Math.round(e.x)}, Y=${Math.round(e.y)}`)}isMobile(){return/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)}}class p{setupCamera(e,t,s){const i=t.widthInPixels,a=t.heightInPixels;e.cameras.main.setBounds(0,0,i,a),e.cameras.main.startFollow(s),e.physics.world.setBounds(0,0,i,a)}}class d{setupKeyboard(e,t){const s=e.input.keyboard.createCursorKeys(),i=e.input.keyboard.addKeys("W,S,A,D");t.setInputKeys(s,i)}}class g{constructor(e){this.scene=e,this.dialogSystem=null,this.collisionGroups={walls:null,npcs:null,items:null,enemies:null}}setDialogSystem(e){this.dialogSystem=e}setupCollisionGroups(){this.collisionGroups.walls=this.scene.physics.add.staticGroup(),this.collisionGroups.npcs=this.scene.physics.add.staticGroup(),this.collisionGroups.items=this.scene.physics.add.group(),this.collisionGroups.enemies=this.scene.physics.add.group()}addObjectToCollision(e,t){const s=t.type||"wall";this.scene.physics.add.existing(e,"item"!==s&&"enemy"!==s);const i=t.width||32,a=t.height||32;switch(e.body.setSize(i,a),s){case"npc":this.collisionGroups.npcs.add(e),e.setInteractive(),e.on("pointerdown",()=>{this.startConversation(t.name)});break;case"item":this.collisionGroups.items.add(e),e.setData("itemId",t.name);break;case"enemy":this.collisionGroups.enemies.add(e),e.setData("enemyId",t.name);break;default:this.collisionGroups.walls.add(e)}}setupPlayerCollisions(e){this.scene.physics.add.collider(e,this.collisionGroups.walls),this.scene.physics.add.collider(e,this.collisionGroups.npcs),this.scene.physics.add.overlap(e,this.collisionGroups.items,this.collectItem,null,this.scene),this.scene.physics.add.overlap(e,this.collisionGroups.enemies,this.encounterEnemy,null,this.scene)}collectItem(e,t){t.destroy()}startConversation(e){if(this.scene.playerController&&this.scene.playerController.player&&this.scene.mapManager){const t=this.scene.playerController.getPosition();this.scene.mapManager.makeNpcFacePlayer(e,t.x,t.y)}this.dialogSystem&&this.dialogSystem.startDialog(e)}isDialogActive(){return!!this.dialogSystem&&this.dialogSystem.isDialogActive()}getDialogSystem(){return this.dialogSystem}setupAllCollisions(e,t){this.setupTileCollisions(e,t),this.setupPlayerCollisions(e)}setupTileCollisions(e,t){t&&t.layers&&t.layers.forEach(t=>{t&&this.scene.physics.add.collider(e,t)})}}class u{constructor(e){this.scene=e}setupObjectBehavior(e,t){switch(t.type){case"npc":this.setupNpcBehavior(e,t);break;case"item":this.setupItemBehavior(e,t);break;case"enemy":this.setupEnemyBehavior(e,t)}}setupNpcBehavior(e,t){switch(t.name){case"kuccoro1":this.setupKuccoro1Animation(e);break;case"kuccoro2":this.setupKuccoro2Animation(e);break;case"kuccoro3":this.setupKuccoro3Animation(e);break;case"hanni":this.setupHanniAnimation(e)}}setupItemBehavior(e,t){this.scene.tweens.add({targets:e,alpha:.7,duration:1e3,yoyo:!0,repeat:-1})}setupEnemyBehavior(e,t){switch(t.name){case"enemy1":this.setupEnemy1Animation(e);break;case"enemy2":this.setupEnemy2Animation(e);break;default:this.setupDefaultEnemyAnimation(e)}}isMobile(){return/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)}setupKuccoro1Animation(e){e.hasAnimation||(e.hasAnimation=!0,this.isMobile()?this.scene.tweens.add({targets:e,y:e.y+3,duration:3e3,yoyo:!0,repeat:-1,ease:"Linear"}):this.scene.tweens.add({targets:e,y:e.y+5,duration:1500,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"}))}setupKuccoro2Animation(e){this.isMobile()||this.scene.tweens.add({targets:e,x:e.x+20,duration:2e3,yoyo:!0,repeat:-1,ease:"Power1"})}setupKuccoro3Animation(e){this.isMobile()||this.scene.tweens.add({targets:e,rotation:2*Math.PI,duration:4e3,repeat:-1,ease:"Linear"})}setupHanniAnimation(e){this.scene.tweens.add({targets:e,scale:1.1,duration:1e3,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"})}setupEnemy1Animation(e){this.scene.tweens.add({targets:e,x:e.x+50,duration:2e3,yoyo:!0,repeat:-1,ease:"Power2"})}setupEnemy2Animation(e){this.scene.tweens.add({targets:e,y:e.y+30,duration:1500,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"})}setupDefaultEnemyAnimation(e){this.scene.tweens.add({targets:e,x:e.x+25,duration:3e3,yoyo:!0,repeat:-1,ease:"Linear"})}startConversation(e){this.scene.collisionManager&&this.scene.collisionManager.startConversation(e)}}class m{constructor(e,t){console.log("NEW DialogSystem created for scene:",e.scene.key),console.log("Stage data keys:",Object.keys(t)),this.scene=e,this.isActive=!1,this.dialogContainer=null,this.dialogText=null,this.currentDialog=null,this.currentTextIndex=0,this.dialogs=t,this.setupUI(),this.setupInput()}setupUI(){this.dialogContainer&&this.dialogContainer.destroy();const e=this.scene.cameras.main,t=e.width,s=e.height;console.log("=== Dialog UI Setup Debug ==="),console.log("gameWidth:",t,"gameHeight:",s);const i=s-120-20-20;console.log("dialogY:",i),this.dialogContainer=this.scene.add.container(0,0),this.dialogContainer.setDepth(1e4),this.dialogContainer.setVisible(!1);const a=this.scene.add.rectangle(t/2,i+60,t-20,120,0,.8);this.dialogText=this.scene.add.text(30,i+60,"",{fontSize:"18px",fill:"#ffffff",metrics:{ascent:15,descent:5,fontSize:18},wordWrap:{width:t-60}}),this.dialogText.setOrigin(0,.5),this.continueIndicator=this.scene.add.text(t-20,i+60-20,"タップで続行",{fontSize:"12px",fill:"#ffff00",align:"center"}),this.continueIndicator.setOrigin(1,1),this.scene.tweens.add({targets:this.continueIndicator,alpha:.3,duration:800,yoyo:!0,repeat:-1}),this.dialogContainer.add([a,this.dialogText,this.continueIndicator]),a.removeAllListeners(),a.setInteractive({hitArea:new Phaser.Geom.Rectangle(-t/2,-80,t,160),hitAreaCallback:Phaser.Geom.Rectangle.Contains,useHandCursor:!1}),a.on("pointerdown",(e,t,s,i)=>{console.log("=== Dialog Background Clicked ==="),console.log("NPC ID:",this.currentDialog?"Active":"None"),console.log("isActive:",this.isActive),console.log("Click position:",{x:e.x,y:e.y}),console.log("Local position:",{x:t,y:s}),i&&i.stopPropagation&&(i.stopPropagation(),console.log("Event propagation stopped")),this.isActive?(console.log("Calling nextDialog()"),this.nextDialog()):console.log("Dialog not active, ignoring click")}),this.dialogContainer.setInteractive({hitArea:new Phaser.Geom.Rectangle(0,0,t,s),hitAreaCallback:Phaser.Geom.Rectangle.Contains}),this.dialogContainer.on("pointerdown",(e,t,s,i)=>{console.log("=== Dialog Container Clicked ==="),i&&i.stopPropagation&&i.stopPropagation(),this.isActive&&(console.log("Container click -> calling nextDialog()"),this.nextDialog())}),this.dialogContainer.setScrollFactor(0),console.log("Dialog container position:",this.dialogContainer.x,this.dialogContainer.y),console.log("Background rectangle bounds:",a.getBounds()),this.scene.scale.off("resize",this.handleResize,this),this.scene.scale.on("resize",this.handleResize,this)}handleResize(e){if(!this.dialogContainer)return;const t=e.width,s=e.height;console.log("Dialog resize:",t,s),this.setupUI()}setupInput(){this.scene.input.keyboard.on("keydown-SPACE",()=>{this.isActive&&this.nextDialog()})}startDialog(e){console.log("=== NEW CONVERSATION START ==="),console.log("Scene:",this.scene.scene.key),console.log("NPC:",e),console.log("Available dialogs:",Object.keys(this.dialogs)),console.log("DialogSystem.startDialog called with:",e),console.log("dialogs:",this.dialogs),console.log("dialog exists:",!!this.dialogs[e]),this.dialogs[e]?(this.currentDialog=this.dialogs[e],this.currentTextIndex=0,this.isActive=!0,console.log("Force reset currentTextIndex to 0"),this.currentTextIndex=0,this.dialogContainer.setVisible(!0),this.showMessage(),console.log("Dialog started for:",e)):console.error("No dialog found for:",e)}showMessage(){if(console.log("currentTextIndex:",this.currentTextIndex),console.log("message:",this.currentDialog.messages[this.currentTextIndex]),this.currentTextIndex>=this.currentDialog.messages.length)return void this.endDialog();const e=this.currentDialog.messages[this.currentTextIndex];this.dialogText.setText(e),console.log("Showing message:",e)}nextDialog(){console.log("nextDialog() called - before increment:",this.currentTextIndex),this.currentTextIndex++,console.log("nextDialog() called - after increment:",this.currentTextIndex),this.showMessage()}endDialog(){this.isActive=!1,this.dialogContainer.setVisible(!1)}isDialogActive(){return this.isActive}}const y={kuccoro1:{name:"くっころ1",messages:["クンニちわ！","今日はいい天気ですね","また会いましょう！"]},kuccoro2:{name:"くっころ2",messages:["くっ、、、殺せ！","イクイクイクイクイクっ、おっちんぽーーーーー！"]},kuccoro3:{name:"エッチな女騎士",messages:["くっ、、、ころせ！","イグイグイグぅぅ！"]},hanni:{name:"はんに",messages:["ようこそ、Stage1へ！","このエリアには色々な仲間がいますよ","みんなと話してみてくださいね"]},enemy1:{name:"敵1",messages:["グルル...","通さないぞ！"]},enemy2:{name:"敵2",messages:["ここから先は危険だ","引き返すんだ！"]}},x={demo_chinpo:{background:"test_1",conversations:[{speaker:"ひろかず",character:"kawamuro",text:"おれけっこんすんだ",expression:"A"},{speaker:"だいち",character:"daichi",text:"お前もか",expression:"A"},{speaker:"河村",character:"kawamuro",text:"そんなに固くならなくてもいい",expression:"B"},{speaker:"なおき",character:"naoki",text:"ちんぽかためます",expression:"A"},{speaker:"だいち",character:"daichi",text:"やったね！",expression:"A"},{speaker:"なおき",character:"naoki",text:"俺の特殊能力、メタルチンコはがねのように硬いぜ★",expression:"A"},{speaker:"なおき",character:"naoki",text:"金玉もでかいぜ！",expression:"A"}]},after_chinpo:{background:"test_1",conversations:[{speaker:"河室",character:"kawamuro",text:"（新しいクラスか...少し緊張するな）",expression:"E"},{speaker:"河室",character:"heroine",text:"あ、あなたが転校生の方ですね！",expression:"F"},{speaker:"河室",character:"kawamuro",text:"はい、今日からお世話になります",expression:"D"},{speaker:"河室",character:"kawamuro",text:"私、田中花子です。よろしくお願いします！",expression:"C"},{speaker:"河室",character:"kawamuro",text:"こちらこそ。分からないことがあったら教えてください",expression:"A"},{speaker:"河室",character:"kawamuro",text:"はい！何でも聞いてくださいね♪",expression:"E"}]}};class C{constructor(){this.conversations=x,this.currentEvent=null}getConversation(e){return this.conversations[e]||null}getAvailableEvents(){return Object.keys(this.conversations)}addConversation(e,t){this.conversations[e]=t}updateConversation(e,t){return!!this.conversations[e]&&(this.conversations[e]=t,!0)}}class v{constructor(e){this.scene=e,this.conversationManager=new C,this.isConversationActive=!1,this.triggeredEvents=new Set}startConversation(e){const t=this.conversationManager.getConversation(e);t?this.startVisualNovelConversation(t):this.startSimpleDialog(e)}startVisualNovelConversation(e){this.isConversationActive&&(this.scene.scene.stop("ConversationScene"),this.isConversationActive=!1);const t=this.scene.scene.get("ConversationScene");t&&t.scene.isActive()&&this.scene.scene.stop("ConversationScene"),this.isConversationActive=!0;try{this.scene.time.delayedCall(100,()=>{this.scene.scene.launch("ConversationScene");const t=this.scene.scene.get("ConversationScene");t?(this.scene.time.delayedCall(200,()=>{try{t.startConversation(e)}catch(e){console.error("[ConversationTrigger] 会話開始エラー:",e),console.error("[ConversationTrigger] エラースタック:",e.stack),this.isConversationActive=!1}}),t.events.once("conversationEnded",()=>{this.scene.scene.stop("ConversationScene"),this.isConversationActive=!1})):(console.error("[ConversationTrigger] ConversationSceneの取得に失敗"),this.isConversationActive=!1)})}catch(e){console.error("[ConversationTrigger] startVisualNovelConversation()でエラーが発生:",e),console.error("[ConversationTrigger] エラースタック:",e.stack),this.isConversationActive=!1}}startSimpleDialog(e){this.scene.collisionManager&&this.scene.collisionManager.getDialogSystem()&&this.scene.collisionManager.getDialogSystem().startDialog(e)}setupNpcClickHandler(e,t){e.setInteractive(),e.on("pointerdown",()=>{this.isConversationActive||this.startConversation(t)})}setupAreaTrigger(e,t,s,i,a){const n=this.scene.add.rectangle(e,t,s,i,0,0);return n.setInteractive(),this.scene.physics.add.existing(n),n.body.setSize(s,i),this.scene.physics.add.overlap(this.scene.playerController.player,n,()=>{this.isConversationActive||this.triggeredEvents.has(a)||(this.triggeredEvents.add(a),this.startConversation(a))},null,this.scene),n}setupProximityTrigger(e,t,s,i){const a=this.scene.add.circle(e,t,s,0,0);return this.scene.physics.add.existing(a),a.body.setCircle(s),this.scene.physics.add.overlap(this.scene.playerController.player,a,()=>{this.isConversationActive||this.triggeredEvents.has(i)||(this.triggeredEvents.add(i),this.startConversation(i))},null,this.scene),a}isActive(){return this.isConversationActive}}class k extends Phaser.Scene{constructor(){super({key:"ConversationScene"}),this.currentConversationIndex=0,this.currentConversation=null,this.isTextAnimating=!1,this.textSpeed=30}create(){if(!this.sys)return void console.error("[ConversationScene] this.sys が undefined です");if(!this.sys.game)return void console.error("[ConversationScene] this.sys.game が undefined です");this.cleanupCharacterSprites(),this.currentTextTimer&&(this.currentTextTimer.destroy(),this.currentTextTimer=null);const e=this.sys?.game?.canvas?.width||this.sys?.game?.config?.width||800,t=this.sys?.game?.canvas?.height||this.sys?.game?.config?.height||600;if(this.background=this.add.rectangle(e/2,t/2,e,t,0,.5),this.background.setOrigin(.5,.5),this.characterContainer=this.add.container(0,0),this.textures.exists("textbox"))this.textbox=this.add.image(e/2,t-60,"textbox");else{const s=Math.min(e-40,700),i=Math.min(150,.25*t);this.textbox=this.add.rectangle(e/2,t-60,s,i,0,.8)}if(this.textbox.setOrigin(.5,.5),this.textures.exists("namebox"))this.namebox=this.add.image(.2*e,t-100,"namebox");else{const s=Math.min(200,.4*e),i=Math.min(50,.08*t);this.namebox=this.add.rectangle(.2*e,t-100,s,i,0,.8)}this.namebox.setOrigin(.5,.5);const s=Math.min(e-80,600),i=e<600?"18px":"24px";this.dialogText=this.add.text(e/2,t-60,"",{fontSize:i,fill:"#ffffff",lineSpacing:8,padding:{x:10,y:10},wordWrap:{width:s,useAdvancedWrap:!0}}),this.dialogText.setOrigin(.5,.5);const a=e<600?"16px":"20px";this.nameText=this.add.text(.2*e,t-100,"",{fontSize:a,fill:"#ffffff",fontStyle:"bold",padding:{x:10,y:10}}),this.nameText.setOrigin(.5,.5),this.input.on("pointerdown",()=>{this.nextDialog()}),this.input.keyboard.on("keydown-SPACE",()=>{this.nextDialog()}),this.isUICreated=!0}resetUI(){this.dialogText&&this.dialogText.setText(""),this.nameText&&this.nameText.setText(""),this.background&&(this.background.destroy(),this.background=null)}startConversation(e){this.currentConversation=e,this.currentConversationIndex=0,this.updateBackground(e.background),this.showDialog()}nextDialog(){this.isTextAnimating?this.completeTextAnimation():(this.currentConversationIndex++,this.currentConversationIndex<this.currentConversation.conversations.length?this.showDialog():this.endConversation())}showDialog(){const e=this.currentConversation.conversations[this.currentConversationIndex];this.updateCharacterSprite(e.character,e.expression),this.nameText.setText(e.speaker),this.animateText(e.text)}updateCharacterSprite(e,t){if(this.characterSprites||(this.characterSprites={}),this.characterContainer){if(e&&t){const s=`${e}_${t}`,i=this.sys?.game?.canvas?.width||this.sys?.game?.config?.width||800,a=this.sys?.game?.canvas?.height||this.sys?.game?.config?.height||600,n={heroine:{x:.7*i,y:.4*a},friend:{x:.3*i,y:.4*a},teacher:{x:.5*i,y:.4*a},kawamuro:{x:.7*i,y:.4*a},daichi:{x:.3*i,y:.4*a},naoki:{x:.5*i,y:.4*a}}[e]||{x:.7*i,y:.4*a};if(this.characterSprites[e]){const t=this.characterSprites[e];t.texture.key!==s&&t.setTexture(s)}else{const t=this.add.image(n.x,n.y,s);t.setOrigin(.5,.5),this.characterContainer.add(t),this.characterSprites[e]=t,t.setAlpha(0),t.setScale(.8),this.tweens.add({targets:t,alpha:1,scaleX:1,scaleY:1,duration:500,ease:"Power2"})}this.dimOtherCharacters(e)}}else console.warn("characterContainer is not initialized yet")}dimOtherCharacters(e){this.characterSprites&&Object.keys(this.characterSprites).forEach(t=>{const s=this.characterSprites[t];t===e?s.setTint(16777215):s.setTint(8947848)})}isMobile(){return/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)}animateText(e){if(this.isTextAnimating=!0,this.dialogText.setText(""),this.isMobile())return this.dialogText.setText(e),void(this.isTextAnimating=!1);let t="",s=0;const i=this.time.addEvent({delay:this.textSpeed,callback:()=>{s<e.length?(t+=e[s],this.dialogText.setText(t),s++):(this.isTextAnimating=!1,i.destroy())},loop:!0});this.currentTextTimer=i}completeTextAnimation(){this.currentTextTimer&&this.currentTextTimer.destroy();const e=this.currentConversation.conversations[this.currentConversationIndex];this.dialogText.setText(e.text),this.isTextAnimating=!1}updateBackground(e){if(e&&this.textures.exists(e)){this.background&&this.background.destroy();const t=this.sys?.game?.canvas?.width||this.sys?.game?.config?.width||800,s=this.sys?.game?.canvas?.height||this.sys?.game?.config?.height||600;this.background=this.add.image(t/2,s/2,e),this.background.setOrigin(.5,.5);const i=t/this.background.width,a=s/this.background.height,n=Math.max(i,a);this.background.setScale(n),this.background.setDepth(-1)}}endConversation(){this.cleanupCharacterSprites(),this.currentTextTimer&&(this.currentTextTimer.destroy(),this.currentTextTimer=null),this.resetUI(),this.events.emit("conversationEnded"),this.scene.stop()}cleanupCharacterSprites(){this.characterSprites&&(Object.values(this.characterSprites).forEach(e=>{e&&e.destroy&&e.destroy()}),this.characterSprites={}),this.characterContainer&&this.characterContainer.removeAll()}resize(e){const{width:t,height:s}=e;if(this.background){this.background.setPosition(t/2,s/2);const e=t/this.background.width,i=s/this.background.height,a=Math.max(e,i);this.background.setScale(a)}if(this.textbox){this.textbox.setPosition(t/2,s-60);const e=Math.min(t-40,700),i=Math.min(150,.25*s);this.textbox.setDisplaySize(e,i)}if(this.namebox){this.namebox.setPosition(.2*t,s-100);const e=Math.min(200,.4*t),i=Math.min(50,.08*s);this.namebox.setDisplaySize(e,i)}if(this.dialogText){this.dialogText.setPosition(t/2,s-60);const e=Math.min(t-80,600);this.dialogText.setWordWrapWidth(e);const i=t<600?"18px":"24px";this.dialogText.setFontSize(i)}if(this.nameText){this.nameText.setPosition(.2*t,s-100);const e=t<600?"16px":"20px";this.nameText.setFontSize(e)}this.repositionCharacterSprites()}repositionCharacterSprites(){if(this.characterSprites){const e=this.sys?.game?.canvas?.width||this.sys?.game?.config?.width||800,t=this.sys?.game?.canvas?.height||this.sys?.game?.config?.height||600,s={heroine:{x:.7*e,y:.4*t},friend:{x:.3*e,y:.4*t},teacher:{x:.5*e,y:.4*t},kawamuro:{x:.7*e,y:.4*t},daichi:{x:.3*e,y:.4*t},naoki:{x:.5*e,y:.4*t}};Object.keys(this.characterSprites).forEach(i=>{const a=this.characterSprites[i],n=s[i]||{x:.7*e,y:.4*t};a&&a.setPosition&&a.setPosition(n.x,n.y)})}}}class w extends Phaser.Scene{constructor(){super({key:"Stage1Scene"}),this.mapManager=null,this.playerController=null,this.touchControlManager=null,this.uiManager=null,this.cameraManager=null,this.inputManager=null,this.collisionManager=null,this.behaviorManager=null,this.dialogSystem=null,this.conversationTrigger=null,this.updateCounter=0}preload(){this.load.tilemapTiledJSON("map","assets/maps/stage1.tmj"),this.load.image("[A]Grass1_pipo","assets/maps/tilesets/stage1/[A]Grass1_pipo.png"),this.load.image("Tilemap","assets/maps/tilesets/stage1/Tilemap.png");const e={frameWidth:32,frameHeight:32};this.load.spritesheet("ojyama1","assets/characters/enemies/pipo-charachip005a.png",e),this.load.spritesheet("hanni","assets/characters/npcs/pipo-charachip007a.png",e),this.load.spritesheet("kuccoro","assets/characters/npcs/pipo-charachip022e.png",e),this.load.spritesheet("kuccoro1","assets/characters/npcs/pipo-charachip022a.png",e),this.load.spritesheet("kuccoro2","assets/characters/npcs/pipo-charachip022e.png",e),this.load.spritesheet("kuccoro3","assets/characters/npcs/pipo-charachip026.png",e),this.load.spritesheet("kuccoro4","assets/characters/npcs/pipo-charachip024d.png",e),this.load.spritesheet("enemy1","assets/characters/enemies/pipo-charachip005a.png",e),this.load.spritesheet("enemy2","assets/characters/enemies/pipo-charachip005a.png",e),this.load.spritesheet("friend1","assets/characters/npcs/pipo-charachip007a.png",e),this.load.spritesheet("friend2","assets/characters/npcs/pipo-charachip007a.png",e),this.load.spritesheet("kuccoro","assets/characters/npcs/pipo-charachip022a.png",e),this.load.on("fileerror",e=>{console.error(`Failed to load file: ${e.key} from ${e.url}`)}),this.load.on("complete",()=>{console.log("All assets loaded successfully")}),this.load.image("kawamuro_A","assets/characters/portraits/kawamuro_A.png"),this.load.image("kawamuro_B","assets/characters/portraits/kawamuro_B.png"),this.load.image("kawamuro_C","assets/characters/portraits/kawamuro_C.png"),this.load.image("kawamuro_D","assets/characters/portraits/kawamuro_D.png"),this.load.image("kawamuro_E","assets/characters/portraits/kawamuro_E.png"),this.load.image("kawamuro_F","assets/characters/portraits/kawamuro_F.png"),this.load.image("daichi_A","assets/characters/portraits/daichi_A.png"),this.load.image("naoki_A","assets/characters/portraits/naoki_A.png"),this.load.image("test_1","assets/backgrounds/background_test.png"),this.load.image("textbox","assets/ui/textbox.png"),this.load.image("namebox","assets/ui/namebox.png")}create(){try{this.collisionManager=new g(this),this.collisionManager.setupCollisionGroups(),this.dialogSystem=new m(this,y),this.collisionManager.setDialogSystem(this.dialogSystem),this.behaviorManager=new u(this),this.mapManager=new r(this),this.mapManager.createMap(),this.playerController=new c(this),this.playerController.createPlayer(100,100),this.inputManager=new d,this.inputManager.setupKeyboard(this,this.playerController),this.touchControlManager=new h(this,this.playerController.player),this.uiManager=new l,this.uiManager.createUI(this),this.cameraManager=new p,this.cameraManager.setupCamera(this,this.mapManager.map,this.playerController.player),this.collisionManager.setupAllCollisions(this.playerController.player,this.mapManager),this.conversationTrigger=new v(this),this.scene.add("ConversationScene",k),this.setupConversationEvents()}catch(e){console.error("Error during scene creation:",e),console.error("Stack trace:",e.stack)}}setupConversationEvents(){this.setupNpcConversations(),this.setupAreaTriggers(),this.setupProximityTriggers()}setupNpcConversations(){const e=this.mapManager.getNpcSprite("hanni");e&&this.conversationTrigger.setupNpcClickHandler(e,"demo_chinpo")}setupAreaTriggers(){this.conversationTrigger.setupAreaTrigger(200,200,64,64,"after_chinpo")}setupProximityTriggers(){this.conversationTrigger.setupProximityTrigger(300,300,50,"library_scene")}update(){this.updateCounter++,this.updateCounter%2==0&&(this.playerController.update(),this.uiManager.updatePlayerPosition(this.playerController.player))}resize(e){const t=e.width,s=e.height;this.cameras.resize(t,s),console.log(`Game resized to: ${t}x${s}`)}}class f{constructor(e){this.scene=e}setupObjectBehavior(e,t){switch(t.type){case"npc":this.setupNpcBehavior(e,t);break;case"item":this.setupItemBehavior(e);break;case"enemy":this.setupEnemyBehavior(e,t)}}setupNpcBehavior(e,t){switch(t.name){case"friend2_4":this.setupFriend2Animation(e);break;case"shopkeeper":this.setupShopkeeperAnimation(e);break;case"guard":this.setupGuardAnimation(e);break;case"merchant":this.setupMerchantAnimation(e)}}setupItemBehavior(e){this.scene.tweens.add({targets:e,alpha:.5,scale:1.2,duration:800,yoyo:!0,repeat:-1,ease:"Power2"})}setupEnemyBehavior(e,t){switch(t.name){case"boss_stage2":this.setupBossAnimation(e);break;case"strong_enemy":this.setupStrongEnemyAnimation(e);break;default:this.setupDefaultEnemyAnimation(e)}}setupFriend2Animation(e){this.scene.tweens.add({targets:e,alpha:.8,duration:2e3,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"})}setupShopkeeperAnimation(e){this.scene.tweens.add({targets:e,rotation:.1,duration:1e3,yoyo:!0,repeat:-1,ease:"Power1"})}setupGuardAnimation(e){this.scene.tweens.add({targets:e,x:e.x+40,duration:3e3,yoyo:!0,repeat:-1,ease:"Linear"})}setupMerchantAnimation(e){this.scene.tweens.add({targets:e,y:e.y+8,duration:1200,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"})}setupBossAnimation(e){this.scene.tweens.add({targets:e,scale:1.2,rotation:.2,duration:1500,yoyo:!0,repeat:-1,ease:"Power2"})}setupStrongEnemyAnimation(e){this.scene.tweens.add({targets:e,x:e.x+60,y:e.y+20,duration:1e3,yoyo:!0,repeat:-1,ease:"Back.easeInOut"})}setupDefaultEnemyAnimation(e){this.scene.tweens.add({targets:e,x:e.x+35,rotation:Math.PI/8,duration:2e3,yoyo:!0,repeat:-1,ease:"Power2"})}startConversation(e){this.scene.collisionManager&&this.scene.collisionManager.startConversation(e)}}const S={friend2_4:{name:"ひろかず",messages:["もこうにドンキあるから","そこで、５０万かたしてもらって","もいいい？"]},friend2_5:{name:"くず",messages:["はらめおらぁ"]},guard:{name:"ポルノさん",messages:["できたら愛してくだーさい","僕の肩で羽を休めておくれー"]},kuccoro:{name:"商人",messages:["やめて！","ラーの翼神竜の特殊能力で、ギルフォード・ザ・ライトニングを焼き払われたら、","闇のゲームでモンスターと繋がってる城之内の精神まで燃え尽きちゃう！","お願い、死なないで城之内！","あんたが今ここで倒れたら、舞さんや遊戯との約束はどうなっちゃうの？","ライフはまだ残ってる。ここを耐えれば、マリクに勝てるんだから！","次回「城之内死す」デュエルスタンバイ！"]},kuccoro1:{name:"くっころ",messages:["ここまで辿り着くとはな","しかし、ここが君の限界だ！","かかってこい！","ここが貴様の墓場となろう"]},kuccoro2:{name:"エッチな女騎士",messages:["くっ、、、ころせ！","イグイグイグぅぅ！"]},kuccoro4:{name:"２コマ即落ち女騎士",messages:["くっ、、、殺せ！","イクイクイクイクイクっ、おっちんぽーーーーー！"]}};class A extends Phaser.Scene{constructor(){super({key:"Stage2Scene"}),this.mapManager=null,this.playerController=null,this.touchControlManager=null,this.uiManager=null,this.cameraManager=null,this.inputManager=null,this.collisionManager=null,this.dialogSystem=null}preload(){this.load.tilemapTiledJSON("map","assets/maps/test_map5.tmj"),this.load.image("GK_A2_C_autotile","assets/maps/tilesets/stage2/GK_A2_JC_autotile.png"),this.load.image("Preview_RPGMakerVXAce","assets/maps/tilesets/stage2/Preview_RPGMakerVXAce.png"),this.load.image("Preview","assets/maps/tilesets/stage2/Preview.png"),this.load.image("GK_JC_A5_2","assets/maps/tilesets/stage2/GK_JC_A5_2.png"),this.load.image("GK_JC_B_2","assets/maps/tilesets/stage2/GK_JC_B_2.png"),this.load.image("tiles","assets/maps/tilesets/stage2/tiles.png"),this.load.image("Tilemap","assets/maps/tilesets/stage2/Tilemap.png"),this.load.image("pipo-map001_at-kusa","assets/maps/tilesets/stage2/pipo-map001_at-kusa.png");const e={frameWidth:32,frameHeight:32};this.load.spritesheet("enemy1","assets/characters/enemies/pipo-charachip005a.png",e),this.load.spritesheet("friend2_6","assets/characters/npcs/pipo-charachip007a.png",e),this.load.spritesheet("friend2_5","assets/characters/npcs/pipo-charachip007a.png",e),this.load.spritesheet("friend2_4","assets/characters/npcs/pipo-charachip007a.png",e),this.load.spritesheet("friend2_3","assets/characters/npcs/pipo-charachip007a.png",e),this.load.spritesheet("friend2_2","assets/characters/npcs/pipo-charachip007a.png",e),this.load.spritesheet("friend2_1","assets/characters/npcs/pipo-charachip007a.png",e),this.load.spritesheet("kuccoro1","assets/characters/npcs/pipo-charachip022a.png",e),this.load.spritesheet("kuccoro","assets/characters/npcs/pipo-charachip022e.png",e),this.load.spritesheet("kuccoro2","assets/characters/npcs/pipo-charachip024d.png",e),this.load.on("complete",()=>{console.log("All assets loaded successfully")})}create(){console.log("Before creating CollisionManager"),this.collisionManager=new g(this),console.log("CollisionManager created:",this.collisionManager),this.collisionManager.setupCollisionGroups(),console.log("Stage2: Creating DialogSystem for Stage2"),this.dialogSystem=new m(this,S),this.collisionManager.setDialogSystem(this.dialogSystem),console.log("Stage2: Creating BehaviorManager_Stage2"),this.behaviorManager=new f(this),this.mapManager=new r(this),console.log("MapManager: placeObjectsを呼ぶ前"),this.mapManager.createMap(),console.log("MapManager: placeObjectsを呼んだ後"),this.playerController=new c(this),this.playerController.createPlayer(100,100),this.inputManager=new d,this.inputManager.setupKeyboard(this,this.playerController),this.touchControlManager=new h(this,this.playerController.player),this.uiManager=new l,this.uiManager.createUI(this),this.cameraManager=new p,this.cameraManager.setupCamera(this,this.mapManager.map,this.playerController.player),console.log("setupCollisionGroups completed"),this.collisionManager.setupAllCollisions(this.playerController.player,this.mapManager),console.log("=== 読み込まれた画像 ==="),console.log("friend1 exists:",this.textures.exists("friend1")),console.log("friend2 exists:",this.textures.exists("friend2")),console.log("kuccoro exists:",this.textures.exists("kuccoro"))}update(){if(this.dialogSystem&&this.dialogSystem.isDialogActive())return this.playerController.player.setVelocityX(0),void this.playerController.player.setVelocityY(0);this.playerController&&this.playerController.update(),this.updateCounter||(this.updateCounter=0),this.updateCounter++,this.updateCounter%2==0&&this.uiManager&&this.playerController&&this.uiManager.updatePlayerPosition(this.playerController.player)}resize(e){const t=e.width,s=e.height;this.cameras.resize(t,s),console.log(`Game resized to: ${t}x${s}`)}}class b extends Phaser.Scene{constructor(){super({key:"Stage3Scene"}),this.mapManager=null,this.playerController=null,this.touchControlManager=null,this.uiManager=null,this.cameraManager=null,this.inputManager=null,this.collisionManager=null}preload(){this.load.tilemapTiledJSON("map","assets/test_map5.tmj"),this.load.image("GK_A2_C_autotile","assets/GK_A2_JC_autotile.png"),this.load.image("Preview_RPGMakerVXAce","assets/Preview_RPGMakerVXAce.png"),this.load.image("Preview","assets/Preview.png"),this.load.image("GK_JC_A5_2","assets/GK_JC_A5_2.png"),this.load.image("GK_JC_B_2","assets/GK_JC_B_2.png"),this.load.image("tiles","assets/tiles.png"),this.load.image("Tilemap","assets/Tilemap.png"),this.load.image("pipo-map001_at-kusa","assets/pipo-map001_at-kusa.png");const e={frameWidth:32,frameHeight:32};this.load.spritesheet("enemy1","assets/pipo-charachip005a.png",e),this.load.spritesheet("friend2_6","assets/pipo-charachip007a.png",e),this.load.spritesheet("friend2_5","assets/pipo-charachip007a.png",e),this.load.spritesheet("friend2_4","assets/pipo-charachip007a.png",e),this.load.spritesheet("friend2_3","assets/pipo-charachip007a.png",e),this.load.spritesheet("friend2_2","assets/pipo-charachip007a.png",e),this.load.spritesheet("friend2_1","assets/pipo-charachip007a.png",e),this.load.spritesheet("kuccoro1","assets/pipo-charachip022a.png",e),this.load.spritesheet("kuccoro","assets/pipo-charachip022e.png",e),this.load.spritesheet("kuccoro2","assets/pipo-charachip024d.png",e),this.load.on("complete",()=>{console.log("All assets loaded successfully")})}create(){console.log("Before creating CollisionManager"),this.collisionManager=new g(this),console.log("CollisionManager created:",this.collisionManager),this.collisionManager.setupCollisionGroups(),this.mapManager=new r(this),console.log("MapManager: placeObjectsを呼ぶ前"),this.mapManager.createMap(),console.log("MapManager: placeObjectsを呼んだ後"),this.playerController=new c(this),this.playerController.createPlayer(100,100),this.touchControlManager=new h(this,this.playerController.player),this.uiManager=new l,this.uiManager.createUI(this),this.cameraManager=new p,this.cameraManager.setupCamera(this,this.mapManager.map,this.playerController.player),this.inputManager=new d,this.inputManager.setupKeyboard(this,this.playerController),console.log("setupCollisionGroups completed"),this.collisionManager.setupAllCollisions(this.playerController.player,this.mapManager),console.log("=== 読み込まれた画像 ==="),console.log("friend1 exists:",this.textures.exists("friend1")),console.log("friend2 exists:",this.textures.exists("friend2")),console.log("kuccoro exists:",this.textures.exists("kuccoro"))}update(){this.playerController.update(),this.updateCounter||(this.updateCounter=0),this.updateCounter++,this.updateCounter%2==0&&this.uiManager&&this.uiManager.updatePlayerPosition(this.playerController.player)}resize(e){const t=e.width,s=e.height;this.cameras.resize(t,s),console.log(`Game resized to: ${t}x${s}`)}}class M extends Phaser.Scene{constructor(){super({key:"DemoScene"})}preload(){this.load.image("button","data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjUwIiB2aWV3Qm94PSIwIDAgMjAwIDUwIiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPgo8cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjUwIiByeD0iMTAiIGZpbGw9IiM0Mjg1RjQiLz4KPHRleHQgeD0iMTAwIiB5PSIzMCIgZmlsbD0iI0ZGRkZGRiIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE2IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iMC4zZW0iPkNsaWNrIE1lPC90ZXh0Pgo8L3N2Zz4K")}create(){const{width:e,height:t}=this.sys.game.canvas;this.add.text(e/2,100,"ギャルゲ風会話システム デモ",{fontSize:"32px",fill:"#000000",fontStyle:"bold"}).setOrigin(.5),this.conversationManager=new C,this.scene.add("ConversationScene",k),this.conversationManager.getAvailableEvents().forEach((t,s)=>{const i=this.add.image(e/2,200+80*s,"button");i.setInteractive(),this.add.text(e/2,200+80*s,this.getEventLabel(t),{fontSize:"18px",fill:"#FFFFFF",fontStyle:"bold"}).setOrigin(.5),i.on("pointerdown",()=>{this.startConversation(t)}),i.on("pointerover",()=>{i.setTint(13421772)}),i.on("pointerout",()=>{i.clearTint()})}),this.add.text(e/2,t-100,"ボタンをクリックして会話を開始してください\n会話中はクリックまたはスペースキーで進行します",{fontSize:"16px",fill:"#666666",align:"center"}).setOrigin(.5)}getEventLabel(e){return{first_meeting:"初回出会い",after_school:"放課後",library_scene:"図書館でのシーン"}[e]||e}startConversation(e){const t=this.conversationManager.getConversation(e);if(t){this.scene.launch("ConversationScene");const e=this.scene.get("ConversationScene");e.startConversation(t),e.events.once("conversationEnded",()=>{this.scene.stop("ConversationScene"),console.log("会話が終了しました")})}}}let _=null;function T(e){const t=function(){if(_)return _;const e={...o,scene:[]};return _=new Phaser.Game(e),console.log("Phaser Game initialized (one-time only)"),_}();let s,i;switch(e){case 1:case"stage1_enhanced":default:s=w,i="Stage1Scene";break;case 2:s=A,i="Stage2Scene";break;case 3:s=b,i="Stage3Scene";break;case"demo":s=M,i="DemoScene"}t.scene.getScenes(!0).forEach(e=>{console.log(`Stopping and removing scene: ${e.scene.key}`),t.scene.stop(e.scene.key),e.scene.key!==i&&t.scene.remove(e.scene.key)}),t.scene.getScene("ConversationScene")&&(t.scene.stop("ConversationScene"),t.scene.remove("ConversationScene")),setTimeout(()=>{t.scene.getScene(i)||t.scene.add(i,s),t.scene.start(i),console.log(`Started scene: ${i} (fully cleaned)`)},50)}window.addEventListener("orientationchange",()=>{setTimeout(()=>{window.location.reload()},100)})})();