(()=>{"use strict";const e=function(){let e,t;document.fullscreenElement?(e=screen.width,t=screen.height):(e=window.innerWidth,window.visualViewport?t=window.visualViewport.height:(t=window.innerHeight,/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)&&(t=Math.min(window.innerHeight,window.screen.height-100))));let s=e,a=t;return s=Math.max(320,s),a=Math.max(240,a),{width:s,height:a}}(),t={type:Phaser.AUTO,width:e.width,height:e.height,backgroundColor:"#87CEEB",parent:"game-container",scale:{mode:Phaser.Scale.RESIZE,autoCenter:Phaser.Scale.CENTER_BOTH,expandParent:!0,fullscreenTarget:"game-container",resizeCallback:function(){}},physics:{default:"arcade",arcade:{gravity:{y:0},debug:!1,fps:60,timeScale:1,skipQuadTree:!1,maxEntries:12,tileBias:16,forceX:!1,overlapBias:4}},render:{antialias:!1,pixelArt:!1,clearBeforeRender:!0,preserveDrawingBuffer:!1,failIfMajorPerformanceCaveat:!1,powerPreference:"default"}};class s{constructor(e){this.scene=e,this.tilemap=null,this.mapLayer=null,this.areas=[],this.mapWidth=0,this.mapHeight=0,this.mapScaleX=1,this.mapScaleY=1,this.scaledMapWidth=0,this.scaledMapHeight=0,this.map=null,this.layers=[],this.npcSprites=new Map,this.objectGroup=null}createMap(e,t,s="タイルレイヤー1"){return arguments.length>0?this.createNewMap(e,t,s):this.createLegacyMap()}createNewMap(e,t,s="タイルレイヤー1"){this.tilemap=this.scene.make.tilemap({key:e}),this.map=this.tilemap;const a=this.tilemap.addTilesetImage(t,t);return this.mapLayer=this.tilemap.createLayer(s,a),this.layers=[this.mapLayer],this.mapWidth=this.tilemap.widthInPixels,this.mapHeight=this.tilemap.heightInPixels,this.scaleMapToScreen(),this.extractAreaData(),this.tilemap}createLegacyMap(){this.map=this.scene.make.tilemap({key:"map"}),this.tilemap=this.map;try{const e=this.createTilesets();this.createLayers(e),this.placeObjects()}catch(e){console.error("Error creating tilesets/layers:",e),this.createFallbackMap()}return this.map}scaleMapToScreen(){const e=this.scene.cameras.main.width,t=this.scene.cameras.main.height,s=e/this.mapWidth,a=t/this.mapHeight,i=Math.min(s,a);if(this.scene.cameraManager&&(this.scene.cameraManager.currentScale=i,console.log(`MapManager: Set initial scale to ${i} (whole map view)`)),this.mapScaleX=i,this.mapScaleY=i,this.mapLayer){this.mapLayer.setScale(this.mapScaleX,this.mapScaleY);const s=(e-this.mapWidth*this.mapScaleX)/2,a=(t-this.mapHeight*this.mapScaleY)/2;this.mapLayer.setPosition(s,a)}if(this.scaledMapWidth=this.mapWidth*this.mapScaleX,this.scaledMapHeight=this.mapHeight*this.mapScaleY,this.scene.cameraManager){this.scene.cameraManager.camera.setBounds(0,0,e,t);const s=this.mapLayer?this.mapLayer.x:0,a=this.mapLayer?this.mapLayer.y:0;this.scene.cameraManager.camera.centerOn(s+this.scaledMapWidth/2,a+this.scaledMapHeight/2),console.log(`MapManager: Initial camera bounds: (0, 0, ${e}, ${t})`)}this.updateObjectPositions(this.mapScaleX)}extractAreaData(e="miemachi"){const t=this.tilemap.getObjectLayer(e);t&&(this.areas=[],this.areas=t.objects.map((e=>({id:e.id,name:e.name,originalX:e.x,originalY:e.y,x:e.x*this.mapScaleX+(this.mapLayer?this.mapLayer.x:0),y:e.y*this.mapScaleY+(this.mapLayer?this.mapLayer.y:0),type:e.type||"location"}))),console.log(`MapManager: Extracted ${this.areas.length} areas from object layer`))}handleResize(){this.scaleMapToScreen(),this.extractAreaData()}createFallbackImage(e){const t=this.scene.add.graphics();t.fillStyle(65280),t.fillRect(0,0,32,32),t.generateTexture(e,32,32),t.destroy()}getTilemap(){return this.tilemap}getMapLayer(){return this.mapLayer}getAreas(){return this.areas}getMapSize(){return{width:this.mapWidth,height:this.mapHeight,scaledWidth:this.scaledMapWidth,scaledHeight:this.scaledMapHeight}}getMapScale(){return{scaleX:this.mapScaleX,scaleY:this.mapScaleY}}updateObjectPositions(e){if(this.areas&&this.areas.length>0){const t=this.mapLayer?this.mapLayer.x:0,s=this.mapLayer?this.mapLayer.y:0;console.log(`MapManager: Map layer position - x: ${t}, y: ${s}, scale: ${e}`),this.areas.forEach((a=>{a.x=a.originalX*e+t,a.y=a.originalY*e+s,console.log(`MapManager: Area ${a.name} - original: (${a.originalX}, ${a.originalY}), new: (${a.x}, ${a.y})`)})),this.scaledMapWidth=this.mapWidth*e,this.scaledMapHeight=this.mapHeight*e,this.scene.areaSelectionManager&&(console.log(`MapManager: Sending ${this.areas.length} areas to AreaSelectionManager`),this.scene.areaSelectionManager.updateAreaPositions([...this.areas])),console.log(`MapManager: Updated object positions with scale ${e}, areas count: ${this.areas.length}`)}else console.warn("MapManager: No areas available for position update")}createTilesets(){const e=[],t={"[A]Grass1_pipo":"[A]Grass1_pipo",backgraund:"pipo-map001_at-kusa",GK_A2_C_autotile:"GK_A2_C_autotile",Preview_RPGMakerVXAce:"Preview_RPGMakerVXAce",Preview:"Preview",GK_JC_A5_2:"GK_JC_A5_2",GK_JC_B_2:"GK_JC_B_2",tiles:"tiles",tileset:"tiles",Tilemap:"Tilemap"},s=[{keyword:"GK_A2_C",texture:"GK_A2_C_autotile"},{keyword:"Preview_RPGMaker",texture:"Preview_RPGMakerVXAce"},{keyword:"GK_JC_A5",texture:"GK_JC_A5_2"},{keyword:"GK_JC_B",texture:"GK_JC_B_2"},{keyword:"Tilemap",texture:"Tilemap"}];return this.map.tilesets.forEach((a=>{let i=null;const n=a.name,r=a.tileWidth||32,o=a.tileHeight||32;let h=t[n];if(!h){const e=s.find((e=>n.includes(e.keyword)));h=e?e.texture:"tiles",e||console.warn(`Unknown tileset: ${n}, using tiles.png as fallback`)}i=this.map.addTilesetImage(n,h,r,o),i&&e.push(i)})),e}createLayers(e){this.map.layers.forEach(((t,s)=>{const a=this.map.createLayer(t.name,e,0,0);if(a){this.layers.push(a);const e=100*s-1e3;a.setDepth(e),a.setCollisionByProperty({collides:!0})}else console.error(`Failed to create layer: ${t.name}`)}))}placeObjects(){this.objectGroup=this.scene.physics.add.staticGroup(),this.map.objects.forEach((e=>{e.objects.forEach((e=>{const t=e.name;if(this.scene.textures.exists(t)){const s=this.scene.add.sprite(e.x,e.y,t,1);s.setOrigin(0,0),s.setScale(1),"npc"===e.type&&this.npcSprites.set(e.name,s);let a=!1;if(e.properties&&Array.isArray(e.properties)){const t=e.properties.find((e=>"collides"===e.name));a=t&&!0===t.value}if(a){let t=e.type||"wall";this.scene.collisionManager.addObjectToCollision(s,{type:t,width:e.width||32,height:e.height||32,name:e.name})}}else console.warn(`Image not found: ${t} - スプライト作成をスキップします`)}))}))}createFallbackMap(){try{const e=this.map.addTilesetImage("tileset","tiles",32,32),t=this.map.createLayer(0,e,0,0);t&&(this.layers.push(t),t.setDepth(-1),t.setCollisionByProperty({collides:!0}))}catch(e){console.error("Fallback also failed:",e)}}getObjectGroup(){return this.objectGroup}getNpcSprite(e){return this.npcSprites.get(e)}makeNpcFacePlayer(e,t,s){const a=this.getNpcSprite(e);if(!a)return void console.warn(`NPC sprite not found: ${e}`);const i=t-a.x,n=s-a.y;let r,o;switch(r=Math.abs(i)>Math.abs(n)?i>0?"right":"left":n>0?"down":"up",r){case"down":default:o=1;break;case"left":o=4;break;case"right":o=7;break;case"up":o=10}a.setFrame(o)}destroy(){this.layers&&this.layers.length>0&&(this.layers.forEach((e=>{e&&e.destroy&&e.destroy()})),this.layers=[]),this.mapLayer&&this.mapLayer.destroy&&(this.mapLayer.destroy(),this.mapLayer=null),this.tilemap&&this.tilemap.destroy&&(this.tilemap.destroy(),this.tilemap=null),this.map&&this.map.destroy&&(this.map.destroy(),this.map=null),this.npcSprites&&(this.npcSprites.forEach((e=>{e&&e.destroy&&e.destroy()})),this.npcSprites.clear()),this.objectGroup&&this.objectGroup.destroy&&(this.objectGroup.destroy(),this.objectGroup=null),this.areas=[],this.mapWidth=0,this.mapHeight=0,this.mapScaleX=1,this.mapScaleY=1,this.scaledMapWidth=0,this.scaledMapHeight=0}}class a{constructor(e){this.scene=e,this.player=null,this.cursors=null,this.wasd=null,this.speed=300}createPlayer(e,t){this.scene.textures.exists("player_placeholder")||this.scene.textures.addBase64("player_placeholder","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg=="),this.player=this.scene.physics.add.sprite(e,t,"player_placeholder"),this.player.setDisplaySize(30,30),this.player.setTint(16711680),this.player.setCollideWorldBounds(!0),this.player.setBounce(0),this.player.setDrag(200)}setInputKeys(e,t){this.cursors=e,this.wasd=t}update(){if(!this.player||!this.cursors||!this.wasd)return;let e=0,t=0;this.cursors.left.isDown||this.wasd.A.isDown?e=-this.speed:(this.cursors.right.isDown||this.wasd.D.isDown)&&(e=this.speed),this.cursors.up.isDown||this.wasd.W.isDown?t=-this.speed:(this.cursors.down.isDown||this.wasd.S.isDown)&&(t=this.speed),this.player.setVelocityX(e),this.player.setVelocityY(t)}setVelocity(e,t){this.player&&(this.player.setVelocityX(e),this.player.setVelocityY(t))}getPosition(){return this.player?{x:this.player.x,y:this.player.y}:{x:0,y:0}}destroy(){try{this.player&&(this.player.destroy(),this.player=null),this.cursors=null,this.wasd=null}catch(e){console.error("Error during PlayerController cleanup:",e)}}}class i{constructor(e){this.scene=e,this.activeEffects=[]}showTouchRipple(e,t,s=65280,a=400){const i=this.scene.add.circle(e,t,10,s,.7);i.setDepth(9999),this.scene.tweens.add({targets:i,scaleX:5,scaleY:5,alpha:0,duration:a,ease:"Power2",onComplete:()=>{i.destroy()}}),this.activeEffects.push(i)}showButtonHover(e,t=1.2,s=16766720,a=.7){e.setScale&&e.setScale(t),e.setFillStyle&&e.setFillStyle(s,a)}resetButtonState(e,t=1,s=4286945,a=.7){e.setScale&&e.setScale(t),e.setFillStyle&&e.setFillStyle(s,a)}showSelectionEffect(e,t,s=16776960,a=16711680){const i=this.scene.add.circle(e,t,30,s,.6);i.setStrokeStyle(4,a),this.scene.tweens.add({targets:i,scaleX:2,scaleY:2,alpha:0,duration:800,ease:"Power2",onComplete:()=>{i.destroy()}}),this.activeEffects.push(i)}}class n{constructor(e,t,s="se_touch"){this.scene=e,this.player=t,this.seKey=s,this.visualFeedback=new i(e),this.touchStartX=0,this.touchStartY=0,this.isPointerDown=!1,this.targetX=0,this.targetY=0,this.setupVirtualGamepad(),this.scene.input.on("pointerdown",(e=>{this.showTouchFeedback(e.x,e.y)}))}setupVirtualGamepad(){const e=this.scene.scale.width-120,t=this.scene.scale.height-120;this.baseCircle=this.scene.add.circle(e,t,50,3355443,.6),this.baseCircle.setScrollFactor(0),this.baseCircle.setStrokeStyle(2,5592405),this.baseCircle.setDepth(1e3),this.stickCircle=this.scene.add.circle(e,t,20,8947848,.9),this.stickCircle.setScrollFactor(0),this.stickCircle.setStrokeStyle(2,11184810),this.stickCircle.setDepth(1001),this.centerX=e,this.centerY=t,this.maxDistance=40,this.currentInput={x:0,y:0},this.isStickActive=!1,this.currentPointerId=null;const s=this.scene.add.circle(e,t,80,0,.01);s.setScrollFactor(0),s.setDepth(999),s.setInteractive(),s.on("pointerdown",(e=>{null===this.currentPointerId&&this.startStickControl(e)})),this.scene.input.on("pointermove",(e=>{this.isStickActive&&e.id===this.currentPointerId&&this.updateStick(e.x,e.y)})),this.scene.input.on("pointerup",(e=>{this.isStickActive&&e.id===this.currentPointerId&&this.endStickControl()})),this.scene.scale.on("resize",this.handleResize,this)}startStickControl(e){this.isStickActive=!0,this.currentPointerId=e.id,this.stickCircle.setAlpha(1),this.baseCircle.setAlpha(.8),this.updateStick(e.x,e.y)}endStickControl(){this.isStickActive=!1,this.currentPointerId=null,this.resetStick(),this.stickCircle.setAlpha(.9),this.baseCircle.setAlpha(.6)}handleResize(){const e=this.scene.scale.width,t=this.scene.scale.height;this.centerX=e-120,this.centerY=t-120,this.baseCircle.setPosition(this.centerX,this.centerY),this.stickCircle.setPosition(this.centerX,this.centerY)}updateStick(e,t){const s=e-this.centerX,a=t-this.centerY;let i=e,n=t;if(Math.sqrt(s*s+a*a)>this.maxDistance){const e=Math.atan2(a,s);i=this.centerX+Math.cos(e)*this.maxDistance,n=this.centerY+Math.sin(e)*this.maxDistance}this.stickCircle.x=i,this.stickCircle.y=n;const r=(i-this.centerX)/this.maxDistance,o=(n-this.centerY)/this.maxDistance;if(this.currentInput.x=r,this.currentInput.y=o,Math.sqrt(r*r+o*o)<.05)return void(this.player&&this.player.setVelocityX&&(this.player.setVelocityX(0),this.player.setVelocityY(0)));const h=450*r,c=450*o;this.player&&this.player.setVelocityX&&(this.player.setVelocityX(h),this.player.setVelocityY(c))}resetStick(){this.stickCircle.x=this.centerX,this.stickCircle.y=this.centerY,this.currentInput.x=0,this.currentInput.y=0,this.player&&this.player.setVelocityX&&(this.player.setVelocityX(0),this.player.setVelocityY(0))}getCurrentInput(){return{...this.currentInput}}enableAreaSelection(e){this.areaSelectionManager=e,this.hideVirtualGamepad(),this.setupAreaSelectionTouch()}hideVirtualGamepad(){this.baseCircle&&this.baseCircle.setVisible(!1),this.stickCircle&&this.stickCircle.setVisible(!1)}showVirtualGamepad(){this.baseCircle&&this.baseCircle.setVisible(!0),this.stickCircle&&this.stickCircle.setVisible(!0)}setupAreaSelectionTouch(){this.scene.input.on("pointerdown",(e=>{this.handleAreaSelectionTouch(e)})),this.touchStartTime=0,this.longPressThreshold=500}handleAreaSelectionTouch(e){try{if(this.touchStartTime=Date.now(),!this.scene.cameras||!this.scene.cameras.main)return void console.error("TouchControlManager: Camera not available");const t=this.scene.cameras.main.getWorldPoint(e.x,e.y),s=t.x,a=t.y;this.areaSelectionManager&&this.areaSelectionManager.handleTouchAt(s,a),this.showTouchFeedback(s,a)}catch(e){console.error("TouchControlManager: Error in handleAreaSelectionTouch:",e)}}showTouchFeedback(e,t){this.visualFeedback.showTouchRipple(e,t),this.scene.audioManager&&this.scene.audioManager.playSe&&this.scene.audioManager.playSe(this.seKey,.3)}disableAreaSelection(){this.areaSelectionManager=null,this.showVirtualGamepad(),this.scene.input.off("pointerdown")}destroy(){this.baseCircle&&this.baseCircle.destroy(),this.stickCircle&&this.stickCircle.destroy(),this.scene.scale.off("resize",this.handleResize,this)}}class r{constructor(){this.playerPosText=null,this.backButton=null}createUI(e){e.add.text(400,50,"★★★テスト中★★★bbbbb",{fontSize:"24px",fill:"#000000",fontWeight:"bold"}).setOrigin(.5),e.add.text(400,550,"矢印キーまたはWASDで移動！マップ上を歩いてみよう！",{fontSize:"16px",fill:"#000000"}).setOrigin(.5),this.playerPosText=e.add.text(10,10,"",{fontSize:"16px",fill:"#000000",backgroundColor:"#ffffff",padding:{x:5,y:5}}),this.createBackButton(e)}createBackButton(e){e&&e.cameras&&e.cameras.main?(this.backButtonGraphics=e.add.graphics(),this.backButtonGraphics.fillStyle(0,.7),this.backButtonGraphics.fillRoundedRect(-45,-20,80,40,5),this.backButtonGraphics.setPosition(50,25),this.backButtonGraphics.setDepth(1e3),this.backButtonGraphics.setScrollFactor(0),this.backButtonGraphics.setInteractive(new Phaser.Geom.Rectangle(-45,-20,80,40),Phaser.Geom.Rectangle.Contains),this.backButtonGraphics.on("pointerdown",(()=>{window.returnToStageSelect&&window.returnToStageSelect()})),this.backButtonGraphics.on("pointerover",(()=>{this.backButtonGraphics.clear(),this.backButtonGraphics.fillStyle(3355443,.8),this.backButtonGraphics.fillRoundedRect(-45,-20,80,40,5)})),this.backButtonGraphics.on("pointerout",(()=>{this.backButtonGraphics.clear(),this.backButtonGraphics.fillStyle(0,.7),this.backButtonGraphics.fillRoundedRect(-45,-20,80,40,5)})),this.backButtonText=e.add.text(45,34,"戻る",{fontSize:"16px",fill:"#ffffff",fontWeight:"bold",fixedHeight:40}),this.backButtonText.setOrigin(.5,.4),this.backButtonText.setScrollFactor(0),this.backButtonText.setDepth(1001),e.scale.on("resize",(()=>{e&&e.cameras&&e.cameras.main&&this.backButtonGraphics}))):console.warn("UIManager: Scene or camera is not available for back button")}updatePlayerPosition(e){(!this.lastPlayerX||!this.lastPlayerY||Math.abs(e.x-this.lastPlayerX)>1||Math.abs(e.y-this.lastPlayerY)>1)&&(this.lastPlayerX=e.x,this.lastPlayerY=e.y),this.playerPosText&&this.playerPosText.setText(`ひろかず位置: X=${Math.round(e.x)}, Y=${Math.round(e.y)}`)}createMapUI(e,t){this.titleText=e.add.text(e.cameras.main.centerX,50,t,{fontSize:"24px",fill:"#000000",fontWeight:"bold",backgroundColor:"#FFFFFF",padding:{x:10,y:5},borderRadius:10}).setOrigin(.5),this.instructionText=e.add.text(e.cameras.main.centerX,100,"場所をタップして移動！",{fontSize:"16px",fill:"#333333",backgroundColor:"#FFFFFF",padding:{x:8,y:4},borderRadius:8}).setOrigin(.5),this.selectedAreaText=e.add.text(e.cameras.main.centerX,e.cameras.main.height-50,"",{fontSize:"14px",fill:"#000000",backgroundColor:"#FFFF99",padding:{x:8,y:4},borderRadius:8}).setOrigin(.5)}updateMapUI(e){const t=e.width/2;this.titleText&&this.titleText.setPosition(t,50),this.instructionText&&this.instructionText.setPosition(t,100),this.selectedAreaText&&this.selectedAreaText.setPosition(t,e.height-50)}showSelectedArea(e,t){this.selectedAreaText&&this.selectedAreaText.setText(`エリア: ${e}\n${t}`)}destroy(){if(!this._destroyed){this._destroyed=!0;try{const e=e=>{this[e]&&"function"==typeof this[e].destroy&&(this[e].destroy(),this[e]=null)};e("playerPosText"),e("backButtonGraphics"),e("backButtonText"),e("titleText"),e("instructionText"),e("selectedAreaText")}catch(e){console.error("Error during UIManager cleanup:",e)}}}}class o{constructor(e){this.scene=e,this.camera=e.cameras.main,this.zoom=1,this.followTarget=null,this.bounds=null,this.currentScale=null}setupCamera(e,t,s){if(1===arguments.length&&"object"==typeof e&&e.width){const t=e;this.camera.setZoom(this.zoom);const s=this.scene.mapManager?.mapLayer,a=s?s.x:0,i=s?s.y:0,n=this.scene.cameras.main.width,r=this.scene.cameras.main.height;this.camera.setBounds(0,0,n,r),this.camera.centerOn(a+t.scaledWidth/2,i+t.scaledHeight/2),console.log(`CameraManager: Initial setup - bounds: (0, 0, ${n}, ${r})`)}else if(3===arguments.length){const a=e,i=t.widthInPixels,n=t.heightInPixels;a.cameras.main.setBounds(0,0,i,n),a.cameras.main.startFollow(s),a.physics.world.setBounds(0,0,i,n)}else console.error("Invalid arguments for setupCamera")}setZoom(e){this.zoom=e,this.camera.setZoom(e)}centerOn(e,t){this.camera.centerOn(e,t)}setFollowTarget(e,t=.1){this.followTarget=e,this.camera.startFollow(e,!0,t,t)}stopFollow(){this.followTarget=null,this.camera.stopFollow()}setBackgroundColor(e){this.camera.setBackgroundColor(e)}fadeIn(e=1e3,t){this.camera.fadeIn(e,0,0,0,t)}fadeOut(e=1e3,t){this.camera.fadeOut(e,0,0,0,t)}shake(e=100,t=.02){this.camera.shake(e,t)}flash(e=100,t=16777215){this.camera.flash(e,t)}getBounds(){return this.bounds}getZoom(){return this.zoom}getWorldPoint(e,t){return this.camera.getWorldPoint(e,t)}getScreenPoint(e,t){return this.camera.getScreenPoint(e,t)}update(){}setupScrollControls(){let e=!1,t={x:0,y:0},s={x:0,y:0};this.scene.input.on("pointerdown",(a=>{e=!0,t={x:a.x,y:a.y},s={x:this.camera.scrollX,y:this.camera.scrollY}})),this.scene.input.on("pointermove",(a=>{if(e){const e=t.x-a.x,i=t.y-a.y,n=s.x+e,r=s.y+i;this.camera.setScroll(n,r)}})),this.scene.input.on("pointerup",(()=>{e=!1})),console.log("Scroll controls setup complete")}setupPinchZoom(){let e=0,t=1;this.scene.input.on("pointerdown",(()=>{if(this.scene.input.pointers&&2===this.scene.input.pointers.length){const s=this.scene.input.pointers[0],a=this.scene.input.pointers[1];e=Phaser.Math.Distance.Between(s.x,s.y,a.x,a.y),t=this.camera.zoom}})),this.scene.input.on("pointermove",(()=>{if(this.scene.input.pointers&&2===this.scene.input.pointers.length){const s=this.scene.input.pointers[0],a=this.scene.input.pointers[1],i=Phaser.Math.Distance.Between(s.x,s.y,a.x,a.y)/e,n=Math.max(.5,Math.min(3,t*i));this.camera.setZoom(n)}}))}toggleMapScale(){if(1.5===(this.scene.mapManager?.mapScaleX||this.currentScale)){const e=this.scene.cameras.main.width,t=this.scene.cameras.main.height,s=e/this.scene.mapManager.mapWidth,a=t/this.scene.mapManager.mapHeight,i=Math.min(s,a);console.log(`Switching from 1.5 to whole scale: ${i}`),this.setMapScale(i)}else console.log("Switching from whole scale to 1.5"),this.setMapScale(1.5)}setMapScale(e){if(this.currentScale=e,!this.scene.mapManager||!this.scene.mapManager.mapLayer)return void console.error("MapManager or mapLayer not available");this.scene.mapManager.mapLayer.setScale(e,e),this.scene.mapManager.mapScaleX=e,this.scene.mapManager.mapScaleY=e;const t=this.scene.cameras.main.width,s=this.scene.cameras.main.height,a=this.scene.mapManager.mapWidth*e,i=this.scene.mapManager.mapHeight*e,n=(t-a)/2,r=(s-i)/2;this.scene.mapManager.mapLayer.setPosition(n,r),this.scene.mapManager.updateObjectPositions(e),1.5===e?this.camera.setBounds(n,r,a,i):this.camera.setBounds(0,0,t,s),this.camera.centerOn(n+a/2,r+i/2);const o=1.5===e?`(${n}, ${r}, ${a}, ${i})`:`(0, 0, ${t}, ${s})`;console.log(`CameraManager: Set map scale to ${e}, bounds: ${o}`)}destroy(){this.stopFollow(),this.followTarget=null,this.bounds=null}}class h{constructor(){this.cursors=null,this.wasd=null}setupKeyboard(e,t){this.cursors=e.input.keyboard.createCursorKeys(),this.wasd=e.input.keyboard.addKeys("W,S,A,D"),t.setInputKeys(this.cursors,this.wasd)}destroy(){try{this.cursors&&(this.cursors=null),this.wasd&&(this.wasd=null)}catch(e){console.error("Error during InputManager cleanup:",e)}}}class c{constructor(e){this.scene=e,this.dialogSystem=null,this.collisionGroups={walls:null,npcs:null,items:null,enemies:null}}setDialogSystem(e){this.dialogSystem=e}setupCollisionGroups(){this.collisionGroups.walls=this.scene.physics.add.staticGroup(),this.collisionGroups.npcs=this.scene.physics.add.staticGroup(),this.collisionGroups.items=this.scene.physics.add.group(),this.collisionGroups.enemies=this.scene.physics.add.group()}addObjectToCollision(e,t){const s=t.type||"wall";this.scene.physics.add.existing(e,"item"!==s&&"enemy"!==s);const a=t.width||32,i=t.height||32;switch(e.body.setSize(a,i),s){case"npc":this.collisionGroups.npcs.add(e),e.setInteractive(),e.on("pointerdown",(()=>{this.startConversation(t.name)}));break;case"item":this.collisionGroups.items.add(e),e.setData("itemId",t.name);break;case"enemy":this.collisionGroups.enemies.add(e),e.setData("enemyId",t.name);break;default:this.collisionGroups.walls.add(e)}}setupPlayerCollisions(e){this.scene.physics.add.collider(e,this.collisionGroups.walls),this.scene.physics.add.collider(e,this.collisionGroups.npcs),this.scene.physics.add.overlap(e,this.collisionGroups.items,this.collectItem,null,this.scene),this.scene.physics.add.overlap(e,this.collisionGroups.enemies,this.encounterEnemy,null,this.scene)}collectItem(e,t){t.destroy()}startConversation(e){if(this.scene.playerController&&this.scene.playerController.player&&this.scene.mapManager){const t=this.scene.playerController.getPosition();this.scene.mapManager.makeNpcFacePlayer(e,t.x,t.y)}this.dialogSystem&&this.dialogSystem.startDialog(e)}isDialogActive(){return!!this.dialogSystem&&this.dialogSystem.isDialogActive()}getDialogSystem(){return this.dialogSystem}setupAllCollisions(e,t){this.setupTileCollisions(e,t),this.setupPlayerCollisions(e)}setupTileCollisions(e,t){t&&t.layers&&t.layers.forEach((t=>{t&&this.scene.physics.add.collider(e,t)}))}}class l{constructor(e){this.scene=e}setupObjectBehavior(e,t){switch(t.type){case"npc":this.setupNpcBehavior(e,t);break;case"item":this.setupItemBehavior(e,t);break;case"enemy":this.setupEnemyBehavior(e,t)}}setupNpcBehavior(e,t){switch(t.name){case"kuccoro1":this.setupKuccoro1Animation(e);break;case"kuccoro2":this.setupKuccoro2Animation(e);break;case"kuccoro3":this.setupKuccoro3Animation(e);break;case"hanni":this.setupHanniAnimation(e)}}setupItemBehavior(e){this.scene.tweens.add({targets:e,alpha:.7,duration:1e3,yoyo:!0,repeat:-1})}setupEnemyBehavior(e,t){switch(t.name){case"enemy1":this.setupEnemy1Animation(e);break;case"enemy2":this.setupEnemy2Animation(e);break;default:this.setupDefaultEnemyAnimation(e)}}isMobile(){return/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)}setupKuccoro1Animation(e){e.hasAnimation||(e.hasAnimation=!0,this.isMobile()?this.scene.tweens.add({targets:e,y:e.y+3,duration:3e3,yoyo:!0,repeat:-1,ease:"Linear"}):this.scene.tweens.add({targets:e,y:e.y+5,duration:1500,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"}))}setupKuccoro2Animation(e){this.isMobile()||this.scene.tweens.add({targets:e,x:e.x+20,duration:2e3,yoyo:!0,repeat:-1,ease:"Power1"})}setupKuccoro3Animation(e){this.isMobile()||this.scene.tweens.add({targets:e,rotation:2*Math.PI,duration:4e3,repeat:-1,ease:"Linear"})}setupHanniAnimation(e){this.scene.tweens.add({targets:e,scale:1.1,duration:1e3,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"})}setupEnemy1Animation(e){this.scene.tweens.add({targets:e,x:e.x+50,duration:2e3,yoyo:!0,repeat:-1,ease:"Power2"})}setupEnemy2Animation(e){this.scene.tweens.add({targets:e,y:e.y+30,duration:1500,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"})}setupDefaultEnemyAnimation(e){this.scene.tweens.add({targets:e,x:e.x+25,duration:3e3,yoyo:!0,repeat:-1,ease:"Linear"})}startConversation(e){this.scene.collisionManager&&this.scene.collisionManager.startConversation(e)}}class p{constructor(e,t){e&&e.scene?(this.scene=e,this.isActive=!1,this.dialogContainer=null,this.dialogText=null,this.currentDialog=null,this.currentTextIndex=0,this.dialogs=t,this.setupUI(),this.setupInput()):console.error("DialogSystem: Invalid scene provided")}setupUI(){if(!this.scene||!this.scene.cameras||!this.scene.cameras.main)return void console.warn("DialogSystem: Scene or camera is not available");this.dialogContainer&&this.dialogContainer.destroy();const e=this.scene.cameras.main,t=e.width||800,s=e.height||600,a=s-120-20-20;this.dialogContainer=this.scene.add.container(0,0),this.dialogContainer.setDepth(1e4),this.dialogContainer.setVisible(!1);const i=this.scene.add.rectangle(t/2,a+60,t-20,120,0,.8);this.dialogText=this.scene.add.text(30,a+60,"",{fontSize:"18px",fill:"#ffffff",metrics:{ascent:15,descent:5,fontSize:18},wordWrap:{width:t-60}}),this.dialogText.setOrigin(0,.5),this.continueIndicator=this.scene.add.text(t-20,a+60-20,"タップで続行",{fontSize:"12px",fill:"#ffff00",align:"center"}),this.continueIndicator.setOrigin(1,1),this.scene.tweens.add({targets:this.continueIndicator,alpha:.3,duration:800,yoyo:!0,repeat:-1}),this.dialogContainer.add([i,this.dialogText,this.continueIndicator]),i.removeAllListeners(),i.setInteractive({hitArea:new Phaser.Geom.Rectangle(-t/2,-80,t,160),hitAreaCallback:Phaser.Geom.Rectangle.Contains,useHandCursor:!1}),i.on("pointerdown",((e,t,s,a)=>{a&&a.stopPropagation&&a.stopPropagation(),this.isActive&&this.nextDialog()})),this.dialogContainer.setInteractive({hitArea:new Phaser.Geom.Rectangle(0,0,t,s),hitAreaCallback:Phaser.Geom.Rectangle.Contains}),this.dialogContainer.on("pointerdown",((e,t,s,a)=>{a&&a.stopPropagation&&a.stopPropagation(),this.isActive&&this.nextDialog()})),this.dialogContainer.setScrollFactor(0),this.scene.scale.off("resize",this.handleResize,this),this.scene.scale.on("resize",this.handleResize,this)}handleResize(e){this.scene&&this.scene.cameras&&this.scene.cameras.main&&this.dialogContainer?this.setupUI():console.warn("DialogSystem: Scene, camera, or dialog container is not available for resize")}setupInput(){this.scene&&this.scene.input&&this.scene.input.keyboard?this.scene.input.keyboard.on("keydown-SPACE",(()=>{this.isActive&&this.nextDialog()})):console.warn("DialogSystem: Scene input is not available")}startDialog(e){this.dialogs[e]?(this.currentDialog=this.dialogs[e],this.currentTextIndex=0,this.isActive=!0,this.currentTextIndex=0,this.dialogContainer.setVisible(!0),this.showMessage()):console.error("No dialog found for:",e)}showMessage(){if(!this.currentDialog||!this.currentDialog.messages)return;if(this.currentTextIndex>=this.currentDialog.messages.length)return void this.endDialog();const e=this.currentDialog.messages[this.currentTextIndex];console.log("[DialogSystem] showMessage",{index:this.currentTextIndex,name:this.currentDialog.name,text:e}),this.dialogText.setText(e)}nextDialog(){this.currentTextIndex++,this.showMessage()}endDialog(){this.isActive=!1,this.dialogContainer&&this.dialogContainer.setVisible(!1),this.scene&&this.scene.scale&&this.scene.scale.off("resize",this.handleResize,this)}isDialogActive(){return this.isActive}}const d={kuccoro1:{name:"くっころ1",messages:["クンニちわ！","今日はいい天気ですね","また会いましょう！"]},kuccoro2:{name:"くっころ2",messages:["くっ、、、殺せ！","イクイクイクイクイクっ、おっちんぽーーーーー！"]},kuccoro3:{name:"エッチな女騎士",messages:["くっ、、、ころせ！","イグイグイグぅぅ！"]},enemy1:{name:"敵1",messages:["グルル...","通さないぞ！"]},enemy2:{name:"敵2",messages:["ここから先は危険だ","引き返すんだ！"]}},g={demo_chinpo:{background:"test_1",bgm:"bgm_demo_chinpo",conversations:[{speaker:"ひろかず",character:"kawamuro",text:"おれけっこんすんだ",expression:"A"},{speaker:"だいち",character:"daichi",text:"お前もか",expression:"A"},{speaker:"河村",character:"kawamuro",text:"そんなに固くならなくてもいい",expression:"B"},{speaker:"なおき",character:"naoki",text:"ちんぽかためます",expression:"A"},{speaker:"だいち",character:"daichi",text:"やったね！",expression:"A"},{speaker:"なおき",character:"naoki",text:"俺の特殊能力、メタルチンコはがねのように硬いぜ★",expression:"A"},{speaker:"なおき",character:"naoki",text:"金玉もでかいぜ！",expression:"A"}]},after_chinpo:{background:"test_1",bgm:"bgm_demo_chinpo",conversations:[{speaker:"河室",character:"kawamuro",text:"（新しいクラスか...少し緊張するな）",expression:"E"},{speaker:"河室",character:"kawamuro",text:"あ、あなたが転校生の方ですね！",expression:"F"},{speaker:"河室",character:"kawamuro",text:"はい、今日からお世話になります",expression:"D"},{speaker:"河室",character:"kawamuro",text:"私、田中花子です。よろしくお願いします！",expression:"C"},{speaker:"河室",character:"kawamuro",text:"こちらこそ。分からないことがあったら教えてください",expression:"A"},{speaker:"河室",character:"kawamuro",text:"はい！何でも聞いてくださいね♪",expression:"E"}]}};class u{constructor(){this.conversations=g,this.currentEvent=null}getConversation(e){return this.conversations[e]||null}getAvailableEvents(){return Object.keys(this.conversations)}addConversation(e,t){this.conversations[e]=t}updateConversation(e,t){return!!this.conversations[e]&&(this.conversations[e]=t,!0)}}class m{constructor(e){this.scene=e,this.conversationManager=new u,this.isConversationActive=!1,this.triggeredEvents=new Set}startConversation(e){const t=this.conversationManager.getConversation(e);t?this.startVisualNovelConversation(t):this.startSimpleDialog(e)}startVisualNovelConversation(e){this.isConversationActive&&(this.scene.scene.stop("ConversationScene"),this.isConversationActive=!1);const t=this.scene.scene.get("ConversationScene");t&&t.scene.isActive()&&this.scene.scene.stop("ConversationScene"),this.isConversationActive=!0;try{this.scene.time.delayedCall(100,(()=>{this.scene.scene.launch("ConversationScene");const t=this.scene.scene.get("ConversationScene");t?(this.scene.time.delayedCall(200,(()=>{try{t.startConversation(e)}catch(e){console.error("[ConversationTrigger] 会話開始エラー:",e),console.error("[ConversationTrigger] エラースタック:",e.stack),this.isConversationActive=!1}})),t.events.once("conversationEnded",(()=>{this.scene.scene.stop("ConversationScene"),this.isConversationActive=!1}))):(console.error("[ConversationTrigger] ConversationSceneの取得に失敗"),this.isConversationActive=!1)}))}catch(e){console.error("[ConversationTrigger] startVisualNovelConversation()でエラーが発生:",e),console.error("[ConversationTrigger] エラースタック:",e.stack),this.isConversationActive=!1}}startSimpleDialog(e){this.scene.collisionManager&&this.scene.collisionManager.getDialogSystem()&&this.scene.collisionManager.getDialogSystem().startDialog(e)}setupNpcClickHandler(e,t){e.setInteractive(),e.on("pointerdown",(()=>{this.isConversationActive||this.startConversation(t)}))}setupAreaTrigger(e,t,s,a,i){const n=this.scene.add.rectangle(e,t,s,a,0,0);return n.setInteractive(),this.scene.physics.add.existing(n),n.body.setSize(s,a),this.scene.physics.add.overlap(this.scene.playerController.player,n,(()=>{this.isConversationActive||this.triggeredEvents.has(i)||(this.triggeredEvents.add(i),this.startConversation(i))}),null,this.scene),n}setupProximityTrigger(e,t,s,a){const i=this.scene.add.circle(e,t,s,0,0);return this.scene.physics.add.existing(i),i.body.setCircle(s),this.scene.physics.add.overlap(this.scene.playerController.player,i,(()=>{this.isConversationActive||this.triggeredEvents.has(a)||(this.triggeredEvents.add(a),this.startConversation(a))}),null,this.scene),i}isActive(){return this.isConversationActive}}class y extends Phaser.Scene{constructor(){super({key:"ConversationScene"}),this.currentConversationIndex=0,this.currentConversation=null,this.isTextAnimating=!1,this.textSpeed=30,this.originalBgm=null,this.eventBgm=null}create(){if(!this.sys)return void console.error("[ConversationScene] this.sys が undefined です");if(!this.sys.game)return void console.error("[ConversationScene] this.sys.game が undefined です");this.cleanupCharacterSprites(),this.currentTextTimer&&(this.currentTextTimer.destroy(),this.currentTextTimer=null);const e=this.sys?.game?.canvas?.width||this.sys?.game?.config?.width||800,t=this.sys?.game?.canvas?.height||this.sys?.game?.config?.height||600;if(this.background=this.add.rectangle(e/2,t/2,e,t,0,.5),this.background.setOrigin(.5,.5),this.characterContainer=this.add.container(0,0),this.textures.exists("textbox"))this.textbox=this.add.image(e/2,t-60,"textbox");else{const s=Math.min(e-40,700),a=Math.min(150,.25*t);this.textbox=this.add.rectangle(e/2,t-60,s,a,0,.8)}if(this.textbox.setOrigin(.5,.5),this.textures.exists("namebox"))this.namebox=this.add.image(.2*e,t-100,"namebox");else{const s=Math.min(200,.4*e),a=Math.min(50,.08*t);this.namebox=this.add.rectangle(.2*e,t-100,s,a,0,.8)}this.namebox.setOrigin(.5,.5);const s=Math.min(e-80,600),a=e<600?"18px":"24px";this.dialogText=this.add.text(e/2,t-60,"",{fontSize:a,fill:"#ffffff",lineSpacing:8,padding:{x:10,y:10},wordWrap:{width:s,useAdvancedWrap:!0},fixedHeight:50}),this.dialogText.setOrigin(.5,.5);const i=e<600?"16px":"20px";this.nameText=this.add.text(.2*e,t-100,"",{fontSize:i,fill:"#ffffff",fontStyle:"bold",padding:{x:10,y:10},fixedHeight:50}),this.nameText.setOrigin(.5,.2),this.input.removeAllListeners("pointerdown"),this.input.on("pointerdown",(()=>{this.nextDialog()})),this.input.keyboard.on("keydown-SPACE",(()=>{this.nextDialog()})),this.isUICreated=!0}resetUI(){this.dialogText&&this.dialogText.setText(""),this.nameText&&this.nameText.setText(""),this.background&&(this.background.destroy(),this.background=null)}startConversation(e){console.log("[ConversationScene] startConversation:",e),this.currentConversation=e,this.currentConversationIndex=0,this.updateBackground(e.background),this.switchToEventBgm(e.bgm),this.showDialog()}nextDialog(){console.log("[ConversationScene] nextDialog called",this.currentConversationIndex),this.isTextAnimating?this.completeTextAnimation():(this.currentConversationIndex++,this.currentConversationIndex<this.currentConversation.conversations.length?this.showDialog():this.endConversation())}showDialog(){const e=this.currentConversation.conversations[this.currentConversationIndex];console.log("[ConversationScene] showDialog",{index:this.currentConversationIndex,speaker:e?.speaker,text:e?.text,conversation:e}),this.updateCharacterSprite(e.character,e.expression),this.nameText.setText(e.speaker),this.animateText(e.text)}updateCharacterSprite(e,t){if(this.characterSprites||(this.characterSprites={}),this.characterContainer){if(e&&t){const s=`${e}_${t}`,a=this.sys?.game?.canvas?.width||this.sys?.game?.config?.width||800,i=this.sys?.game?.canvas?.height||this.sys?.game?.config?.height||600,n={heroine:{x:.7*a,y:.4*i},friend:{x:.3*a,y:.4*i},teacher:{x:.5*a,y:.4*i},kawamuro:{x:.7*a,y:.4*i},daichi:{x:.3*a,y:.4*i},naoki:{x:.5*a,y:.4*i}}[e]||{x:.7*a,y:.4*i};if(this.characterSprites[e]){const t=this.characterSprites[e];t.texture.key!==s&&t.setTexture(s)}else{const t=this.add.image(n.x,n.y,s);t.setOrigin(.5,.5),this.characterContainer.add(t),this.characterSprites[e]=t,t.setAlpha(0),t.setScale(.8),this.tweens.add({targets:t,alpha:1,scaleX:1,scaleY:1,duration:500,ease:"Power2"})}this.dimOtherCharacters(e)}}else console.warn("characterContainer is not initialized yet")}dimOtherCharacters(e){this.characterSprites&&Object.keys(this.characterSprites).forEach((t=>{const s=this.characterSprites[t];t===e?s.setTint(16777215):s.setTint(8947848)}))}isMobile(){return/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)}animateText(e){if(this.isTextAnimating=!0,this.dialogText.setText(""),this.isMobile())return this.dialogText.setText(e),void(this.isTextAnimating=!1);let t="",s=0;const a=this.time.addEvent({delay:this.textSpeed,callback:()=>{s<e.length?(t+=e[s],this.dialogText.setText(t),s++):(this.isTextAnimating=!1,a.destroy())},loop:!0});this.currentTextTimer=a}completeTextAnimation(){this.currentTextTimer&&this.currentTextTimer.destroy();const e=this.currentConversation.conversations[this.currentConversationIndex];this.dialogText.setText(e.text),this.isTextAnimating=!1}updateBackground(e){if(e&&this.textures.exists(e)){this.background&&this.background.destroy();const t=this.sys?.game?.canvas?.width||this.sys?.game?.config?.width||800,s=this.sys?.game?.canvas?.height||this.sys?.game?.config?.height||600;this.background=this.add.image(t/2,s/2,e),this.background.setOrigin(.5,.5);const a=t/this.background.width,i=s/this.background.height,n=Math.max(a,i);this.background.setScale(n),this.background.setDepth(-1)}}switchToEventBgm(e){console.log("[ConversationScene] switchToEventBgm called:",e);const t=this.scene.get("Stage1Scene")||this.scene.get("Stage2Scene")||this.scene.get("Stage3Scene");t&&t.audioManager&&(this.originalBgm=t.audioManager.bgm,e?t.audioManager.playBgm(e,.3,!0):t.audioManager.playBgm("bgm_event",.3,!0))}restoreOriginalBgm(){const e=this.scene.get("Stage1Scene")||this.scene.get("Stage2Scene")||this.scene.get("Stage3Scene");if(e&&e.audioManager){e.audioManager.stopBgm(!1);const t=this.getOriginalBgmKey();t&&e.audioManager.playBgm(t,.3,!0)}}getOriginalBgmKey(){const e=this.scene.get("Stage1Scene")||this.scene.get("Stage2Scene")||this.scene.get("Stage3Scene");if(e){if("Stage1Scene"===e.scene.key)return"bgm_kessen_diaruga";if("Stage2Scene"===e.scene.key)return"bgm_stage2";if("Stage3Scene"===e.scene.key)return"bgm_stage3"}return"bgm_kessen_diaruga"}endConversation(){console.log("[ConversationScene] endConversation called",{index:this.currentConversationIndex,length:this.currentConversation?.conversations?.length,stack:(new Error).stack}),this.restoreOriginalBgm(),this.cleanupCharacterSprites(),this.currentTextTimer&&(this.currentTextTimer.destroy(),this.currentTextTimer=null),this.resetUI(),this.events.emit("conversationEnded"),this.scene.stop()}cleanupCharacterSprites(){this.characterSprites&&(Object.values(this.characterSprites).forEach((e=>{e&&e.destroy&&e.destroy()})),this.characterSprites={}),this.characterContainer&&this.characterContainer.removeAll()}resize(e){const{width:t,height:s}=e;if(this.background){this.background.setPosition(t/2,s/2);const e=t/this.background.width,a=s/this.background.height,i=Math.max(e,a);this.background.setScale(i)}if(this.textbox){this.textbox.setPosition(t/2,s-60);const e=Math.min(t-40,700),a=Math.min(150,.25*s);this.textbox.setDisplaySize(e,a)}if(this.namebox){this.namebox.setPosition(.2*t,s-100);const e=Math.min(200,.4*t),a=Math.min(50,.08*s);this.namebox.setDisplaySize(e,a)}if(this.dialogText){this.dialogText.setPosition(t/2,s-60);const e=Math.min(t-80,600);this.dialogText.setWordWrapWidth(e);const a=t<600?"18px":"24px";this.dialogText.setFontSize(a)}if(this.nameText){this.nameText.setPosition(.2*t,s-100);const e=t<600?"16px":"20px";this.nameText.setFontSize(e)}this.repositionCharacterSprites()}repositionCharacterSprites(){if(this.characterSprites){const e=this.sys?.game?.canvas?.width||this.sys?.game?.config?.width||800,t=this.sys?.game?.canvas?.height||this.sys?.game?.config?.height||600,s={heroine:{x:.7*e,y:.4*t},friend:{x:.3*e,y:.4*t},teacher:{x:.5*e,y:.4*t},kawamuro:{x:.7*e,y:.4*t},daichi:{x:.3*e,y:.4*t},naoki:{x:.5*e,y:.4*t}};Object.keys(this.characterSprites).forEach((a=>{const i=this.characterSprites[a],n=s[a]||{x:.7*e,y:.4*t};i&&i.setPosition&&i.setPosition(n.x,n.y)}))}}}class S{constructor(e){this.scene=e,this.bgm=null,this.bgmVolume=.3,this.seVolume=.7,this.voiceVolume=.8,this.isBgmMuted=!1,this.isSeMuted=!1,this.isVoiceMuted=!1,this.loadedSounds=new Set}loadSound(e,t){this.loadedSounds.has(e)||(this.scene.load.audio(e,t),this.loadedSounds.add(e))}playBgm(e,t=this.bgmVolume,s=!0){if(this.bgm){if(this.bgm.key===e)return;this.stopBgm(s,(()=>{this.startNewBgm(e,t,s)}))}else this.startNewBgm(e,t,s)}startNewBgm(e,t,s){if(!this.isBgmMuted)try{console.log("[AudioManager] sound cache keys:",Object.keys(this.scene.cache.audio.entries.entries)),this.bgm=this.scene.sound.add(e,{loop:!0,volume:s?0:t}),this.bgm.play(),s?this.scene.tweens.add({targets:this.bgm,volume:t,duration:500}):this.bgm.setVolume(t),console.log("[AudioManager] BGM started:",e)}catch(t){console.error(`[AudioManager] BGM ${e} の再生に失敗しました:`,t)}}stopBgm(e=!0,t){this.bgm?(console.log("[AudioManager] stopBgm:",this.bgm.key,(new Error).stack),e?this.scene.tweens.add({targets:this.bgm,volume:0,duration:500,onComplete:()=>{this.bgm.stop(),this.bgm=null,console.log("[AudioManager] BGM stopped (fade)"),t&&t()}}):(this.bgm.stop(),this.bgm=null,console.log("[AudioManager] BGM stopped"),t&&t())):t&&t()}playSe(e,t=this.seVolume){if(console.log("[SE] playSe called:",e),!this.isSeMuted)try{const s=this.scene.sound.add(e,{volume:t});s.play(),s.once("complete",(()=>{s.destroy()}))}catch(t){console.error(`SE ${e} の再生に失敗しました:`,t)}}playVoice(e,t=this.voiceVolume){if(!this.isVoiceMuted)try{const s=this.scene.sound.add(e,{volume:t});s.play(),s.once("complete",(()=>{s.destroy()}))}catch(t){console.error(`Voice ${e} の再生に失敗しました:`,t)}}setBgmVolume(e){this.bgmVolume=e,this.bgm&&this.bgm.setVolume(e)}setSeVolume(e){this.seVolume=e}setVoiceVolume(e){this.voiceVolume=e}muteBgm(e){this.isBgmMuted=e,this.bgm&&this.bgm.setMute(e)}muteSe(e){this.isSeMuted=e}muteVoice(e){this.isVoiceMuted=e}muteAll(e){this.muteBgm(e),this.muteSe(e),this.muteVoice(e)}stopAll(){this.stopBgm(!1),this.scene.sound.stopAll()}destroy(){this.stopAll(),this.loadedSounds.clear()}}class M extends Phaser.Scene{constructor(){super({key:"Stage1Scene"}),this.mapManager=null,this.playerController=null,this.touchControlManager=null,this.uiManager=null,this.cameraManager=null,this.inputManager=null,this.collisionManager=null,this.behaviorManager=null,this.dialogSystem=null,this.audioManager=null,this.conversationTrigger=null,this.updateCounter=0}preload(){this.load.tilemapTiledJSON("map","assets/maps/stage1.tmj"),this.load.image("[A]Grass1_pipo","assets/maps/tilesets/stage1/[A]Grass1_pipo.png"),this.load.image("Tilemap","assets/maps/tilesets/stage1/Tilemap.png"),this.load.audio("bgm_kessen_diaruga","assets/audio/bgm/stage1/kessen_diaruga.mp3"),this.load.audio("bgm_demo_chinpo","assets/audio/bgm/stage1/megarovania.mp3"),this.load.on("filecomplete-audio-bgm_menu",(()=>{}));const e={frameWidth:32,frameHeight:32};this.load.spritesheet("ojyama1","assets/characters/enemies/pipo-charachip005a.png",e),this.load.spritesheet("hanni","assets/characters/npcs/pipo-charachip007a.png",e),this.load.spritesheet("kuccoro","assets/characters/npcs/pipo-charachip022e.png",e),this.load.spritesheet("kuccoro1","assets/characters/npcs/pipo-charachip022a.png",e),this.load.spritesheet("kuccoro2","assets/characters/npcs/pipo-charachip022e.png",e),this.load.spritesheet("kuccoro3","assets/characters/npcs/pipo-charachip026.png",e),this.load.spritesheet("kuccoro4","assets/characters/npcs/pipo-charachip024d.png",e),this.load.spritesheet("enemy1","assets/characters/enemies/pipo-charachip005a.png",e),this.load.spritesheet("enemy2","assets/characters/enemies/pipo-charachip005a.png",e),this.load.spritesheet("friend1","assets/characters/npcs/pipo-charachip007a.png",e),this.load.spritesheet("friend2","assets/characters/npcs/pipo-charachip007a.png",e),this.load.spritesheet("kuccoro","assets/characters/npcs/pipo-charachip022a.png",e),this.load.on("fileerror",(()=>{})),this.load.on("complete",(()=>{})),this.load.image("kawamuro_A","assets/characters/portraits/kawamuro_A.png"),this.load.image("kawamuro_B","assets/characters/portraits/kawamuro_B.png"),this.load.image("kawamuro_C","assets/characters/portraits/kawamuro_C.png"),this.load.image("kawamuro_D","assets/characters/portraits/kawamuro_D.png"),this.load.image("kawamuro_E","assets/characters/portraits/kawamuro_E.png"),this.load.image("kawamuro_F","assets/characters/portraits/kawamuro_F.png"),this.load.image("daichi_A","assets/characters/portraits/daichi_A.png"),this.load.image("naoki_A","assets/characters/portraits/naoki_A.png"),this.load.image("test_1","assets/backgrounds/background_test.png"),this.load.image("textbox","assets/ui/textbox.png"),this.load.image("namebox","assets/ui/namebox.png"),this.load.audio("se_touch_stage1","assets/audio/se/touch_1.mp3")}create(){try{this.audioManager=new S(this),this.audioManager.playBgm("bgm_kessen_diaruga",.3),this.collisionManager=new c(this),this.collisionManager.setupCollisionGroups(),this.dialogSystem=new p(this,d),this.collisionManager.setDialogSystem(this.dialogSystem),this.behaviorManager=new l(this),this.mapManager=new s(this),this.mapManager.createMap(),this.playerController=new a(this),this.playerController.createPlayer(100,100),this.inputManager=new h,this.inputManager.setupKeyboard(this,this.playerController),this.touchControlManager=new n(this,this.playerController.player,"se_touch_stage1"),this.uiManager=new r,this.uiManager.createUI(this),this.cameraManager=new o(this),this.cameraManager.setupCamera(this,this.mapManager.map,this.playerController.player),this.collisionManager.setupAllCollisions(this.playerController.player,this.mapManager),this.conversationTrigger=new m(this),this.scene.add("ConversationScene",y),this.setupConversationEvents(),this.events.on("shutdown",this.shutdown,this)}catch{}}shutdown(){this.audioManager&&this.audioManager.stopAll&&(this.audioManager.stopAll(),this.audioManager.bgm&&this.audioManager.bgm.destroy&&(this.audioManager.bgm.destroy(),this.audioManager.bgm=null)),this.sound&&this.sound.stopAll()}destroy(){this.shutdown(),super.destroy()}setupConversationEvents(){this.setupNpcConversations(),this.setupAreaTriggers(),this.setupProximityTriggers()}setupNpcConversations(){const e=this.mapManager.getNpcSprite("hanni");e&&this.conversationTrigger.setupNpcClickHandler(e,"demo_chinpo")}setupAreaTriggers(){this.conversationTrigger.setupAreaTrigger(200,200,64,64,"after_chinpo")}setupProximityTriggers(){this.conversationTrigger.setupProximityTrigger(300,300,50,"library_scene")}update(){this.updateCounter++,this.updateCounter%2==0&&(this.playerController.update(),this.uiManager.updatePlayerPosition(this.playerController.player))}resize(e){const{width:t,height:s}=e;this.cameras.resize(t,s)}}class w{constructor(e){this.scene=e}setupObjectBehavior(e,t){switch(t.type){case"npc":this.setupNpcBehavior(e,t);break;case"item":this.setupItemBehavior(e);break;case"enemy":this.setupEnemyBehavior(e,t)}}setupNpcBehavior(e,t){switch(t.name){case"friend2_4":this.setupFriend2Animation(e);break;case"shopkeeper":this.setupShopkeeperAnimation(e);break;case"guard":this.setupGuardAnimation(e);break;case"merchant":this.setupMerchantAnimation(e)}}setupItemBehavior(e){this.scene.tweens.add({targets:e,alpha:.5,scale:1.2,duration:800,yoyo:!0,repeat:-1,ease:"Power2"})}setupEnemyBehavior(e,t){switch(t.name){case"boss_stage2":this.setupBossAnimation(e);break;case"strong_enemy":this.setupStrongEnemyAnimation(e);break;default:this.setupDefaultEnemyAnimation(e)}}setupFriend2Animation(e){this.scene.tweens.add({targets:e,alpha:.8,duration:2e3,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"})}setupShopkeeperAnimation(e){this.scene.tweens.add({targets:e,rotation:.1,duration:1e3,yoyo:!0,repeat:-1,ease:"Power1"})}setupGuardAnimation(e){this.scene.tweens.add({targets:e,x:e.x+40,duration:3e3,yoyo:!0,repeat:-1,ease:"Linear"})}setupMerchantAnimation(e){this.scene.tweens.add({targets:e,y:e.y+8,duration:1200,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"})}setupBossAnimation(e){this.scene.tweens.add({targets:e,scale:1.2,rotation:.2,duration:1500,yoyo:!0,repeat:-1,ease:"Power2"})}setupStrongEnemyAnimation(e){this.scene.tweens.add({targets:e,x:e.x+60,y:e.y+20,duration:1e3,yoyo:!0,repeat:-1,ease:"Back.easeInOut"})}setupDefaultEnemyAnimation(e){this.scene.tweens.add({targets:e,x:e.x+35,rotation:Math.PI/8,duration:2e3,yoyo:!0,repeat:-1,ease:"Power2"})}startConversation(e){this.scene.collisionManager&&this.scene.collisionManager.startConversation(e)}}const x={friend2_4:{name:"ひろかず",messages:["もこうにドンキあるから","そこで、５０万かたしてもらって","もいいい？"]},friend2_5:{name:"くず",messages:["はらめおらぁ"]},guard:{name:"ポルノさん",messages:["できたら愛してくだーさい","僕の肩で羽を休めておくれー"]},kuccoro:{name:"商人",messages:["やめて！","ラーの翼神竜の特殊能力で、ギルフォード・ザ・ライトニングを焼き払われたら、","闇のゲームでモンスターと繋がってる城之内の精神まで燃え尽きちゃう！","お願い、死なないで城之内！","あんたが今ここで倒れたら、舞さんや遊戯との約束はどうなっちゃうの？","ライフはまだ残ってる。ここを耐えれば、マリクに勝てるんだから！","次回「城之内死す」デュエルスタンバイ！"]},kuccoro1:{name:"くっころ",messages:["ここまで辿り着くとはな","しかし、ここが君の限界だ！","かかってこい！","ここが貴様の墓場となろう"]},kuccoro2:{name:"エッチな女騎士",messages:["くっ、、、ころせ！","イグイグイグぅぅ！"]},kuccoro4:{name:"２コマ即落ち女騎士",messages:["くっ、、、殺せ！","イクイクイクイクイクっ、おっちんぽーーーーー！"]}};class k extends Phaser.Scene{constructor(){super({key:"Stage2Scene"}),this.mapManager=null,this.playerController=null,this.touchControlManager=null,this.uiManager=null,this.cameraManager=null,this.inputManager=null,this.collisionManager=null,this.dialogSystem=null}preload(){this.load.tilemapTiledJSON("map","assets/maps/test_map5.tmj"),this.load.audio("bgm_stage2","assets/audio/bgm/stage1/kessen_diaruga.mp3"),this.load.image("GK_A2_C_autotile","assets/maps/tilesets/stage2/GK_A2_JC_autotile.png"),this.load.image("Preview_RPGMakerVXAce","assets/maps/tilesets/stage2/Preview_RPGMakerVXAce.png"),this.load.image("Preview","assets/maps/tilesets/stage2/Preview.png"),this.load.image("GK_JC_A5_2","assets/maps/tilesets/stage2/GK_JC_A5_2.png"),this.load.image("GK_JC_B_2","assets/maps/tilesets/stage2/GK_JC_B_2.png"),this.load.image("Tilemap","assets/maps/tilesets/stage2/Tilemap.png"),this.load.image("pipo-map001_at-kusa","assets/maps/tilesets/stage2/pipo-map001_at-kusa.png");const e={frameWidth:32,frameHeight:32};this.load.spritesheet("enemy1","assets/characters/enemies/pipo-charachip005a.png",e),this.load.spritesheet("friend2_6","assets/characters/npcs/pipo-charachip007a.png",e),this.load.spritesheet("friend2_5","assets/characters/npcs/pipo-charachip007a.png",e),this.load.spritesheet("friend2_4","assets/characters/npcs/pipo-charachip007a.png",e),this.load.spritesheet("friend2_3","assets/characters/npcs/pipo-charachip007a.png",e),this.load.spritesheet("friend2_2","assets/characters/npcs/pipo-charachip007a.png",e),this.load.spritesheet("friend2_1","assets/characters/npcs/pipo-charachip007a.png",e),this.load.spritesheet("kuccoro1","assets/characters/npcs/pipo-charachip022a.png",e),this.load.spritesheet("kuccoro","assets/characters/npcs/pipo-charachip022e.png",e),this.load.spritesheet("kuccoro2","assets/characters/npcs/pipo-charachip024d.png",e),this.load.audio("se_touch_stage2","assets/audio/se/touch_3.mp3"),this.load.on("complete",(()=>{}))}create(){this.audioManager=new S(this),this.audioManager.playBgm("bgm_stage2",.3),this.collisionManager=new c(this),this.collisionManager.setupCollisionGroups(),this.dialogSystem=new p(this,x),this.collisionManager.setDialogSystem(this.dialogSystem),this.behaviorManager=new w(this),this.mapManager=new s(this),this.mapManager.createMap(),this.playerController=new a(this),this.playerController.createPlayer(100,100),this.inputManager=new h,this.inputManager.setupKeyboard(this,this.playerController),this.touchControlManager=new n(this,this.playerController.player,"se_touch_stage2"),this.uiManager=new r,this.uiManager.createUI(this),this.cameraManager=new o(this),this.cameraManager.setupCamera(this,this.mapManager.map,this.playerController.player),this.collisionManager.setupAllCollisions(this.playerController.player,this.mapManager),this.events.on("shutdown",this.shutdown,this)}shutdown(){this.audioManager&&this.audioManager.stopAll&&(this.audioManager.stopAll(),this.audioManager.bgm&&this.audioManager.bgm.destroy&&(this.audioManager.bgm.destroy(),this.audioManager.bgm=null)),this.sound&&this.sound.stopAll()}update(){if(this.dialogSystem&&this.dialogSystem.isDialogActive())return this.playerController.player.setVelocityX(0),void this.playerController.player.setVelocityY(0);this.playerController&&this.playerController.update(),this.updateCounter||(this.updateCounter=0),this.updateCounter++,this.updateCounter%2==0&&this.uiManager&&this.playerController&&this.uiManager.updatePlayerPosition(this.playerController.player)}resize(e){const{width:t,height:s}=e;this.cameras.resize(t,s)}destroy(){this.shutdown(),super.destroy()}}class f extends Phaser.Scene{constructor(){super({key:"Stage3Scene"}),this.mapManager=null,this.playerController=null,this.touchControlManager=null,this.uiManager=null,this.cameraManager=null,this.inputManager=null,this.collisionManager=null,this.audioManager=null,this.updateCounter=0}preload(){this.load.tilemapTiledJSON("map","assets/test_map5.tmj"),this.load.audio("bgm_stage3","assets/audio/bgm/stage1/kessen_diaruga.mp3"),this.load.audio("se_touch_stage3","assets/audio/se/touch_6.mp3"),this.load.on("complete",(()=>{}))}create(){this.audioManager=new S(this),this.audioManager.playBgm("bgm_stage3",.3),this.collisionManager=new c(this),this.collisionManager.setupCollisionGroups(),this.mapManager=new s(this),this.mapManager.createMap(),this.playerController=new a(this),this.playerController.createPlayer(100,100),this.touchControlManager=new n(this,this.playerController.player,"se_touch_stage3"),this.uiManager=new r,this.uiManager.createUI(this),this.cameraManager=new o(this),this.cameraManager.setupCamera(this,this.mapManager.map,this.playerController.player),this.inputManager=new h,this.inputManager.setupKeyboard(this,this.playerController),this.collisionManager.setupAllCollisions(this.playerController.player,this.mapManager),this.events.on("shutdown",this.shutdown,this)}shutdown(){this.audioManager&&this.audioManager.stopAll&&(this.audioManager.stopAll(),this.audioManager.bgm&&this.audioManager.bgm.destroy&&(this.audioManager.bgm.destroy(),this.audioManager.bgm=null)),this.sound&&this.sound.stopAll()}update(){this.playerController&&this.playerController.update(),this.updateCounter||(this.updateCounter=0),this.updateCounter++,this.updateCounter%2==0&&this.uiManager&&this.playerController&&this.uiManager.updatePlayerPosition(this.playerController.player)}resize(e){const{width:t,height:s}=e;this.cameras.resize(t,s)}destroy(){this.shutdown(),this.mapManager&&this.mapManager.destroy&&this.mapManager.destroy(),this.audioManager&&this.audioManager.destroy&&this.audioManager.destroy(),this.touchControlManager&&this.touchControlManager.destroy&&this.touchControlManager.destroy(),this.collisionManager&&this.collisionManager.destroy&&this.collisionManager.destroy(),this.dialogSystem&&this.dialogSystem.destroy&&this.dialogSystem.destroy(),super.destroy()}}class b{constructor(e){this.scene=e,this.areas=[],this.areaSprites=[],this.selectedArea=null,this.isInteractive=!0,this.hoverEffect=null,this.isMobile=this.scene.sys.game.device.input.touch,this.touchStartTime=0,this.touchThreshold=200,this.visualFeedback=new i(e)}setupAreas(e){this.destroy(),e&&Array.isArray(e)?this.areas=e.map((e=>({...e,description:this.getAreaDescription(e.name)}))):this.areas=[],this.createAreaMarkers(),this.setupInteractionEvents(),console.log(`AreaSelectionManager: Setup ${this.areas?this.areas.length:0} areas with ${this.areaSprites?this.areaSprites.length:0} markers`)}getAreaDescription(e){return{mie_high_school:"三重中学校",sumiwataru:"澄みわたる",shigaku:"志学",Banned_kiku:"出禁のキク",drinking_hope:"飲みをしたいなぁ",Weeds_burn:"雑草がもえるぅぅ",katou_poteto:"こうたろうポテト",Tanabata_bamboo:"七夕竹",bookmarket:"ブックマーケット",drink_zutu:"飲み頭痛",ドール:"ドール",momoiro:"桃色",profile:"プロフィール"}[e]||e}createAreaMarkers(){this.areaSprites=[],console.log(`AreaSelectionManager: Creating markers for ${this.areas?this.areas.length:0} areas`),this.areas&&0!==this.areas.length?(this.areas.forEach(((e,t)=>{if(e){console.log(`AreaSelectionManager: Creating marker ${t+1} for area ${e.name} at (${e.x}, ${e.y})`);const s=this.createAreaMarker(e);s&&this.areaSprites.push(s)}})),console.log(`AreaSelectionManager: Created ${this.areaSprites.length} markers`)):console.warn("AreaSelectionManager: No areas available for marker creation")}createAreaMarker(e){const t=this.scene.add.group();t.setData("markerType","areaMarker"),t.setData("areaName",e.name);const s=this.scene.mapManager?.mapScaleX||1,a=10*s,i=Math.max(8,Math.floor(10*s))+"px",n=15*s;console.log(`AreaSelectionManager: Creating marker for ${e.name} at (${e.x}, ${e.y}) with scale ${s}, radius ${a}, fontSize ${i}`);const r=this.scene.add.circle(e.x,e.y,a,4286945,.7);r.setStrokeStyle(2*s,16777215),r.setData("markerType","areaMarker"),r.setData("areaName",e.name);const o=this.scene.add.text(e.x,e.y-n,e.description,{fontSize:i,fill:"#000000",backgroundColor:"#FFFFFF",padding:{x:3*s,y:1*s},borderRadius:2*s});return o.setOrigin(.5,.5),o.setData("markerType","areaMarker"),o.setData("areaName",e.name),t.add(r),t.add(o),r.setInteractive(),r.setData("area",e),this.setupMarkerHover(r,o),this.setupMarkerClick(r),console.log(`AreaSelectionManager: Successfully created marker for ${e.name}`),t}setupMarkerHover(e,t){e.on("pointerover",(()=>{this.isMobile||(this.visualFeedback.showButtonHover(e,1.2,16766720,.7),t.setStyle({fill:"#FF0000"}))})),e.on("pointerout",(()=>{this.isMobile||(this.visualFeedback.resetButtonState(e,1,4286945,.7),t.setStyle({fill:"#000000"}))}))}setupMarkerClick(e){e.on("pointerdown",(()=>{this.isMobile&&(this.touchStartTime=Date.now()),e.setFillStyle(16711680,.7),this.scene.tweens.add({targets:e,scaleX:1.3,scaleY:1.3,duration:100,yoyo:!0,ease:"Power2"})})),e.on("pointerup",(()=>{const t=e.getData("area");this.isMobile?Date.now()-this.touchStartTime<this.touchThreshold&&this.selectArea(t):this.selectArea(t),e.setFillStyle(4286945,.7)}))}setupInteractionEvents(){this.scene.input.on("pointerdown",(e=>{this.lastTapX=e.x,this.lastTapY=e.y})),this.scene.input.on("pointerup",(e=>{Math.abs(e.x-this.lastTapX),Math.abs(e.y-this.lastTapY)}))}selectArea(e){try{if(!this.isInteractive)return;this.selectedArea=e,this.showSelectionEffect(e),this.playSelectionSound()}catch(e){console.error("AreaSelectionManager: Error in selectArea:",e)}}showSelectionEffect(e){this.visualFeedback.showSelectionEffect(e.x,e.y),this.showConfirmDialog(e)}showConfirmDialog(e){const t=this.scene.add.container(this.scene.cameras.main.worldView.centerX,this.scene.cameras.main.worldView.centerY),s=this.scene.add.rectangle(0,0,300,150,0,.8);s.setStrokeStyle(2,16777215);const a=this.scene.add.text(0,-40,e.description,{fontSize:"18px",fill:"#FFFFFF",align:"center"});a.setOrigin(.5);const i=this.scene.add.text(0,-10,"この場所に移動しますか？",{fontSize:"14px",fill:"#FFFFFF",align:"center"});i.setOrigin(.5);const n=this.scene.add.text(-60,30,"はい",{fontSize:"16px",fill:"#00FF00",backgroundColor:"#333333",padding:{x:10,y:5}});n.setOrigin(.5),n.setInteractive();const r=this.scene.add.text(60,30,"いいえ",{fontSize:"16px",fill:"#FF0000",backgroundColor:"#333333",padding:{x:10,y:5}});r.setOrigin(.5),r.setInteractive(),t.add([s,a,i,n,r]),n.on("pointerdown",(()=>{t.destroy(),this.handleAreaSelection(e)})),r.on("pointerdown",(()=>{t.destroy()})),this.scene.time.delayedCall(5e3,(()=>{t.active&&t.destroy()}))}handleAreaSelection(e){this.scene.time.delayedCall(1e3,(()=>{this.navigateToArea(e)}))}navigateToArea(e){e.scene?this.scene.scene.start(e.scene):console.log(`Area ${e.name} not implemented yet`)}playSelectionSound(){try{this.scene.audioManager&&this.scene.audioManager.playSe("se_touch",.5)}catch(e){}}enableInteraction(){this.isInteractive=!0}disableInteraction(){this.isInteractive=!1}update(){}handleTouchAt(e,t){try{const s=this.findAreaAtPosition(e,t);s?this.selectArea(s):this.scene.audioManager&&this.scene.mapConfig?.se?.map_touch&&this.scene.audioManager.playSe("se_map_touch",.3)}catch(e){console.error("AreaSelectionManager: Error in handleTouchAt:",e)}}findAreaAtPosition(e,t){for(let s of this.areas)if(Math.sqrt(Math.pow(e-s.x,2)+Math.pow(t-s.y,2))<=20)return s;return null}getAreas(){return this.areas}findAreaByName(e){return this.areas.find((t=>t.name===e))}updateAreaPositions(e){e&&0!==e.length?(console.log(`AreaSelectionManager: Updating positions for ${e.length} areas`),this.destroy(),this.scene&&this.scene.children&&this.scene.children.entries&&this.scene.children.entries.forEach((e=>{!e||"Group"!==e.type&&"Arc"!==e.type&&"Text"!==e.type||e.destroy&&e.destroy()})),this.areas=e.map((e=>({...e,description:this.getAreaDescription(e.name)}))),console.log(`AreaSelectionManager: Creating ${this.areas.length} markers`),this.createAreaMarkers(),console.log(`AreaSelectionManager: Updated ${this.areaSprites.length} markers`)):console.warn("AreaSelectionManager: No areas provided for marker update")}repositionMarkers(){const e=this.scene.mapManager?.mapScaleX||1,t=15*e;this.areaSprites.forEach(((s,a)=>{if(s&&this.areas[a]){const i=this.areas[a];s.children.entries.forEach((s=>{if("Arc"===s.type)s.setPosition(i.x,i.y),s.setRadius(10*e),s.setStrokeStyle(2*e,16777215);else if("Text"===s.type){s.setPosition(i.x,i.y-t);const a=Math.max(8,Math.floor(10*e))+"px";s.setStyle({fontSize:a})}}))}}))}destroy(){this.areaSprites&&Array.isArray(this.areaSprites)&&this.areaSprites.forEach((e=>{e&&(e.children&&e.children.entries&&e.children.entries.forEach((e=>{e&&e.destroy&&e.destroy()})),e.destroy&&e.destroy())})),this.scene&&this.scene.children&&this.scene.children.entries&&this.scene.children.entries.forEach((e=>{e&&e.getData&&"areaMarker"===e.getData("markerType")&&e.destroy&&e.destroy()})),this.areaSprites=[],this.selectedArea=null,console.log("AreaSelectionManager: Destroyed all markers")}}const C={miemachi:{mapKey:"bunngo_mie_city",tilesetKey:"bunngooonoshimiemachi",mapTitle:"三重町マップ",bgm:{map:"assets/audio/bgm/stage1/kessen_diaruga.mp3",battle:"assets/audio/bgm/stage1/battle.mp3",event:"assets/audio/bgm/stage1/event.mp3"},se:{touch:"assets/audio/se/touch_7.mp3",map_touch:"assets/audio/se/touch_2.mp3"},areas:[{name:"mie_high_school",scene:"MieHighSchoolScene"},{name:"sumiwataru",scene:"SumiWataruScene"},{name:"shigaku",scene:"ShigakuScene"},{name:"Banned_kiku",scene:"BannedKikuScene"},{name:"drinking_hope",scene:"DrinkingHopeScene"},{name:"Weeds_burn",scene:"WeedsBurnScene"},{name:"katou_poteto",scene:"KatouPotetoScene"},{name:"Tanabata_bamboo",scene:"TanabataBambooScene"},{name:"bookmarket",scene:"BookMarketScene"},{name:"drink_zutu",scene:"DrinkZutuScene"},{name:"ドール",scene:"DollScene"},{name:"momoiro",scene:"MomoiroScene"},{name:"profile",scene:"ProfileScene"}]},second_map:{mapKey:"second_map",tilesetKey:"second_tileset",mapTitle:"2つ目のマップ",bgm:"assets/audio/bgm/stage1/kessen_diaruga.mp3",eventBgm:{area_1:"assets/audio/bgm/events/school_event.mp3",area_2:"assets/audio/bgm/events/romantic_event.mp3"},areas:[{name:"area_1",scene:"SecondMap_Area1Scene"},{name:"area_2",scene:"SecondMap_Area2Scene"}]},third_map:{mapKey:"third_map",tilesetKey:"third_tileset",mapTitle:"3つ目のマップ",bgm:"assets/audio/bgm/stage1/kessen_diaruga.mp3",eventBgm:{area_A:"assets/audio/bgm/events/school_event.mp3",area_B:"assets/audio/bgm/events/romantic_event.mp3"},areas:[{name:"area_A",scene:"ThirdMap_AreaAScene"},{name:"area_B",scene:"ThirdMap_AreaBScene"}]}};class v extends Phaser.Scene{constructor(e){super({key:e.sceneKey}),this.mapConfig=e.mapConfig,this.mapId=e.mapId,this.mapManager=null,this.areaSelectionManager=null,this.uiManager=null,this.cameraManager=null,this.audioManager=null,this.visualFeedbackManager=null,this.isMobile=!1}preload(){this.load.tilemapTiledJSON(this.mapConfig.mapKey,`assets/maps/${this.mapId}/${this.mapConfig.mapKey}.tmj`),this.load.image(this.mapConfig.tilesetKey,`assets/maps/${this.mapId}/${this.mapConfig.tilesetKey}.png`),this.loadBgmFiles(),this.loadSeFiles(),this.load.on("fileerror",(e=>{console.warn(`File not found: ${e.key}, using fallback`),this.mapManager?.createFallbackImage(e.key)})),this.load.on("complete",(()=>{}))}loadSeFiles(){this.mapConfig.se&&Object.keys(this.mapConfig.se).forEach((e=>{this.load.audio(`se_${e}`,this.mapConfig.se[e])}))}loadBgmFiles(){this.mapConfig.bgm&&"object"==typeof this.mapConfig.bgm&&Object.keys(this.mapConfig.bgm).forEach((e=>{this.load.audio(`bgm_${e}`,this.mapConfig.bgm[e])})),this.mapConfig.eventBgm&&Object.keys(this.mapConfig.eventBgm).forEach((e=>{this.load.audio(`bgm_event_${e}`,this.mapConfig.eventBgm[e])}))}create(){try{this.isMobile=this.sys.game.device.input.touch,this.cameraManager=new o(this),this.cameraManager.setBackgroundColor("#87CEEB"),this.mapManager=new s(this),this.mapManager.createMap(this.mapConfig.mapKey,this.mapConfig.tilesetKey),this.mapManager.scaleMapToScreen(),this.cameraManager.setupCamera(this.mapManager.getMapSize()),this.areaSelectionManager=new b(this),this.visualFeedbackManager=new i(this);const e=this.mapManager.getAreas(),t=this.mapConfig.areas,a=e.map((e=>{const s=t.find((t=>t.name===e.name));return{...e,scene:s?.scene||null}}));this.areaSelectionManager.setupAreas(a),this.setupTouchEvents(),this.uiManager=new r,this.uiManager.createMapUI(this,this.mapConfig.mapTitle),this.uiManager.createBackButton(this),this.createScaleToggleButton(),this.audioManager=new S(this),this.audioManager.playBgm("bgm_map",.3),this.scale.on("resize",this.handleResize,this),this.events.on("shutdown",this.shutdown,this)}catch(e){console.error(`Error creating ${this.mapConfig.mapTitle}:`,e),console.error("Stack trace:",e.stack)}}setupTouchEvents(){this.input.on("pointerdown",(e=>{this.handleTouch(e)})),this.cameraManager.setupScrollControls(),this.cameraManager.setupPinchZoom()}handleTouch(e){try{if(!this.cameras||!this.cameras.main)return void console.error(`${this.mapConfig.mapTitle}: Camera not available`);const t=this.cameras.main.getWorldPoint(e.x,e.y),s=t.x,a=t.y;this.areaSelectionManager&&this.areaSelectionManager.handleTouchAt(s,a),this.visualFeedbackManager&&this.visualFeedbackManager.showTouchRipple(s,a)}catch(e){console.error(`${this.mapConfig.mapTitle}: Error in handleTouch:`,e)}}createScaleToggleButton(){const e=this.add.text(10,50,"スケール切替",{fontSize:"18px",fill:"#ffffff",backgroundColor:"#666666",padding:{x:15,y:8}});e.setScrollFactor(0),e.setInteractive(),e.on("pointerdown",(()=>{this.cameraManager.toggleMapScale(),1.5===(this.cameraManager.scene.mapManager?.mapScaleX||this.cameraManager.currentScale)?e.setText("全体表示"):e.setText("1.5倍表示")})),e.setText("1.5倍表示")}handleResize(e){try{if(this.mapManager?.handleResize(e),this.cameraManager?.setupCamera(this.mapManager.getMapSize()),this.areaSelectionManager){this.areaSelectionManager.destroy(),this.areaSelectionManager=new b(this);const e=this.mapManager.getAreas(),t=this.mapConfig.areas,s=e.map((e=>{const s=t.find((t=>t.name===e.name));return{...e,scene:s?.scene||null}}));this.areaSelectionManager.setupAreas(s)}this.uiManager?.updateMapUI(e)}catch(e){console.error("Error handling resize:",e)}}update(){this.areaSelectionManager?.update(),this.cameraManager?.update()}destroy(){this.shutdown(),super.destroy()}shutdown(){this.audioManager&&this.audioManager.stopAll&&(this.audioManager.stopAll(),this.audioManager.bgm&&this.audioManager.bgm.destroy&&(this.audioManager.bgm.destroy(),this.audioManager.bgm=null)),this.sound&&this.sound.stopAll()}}let A=null;function T(){const e=document.getElementById("game-container"),t=document.getElementById("stage-select");e&&(e.style.display="none"),t&&(t.style.display="block")}function _(){document.getElementById("stage-select").style.display="none",document.getElementById("game-container").style.display="block"}function B(e){_(),function(e){!function(e){const s=function(){if(window.game)return window.game;const e={...t,scene:[]};return A=new Phaser.Game(e),window.game=A,window.gameInstance=A,A}();let a,i;switch(e){case 1:case"stage1_enhanced":default:a=M,i="Stage1Scene";break;case 2:a=k,i="Stage2Scene";break;case 3:a=f,i="Stage3Scene";break;case"miemachi":a=function(e){const t=C[e];return t?new v({sceneKey:"MiemachiStage",mapConfig:t,mapId:e}):(console.error(`Map config not found for: ${e}`),null)}("miemachi"),i="MiemachiStage"}s.scene.add(i,a,!0)}(e)}(e)}if(window.returnToStageSelect=function(){window.game&&window.game.destroy&&(window.game.destroy(!0),window.game=null,void 0!==window.gameInstance&&(window.gameInstance=null)),T()},window.showStageSelect=T,window.hideStageSelect=_,!window.stageSelectInitialized){window.stageSelectInitialized=!0,T();const e=document.getElementById("stage1"),t=document.getElementById("stage2"),s=document.getElementById("stage3"),a=document.getElementById("miemachi");e&&(e.removeEventListener("click",P),e.addEventListener("click",P)),t&&(t.removeEventListener("click",I),t.addEventListener("click",I)),s&&(s.removeEventListener("click",E),s.addEventListener("click",E)),a&&(a.removeEventListener("click",D),a.addEventListener("click",D))}function P(){B(1)}function I(){B(2)}function E(){B(3)}function D(){B("miemachi")}window.addEventListener("orientationchange",(()=>{setTimeout((()=>{window.gameInstance&&window.gameInstance.scale&&window.gameInstance.scale.resize(window.innerWidth,window.innerHeight)}),500)}))})();