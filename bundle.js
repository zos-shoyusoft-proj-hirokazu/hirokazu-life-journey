(()=>{"use strict";var e,t,a={92:(e,t,a)=>{a.r(t),a.d(t,{DynamicConversationScene:()=>s});class s extends Phaser.Scene{constructor(){super(),this.eventId=null,this.resourcesLoaded=!1,this.audioManager=null}init(e){this.eventId=e.eventId,console.log("[DynamicConversationScene] init called with eventId:",this.eventId),this.conversationData=null,this.conversationDataLoaded=!1,this.resourcesLoaded=!1,this.eventConfig=null,this.loadEventConfig()}async loadEventConfig(){try{const{getEventConfig:e}=await a.e(557).then(a.bind(a,557));this.eventConfig=e(this.eventId),console.log("[DynamicConversationScene] loadEventConfig完了, eventConfig:",this.eventConfig)}catch(e){console.error("[DynamicConversationScene] loadEventConfigエラー:",e)}}async preload(){for(console.log("[DynamicConversationScene] preload開始");!this.eventConfig;)await new Promise((e=>setTimeout(e,10)));await this.loadRequiredResources(),this.load.once("complete",(()=>{this.resourcesLoaded=!0,console.log("[DynamicConversationScene] preload complete - リソース読み込み完了"),this.audioManager&&this.requiredResources&&(console.log("[DynamicConversationScene] AudioManager loadedSounds更新開始"),this.requiredResources.bgm&&this.requiredResources.bgm.forEach((e=>{const t=`bgm_${e}`;this.audioManager.loadedSounds.add(t),console.log(`[DynamicConversationScene] preload complete - BGMをloadedSoundsに追加: ${t}`)})),this.requiredResources.se&&this.requiredResources.se.forEach((e=>{const t=`se_${e}`;this.audioManager.loadedSounds.add(t),console.log(`[DynamicConversationScene] preload complete - SEをloadedSoundsに追加: ${t}`)})),console.log("[DynamicConversationScene] AudioManager loadedSounds更新完了:",Array.from(this.audioManager.loadedSounds)))})),this.load.on("error",(e=>{console.error("[DynamicConversationScene] リソース読み込みエラー:",e)})),this.load.on("progress",(e=>{console.log("[DynamicConversationScene] 読み込み進捗:",e),window.LoadingManager&&window.LoadingManager.updateProgress(100*e)})),console.log("[DynamicConversationScene] preload - this.load.start()を実行"),this.load.start()}async loadRequiredResources(){console.log("[DynamicConversationScene] loadRequiredResources開始, eventId:",this.eventId);const{getRequiredResources:e,getEventConfig:t}=await a.e(557).then(a.bind(a,557));this.eventConfig=t(this.eventId),console.log("[DynamicConversationScene] eventConfig:",this.eventConfig);const s=e(this.eventId);console.log("[DynamicConversationScene] required:",s),this.requiredResources=s,s&&(s.backgrounds?.forEach((e=>{let t="miemachi";"taketa"===this.eventConfig.areaType?t="taketa":"japan"===this.eventConfig.areaType&&(t="japan"),this.load.image(e,`assets/backgrounds/${t}/${e}.png`)})),s.characters?.forEach((e=>{this.load.image(e,`assets/characters/portraits/${e}.png`)})),(s.bgm||s.se)&&(console.log("[DynamicConversationScene] AudioManager初期化開始"),this.audioManager=new((await Promise.resolve().then(a.bind(a,296))).AudioManager)(this),console.log("[DynamicConversationScene] AudioManager初期化完了"),console.log("[DynamicConversationScene] AudioManager loadedSounds初期状態:",Array.from(this.audioManager.loadedSounds)),s.bgm&&(console.log("[DynamicConversationScene] BGM読み込み処理開始:",s.bgm),s.bgm.forEach((e=>{const t=`bgm_${e}`,a=`assets/audio/bgm/${e}.mp3`;console.log(`[DynamicConversationScene] BGM読み込み: ${t} -> ${a}`);const s=encodeURI(a);console.log(`[DynamicConversationScene] エンコードされたパス: ${s}`),this.load.audio(t,s),console.log(`[DynamicConversationScene] BGM読み込みキューに追加: ${t}`),this.load.on("loaderror",(e=>{e.key===t&&console.error(`[DynamicConversationScene] BGMファイル読み込みエラー: ${t} -> ${s}`)}))}))))),await this.loadConversationData(),this.conversationDataLoaded=!0,console.log("[DynamicConversationScene] loadRequiredResources完了")}suppressStageBGM(){try{console.log("[DynamicConversationScene] suppressStageBGM開始");const e=this.scene.manager;if(e){const t=["taketa_highschool","mie_high_school"];for(const a of t)try{const t=e.getScene(a);if(t&&t.scene&&t.scene.isActive()){if(console.log("[DynamicConversationScene]",a,"がアクティブです"),void 0!==t._suppressMapBgm&&(t._suppressMapBgm=!0,console.log("[DynamicConversationScene]",a,"の_suppressMapBgmフラグをtrueに設定")),t.audioManager){if(console.log("[DynamicConversationScene]",a,"の直接BGM停止開始"),t.audioManager.bgm){console.log("[DynamicConversationScene]",a,"のBGMオブジェクト停止");try{t.audioManager.bgm.stop(),console.log("[DynamicConversationScene]",a,"のBGMオブジェクト停止完了")}catch(e){console.warn("[DynamicConversationScene]",a,"のBGMオブジェクト停止エラー:",e)}}else console.log("[DynamicConversationScene]",a,"のBGMオブジェクトはnullです");if("function"==typeof t.audioManager.stopBgm){console.log("[DynamicConversationScene]",a,"のstopBgmメソッド実行");try{t.audioManager.stopBgm(),console.log("[DynamicConversationScene]",a,"のstopBgmメソッド実行完了")}catch(e){console.warn("[DynamicConversationScene]",a,"のstopBgmメソッド実行エラー:",e)}}else console.log("[DynamicConversationScene]",a,"のstopBgmメソッドが存在しません");if(t._htmlBgm){console.log("[DynamicConversationScene]",a,"のHTML5 BGM停止");try{t._htmlBgm.pause(),t._htmlBgm.currentTime=0,console.log("[DynamicConversationScene]",a,"のHTML5 BGM停止完了")}catch(e){console.warn("[DynamicConversationScene]",a,"のHTML5 BGM停止エラー:",e)}}else console.log("[DynamicConversationScene]",a,"のHTML5 BGMは存在しません");console.log("[DynamicConversationScene]",a,"の直接BGM停止完了")}else console.log("[DynamicConversationScene]",a,"のaudioManagerが存在しません");break}}catch(e){console.warn("[DynamicConversationScene]",a,"の処理エラー:",e)}}console.log("[DynamicConversationScene] suppressStageBGM完了")}catch(e){console.warn("[DynamicConversationScene] BGM抑制エラー:",e)}}loadConversationData(){return new Promise((e=>{console.log("[DynamicConversationScene] loadConversationData開始"),console.log("[DynamicConversationScene] this.eventConfig:",this.eventConfig);const t=this.eventConfig?.areaType;if(console.log("[DynamicConversationScene] areaType:",t),t)switch(t){case"miemachi":Promise.resolve().then(a.bind(a,362)).then((({miemachiConversationData:t})=>{const a=this.eventConfig.conversationDataKey;this.conversationData=t[a],e()}));break;case"taketa":Promise.resolve().then(a.bind(a,327)).then((({taketaConversationData:t})=>{const a=this.eventConfig.conversationDataKey;console.log("[DynamicConversationScene] taketaエリアの会話データ読み込み開始"),console.log("[DynamicConversationScene] conversationKey:",a),console.log("[DynamicConversationScene] taketaConversationData:",t),console.log("[DynamicConversationScene] 利用可能な会話データキー:",Object.keys(t)),this.conversationData=t[a],console.log("[DynamicConversationScene] 読み込まれた会話データ:",this.conversationData),this.conversationData||console.error(`[DynamicConversationScene] 会話データが見つかりません: ${a}`),e()}));break;case"japan":Promise.resolve().then(a.bind(a,527)).then((({japanConversationData:t})=>{const a=this.eventConfig.conversationDataKey;this.conversationData=t[a],e()}));break;default:e()}else e()}))}create(){if(console.log("[DynamicConversationScene] create開始"),console.log("[DynamicConversationScene] resourcesLoaded:",this.resourcesLoaded),console.log("[DynamicConversationScene] conversationDataLoaded:",this.conversationDataLoaded),!this.resourcesLoaded||!this.conversationDataLoaded)return console.log("[DynamicConversationScene] 読み込み未完了のため、100ms後に再試行"),void this.time.delayedCall(100,(()=>{this.create()}));console.log("[DynamicConversationScene] create実行：読み込み完了フラグ確認"),console.log("[DynamicConversationScene] BGM管理システム開始"),this.suppressStageBGM(),console.log("[DynamicConversationScene] BGM管理システム完了");let e="MiemachiStage",t=null;if(this.eventConfig&&this.eventConfig.areaType)switch(this.eventConfig.areaType){case"miemachi":if("mie_high_school"===this.eventConfig.areaName){e="mie_high_school";try{const e=this.scene.manager.getScene("mie_high_school");e&&(t={floor:e.currentFloor||1,playerPosition:e.playerController?e.playerController.getPosition():{x:100,y:100},mapKey:e.mapManager?e.mapManager.currentMapKey:"mie_high_school_1"},console.log("[DynamicConversationScene] 三重中学校内の状態を取得:",t))}catch(e){console.warn("[DynamicConversationScene] 状態取得エラー:",e)}}else e="MiemachiStage",t=null,console.log("[DynamicConversationScene] 三重町マップに戻ります（状態保存なし）:",this.eventConfig.areaName);break;case"taketa":if("taketa_high_school"===this.eventConfig.areaName||"classroom"===this.eventConfig.areaName){e="taketa_highschool";try{const e=this.scene.manager.getScene("taketa_highschool");e&&(t={floor:e.currentFloor||1,playerPosition:e.playerController?e.playerController.getPosition():{x:100,y:100},mapKey:e.mapManager?e.mapManager.currentMapKey:"taketa_highschool_1"},console.log("[DynamicConversationScene] 竹田高校内の状態を取得:",t))}catch(e){console.warn("[DynamicConversationScene] 状態取得エラー:",e)}}else e="TaketastageStage",t=null,console.log("[DynamicConversationScene] 竹田マップに戻ります（状態保存なし）:",this.eventConfig.areaName);break;case"japan":e="JapanStage";break;default:e="MiemachiStage"}const a=this.eventConfig?.areaName||this.eventId;console.log("[DynamicConversationScene] ConversationScene起動時のデータ:"),console.log("[DynamicConversationScene] conversationId:",this.eventId),console.log("[DynamicConversationScene] eventConfig:",this.eventConfig),console.log("[DynamicConversationScene] conversations:",this.conversationData),console.log("[DynamicConversationScene] audioManager:",this.audioManager),console.log("[DynamicConversationScene] originalSceneKey:",e),console.log("[DynamicConversationScene] areaName:",a),this.scene.launch("ConversationScene",{conversationId:this.eventId,eventConfig:this.eventConfig,conversations:this.conversationData,audioManager:this.audioManager,originalSceneKey:e,areaName:a,currentState:t}),this.scene.bringToTop("ConversationScene"),this.scene.stop()}}},296:(e,t,a)=>{a.r(t),a.d(t,{AudioManager:()=>s});class s{constructor(e){this.scene=e,this.bgm=null,this.bgmVolume=.3,this.seVolume=.7,this.voiceVolume=.8,this.isBgmMuted=!1,this.isSeMuted=!1,this.isVoiceMuted=!1,this.loadedSounds=new Set}ensureAudioUnlocked(){try{if(!this.scene)return console.warn("[AudioManager] シーンが存在しません"),!1;if(!this.scene.sound)return console.warn("[AudioManager] シーンのサウンドシステムが存在しません"),!1;const e=this.scene.sound;if(void 0===e.locked&&(console.log("[AudioManager] サウンドシステムのlockedプロパティが存在しません（stage系のマップ）"),e.context&&"running"===e.context.state))return console.log("[AudioManager] 音声コンテキストは利用可能、続行"),!0;const t=e.context;if(!t){console.log("[AudioManager] 音声コンテキストが初期化されていません、強制再初期化を試行...");try{if(this.scene&&this.scene.sound){if(this.scene.sound.context)try{this.scene.sound.context.close()}catch(e){}try{const e=new(window.AudioContext||window.webkitAudioContext);this.scene.sound.context=e,console.log("[AudioManager] 新しい音声コンテキストを作成しました"),"suspended"===e.state&&(e.resume(),console.log("[AudioManager] 新しい音声コンテキストを開始しました")),"running"!==e.state&&(e.onstatechange=()=>{"running"===e.state&&console.log("[AudioManager] 新しい音声コンテキストが動作開始しました")})}catch(e){console.warn("[AudioManager] 新しい音声コンテキスト作成エラー:",e)}}}catch(e){console.warn("[AudioManager] 音声コンテキスト強制再初期化エラー:",e)}return!1}return console.log("[AudioManager] 音声コンテキスト状態:",t.state),e.locked?(console.log("[AudioManager] 音声がロックされています、ユーザー操作を待機中..."),this.waitForUserInteraction(),!1):(console.log("[AudioManager] 音声はロックされていません"),!0)}catch(e){return console.warn("[AudioManager] Audio unlock error:",e),!1}}waitForUserInteraction(){this.scene&&this.scene.input&&this.scene.input.once("pointerdown",(()=>{if(console.log("[AudioManager] ユーザーインタラクション検出、音声コンテキスト復旧を試行"),this.scene&&this.scene.sound&&this.scene.sound.context){const e=this.scene.sound.context;"suspended"===e.state&&e.resume().then((()=>{console.log("[AudioManager] 音声コンテキストが復旧しました"),this.scene.sound.locked||console.log("[AudioManager] 音声ロックが解除されました")})).catch((e=>{console.warn("[AudioManager] 音声コンテキスト復旧エラー:",e)}))}}))}isSceneUsable(){try{return!(!this.scene||!this.scene.sound)}catch(e){return console.warn("[AudioManager] Scene usability check error:",e),!1}}loadSound(e,t){this.loadedSounds.has(e)||(this.scene.load.audio(e,t),this.loadedSounds.add(e))}playBgm(e,t=this.bgmVolume,a=!0){if(console.log(`[AudioManager] playBgm開始: ${e}, 音量: ${t}`),!this.isSceneUsable())return console.warn("[AudioManager] シーンが使用できません"),!1;try{const e=this.scene&&this.scene.sound,t=e&&e.context;console.log("[AudioManager] 音声システム状態:",{scene:!!this.scene,sound:!!e,context:!!t,contextState:t?t.state:"undefined",locked:e?e.locked:"unknown"})}catch(e){console.warn("[AudioManager] 音声システム状態確認エラー:",e)}return this.ensureAudioUnlocked()?this.bgm?this.bgm.isPlaying&&this.bgm.key===e?(console.log(`[AudioManager] 同じBGM ${e} は実際に再生中、スキップ`),!0):(console.log(`[AudioManager] 既存BGM ${this.bgm.key} の状態: isPlaying=${this.bgm.isPlaying}, 停止してから ${e} を再生`),this.stopBgm(a,(()=>{this.isSceneUsable()&&this.startNewBgm(e,t,a)})),!0):!!this.isSceneUsable()&&this.startNewBgm(e,t,a):(console.warn("[AudioManager] 音声コンテキストが初期化されていません、少し待機してから再試行..."),setTimeout((()=>{this.ensureAudioUnlocked()?(console.log("[AudioManager] 音声コンテキスト再初期化完了、BGM再生を再試行"),this.playBgm(e,t,a)):console.warn("[AudioManager] 音声コンテキスト再初期化失敗、BGM再生をスキップ")}),1e3),!1)}startNewBgm(e,t,a){if(console.log(`[AudioManager] startNewBgm開始: ${e}, 音量: ${t}, フェードイン: ${a}`),this.isBgmMuted)return console.log("[AudioManager] BGMがミュートされています"),!1;if(this.isSceneUsable())try{if(!this.scene||!this.scene.sound)return void console.warn("[AudioManager] Scene or sound system is not available for BGM:",e);console.log(`[AudioManager] 音声ファイル追加: ${e}`),this.bgm=this.scene.sound.add(e,{loop:!0,volume:a?0:t}),this.bgm.key=e,console.log(`[AudioManager] BGM再生開始: ${e}`);try{const e=this.bgm.play();if(console.log("[AudioManager] BGM再生結果:",e),this.bgm&&this.bgm.isPlaying)console.log("[AudioManager] BGM再生状態確認: isPlaying = true");else if(console.warn("[AudioManager] BGM再生状態確認: isPlaying = false"),this.bgm&&!this.bgm.isPlaying){console.warn("[AudioManager] BGM再生失敗、オブジェクトをリセット");try{this.bgm.destroy()}catch(e){console.warn("[AudioManager] BGMオブジェクト破棄エラー:",e)}return this.bgm=null,this._bgmPlayFailed=!0,!1}}catch(t){if(console.error(`[AudioManager] BGM再生エラー: ${e}`,t),this.bgm){try{this.bgm.destroy()}catch(e){console.warn("[AudioManager] BGMオブジェクト破棄エラー:",e)}this.bgm=null}throw this._bgmPlayFailed=!0,t}return a?(console.log("[AudioManager] フェードイン開始"),this.scene.tweens.add({targets:this.bgm,volume:t,duration:500})):(console.log(`[AudioManager] 音量設定: ${t}`),this.bgm.setVolume(t)),console.log(`[AudioManager] BGM再生完了: ${e}`),this.scene&&this.scene.time?this.scene.time.delayedCall(1e3,(()=>{this.bgm&&this.bgm.isPlaying?console.log(`[AudioManager] BGM再生状態確認（1秒後）: ${e} は再生中`):this.bgm?console.warn(`[AudioManager] BGM再生状態確認（1秒後）: ${e} は停止中`):console.warn("[AudioManager] BGM再生状態確認（1秒後）: BGMオブジェクトが存在しません")})):console.warn("[AudioManager] シーンのタイムマネージャーが利用できません、状態監視をスキップ"),!0}catch(t){return console.error(`[AudioManager] BGM ${e} の再生に失敗しました:`,t),!1}else console.warn("[AudioManager] シーンが使用できません")}stopBgm(e=!0,t){if(this.bgm)try{if(!this.isSceneUsable())return this.bgm=null,void(t&&t());if(!this.scene||!this.scene.sound)return console.warn("[AudioManager] Scene or sound system is not available for stopping BGM"),this.bgm=null,void(t&&t());if(!this.bgm||!(this.bgm.isPlaying||this.bgm.isPaused||this.bgm.key||this.bgm.context))return console.debug("[AudioManager] BGM object may not be in expected state, proceeding with cleanup"),this.bgm=null,void(t&&t());if(e)this.scene.tweens.add({targets:this.bgm,volume:0,duration:500,onComplete:()=>{try{this.bgm&&this.bgm.isPlaying&&(this.bgm.pause(),this.bgm.stop()),this.bgm=null}catch(e){console.warn("[AudioManager] Error during BGM stop:",e),this.bgm=null}t&&t()}});else{try{this.bgm&&this.bgm.isPlaying&&(this.bgm.pause(),this.bgm.stop()),this.bgm=null}catch(e){console.warn("[AudioManager] Error during BGM stop:",e),this.bgm=null}t&&t()}}catch(e){console.warn("[AudioManager] Error in stopBgm:",e),this.bgm=null,t&&t()}else t&&t()}async playSe(e,t=this.seVolume){if(this.isSceneUsable()&&!this.isSeMuted)try{let s;const{SE_MAPPING:r}=await a.e(557).then(a.bind(a,557));if(r[e])s=`assets/audio/se/${r[e]}`;else{const{AreaConfig:t}=await Promise.resolve().then(a.bind(a,364));let r="miemachistage";if(this.scene&&this.scene.scene&&this.scene.scene.key){const e=this.scene.scene.key;e.includes("Miemachi")||e.includes("miemachi")?r="miemachistage":e.includes("Taketa")||e.includes("taketa")?r="taketastage":(e.includes("Japan")||e.includes("japan"))&&(r="japanstage")}const n=t[r];s=n&&n.se&&n.se[e]?n.se[e]:`assets/audio/se/${e}.mp3`}const n=new Audio(s);n.volume=t;const o=n.play();void 0!==o&&o.catch((t=>{console.error(`SE ${e} の再生に失敗しました:`,t)})),n.addEventListener("ended",(()=>{n.remove()}))}catch(t){console.error(`SE ${e} の再生に失敗しました:`,t)}}playVoice(e,t=this.voiceVolume){if(this.isSceneUsable()&&(this.ensureAudioUnlocked(),!this.isVoiceMuted))if(this.scene&&this.scene.sound)try{const a=this.scene.sound.add(e,{volume:t});a.play(),a.once("complete",(()=>{a.destroy()}))}catch(t){console.error(`Voice ${e} の再生に失敗しました:`,t)}else console.warn("[AudioManager] Scene or sound system is not available for Voice:",e)}setBgmVolume(e){this.bgmVolume=e,this.bgm&&this.bgm.setVolume(e)}setSeVolume(e){this.seVolume=e}setVoiceVolume(e){this.voiceVolume=e}muteBgm(e){this.isBgmMuted=e,this.bgm&&this.bgm.setMute(e)}muteSe(e){this.isSeMuted=e}muteVoice(e){this.isVoiceMuted=e}muteAll(e){this.muteBgm(e),this.muteSe(e),this.muteVoice(e)}stopAll(){try{this.stopBgm(!1)}catch(e){}try{if(this.scene&&this.scene.sound){try{this.scene.sound.stopAll()}catch(e){}try{((this.scene.sound.getAllPlaying?this.scene.sound.getAllPlaying():[])||[]).forEach((e=>{try{e&&e.stop&&e.stop()}catch(e){}try{e&&e.destroy&&e.destroy()}catch(e){}}))}catch(e){}}}catch(e){}}destroy(){try{this.stopAll()}catch(e){}try{if(this.bgm){try{this.bgm.stop&&this.bgm.stop()}catch(e){}try{this.bgm.destroy&&this.bgm.destroy()}catch(e){}}}finally{this.bgm=null}try{const e=this.scene&&this.scene.cache&&this.scene.cache.audio?this.scene.cache.audio:null;e&&this.loadedSounds.forEach((t=>{try{e.exists(t)&&e.remove(t)}catch(e){}}))}catch(e){}this.loadedSounds.clear(),this.scene=null}async getDefaultBgmKey(){try{if(this.bgm&&this.bgm.key)return this.bgm.key;if(this.scene&&this.scene.scene&&this.scene.scene.key){const e=this.scene.scene.key;try{const{AreaConfig:t}=await Promise.resolve().then(a.bind(a,364));if(e.includes("Stage")&&"MapSelectionStage"!==e){const a=`stage${e.replace("Stage","").replace("Scene","")}`;if(t.stages&&t.stages[a]&&t.stages[a].bgm){const e=t.stages[a].bgm.map;if(e){const t=this.pathToBgmKey(e);if(t)return t}}}if("MapSelectionStage"===e&&this.scene.mapConfig){const e=this.scene.mapConfig.bgm;if(e){if(Object.prototype.hasOwnProperty.call(e,"map"))return"bgm_map";{const t=Object.keys(e)[0];if(t)return`bgm_${t}`}}}}catch(e){console.warn("[AudioManager] AreaConfig import error:",e)}}if(this.scene&&this.scene.mapConfig&&"object"==typeof this.scene.mapConfig.bgm){const e=this.scene.mapConfig.bgm;if(Object.prototype.hasOwnProperty.call(e,"map"))return"bgm_map";{const t=Object.keys(e)[0];if(t)return`bgm_${t}`}}return"bgm_default"}catch(e){return console.warn("[AudioManager] getDefaultBgmKey エラー:",e),"bgm_default"}}pathToBgmKey(e){try{if(!e)return null;const t=e.split("/").pop();return t?`bgm_${t.replace(/\.[^/.]+$/,"")}`:null}catch(e){return console.warn("[AudioManager] pathToBgmKey エラー:",e),null}}async loadConversationAudio(e){try{console.log(`[AudioManager] loadConversationAudio開始: ${e}`),console.log("[AudioManager] 現在のloadedSounds:",Array.from(this.loadedSounds));const{getEventConfig:t}=await a.e(557).then(a.bind(a,557)),s=t(e);if(!s||!s.required)return console.warn(`[AudioManager] Event config not found for: ${e}`),!1;const{bgm:r,se:n}=s.required;if(console.log(`[AudioManager] 必要なリソース: BGM=${r}, SE=${n}`),r&&r.length>0)for(const e of r){const t=`bgm_${e}`;if(this.loadedSounds.has(t))console.log(`[AudioManager] BGM既に読み込み済み: ${t}`);else{const a=this.getBgmPathFromAreaConfig(e);if(a)this.scene.load.audio(t,a),console.log(`[AudioManager] BGM読み込みキュー追加: ${t} -> ${a}`);else{const a=`assets/audio/bgm/${e}.mp3`;this.scene.load.audio(t,a),console.log(`[AudioManager] BGM読み込みキュー追加（フォールバック）: ${t} -> ${a}`)}}}if(n&&n.length>0)for(const e of n){const t=`se_${e}`;if(this.loadedSounds.has(t))console.log(`[AudioManager] SE既に読み込み済み: ${t}`);else{const a=`assets/audio/se/${e}.mp3`;this.scene.load.audio(t,a),console.log(`[AudioManager] SE読み込みキュー追加: ${t} -> ${a}`)}}return console.log(`[AudioManager] loadConversationAudio完了: ${e}`),!0}catch(e){return console.error("[AudioManager] loadConversationAudio error:",e),!1}}getBgmPathFromAreaConfig(e){const t=`assets/audio/bgm/${e}.mp3`;return console.log(`[AudioManager] 標準パス使用: ${e} -> ${t}`),t}async playConversationBgm(e,t=this.bgmVolume,a=!0){try{this.stopBgm(!1);const s=`bgm_${e}`;if(console.log(`[AudioManager] BGM再生試行: ${s}, loadedSounds確認:`,this.loadedSounds.has(s)),console.log("[AudioManager] loadedSoundsの内容:",Array.from(this.loadedSounds)),!this.loadedSounds.has(s))return console.warn(`[AudioManager] BGMファイルが読み込まれていません: ${s}`),!1;try{const r=`assets/audio/bgm/${e}.mp3`,n=encodeURI(r);console.log(`[AudioManager] BGM再生パス: ${e} -> ${n}`),this.bgm=new Audio(n),this.bgm.loop=!0,this.bgm.volume=a?0:t;const o=this.bgm.play();return void 0!==o&&o.then((()=>{if(a){let e=0;const a=t,s=setInterval((()=>{e+=.02,e>=a&&(e=a,clearInterval(s)),this.bgm.volume=e}),25)}})).catch((e=>{console.error(`[AudioManager] HTMLAudio BGM再生エラー: ${s}`,e)})),this.bgm.key=s,!0}catch(e){return console.error(`[AudioManager] HTMLAudio BGM再生エラー: ${s}`,e),!1}}catch(t){return console.error(`[AudioManager] playConversationBgm error: ${e}`,t),!1}}}},327:(e,t,a)=>{a.r(t),a.d(t,{TaketaConversationManager:()=>r,taketaConversationData:()=>s});const s={lunch_tag:{background:"nichijyou_d",bgm:"professor_laytons",conversations:[{speaker:"ひろかず",character:"hirokazu",text:"なんか、今鬼ごっこしたくね？",expression:"a"},{speaker:"だいち",character:"daichi",text:"いやっ、うーん、、、したいなぁ、、",expression:"a"},{speaker:"ひろかず",character:"hirokazu",text:"たっち、、、、",expression:"a"},{speaker:"なおき",character:"naoki",text:"えっ？？？？いきなり？",expression:"a"},{speaker:"なおき",character:"naoki",text:"なら、あ、、、、はい",expression:"a"},{speaker:"かなと",character:"kanato",text:"順応はえーんだよ",expression:"a"},{speaker:"ひろかず、なおき、こうたろう、だいち、あきざわ、しゅうへい",character:"hirokazu",text:"にげろぉぉぉ！！！！！",expression:"a"},{speaker:"かなと",character:"kanato",text:"ちょ、、、まてよ！！！！！",expression:"a"},{speaker:"かなと",character:"kanato",text:"おらぁぁぁぁｌ",expression:"c"},{speaker:"ひろかず",character:"hirokazu",text:"ばりあーーーーーーーーー！！！！",expression:"a"},{speaker:"かなと",character:"kanato",text:"それだけは、しちゃだめだろぉぉぉ！！",expression:"a"},{speaker:"かなと",character:"kanato",text:"なんで、高校生になって鬼ごっこしなきゃならんのだ",expression:"a"},{speaker:"こうたろう",character:"koutarou",text:"タンマーーーーーーーーー！！！！",expression:"b"},{speaker:"かなと",character:"kanato",text:"よくないよねぇ？！！！！",expression:"a"},{speaker:"かなと",character:"kanato",text:"、、、、、、、、",expression:"a"},{speaker:"かなと",character:"kanato",text:"ゲームバランス悪すぎるな",expression:"a"},{speaker:"だいち",character:"daichi",text:"中学の時、ひろすえ、「おにご」っていうのが流行っててな",expression:"a"},{speaker:"だいち",character:"daichi",text:"ずっと、ひろすえが鬼っていう",expression:"a"},{speaker:"こうたろう",character:"koutarou",text:"あったな、そんなの",expression:"b"},{speaker:"かなと",character:"kanato",text:"普通のおにごっこっやらせてやれよ",expression:"a"},{speaker:"だいち",character:"daichi",text:"動けるタイプのハムだったからいいんよ",expression:"a"},{speaker:"かなと",character:"kanato",text:"懐かしいな、そういやハムっていうのは",expression:"a"},{speaker:"かなと",character:"kanato",text:"一時期頭を何かにぶつけて",expression:"a"},{speaker:"かなと",character:"kanato",text:"何針か縫って",expression:"a"},{speaker:"かなと",character:"kanato",text:"頭のガーゼが落ちないようにするためか、頭守るためにネットみたいなのをかぶってたけど",expression:"a"},{speaker:"かなと",character:"kanato",text:"その時の見た目がハムみたいな見た目だったから",expression:"a"},{speaker:"かなと",character:"kanato",text:"一時期、あだなボンレスハムだったな",expression:"a"},{speaker:"かなと",character:"kanato",text:"すげーどうでもいいこと思い出してしまったわ",expression:"a"},{speaker:"ひろかず",character:"hirokazu",text:"おにさんこちら！！！！",expression:"a"},{speaker:"かなと",character:"kanato",text:"えっ、まだやるの？",expression:"a"}]},gospellers_song:{background:"nichijyou_b",bgm:"Fantasy",conversations:[{speaker:"ひろかず",character:"hirokazu",text:"ゴスペラーズの「ひとり」を歌うぞ、、、",expression:"a"},{speaker:"だいち",character:"daichi",text:"えっ、なんで？",expression:"a"},{speaker:"かなと",character:"kanato",text:"まぁ、やるか、、、",expression:"a"},{speaker:"ひろかず,だいち,こうたろう,かなと",character:"hirokazu,daichi,koutarou,kanato",text:"、、、",expression:"b"},{speaker:"ひろかず,だいち,こうたろう,かなと",character:"hirokazu,daichi,koutarou,kanato",text:"、、、、、",expression:"b"},{speaker:"ひろかず,だいち,こうたろう,かなと",character:"hirokazu,daichi,koutarou,kanato",text:"、、、、、、、、、",expression:"b"},{speaker:"ひろかず",character:"hirokazu",text:"そんなに歌詞わからんかったわ",expression:"a"},{speaker:"こうたろう",character:"koutarou",text:"やめようか",expression:"b"}]},climbing_injury:{background:"craimming_a",bgm:"blinding_lights",conversations:[{speaker:"かなと",character:"kanato",text:"あれ、ひろかずどうした？その指？",expression:"a"},{speaker:"ひろかず",character:"hirokazu",text:"クライミングでケガした",expression:"j"}]},classroom_lock_incident:{background:"kyoushitu_b",bgm:"Jounetsu_Tairiku",conversations:[{character:"narrator",text:"`ある日の自習中、先生が教室の後方ドアに鍵がかかっていることに気づく",expression:"a"},{speaker:"安藤先生",character:"anndou",text:"なんか鍵しまってるな、開けとくか。",expression:"a"},{speaker:"ひろかず",character:"hirokazu",text:"おい工藤、もう一回鍵閉めようや",expression:"a"},{speaker:"工藤",character:"kudou",text:"ヴぉ。（了解）",expression:"b"},{speaker:"安藤先生",character:"anndou",text:"、、、、、んん？",expression:"a"},{speaker:"安藤先生",character:"anndou",text:"おい〜、鍵を閉めるな〜",expression:"a"},{character:"narrator",text:"再度鍵を開ける先生、〜数分後〜",expression:"a"},{speaker:"ひろかず",character:"hirokazu",text:"おい工藤、また鍵閉めようや",expression:"a"},{speaker:"工藤",character:"kudou",text:"ヴぉ。（了解）",expression:"b"},{character:"narrator",text:"ガチャ！",expression:"a"},{speaker:"安藤先生",character:"anndou",text:"こら〜、鍵を閉めるな〜",expression:"a"},{speaker:"ひろかず",character:"hirokazu",text:"ういっす、工藤、鍵開けて、、、、",expression:"a"},{speaker:"工藤",character:"kudou",text:"ヴぉ。（了解）",expression:"b"},{speaker:"安藤先生",character:"anndou",text:"うむ、、、、",expression:"a"},{speaker:"ひろかず",character:"hirokazu",text:"（ひそひそ声で）工藤、静かに鍵閉めなおして",expression:"a"},{speaker:"工藤",character:"kudou",text:"（ひそひそ声で）ヴぉ。（了解）",expression:"b"},{character:"narrator",text:"〜数分後〜",expression:"a"},{speaker:"安藤先生",character:"anndou",text:"おい、また鍵かかってるじゃないか",expression:"a"},{speaker:"ひろかず",character:"hirokazu",text:"えっ、ほんとですか？",expression:"a"},{speaker:"工藤",character:"kudou",text:"ヴぉ。（ほんとですか！？）",expression:"b"},{speaker:"安藤先生",character:"anndou",text:"、、、、、、",expression:"a"},{speaker:"安藤先生",character:"anndou",text:"いいか、、、",expression:"a"},{speaker:"安藤先生",character:"anndou",text:"鍵は、、、",expression:"a"},{speaker:"安藤先生",character:"anndou",text:"閉めるな！！！！！",expression:"a"},{speaker:"ひろかず",character:"hirokazu",text:"ヴぉ。（了解）",expression:"a"},{speaker:"工藤",character:"kudou",text:"ヴぉ。（了解）",expression:"b"},{character:"narrator",text:"〜放課後〜",expression:"a"},{character:"narrator",text:"キーンコーンカーンコーン",expression:"a"},{speaker:"工藤",character:"kudo",text:"なぜか俺だけおこられた、、、",expression:"b"},{speaker:"ひろかず",character:"hirokazu",text:"、、、、、なんかごめん、、、",expression:"a"},{character:"narrator",text:"数日後の昼休み",expression:"a"},{speaker:"ひろかず",character:"hirokazu",text:"ということが、あってな",expression:"a"},{speaker:"だいち、こうたろう、かなと",character:"daichi,koutarou,kanato",text:"ひでぇな、、、、",expression:"b"}]},koutarou_toilet:{background:"kyoushitu_b",bgm:"metoroido",conversations:[{speaker:"ひろかず",character:"hirokazu",text:"俺、こう見えて、おしっこ近いんよね、",expression:"a"},{speaker:"ひろかず",character:"hirokazu",text:"だから、おしっこ行ってくるわ",expression:"a"},{speaker:"こうたろう",character:"koutarou",text:"いや、勝手に行けよ",expression:"b"},{character:"narrator",text:"１限目休憩",expression:"a"},{speaker:"ひろかず",character:"hirokazu",text:"おしっこ行ってくるわ",expression:"a"},{speaker:"こうたろう",character:"koutarou",text:"いや、勝手に行っていいよ",expression:"b"},{character:"narrator",text:"2限目休憩",expression:"a"},{speaker:"ひろかず",character:"hirokazu",text:"おしっこ行ってくるわ",expression:"a"},{speaker:"こうたろう",character:"koutarou",text:"いらんよ、報告は、、",expression:"b"},{character:"narrator",text:"3限目休憩",expression:"a"},{speaker:"ひろかず",character:"hirokazu",text:"ちょっと行ってくるわ",expression:"a"},{speaker:"こうたろう",character:"koutarou",text:"膀胱小さいんか？",expression:"b"},{speaker:"ひろかず",character:"hirokazu",text:"水飲んだからかな",expression:"a"},{speaker:"ひろかず",character:"hirokazu",text:"ついでに、うんこも行ってくるわ",expression:"a"},{speaker:"こうたろう",character:"koutarou",text:"、、、まぁ、おれもおしっこ行くわ",expression:"b"},{speaker:"ひろかず",character:"hirokazu",text:"いや、お前は膀胱でかいからダメ",expression:"a"},{speaker:"だいち",character:"daichi",text:"そうだぞ！",expression:"a"},{speaker:"こうたろう",character:"koutarou",text:"なんで？！？",expression:"b"},{speaker:"こうたろう",character:"koutarou",text:"いつの間に、俺膀胱でかいキャラになった？",expression:"b"},{character:"narrator",text:"３分後",expression:"a"},{speaker:"ひろかず",character:"hirokazu",text:"行ってきたわ",expression:"a"},{speaker:"こうたろう",character:"koutarou",text:"。。。。はやくね？",expression:"b"},{speaker:"だいち",character:"daichi",text:"ひろかずは、うんこは早いんだぞ",expression:"a"},{speaker:"こうたろう",character:"koutarou",text:"その情報いらんかったわ",expression:"b"},{speaker:"ひろかず",character:"hirokazu",text:"こうたろう、たまったか？",expression:"a"},{speaker:"こうたろう",character:"koutarou",text:"なにが？",expression:"b"},{speaker:"ひろかず",character:"hirokazu",text:"膀胱にパワーが",expression:"a"},{speaker:"こうたろう",character:"koutarou",text:"いや、まぁ、、普通くらい",expression:"b"},{speaker:"ひろかず",character:"hirokazu",text:"さすが！、膀胱はでかいわ",expression:"a"},{speaker:"こうたろう",character:"koutarou",text:"まぁ、膨張率もな",expression:"b"},{speaker:"ひろかず",character:"hirokazu",text:"何が？",expression:"a"},{character:"narrator",text:"昼休み",expression:"a"},{speaker:"ひろかず",character:"hirokazu",text:"よし！いいぞ！",expression:"a"},{speaker:"こうたろう",character:"koutarou",text:"いくわ",expression:"b"},{speaker:"ひろかず",character:"hirokazu",text:"狂いはなかったな、、１Ｌぐらいは行けんじゃないの？",expression:"a"},{speaker:"こうたろう",character:"koutarou",text:"いや、、まぁな",expression:"b"},{speaker:"ナレーション",character:"narrator",text:"、、、、、、、、、、、、",expression:"a"},{speaker:"ナレーション",character:"narrator",text:"この時から、ひろかずのせいで、",expression:"a"},{speaker:"ナレーション",character:"narrator",text:"こうたろうは昼休みまでトイレにいけない縛りができた",expression:"a"}]},culture_festival_apology:{background:"kyoushitu_a",bgm:"Spain",conversations:[{character:"narrator",text:"文化祭終了後、、、、",expression:"a"},{speaker:"まみっち",character:"mamicchi",text:"とりあえず、教職員の会議があるから、一旦、ちょっとだけ、教室で待機しといてね",expression:"a"},{character:"narrator",text:"〜数十分後〜",expression:"a"},{speaker:"だいち",character:"daichi",text:"長えな、職員会議、、、",expression:"a"},{speaker:"ひろかず",character:"hirokazu",text:"、、、、、、、、、、、",expression:"a"},{speaker:"ひろかず",character:"hirokazu",text:"今帰ったら、16:30の電車に間にあうぞ！",expression:"a"},{speaker:"なおき",character:"naoki",text:"あ、、ここを逃すと一時間先だな、",expression:"a"},{speaker:"だいち",character:"daichi",text:"竹田は一時間に１本しか電車がないからな〜",expression:"a"},{speaker:"こうたろう",character:"koutarou",text:"それは、、、いかんぞ！！！",expression:"b"},{speaker:"ひろかず",character:"hirokazu",text:"かえるぞ！！！！！！！！！！",expression:"a"},{speaker:"reset",character:"narrator",text:"しばらくして、、",expression:"a"},{speaker:"まみっち",character:"mamicchi",text:"おまたせーーー",expression:"a"},{speaker:"まみっち",character:"mamicchi",text:"、、、、、",expression:"a"},{speaker:"まみっち",character:"mamicchi",text:"あれ、三重組は？",expression:"a"},{character:"クラスメイト",text:"帰りましたーーーーーー！！！！！！！！！！",expression:"a"},{speaker:"まみっち",character:"mamicchi",text:"はぁぁぁ！！！？？？",expression:"a"},{speaker:"かなと",character:"kanato",text:"おれをおいて、みんな帰りやがった、、、",expression:"a"},{speaker:"まみっち",character:"mamicchi",text:"みんな待ってたのに？",expression:"a"},{speaker:"まみっち",character:"mamicchi",text:"それは、無責任すぎないか？？",expression:"a"},{speaker:"かなと",character:"kanato",text:"、、、、、、、、",expression:"a"},{speaker:"かなと",character:"kanato",text:"責任って、いったい何の責任のことだ？？？",expression:"a"},{speaker:"かなと",character:"kanato",text:"なにもわからんぞ",expression:"a"},{character:"narrator",text:"週明け",expression:"a"},{speaker:"まみっち",character:"mamicchi",text:"今から席替えをします",expression:"a"},{character:"narrator",text:"いぇーーーーい",expression:"a"},{speaker:"まみっち",character:"mamicchi",text:"しかし、この前勝手に帰った人がいます",expression:"a"},{speaker:"まみっち",character:"mamicchi",text:"なので、その人たちはもう、一番前の席になります",expression:"a"},{speaker:"かなと",character:"kanato",text:"ざまぁ、、、、www",expression:"a"},{speaker:"まみっち",character:"mamicchi",text:"そして、その人たちは前にでて、一言皆に謝ってもらいます",expression:"a"},{character:"クラスメイト",text:"ｗｗｗｗｗｗｗｗｗｗ",expression:"a"},{speaker:"ひろかず",character:"hirokazu",text:"ええーーーと、この前は勝手に帰って申し訳ありませんでした",expression:"a"},{speaker:"だいち",character:"daichi",text:"ええーーー、ごめんなさい",expression:"a"},{speaker:"なおき",character:"naoki",text:"申し訳〜ありませんでした〜",expression:"a"},{speaker:"こうたろう",character:"koutarou",text:"wwwwwww、、、、、すみませんでした",expression:"b"},{speaker:"かなと",character:"kanato",text:"あいつら、反省する気ないな、、、、",expression:"a"},{speaker:"まみっち",character:"mamicchi",text:"はい、二度とないように",expression:"a"},{character:"narrator",text:"それから、しばらくして",expression:"a"},{character:"narrator",text:"冬になり、雪の日に同じことを繰り返すことを、この時はまだしらない",expression:"a"}]},train_no_poop_man:{background:"taketaeki",bgm:"Fantasy",conversations:[{character:"narrator",text:"ある日の放課後、竹田駅から電車で帰宅していた時のこと、、、、",expression:"a"},{speaker:"ひろかず",character:"hirokazu",text:"なんかあれだな、、、",expression:"a"},{speaker:"だいち",character:"daichi",text:"ん〜、これは、、、あれだな、、、",expression:"a"},{speaker:"こうたろう",character:"koutarou",text:"これは、、、間違いなく、、、あれしかないな、、、",expression:"b"},{speaker:"ひろかず",character:"hirokazu",text:"この臭いは間違いないな、、、",expression:"a"},{speaker:"ひろかず、だいち、こうたろう",character:"hirokazu,daichi,koutarou",text:"う⚪︎こ！！！",expression:"a"},{character:"narrator",text:"その日、とある異臭を放つ謎のおじさんが電車に乗っていた",expression:"a"},{character:"narrator",text:"おじさんはその日、電車に乗る人々を恐怖のどん底に陥れた。。。",expression:"a"},{character:"narrator",text:"そのおじさんの話は当時の電車で通う生徒の間で恐れられ密かに囁かれていた。。。かもしれない",expression:"a"}]},galaxy_water:{background:"galaxywater",bgm:"vitality",conversations:[{character:"narrator",text:"ある日の帰り道、銀河水という水が1500円で売られていた",expression:"a"},{speaker:"だいち",character:"daichi",text:"ぼったくりやーーーーー！！！！！！！！",expression:"a"},{character:"narrator",text:"、、、、、、、、、、",expression:"a"},{speaker:"かなと",character:"kanato",text:"、、、、、、",expression:"a"},{speaker:"かなと",character:"kanato",text:"なんか、店員でてきてなかった？？？",expression:"a"}]},videocamera_broken:{background:"nichijyou_d",bgm:"ON_THE_BEACH",conversations:[{speaker:"ひろかず",character:"hirokazu",text:"ちょっと、みしろー",expression:"a"},{speaker:"かなと",character:"kanato",text:"なにー？",expression:"a"},{speaker:"ひろかず",character:"hirokazu",text:"ごめん、撮影中にビデオカメラ落として、割れた、、、",expression:"a"},{speaker:"ひろかず",character:"hirokazu",text:"今度、修理代払うわ、、、",expression:"a"},{speaker:"かなと",character:"kanato",text:"まじかーー、しゃーないなぁ、、、",expression:"c"},{speaker:"ナレーション",character:"narrator",text:"12年後、ビデオカメラを修理されることはなかった、、、",expression:"a"}]},drama_filming:{background:"nichijyou_b",bgm:"nightbarth",conversations:[{speaker:"ひろかず",character:"hirokazu",text:"せっかくビデオカメラあるし、なんか、ドラマを撮ろう",expression:"a"},{speaker:"かなと",character:"kanato",text:"まぁ、ええけど何をとる？",expression:"a"},{speaker:"ひろかず",character:"hirokazu",text:"じゃあ、各々座ってくれ、ほら",expression:"a"},{speaker:"だいち、こうたろう、しゅうへい、まさと、かなと",character:"daichi,koutarou,adachi,masato,kanato",text:"まぁ、了解",expression:"a"},{speaker:"ひろかず",character:"hirokazu",text:"おれには自信のある、アイデアがあるんだ",expression:"a"},{speaker:"かなと",character:"kanato",text:"どんな？",expression:"a"},{speaker:"ひろかず",character:"hirokazu",text:"まさとが教師役で、順番に当てていくから最後にみしろは立ってます！！って言って立つな",expression:"a"},{speaker:"かなと",character:"kanato",text:"どういうこと？",expression:"a"},{speaker:"だいち、こうたろう、しゅうへい、まさと",character:"daichi,koutarou,adachi,masato",text:"了解！",expression:"a"},{speaker:"かなと",character:"kanato",text:"えっ、なんも、理解できなかったんだけど？",expression:"a"},{speaker:"ひろかず",character:"hirokazu",text:"はい、位置についてー",expression:"a"},{speaker:"まさと",character:"masato",text:"きりーつ、礼！",expression:"a"},{speaker:"だいち、しゅうへい、こうたろう",character:"daichi,adachi,koutarou",text:"おねがいしまーす！",expression:"a"},{speaker:"かなと",character:"kanato",text:"わからないんだけど？",expression:"a"},{speaker:"まさと",character:"masato",text:"きょうはキノコについて、授業をする",expression:"a"},{speaker:"まさと",character:"masato",text:"キノコとはなんだ？だいち。席を立って答えてみろ",expression:"a"},{speaker:"だいち",character:"daichi",text:"菌です。",expression:"a"},{speaker:"かなと",character:"kanato",text:"やらせたいだけですよね？",expression:"a"},{speaker:"まさと",character:"masato",text:"そうだ、ではキノコはどこにはえる？こうたろう答えてみろ",expression:"a"},{speaker:"こうたろう",character:"koutarou",text:"森などじめじめしたところに生えることが多いです",expression:"b"},{speaker:"かなと",character:"kanato",text:"拒否権は？？？？？？",expression:"a"},{speaker:"まさと",character:"masato",text:"正解だ、じゃ、このキノコはなんていうんだ？しゅうへい",expression:"a"},{speaker:"しゅうへい",character:"adachi",text:"しいたけです",expression:"a"},{speaker:"かなと",character:"kanato",text:"ないんですね！くそがっ！！",expression:"a"},{speaker:"まさと",character:"masato",text:"そうだな、これはよく食卓などで食べられるキノコだ",expression:"a"},{speaker:"まさと",character:"masato",text:"じゃあ、次は、これは何ていうんだ？みしろー",expression:"a"},{speaker:"かなと",character:"kanato",text:"、、、、、",expression:"a"},{speaker:"かなと",character:"kanato",text:"、、、、、、、、、、すみません、立ってます。",expression:"a"},{speaker:"まさと",character:"masato",text:"どうしたー？みしろー",expression:"a"},{speaker:"かなと",character:"kanato",text:"あっ、いや、立ってます。",expression:"a"},{speaker:"ひろかず",character:"hirokazu",text:"みしろ〜どうした〜？ちゃんと立てよ〜",expression:"a"},{speaker:"だいち",character:"daichi",text:"かなとどうした？ほら立てよ",expression:"a"},{speaker:"こうたろう",character:"koutarou",text:"ほらぁ",expression:"b"},{speaker:"しゅうへい",character:"adachi",text:"みしろどうした？",expression:"a"},{speaker:"かなと",character:"kanato",text:"だから、立ってます。もうすでに立ってます。",expression:"c"},{speaker:"ひろかず、だいち、こうたろう、しゅうへい、まさと",character:"hirokazu,daichi,koutarou,adachi,masato",text:"・・・・・",expression:"a"},{speaker:"しゅうへい",character:"adachi",text:"なにが？？？",expression:"a"},{speaker:"だいち",character:"daichi",text:"ほら、立てよ",expression:"a"},{speaker:"こうたろう",character:"koutarou",text:"、、、、、",expression:"b"},{speaker:"ひろかず",character:"hirokazu",text:"あっ、、、ちんち、、、、",expression:"a"},{speaker:"かなと",character:"kanato",text:"ちょっ、、、ひろかずさん、オブラートって知ってます？",expression:"a"},{speaker:"ひろかず",character:"hirokazu",text:"当たり前だろ。薬も言葉も包める便利なものや～",expression:"a"},{speaker:"かなと",character:"kanato",text:"じゃあ、包めよ！！！下品な言葉をさぁ！！！、やらせたの、お前じゃねーか！",expression:"a"},{speaker:"ひろかず",character:"hirokazu",text:"・・・",expression:"a"},{speaker:"かなと",character:"kanato",text:"やらせといて、引くのやめてもらえます？",expression:"a"},{speaker:"まさと",character:"masato",text:"みしろ、不正解ですよ",expression:"a"},{speaker:"かなと",character:"kanato",text:"うるせーよ！",expression:"a"},{speaker:"かなと",character:"kanato",text:"ってか、これ、俺だけ恥ずかしいやつじゃんか",expression:"a"},{speaker:"だいち",character:"daichi",text:"そうだよ",expression:"a"},{speaker:"ひろかず",character:"hirokazu",text:"まぁ、座れよ",expression:"a"},{speaker:"かなと",character:"kanato",text:"最初から、立ってねーよ！？",expression:"a"}]},kannnamu_kudou:{background:"kannnamu",bgm:"Fantasy",conversations:[{speaker:"ひろかず",character:"hirokazu",text:"このカンナムスタイルとかいうの、いいな",expression:"a"},{speaker:"ひろかず",character:"hirokazu",text:"（工藤にやらせよう）",expression:"a"},{speaker:"ひろかず",character:"hirokazu",text:"工藤電車で誰もいないときにこれやりながら、前に来て",expression:"a"},{speaker:"くどう",character:"kudou",text:"いいよ",expression:"a"},{speaker:"くどう",character:"kudou",text:"ふんっふんっふんっ",expression:"a"},{speaker:"なおき",character:"naoki",text:"何してんの？",expression:"a"},{speaker:"ひろかず",character:"hirokazu",text:"くどうにカンナムスタイルをやらせている",expression:"a"},{speaker:"かなと",character:"kanato",text:"なんでだよ",expression:"b"},{speaker:"ひろかず",character:"hirokazu",text:"おもしろいから",expression:"a"},{speaker:"なおき、かなと、だいち",character:"naoki,kanato,daichi",text:"・・・",expression:"c"}]},udefuriojisann:{background:"taketamachi",bgm:"主題_opening_theme",conversations:[{speaker:"ひろかず",character:"hirokazu",text:"なんか竹田の街中歩いてる時さ、大げさに腕振り上げて、歩いてる人いるよな",expression:"a"},{speaker:"だいち",character:"daichi",text:"なんか見たことあるな、、",expression:"a"},{speaker:"かなと",character:"kanato",text:"その人、めっちゃ歩くのはえーんだよな、どっかの塾の先生らしいけど",expression:"a"},{speaker:"ひろかず",character:"hirokazu",text:"ちゃんとした、歩き方おしえてもらってないんかな",expression:"a"},{speaker:"だいち",character:"daichi",text:"ちゃんとした歩き方ってなんだよ",expression:"a"},{speaker:"かなと",character:"kanato",text:"、、、まぁ、足は、正しい型だよ",expression:"a"}]},working_go_to_home_miemachi:{background:"nomiaruki_1",bgm:"dragostea_din_tei",conversations:[{speaker:"かなと",character:"kanato",text:"はじめてだな、高校のメンバーで飲み会するのは",expression:"b"},{speaker:"ひろかず",character:"hirokazu",text:"三重の人間は三重町で飲むからな",expression:"i"},{speaker:"だいち",character:"daichi",text:"そういえば、、、、、竹田の終電ってどうなっている、、、",expression:"b"},{speaker:"かなと",character:"kanato",text:"今何時だ？？？",expression:"b"},{speaker:"こうたろう",character:"koutarou",text:"もう、11時すぎたな、、、",expression:"a"},{speaker:"なおき",character:"naoki",text:"２２時にはもう終電なかったぞ",expression:"b"},{speaker:"かなと",character:"kanato",text:"なぜ言わない",expression:"c"},{speaker:"なおき",character:"naoki",text:"きかれなかったから",expression:"b"},{speaker:"だいち",character:"daichi",text:"馬鹿やろー",expression:"b"},{speaker:"ひろかず",character:"hirokazu",text:"どうするよ、竹田はどこにも泊まるあてもないぞ",expression:"d"},{speaker:"かなと",character:"kanato",text:"タクシーは？",expression:"b"},{speaker:"なおき",character:"naoki",text:"車で３０分以上かかるから、いくらかかるかわからないぞ",expression:"b"},{speaker:"かなと",character:"kanato",text:"そもそも、一台のタクシーに５人も乗れないから、2-3で別れるしかないしな",expression:"b"},{speaker:"だいち",character:"daichi",text:"２台いるということか、、、",expression:"b"},{speaker:"こうたろう",character:"koutarou",text:"どうするか、、、、、",expression:"a"},{speaker:"ひろかず",character:"hirokazu",text:"歩いて帰るぞ！！！",expression:"d",background:"taketamachi"},{speaker:"だいち",character:"daichi",text:"、、、歩くぞ！！！",expression:"b"},{speaker:"なおき",character:"naoki",text:"そうするしかないか！！！",expression:"b"},{speaker:"かなと",character:"kanato",text:"仕方ないな、やるしかねーな！！！",expression:"b"},{speaker:"こうたろう",character:"koutarou",text:"やるかっ！！",expression:"a"},{speaker:"竹田のメンバー",character:"others",text:"こいつらマジか、、、、、大丈夫か？",expression:"b"},{speaker:"ひろかず",character:"hirokazu",text:"おらぁ！！！！！",expression:"i"},{speaker:"竹田のメンバー",character:"others",text:"今、１２月だけど、大丈夫か？",expression:"b"},{speaker:"かなと",character:"kanato",text:"いけるいける",expression:"b"},{speaker:"だいち",character:"daichi",text:"大丈夫！！！！いける！！！！",expression:"d"},{speaker:"なおき",character:"naoki",text:"よゆーよゆー",expression:"b"},{speaker:"こうたろう",character:"koutarou",text:"マジ、よゆー",expression:"a"},{speaker:"ひろかず",character:"hirokazu",text:"おらぁ、いくぞ！！！！",expression:"i"},{speaker:"竹田のメンバー",character:"others",text:"おっ、、、おっ、、まぁ、頑張れ",expression:"b"},{speaker:"ナレーション",character:"narrator",text:"１時間後",expression:"a",background:"nomiaruki_4"},{speaker:"ひろかず",character:"hirokazu",text:"なんか寒くねーか？",expression:"k"},{speaker:"なおき",character:"naoki",text:"あれ、なんか寒いな",expression:"b"},{speaker:"かなと",character:"kanato",text:"寒い気がするな",expression:"b"},{speaker:"だいち",character:"daichi",text:"もしかして、アルコールのおかげだったか？",expression:"b"},{speaker:"こうたろう",character:"koutarou",text:"そうかも、しれない",expression:"a"},{speaker:"ひろかず",character:"hirokazu",text:"あっ、言ってなかったんだけど、",expression:"c"},{speaker:"ひろかず",character:"hirokazu",text:"おれ、足にひびが入っていてあんまり、うまく歩けないんだよね、今",expression:"c"},{speaker:"だいち",character:"daichi",text:"いまいう？",expression:"b"},{speaker:"ナレーション",character:"narrator",text:"２時間後",expression:"a"},{speaker:"ひろかず",character:"hirokazu",text:"あっ、これやべーさむいわ、足いてーわ",expression:"c"},{speaker:"だいち",character:"daichi",text:"これはいかんぞ",expression:"b"},{speaker:"なおき",character:"naoki",text:"なめてたかもしれん",expression:"b"},{speaker:"こうたろう",character:"koutarou",text:"それにしても、夜空はきれいだな",expression:"a"},{speaker:"かなと",character:"kanato",text:"こんなに夜空を眺めるのは久しぶりだな、きれいだ",expression:"c"},{speaker:"ナレーション",character:"narrator",text:"３時間後",expression:"a"},{speaker:"かなと",character:"kanato",text:"大丈夫か？なんか、足を引きずりながら、歩いているけど",expression:"b"},{speaker:"ひろかず",character:"hirokazu",text:"あんまり大丈夫じゃない",expression:"d"},{speaker:"なおき",character:"naoki",text:"さむい、、、、人が死ぬレベル、、、",expression:"b"},{speaker:"こうたろう",character:"koutarou",text:"夜空がきれいだな、、、ステキ、、、",expression:"a"},{speaker:"だいち",character:"daichi",text:"ちょっと、やばい、とっ、とりあえず、暖を取らねーと死ぬ",expression:"b"},{speaker:"かなと",character:"kanato",text:"もうちょっといったら、コンビニがあるはず、開いているとは思うけど、、、",expression:"b"},{speaker:"ナレーション",character:"narrator",text:"４時間後",expression:"a",background:"nomiaruki_3"},{speaker:"かなと",character:"kanato",text:"コンビニ開いていたな、、助かった、、マジで",expression:"b"},{speaker:"ひろかず",character:"hirokazu",text:"あ、、、アルコール買うぞ",expression:"d"},{speaker:"なおき",character:"naoki",text:"・・・",expression:"b"},{speaker:"だいち",character:"daichi",text:"なおきがしゃべらない、、、",expression:"b"},{speaker:"こうたろう",character:"koutarou",text:"酒、、、酒、、、、寒い、、空がきれい、、、きれい、、？",expression:"a"},{speaker:"ナレーション",character:"narrator",text:"５時間後",expression:"a"},{speaker:"かなと",character:"kanato",text:"なおきどうした？",expression:"b"},{speaker:"なおき",character:"naoki",text:"やばいかも、俺も足が痛いかも",expression:"b"},{speaker:"ひろかず",character:"hirokazu",text:"俺この前、医者にいったんだよな",expression:"c"},{speaker:"だいち",character:"daichi",text:"なんで、歩いて帰るとかいったんだよ",expression:"b"},{speaker:"こうたろう",character:"koutarou",text:"なんか、夜空がキレイなのがムカついてきた",expression:"a"},{speaker:"なおき",character:"naoki",text:"ひろかずくん、ちょっと肩を貸しあおう、、",expression:"b"},{speaker:"ひろかず",character:"hirokazu",text:"そうだな、、、",expression:"b"},{speaker:"なおき、ひろかず",character:"naoki,hirokazu",text:"いち、に、いち、に、いち、に、、、、、、",expression:"b"},{speaker:"こうたろう",character:"koutarou",text:"あーーーーーーーー、くそ！！！空がキレイだなぁーーーー、くそが",expression:"a"},{speaker:"ナレーション",character:"narrator",text:"６時間後",expression:"a"},{speaker:"かなと",character:"kanato",text:"あっ、みんなあきらめるな、、、歩きを止めたら、死ぬぞ",expression:"c"},{speaker:"こうたろう",character:"koutarou",text:"ちょっと、マジで死ぬぞ",expression:"a"},{speaker:"だいち",character:"daichi",text:"えぐい、えぐいえぐい、川沿いえぐいぞ、冗談抜きで凍え死ぬぞ",expression:"b"},{speaker:"ひろかず、なおき",character:"hirokazu,naoki",text:"・・・",expression:"b"},{speaker:"だいち",character:"daichi",text:"アルコールが、アルコールが、アルコールが、、、、、、、、",expression:"b"},{speaker:"こうたろう",character:"koutarou",text:"ここにきて、夜空が、めっちゃきれいに見えるのめっちゃむかついてきた",expression:"a"},{speaker:"かなと",character:"kanato",text:"さむいさむいさむい、ちょっと、冗談じゃないぞ",expression:"c"},{speaker:"かなと",character:"kanato",text:"ちょっと、皆みてみろ！！なにか、、、なにかの光が見えるぞ",expression:"b"},{speaker:"だいち、こうたろう、ひろかず、なおき",character:"daichi,koutarou,hirokazu,naoki",text:"？？？",expression:"b"},{speaker:"かなと",character:"kanato",text:"あれは、、、、、、、",expression:"b"},{speaker:"かなと",character:"kanato",text:"コインランドリーだ、、コインランドリーがあったぞ！！！！！",expression:"b"},{speaker:"だいち",character:"daichi",text:"暖がとれるかもしれない",expression:"b"},{speaker:"こうたろう",character:"koutarou",text:"とりあえず、あそこまでかんばるぞ",expression:"a"},{speaker:"ひろかず、なおき",character:"hirokazu,naoki",text:"はぁ、、、はぁ、、",expression:"c"},{speaker:"かなと",character:"kanato",text:"あと、ちょっとの辛抱だ、頑張れ！！！！",expression:"b"},{speaker:"ナレーション",character:"narrator",text:"・・・",expression:"a"},{speaker:"かなと",character:"kanato",text:"よかった、コインランドリーについた、開いているみたいだな",expression:"b"},{speaker:"だいち",character:"daichi",text:"これで、暖が取れる",expression:"b"},{speaker:"こうたろう",character:"koutarou",text:"とりあえず、少し休憩しよう",expression:"a"},{speaker:"ひろかず",character:"hirokazu",text:"もうだめかと思った",expression:"b"},{speaker:"なおき",character:"naoki",text:"飲み物を買おう",expression:"b"},{speaker:"かなと",character:"kanato",text:"落ち着いたら、いくか、、、",expression:"b"},{speaker:"ナレーション",character:"narrator",text:"７時間後",expression:"a"},{speaker:"かなと",character:"kanato",text:"み、、、見えたぞ、これは、、",expression:"b"},{speaker:"こうたろう",character:"koutarou",text:"三重町だ、、、、",expression:"a"},{speaker:"だいち",character:"daichi",text:"やったぞ、、、やったぞ、、、",expression:"b"},{speaker:"ひろかず",character:"hirokazu",text:"うおおおおおおお",expression:"i"},{speaker:"なおき",character:"naoki",text:"よかった、、、よかった、、、",expression:"b"},{speaker:"かなと",character:"kanato",text:"あと、もう一息だ",expression:"b"},{speaker:"ナレーション",character:"narrator",text:"８時間後",expression:"a"},{speaker:"かなと",character:"kanato",text:"なんか、、、日が昇ってきたな",expression:"b"},{speaker:"こうたろう",character:"koutarou",text:"きれいだった、星々もみえなくなった",expression:"a"},{speaker:"だいち",character:"daichi",text:"寒さも凍えるほどではなくなってきたな",expression:"b"},{speaker:"ひろかず",character:"hirokazu",text:"日の光をこれほど、ありがたいと思うとは、、、",expression:"b"},{speaker:"なおき",character:"naoki",text:"やりとげたんだな、、、おれたち、、、",expression:"b"},{speaker:"かなと",character:"kanato",text:"もしかして、もう少ししたら、ジョイフルが開いているんじゃないのか？",expression:"b"},{speaker:"だいち",character:"daichi",text:"朝ご飯食べるか、、",expression:"b"},{speaker:"こうたろう",character:"koutarou",text:"そうだな、、、",expression:"a"},{speaker:"ひろかず",character:"hirokazu",text:"せっかくだし行くか、、、、",expression:"b"},{speaker:"なおき",character:"naoki",text:"うん、、、、",expression:"b"},{character:"narrator",text:"ジョイフル到着",expression:"a",background:"nomiaruki_5"},{speaker:"かなと",character:"kanato",text:"なんか、涙出てきた",expression:"b"},{speaker:"ひろかず",character:"hirokazu",text:"こんなにうまい、ジョイフルは初めてだ、、",expression:"b"},{speaker:"こうたろう",character:"koutarou",text:"達成感がやばいな",expression:"a"},{speaker:"なおき",character:"naoki",text:"俺たち生きてたんだな、、、",expression:"b"},{speaker:"全員",character:"all",text:"・・・・・",expression:"c"},{speaker:"だいち",character:"daichi",text:"ところで、ここまで結構歩いて帰るのにお金使ってきたけど",expression:"b"},{speaker:"だいち",character:"daichi",text:"お酒とか、自動販売機で温かい飲み物とか、ジョイフルとかで、、、",expression:"b"},{speaker:"だいち",character:"daichi",text:"タクシー代を割り勘したときの金額と変わらないってことはないよな、、、",expression:"b"},{speaker:"全員",character:"all",text:"・・・・・",expression:"c"},{speaker:"かなと",character:"kanato",text:"野暮なことを考えるのはよそうぜ、、、",expression:"b"},{speaker:"なおき",character:"naoki",text:"無事帰れたんだからな、、、",expression:"b"},{speaker:"こうたろう",character:"koutarou",text:"そうだな",expression:"a"},{speaker:"ひろかず",character:"hirokazu",text:"う、、、む、、、",expression:"b"},{speaker:"だいち",character:"daichi",text:"わるい、忘れてくれ",expression:"b"},{character:"narrator",text:"やっぱり、歩いて帰ったほうが、高くついたのは知らないほうがよかった話",expression:"a"}]},black_clothes:{background:"kyoushitu_a",bgm:"Nagisa_Moderato",conversations:[{speaker:"まみっち",character:"mamicchi",text:"ホームルームはじめるよ",expression:"a"},{speaker:"クラスメイト",character:"classmate",text:"はーい",expression:"a"},{speaker:"ナレーション",character:"narrator",text:"ホームルーム終了後",expression:"a"},{speaker:"だいち",character:"daichi",text:"なんか、今日まみっちなんか、、、",expression:"a"},{speaker:"ひろかず",character:"hirokazu",text:"なんだろうな、、、、",expression:"a"},{speaker:"こうたろう",character:"koutarou",text:"そう、、、なんかな、、、、",expression:"b"},{speaker:"ひろかず",character:"hirokazu",text:"なんか、黒かったよな、、、",expression:"a"},{speaker:"だいち",character:"daichi",text:"カラスみたいやったよな、、、",expression:"a"},{speaker:"かなと",character:"kanato",text:"ｗｗｗｗｗｗ、、、やめたげてｗｗ、、、",expression:"a"},{speaker:"しゅうへい",character:"adachi",text:"カラスｗｗｗｗｗ",expression:"a"},{speaker:"まみっち",character:"mamicchi",text:"！！！！！！！",expression:"a"},{speaker:"ひろかず",character:"hirokazu",text:"おい、だいち声がでかいぞ",expression:"a"},{speaker:"だいち",character:"daichi",text:"なに？？？",expression:"a"},{speaker:"こうたろう",character:"koutarou",text:"ああ、だいちがでたな、、、",expression:"b"},{speaker:"ナレーション",character:"narrator",text:"、、、、、",expression:"a"},{speaker:"ナレーション",character:"narrator",text:"その日以降、先生が同じ黒い服を着てくることはなかった",expression:"a"}]},broadcast:{background:"kyoushitu_a",bgm:"unオーエン彼女なのか？",conversations:[{speaker:"ナレーション",character:"narrator",text:"ある日のお昼休み",expression:"a"},{speaker:"放送",character:"broadcast",text:"お昼の放送を始めます",expression:"a"},{speaker:"放送",character:"broadcast",text:"本日は、各クラスの人気先生ランキング１位２位を放送します",expression:"a"},{speaker:"ひろかず",character:"hirokazu",text:"なんとなく記憶あるな",expression:"a"},{speaker:"かなと",character:"kanato",text:"なんか、書いた記憶あるわ",expression:"a"},{speaker:"しゅうへい",character:"adachi",text:"おれらは一組だな",expression:"a"},{speaker:"放送",character:"broadcast",text:"えーー、では、まず５組から",expression:"a"},{speaker:"放送",character:"broadcast",text:"５組の人気の先生は？？？",expression:"a"},{speaker:"放送",character:"broadcast",text:"２位から行きます",expression:"a"},{speaker:"reset",character:"doragon",text:"２位、真柴先生",expression:"b",se:"don"},{speaker:"reset",character:"kannda",text:"１位、神田先生",expression:"a",se:"don"},{speaker:"遠くのクラス",character:"far_class",text:"わーーーーーー！！！！",expression:"a"},{speaker:"だいち",character:"daichi",text:"誰に入れたっけ？",expression:"a"},{speaker:"放送",character:"broadcast",text:"続いて。４組",expression:"a"},{speaker:"reset",character:"turuturu",text:"２位、鶴原先生",expression:"a",se:"don"},{speaker:"reset",character:"washio",text:"１位、鷲尾先生です",expression:"a",se:"don"},{speaker:"遠くのクラス",character:"far_class",text:"わーーーーーー！！！！",expression:"a"},{speaker:"放送",character:"broadcast",text:"続いて、3組",expression:"a"},{speaker:"reset",character:"gotoujyunnji",text:"２位、後藤先生",expression:"a",se:"don"},{speaker:"reset",character:"anndou",text:"１位、安藤先生です",expression:"a",se:"don"},{speaker:"近くのクラス",character:"near_class",text:"わーーーーーー！！！！",expression:"a"},{speaker:"こうたろう",character:"koutarou",text:"あー、こういうのあったな、どうしたっけな、、、",expression:"b"},{speaker:"放送",character:"broadcast",text:"続いて、2組です",expression:"a"},{speaker:"reset",character:"yamazaki",text:"２位、山崎先生",expression:"a",se:"don"},{speaker:"reset",character:"honngou",text:"１位、本郷先生です",expression:"a",se:"don"},{speaker:"隣のクラス",character:"next_class",text:"わーーーーーー！！！！",expression:"a"},{speaker:"reset",character:"narrator",text:"",expression:"a"},{speaker:"ひろかず",character:"hirokazu",text:"次は俺たちのクラスだな、、、",expression:"a"},{speaker:"しゅうへい",character:"adachi",text:"どこのクラスもちゃんと副担任と担任が入っているな",expression:"a"},{speaker:"放送",character:"broadcast",text:"続いて、1組です",expression:"a"},{speaker:"かなと",character:"kanato",text:"きたきた、、、、",expression:"a"},{speaker:"放送",character:"broadcast",text:"えーーーー",expression:"a"},{speaker:"放送",character:"broadcast",text:"２位、、、、",expression:"a"},{speaker:"reset",character:"sciencemother",text:"サっ、、サイエンスマザー先生、、、",expression:"a",se:"don"},{speaker:"１組のみなさん",character:"class1",text:"、、、、、、、、、、、、",expression:"a"},{speaker:"放送",character:"broadcast",text:"１位、、、",expression:"a"},{speaker:"reset",character:"doragon",text:"ドっ、、、ドラゴン先生です",expression:"b",se:"don"},{speaker:"１組のみなさん",character:"class1",text:"、、、、、、、、、、",expression:"a"},{speaker:"reset",character:"narrator",text:"、、、、、、、、、",expression:"a"},{speaker:"だいち、こうたろう、しゅうへい、かなと",character:"daichi",text:"あっ、、、、",expression:"a"},{speaker:"ひろかず",character:"hirokazu",text:"あっ、、、、なんか、まみっちかわいそうだな",expression:"a"},{speaker:"だいち",character:"daichi",text:"いやっ、、、お前がみんなに入れさせたんだろうが、、、",expression:"a"},{speaker:"かなと",character:"kanato",text:"あーあー",expression:"a"},{speaker:"しゅうへい",character:"adachi",text:"担任、副担どっちも入ってないっていう",expression:"a"},{speaker:"ナレーション",character:"narrator",text:"、、、、、、、、",expression:"a"},{speaker:"ナレーション",character:"narrator",text:"そのあとの、英語の授業終了後",expression:"a"},{speaker:"ひろかず",character:"hirokazu",text:"なんか、まみっちすねてたな",expression:"a"},{speaker:"だいち",character:"daichi",text:"おまえのせいだろ",expression:"a"}]},wax_on:{background:"taketakukou",bgm:"vitality",conversations:[{speaker:"おおや",character:"ooya",text:"なおくん、なおくん",expression:"a"},{speaker:"なおき",character:"naoki",text:"なに？、どしたよ？",expression:"a"},{speaker:"おおや",character:"ooya",text:"なんか、気づくことない？",expression:"a"},{speaker:"なおき",character:"naoki",text:"んん、、、なんだろう、わからんかも",expression:"a"},{speaker:"おおや",character:"ooya",text:"実はワックスつけてみたんよ",expression:"a"},{speaker:"なおき",character:"naoki",text:"えっ、、、あっ、、、うん",expression:"a"},{speaker:"なおき",character:"naoki",text:"（ぼうずやん、、、わかるか）",expression:"a"},{type:"choice",choiceId:"wax_on_choice",choices:[{id:"praise",text:"いいじゃん！似合ってる！",result:"correct",nextMessages:[{speaker:"おおや",character:"ooya",text:"ほんと？うれしい！",expression:"a"}]},{id:"point_out",text:"いや、それワックス以前の問題では…",result:"wrong",nextMessages:[{speaker:"なおき",character:"naoki",text:"たしかに…でも言わないであげて…",expression:"b"}]},{id:"neutral",text:"気づかなかった…でも新しい挑戦いいね",result:"wrong",nextMessages:[{speaker:"おおや",character:"ooya",text:"次はもっと分かりやすい変化にしてみるわ！",expression:"a"}]}]}]},valentine:{background:"nichijyou_d",bgm:"rainbow_Seeker_II",conversations:[{speaker:"narrator",character:"narrator",text:"バレンタインデーの日",expression:"a"},{speaker:"かなと",character:"kanato",text:"なんかチョコレートもらったな、、、机においとこ",expression:"a"},{speaker:"ナレーション",character:"narrator",text:"帰り道の電車内にて",expression:"a"},{speaker:"かなと",character:"kanato",text:"食べるか、、、ん、、、何か手紙が入っているぞ、",expression:"a"},{speaker:"かなと",character:"kanato",text:"なになに、、",expression:"a"},{speaker:"手紙",character:"letter",text:"いきなりでごめんちょ♪、放課後体育館前に来てちょ♪",expression:"a"},{speaker:"かなと",character:"kanato",text:"ああ、やべぇ、読んでなかった、どうしよう",expression:"a"},{speaker:"かなと",character:"kanato",text:"行かないの、かわいそうだしな、誰かは知らんけど",expression:"a"},{speaker:"ひろかず",character:"hirokazu",text:"どうした？みしろ",expression:"a"},{speaker:"かなと",character:"kanato",text:"なんか手紙に、体育館前に来いってかいてて",expression:"a"},{speaker:"かなと",character:"kanato",text:"（、、、、ちょ♪ってなんやろな、こんなはっちゃけるもんなんかな、こういうときって）",expression:"a"},{speaker:"こうたろう",character:"koutarou",text:"どうした？ごめんちょ♪って、してた？",expression:"b"},{speaker:"かなと",character:"kanato",text:"うん、ちょ♪ってしてた、、、",expression:"a"},{speaker:"かなと",character:"kanato",text:"、、、、いや、まて、なんで、お前が中身知ってんだよ",expression:"a"},{speaker:"ひろかず",character:"hirokazu",text:"みしろ、体育館に行かないでいいの？",expression:"a"},{speaker:"かなと",character:"kanato",text:"、、、おまえらか！！！おい、、、やりやがったな",expression:"a"},{speaker:"かなと",character:"kanato",text:"俺の純情もてあそびやがって",expression:"a"},{speaker:"かなと",character:"kanato",text:"無駄にかわいい文字だなぁ！？、凝ってんなぁ、くそが、、、",expression:"a"}]}};class r{constructor(){this.conversations=s,this.currentEvent=null,this.resourceManager=null}setResourceManager(e){this.resourceManager=e}async loadMap(e="taketa"){if(!this.resourceManager)throw new Error("ResourceManager not set");try{return await this.resourceManager.loadMapResources(e),!0}catch(e){throw console.error("マップ読み込みエラー:",e),e}}getConversation(e){return this.conversations[e]||null}getAvailableEvents(){return Object.keys(this.conversations)}async startEvent(e){if(!this.resourceManager)throw new Error("ResourceManager not set");try{return await this.resourceManager.loadEventResources(e,this.conversations),this.currentEvent=e,!0}catch(e){throw console.error("Failed to start event:",e),e}}endEvent(){this.resourceManager&&this.resourceManager.unloadResources(),this.currentEvent=null}addConversation(e,t){this.conversations[e]=t}updateConversation(e,t){return!!this.conversations[e]&&(this.conversations[e]=t,!0)}}},362:(e,t,a)=>{a.r(t),a.d(t,{MiemachiConversationManager:()=>r,miemachiConversationData:()=>s});const s={oreno_koto:{background:"orenokoto",bgm:"Fantasy",conversations:[{speaker:"ひろかず",character:"hirokazu",text:"俺のことについてはなすぜ☆",expression:"g"},{speaker:"ひろかず",character:"hirokazu",text:"生まれた時間は１９９６年９月２９年日曜日で晴れの日だぜ☆",expression:"g"},{speaker:"ひろかず",character:"hirokazu",text:"生まれた病院は佐藤産婦人科でうまれたぜ",expression:"g"},{speaker:"ひろかず",character:"hirokazu",text:"名前の由来は「寛」の字は父親が気に入ってた字で、和は母さんから取ったぜ",expression:"g"},{speaker:"ひろかず",character:"hirokazu",text:"出産は予定日から１９日前に２６４８gで生まれたぜ☆",expression:"g"},{speaker:"ひろかず",character:"hirokazu",text:"血液型はAB型だぜ☆",expression:"g"},{speaker:"ひろかず",character:"hirokazu",text:"安産だったらしいぜ",expression:"g"},{speaker:"ひろかず",character:"hirokazu",text:"生まれた時髪の毛は比較的多かったぜ",expression:"g"},{speaker:"ひろかず",character:"hirokazu",text:"生まれたときの第一声が「オギャー」だぜ",expression:"g"},{speaker:"ひろかず",character:"hirokazu",text:"最後に俺の自信作の漫画を紹介するぜ",expression:"g"},{speaker:"narrator",character:"narrator",text:"",expression:"a",se:"don",background:"mannga_a"},{speaker:"narrator",character:"narrator",text:"",expression:"a",se:"don",background:"mannga_b"},{speaker:"narrator",character:"narrator",text:"",expression:"a",se:"don",background:"mannga_c"},{speaker:"narrator",character:"narrator",text:"",expression:"a",se:"don",background:"mannga_d"},{speaker:"narrator",character:"narrator",text:"",expression:"a",se:"don",background:"mannga_e"},{speaker:"narrator",character:"narrator",text:"",expression:"a",se:"don",background:"mannga_f"},{speaker:"narrator",character:"narrator",text:"",expression:"a",se:"don",background:"mannga_g"},{speaker:"narrator",character:"narrator",text:"",expression:"a",se:"don",background:"mannga_h"},{speaker:"narrator",character:"narrator",text:"",expression:"a",se:"don",background:"mannga_i"},{speaker:"narrator",character:"narrator",text:"",expression:"a",se:"don",background:"mannga_j"},{speaker:"narrator",character:"narrator",text:"",expression:"a",se:"don",background:"mannga_k"},{speaker:"narrator",character:"narrator",text:"",expression:"a",se:"don",background:"mannga_l"},{speaker:"ひろかず",character:"hirokazu",text:"自信はあるぜ☆",expression:"g",se:"wadodon",background:"orenokoto"}]},raizu:{background:"raizu",bgm:"metoroido",conversations:[{speaker:"ひろかず",character:"hirokazu",text:"昔さぁ、、、ライズっていうやば人がいた塾あったじゃん、今どんな感じ？",expression:"e"},{speaker:"かなと",character:"kanato",text:"どうもこうも、まだやってるよね？",expression:"c"},{speaker:"だいち",character:"daichi",text:"やってるな、その塾はまだやってる、今はライズ１とかいう名前でやってるけど",expression:"e"},{speaker:"こうたろう",character:"koutarou",text:"なついな、、、元気かな？",expression:"a"},{speaker:"かなと",character:"koutarou",text:"ああ、一日２箱キメてる、ヘビースモーカーのやば人な",expression:"c"},{speaker:"なおき",character:"naoki",text:"まだ、元気なんだろか",expression:"c"},{speaker:"かなと",character:"kanato",text:"ちょっと、今度確認してくるわ",expression:"c"},{character:"narrator",text:"数日後",expression:"a"},{speaker:"やばじん",character:"yabajinn",text:"おらぁぁぁ！！！！！",expression:"a"},{speaker:"なおき",character:"naoki",text:"でたな",expression:"c"},{speaker:"かなと",character:"kanato",text:"でたな",expression:"c"},{speaker:"かなと",character:"kanato",text:"なんか、安心したわ",expression:"c"},{speaker:"かなと",character:"kanato",text:"かわらない、良さというものがあるな",expression:"c"},{speaker:"なおき",character:"naoki",text:"ライズだなー",expression:"c"}]},souce:{background:"souce",bgm:"pokémon_Theme",conversations:[{speaker:"ひろかず",character:"hirokazu",text:"お盆で暇だな、喜久でちょっと飲むか？",expression:"e"},{speaker:"こうたろう",character:"koutarou",text:"ええよ、せっかくそろったしな",expression:"a"},{speaker:"かなと",character:"kanato",text:"あーーーーーーー、、、、、",expression:"c"},{speaker:"かなと",character:"kanato",text:"と、、、、",expression:"c"},{speaker:"ひろかず",character:"hirokazu",text:"どした？？",expression:"e"},{speaker:"こうたろう",character:"koutarou",text:"？？",expression:"a"},{speaker:"かなと",character:"kanato",text:"俺ら、実は喜久、出禁になったんよね、、",expression:"c"},{speaker:"ひろかず、こうたろう",character:"hirokazu",text:"！？",se:"wadodon",expression:"e"},{speaker:"こうたろう",character:"koutarou",text:"ん？どういうこと？",expression:"a"},{speaker:"ひろかず、こうたろう",character:"hirokazu",text:"全く、俺たち、心当たりはないんだが？",expression:"e"},{speaker:"だいち",character:"daichi",text:"説明すると、この前「かなと、俺、なおき」その他のメンバーで喜久に飲みに行ったんやけど、",expression:"e"},{speaker:"だいち",character:"daichi",text:"その時に来てた、日本酒のお酒の中になぜか日本酒と醤油が混ざってたんよ",expression:"e"},{speaker:"だいち",character:"daichi",text:"マスターのミスかなぁと思って",expression:"e"},{speaker:"だいち",character:"daichi",text:"、何もいわずにテーブルの上において帰ったんだけど",expression:"e"},{speaker:"だいち",character:"daichi",text:"それを、俺らがいたずらで入れたって話になって冤罪で出禁になりました。",expression:"e"},{speaker:"かなと",character:"kanato",text:"もちろん、俺らがいれたわけじゃないけど、、、、、",expression:"c"},{speaker:"なおき",character:"naoki",text:"一応、次の日に謝りにいったけど門前払いを食らったで",expression:"b"},{speaker:"かなと",character:"kanato",text:"俺ら何も、悪いことしてないから、何を反省していいのかわからんけど",expression:"b"},{speaker:"ひろかず,功太郎",character:"hirokazu,koutarou",text:"、、、、、、、、、、、、、、、、",expression:"b"},{speaker:"ひろかず",character:"hirokazu",text:"俺とこうたろうはとばっちりすぎん？",expression:"b"},{speaker:"かなと",character:"kanato",text:"いや、、、、まぁ",expression:"c"},{speaker:"かなと",character:"kanato",text:"そう",expression:"c"},{speaker:"ひろかず",character:"hirokazu",text:"なんでだよ、、",expression:"d"},{speaker:"こうたろう",character:"koutarou",text:"飛び火すぎるわ",expression:"e"},{speaker:"だいち",character:"daichi",text:"残念だなｗ",expression:"f"},{speaker:"こうたろう",character:"koutarou",text:"どこでのむよ、、、俺らの聖地なくなったぞ",expression:"g"},{speaker:"なおき",character:"naoki",text:"「かくれんぼ」、ならいけるとおもうぞ",se:"wadodon",expression:"a"},{speaker:"ひろかず",character:"hirokazu",text:"かくれんぼにするか、、、",expression:"l"},{speaker:"なおき",character:"naoki",text:"ちょうど、改装しているから行けるかどうか、、",expression:"c"},{speaker:"ひろかず",character:"hirokazu",text:"まぁ、あそこはいけるやろ、あそこは、なんか知らんけどいつも空いてるやん",expression:"l"},{speaker:"なおき",character:"naoki",text:"たしかにぃ、、",expression:"b"},{speaker:"ひろかず",character:"hirokazu",text:"えっと、どうする？",expression:"l"},{speaker:"かなと",character:"kanato",text:"何が？",expression:"d"},{speaker:"ひろかず",character:"hirokazu",text:"もう、おれらのグループ名『しょうゆ』にするか",expression:"l"},{speaker:"だいち",character:"daichi",text:"するか、、、、「しょうゆ』に",expression:"b"},{speaker:"かなと",character:"kanato",text:"仕方ないから、ＬＩＮＥのグループ名は『しょうゆ』にしときます",expression:"d"},{speaker:"こうたろう",character:"koutarou",text:"『しょうゆ』か、、、、、",expression:"c"},{speaker:"ひろかず",character:"hirokazu",text:"とばっちりだなぁ、、、",expression:"c"},{speaker:"だいち",character:"daichi",text:"んんんん、、、、、、、決定だやな",expression:"a"},{speaker:"narrator",character:"narrator",text:"、、、、、、、、、、、、、",expression:"a"},{character:"line_group_syouyu",text:"こうして、lineグループはしょうゆになった。",expression:"a"}]},seven:{background:"seven",bgm:"Last_Summer_In_Rio",conversations:[{speaker:"ひろかず",character:"hirokazu",text:"帰るか、、、",expression:"e"},{speaker:"だいち",character:"daichi",text:"どうやって帰ります？",expression:"e"},{speaker:"ひろかず",character:"hirokazu",text:"ん？？そりゃ、タクシーで、、",expression:"e"},{speaker:"かなと",character:"kanato",text:"タクシー？",expression:"c"},{speaker:"なおき",character:"naoki",text:"三重町にそんな便利な物ないぞ",expression:"c"},{speaker:"だいち",character:"daichi",se:"dededon",text:"あっ！！！",expression:"e"},{speaker:"こうたろう",character:"koutarou",text:"三重町にはそんなものないぞ、こんな時間は",expression:"a"},{speaker:"なおき",character:"naoki",text:"残念だったなｗ",expression:"c"},{speaker:"ひろかず",character:"hirokazu",text:"歩いて帰るのか、、、",expression:"e"},{speaker:"だいち",character:"daichi",text:"三重町だからな、、、",expression:"e"},{speaker:"こうたろう",character:"koutarou",text:"仕方ないつきあってやるか",expression:"a"},{speaker:"かなと,なおき",character:"kanato",text:"はじまった、、反対方向なのに、、、",expression:"c"},{speaker:"ナレーション",character:"narrator",text:"移動中",expression:"a",background:"seven_1"},{speaker:"こうたろう",character:"koutarou",text:"、、、、、",expression:"N"},{speaker:"こうたろう",character:"koutarou",text:"、、、、、おれ結婚するんだよな、、、",expression:"N"},{speaker:"ひろかず",character:"hirokazu",text:"ん？？",expression:"e"},{speaker:"だいち",character:"daichi",text:"おっと、、、なんか言った？",expression:"e"},{speaker:"かなと",character:"kanato",text:"なんか、聞こえたな",expression:"c"},{speaker:"ひろかず",character:"hirokazu",text:"おい、やっぱりおっぱいか、おっぱいなんだな、嫁さんおっぱい大きいって言ってたもんな！",expression:"e"},{speaker:"こうたろう",character:"koutarou",text:"ん、、、、、？",expression:"a"},{speaker:"こうたろう",character:"koutarou",text:"そう",expression:"a"},{speaker:"なおき",character:"naoki",text:"おらぁぁぁ！！！！！！！！！！！！！！！！！！！！！！！！！！！！！",expression:"c"},{speaker:"ひろかず",character:"hirokazu",text:"えっと、どうする？処すか？",expression:"e"},{speaker:"だいち",character:"daichi",text:"処します",expression:"e"},{speaker:"かなと",character:"kanato",text:"拷問して、、、、死刑！！！！！！！！",expression:"c"},{speaker:"なおき",character:"naoki",text:"賛成です",expression:"c"},{speaker:"だいち",character:"daichi",text:"ゆるさんぞ！！！",expression:"e"},{speaker:"ナレーション",character:"narrator",text:"ー２年後ー",expression:"a"},{speaker:"ひろかず",character:"hirokazu",text:"おれ、結婚するんだよな、、、",expression:"e"},{speaker:"かなと、なおき",character:"kanato",text:"はい、死刑",expression:"c,c"}]},Weeds_burn:{background:"Fire",bgm:"bloody_tears",conversations:[{speaker:"だいち少年",character:"syounenndaichi",text:"火遊びしたいな",expression:"1"},{speaker:"ひろかず少年",character:"syounennhirokazu",text:"これを使えば、火遊びできるよ",expression:"1"},{speaker:"だいち少年",character:"syounenndaichi",text:"よし！いけ！",expression:"1"},{speaker:"ひろかず少年",character:"syounennhirokazu",text:"いや、まてさすがにここでは周りに火が付きそうなものがおおい",expression:"1"},{speaker:"ひろかず少年",character:"syounennhirokazu",text:"なので、距離をおいて火をつけよう",expression:"1"},{speaker:"だいち少年",character:"syounenndaichi",text:"ここなら大丈夫だろ、この川の別れて、陸みたいになってるとこ！！！",expression:"1"},{speaker:"だいち少年",character:"syounenndaichi",text:"新大陸だ！！！！",expression:"1"},{speaker:"ひろかず少年",character:"syounennhirokazu",text:"ここならいける！！！！",expression:"1"},{speaker:"だいち少年",character:"syounenndaichi",text:"よし、やるんだ！！！",expression:"1"},{speaker:"ナレーター",character:"narrator",se:"sei_ge_matti_tukeru01",expression:"1"},{speaker:"ナレーター",character:"narrator",text:"パチパチっ、、、",se:"焚き火短",expression:"1"},{speaker:"ダイチ少年",character:"syounenndaichi",text:"火ついたな、、、",expression:"1"},{speaker:"ひろかず少年",character:"syounennhirokazu",text:"おおっ、、あたたけぇ、、、",expression:"1"},{speaker:"ダイチ少年",character:"syounenndaichi",text:"ええな、、、、",expression:"1"},{speaker:"ナレーター",character:"narrator",text:"びゅぅぅぅぅ、、。",se:"wind2",expression:"1"},{speaker:"ダイチ少年",character:"syounenndaichi",text:"なんか風が、、、なぁ、、、！？！？！！！！！？！？！？",expression:"1"},{speaker:"ダイチ少年",character:"syounenndaichi",text:"もえた、物が、、、、、風に飛んで、、",expression:"1"},{speaker:"ダイチ少年、ひろかず少年",character:"syounenndaichi",text:"あっっっ！！！！！！！！！！！！！！！！",se:"焚き火短",background:"moeru",expression:"1,1"},{speaker:"ダイチ少年",character:"syounenndaichi",text:"えっと、なんかやばくね",expression:"1"},{speaker:"ダイチ少年",character:"syounenndaichi",text:"やばくね？なんかやばくね？？？？？",expression:"1"},{speaker:"ひろかず少年",character:"syounennhirokazu",text:"、、、、、けせーーーーーーーー！、水かけろ！！！！",expression:"1"},{speaker:"ダイチ少年",character:"syounenndaichi",text:"まずいまずいまずいまずいまずいまずいまずいまずい！！！！！！！",expression:"1"},{speaker:"ひろかず少年",character:"syounennhirokazu",text:"みっ、、、水をかけるんだ！！！はやく！！！！",expression:"1"},{speaker:"ダイチ少年",character:"syounenndaichi",text:"ダメだ！！！！！火の勢いが強い",expression:"1"},{speaker:"ひろかず少年",character:"syounennhirokazu",text:"つっっつち！！！！",expression:"1"},{speaker:"ひろかず少年",character:"syounennhirokazu",text:"土をなげろぉーーーーーーーーーー！！！！！",expression:"1"},{speaker:"ダイチ少年",character:"syounenndaichi",text:"泥しかないです！！！",expression:"1"},{speaker:"ダイチ少年",character:"syounenndaichi",text:"なんでもいいから、なげろぉぉおぉ！！！",expression:"1"},{speaker:"ダイチ少年",character:"syounenndaichi",text:"火がぁぁぁ！つよい！！！",expression:"1"},{speaker:"ひろかず少年",character:"syounennhirokazu",text:"あきらめるな！！！早くけせーーーーーーーー！！！",expression:"1"},{text:"３０分後",expression:"1"},{speaker:"ダイチ少年",character:"syounenndaichi",text:"やったか？、、、",expression:"1"},{speaker:"ナレーター",character:"narrator",se:"sei_ge_matti_tukeru01",expression:"1"},{speaker:"ひろかず少年",character:"syounennhirokazu",text:"早くけせーーーーーーーー！！！",expression:"1"},{speaker:"ナレーター",character:"narrator",text:"、、、",se:"sei_ge_matti_tukeru01",expression:"1"},{speaker:"ナレーター",character:"narrator",text:"、、、、、",expression:"1"},{speaker:"ナレーター",character:"narrator",text:"、、、、、、、、、、、、",expression:"1"},{speaker:"ダイチ少年",character:"syounenndaichi",text:"なっ、、、何とかきえたぞ、、、、",background:"moeato",expression:"1"},{speaker:"ひろかず少年",character:"syounennhirokazu",text:"やばかった、焦ったわ、、、、、",expression:"1"}]},koutaroupoteto:{background:"koutaroupoteto",bgm:"Nagisa_Moderato",conversations:[{speaker:"だいち",character:"daichi",text:"ここのポテトうまいな、、",expression:"g"},{speaker:"ひろかず",character:"hirokazu",text:"ここは三重町で有名なポテト屋ですよ",expression:"n"},{speaker:"だいち",character:"daichi",text:"１００円で、この量はお得でうまいな",expression:"h"},{speaker:"だいち",character:"daichi",text:"まぁ、いいけど、一週間ずっと、来てるやん、、、",expression:"h"},{speaker:"ひろかず",character:"hirokazu",text:"うまいからいいんだよ",expression:"m"},{speaker:"だいち",character:"daichi",text:"あっ、、、はい",expression:"h"}]},antares:{background:"test_1",bgm:"Nagisa_Moderato",conversations:[{speaker:"ひろかず",character:"hirokazu",text:"バス釣りっておもしろいな、、、リールがほしい、、、",expression:"a"},{speaker:"だいち",character:"daichi",text:"やっぱ、釣り道具ってかっちょいいよな",expression:"b"},{speaker:"ひろかず",character:"hirokazu",text:"アンタレス欲しいな、、、あと、ルアーも",expression:"c"},{speaker:"だいち",character:"daichi",text:"とりあえず、帰りにバス釣り行くぞ！！",expression:"d"},{speaker:"ひろかず",character:"hirokazu",text:"おっしゃ、いくんだ！！！",expression:"e"},{speaker:"ひろかず",character:"hirokazu",text:"おらぁぁぁ！！！！！",expression:"f"},{speaker:"ひろかず",character:"hirokazu",text:"ああああああああ、俺のルアーがあああああああ",expression:"g"},{speaker:"ひろかず",character:"hirokazu",text:"ルアーだけ飛んでったぞ、、、、、、うわぁぁぁ",expression:"h"}]},drinking_dutu:{background:"dutu",bgm:"africa",conversations:[{speaker:"ひろかず",character:"hirokazu",text:"普通の酒飲み飽きたなー",expression:"a"},{speaker:"こうたろう",character:"koutarou",text:"ドンキで探すか",expression:"a"},{speaker:"だいち",character:"daichi",text:"あっ！これよくね！？",expression:"b"},{speaker:"narrator",character:"narrator",text:"",expression:"a",se:"taiko_2ren",background:"omiki"},{speaker:"ひろかず",character:"hirokazu",text:"これもう一気するための大きさじゃん！",expression:"b"},{speaker:"だいち",character:"daichi",text:"一気してくださいって言ってるなあ！",expression:"a"},{speaker:"こうたろう",character:"koutarou",text:"それ御神酒じゃね？",expression:"c"},{speaker:"ひろかず",character:"hirokazu",text:"ドンキには一気する用の酒も売ってるんかあ！",expression:"b"},{speaker:"だいち",character:"daichi",text:"じゃあ1人一本ずつ買うか！",expression:"a"},{speaker:"こうたろう",character:"koutarou",text:"いや1人一本ずつのやつかそれ？",expression:"c"},{speaker:"ひろかず",character:"hirokazu",text:'1人一本"ずつ"のやつ、いくぞお！',expression:"b"},{speaker:"だいち",character:"daichi",text:'"ずつ"！うおおお！',expression:"b"},{speaker:"こうたろう",character:"koutarou",text:"だから……まあいいか！うおおお！",expression:"a"},{speaker:"narrator",character:"narrator",text:"夜",expression:"a",background:"yorumofuketa"},{speaker:"ひろかず",character:"hirokazu",text:"ーーさて、夜も更けてきました",expression:"a"},{speaker:"だいち",character:"daichi",text:'"ずつ"、いきますか',expression:"a"},{speaker:"こうたろう",character:"koutarou",text:'もうそれの名前"ずつ"なんや',expression:"c"},{speaker:"ひろかず",character:"hirokazu",text:"よっしゃ3人で同時にいくぞお！",expression:"b"},{speaker:"だいち",character:"daichi",text:"うおおお！",expression:"b"},{speaker:"こうたろう",character:"koutarou",text:"もういいや！いくぞお！",expression:"c"},{speaker:"ひろかず・だいち・こうたろう",character:"all",text:"「「「ゴクゴクゴッ…オロロロロロ✨」」」",se:"outo",expression:"c"},{speaker:"ひろかず",character:"hirokazu",text:"なんだこれ…",expression:"c"},{speaker:"だいち",character:"daichi",text:"体に入らないです",expression:"c"},{speaker:"こうたろう",character:"koutarou",text:"胃に当たってそのまま跳ね返ってくる",expression:"c"},{speaker:"ひろかず",character:"hirokazu",text:"オロロロロロ✨",se:"outo",expression:"c"},{speaker:"こうたろう",character:"koutarou",text:"オロロロロロ…",se:"outo",expression:"c"},{speaker:"こうたろう",character:"koutarou",text:"止まらん…",expression:"c"},{type:"choice",choiceId:"vomit_choice",choices:[{id:"under_tree",text:"木の下にはく",result:"correct",nextMessages:[{speaker:"ひろかず",character:"hirokazu",text:"木の下に吐こオロロロロロ✨",se:"outo",expression:"c"},{speaker:"だいち",character:"daichi",text:"大きく成長しろよ",expression:"c"}]},{id:"on_ant",text:"アリの上にはく",result:"wrong",nextMessages:[{speaker:"ひろかず",character:"hirokazu",text:"アリの上に吐こオロロロロロ✨",se:"outo",expression:"c"}]}]},{speaker:"だいち",character:"daichi",text:"オロロロロロ✨",se:"outo",expression:"c"},{speaker:"こうたろう",character:"koutarou",text:"最低の栄養や…",expression:"c"}]},snack_street_night:{background:"miemachimae",bgm:"nightbarth",conversations:[{speaker:"ひろかず",character:"hirokazu",text:"あー飲んだなー",expression:"d"},{speaker:"かなと",character:"kanato",text:"まだ21時か……",expression:"c"},{speaker:"こうたろう",character:"koutarou",text:"2軒目いくか",expression:"a"},{speaker:"なおき",character:"naoki",text:"空いてるのスナックしかないよなー",expression:"c"},{speaker:"だいち",character:"daichi",text:"三重町はこの時間もう眠ってるからな",expression:"e"},{speaker:"ひろかず",character:"hirokazu",text:"よし、じゃあスナック行くぞ！",expression:"e"},{speaker:"ナレーター",character:"narrator",text:"ここは三重町駅前。推定平均年齢50歳、無数のママたちがひしめく三重町最大の歓楽街。",expression:"a"},{speaker:"ナレーター",character:"narrator",text:"【スナック名鑑 in 三重町】",expression:"a"},{speaker:"ナレーター",character:"narrator",text:"まずはここ！！",expression:"a",se:"taiko_2ren"},{speaker:"ナレーター",character:"narrator",text:"『シリウス』",expression:"a"},{speaker:"ナレーター",character:"narrator",text:"クセの強い「よいしょ⤴あそれ⤴」のカラオケ合いの手が名物！",expression:"a"},{speaker:"ナレーター",character:"narrator",text:"文字では伝わらないニュアンスだぞ！あともう店は潰れてるぞ！",expression:"a"},{speaker:"ナレーター",character:"narrator",text:"次に、『ジュエリー』",expression:"a",background:"jewelry",se:"taiko_2ren"},{speaker:"ナレーター",character:"narrator",text:"鳴物入りでやってきたルーキー！原液9割のレモンサワーで飛べるぞ！",expression:"a"},{speaker:"ナレーター",character:"narrator",text:"更に『ドール』",expression:"a",background:"doll",se:"taiko_2ren"},{speaker:"ナレーター",character:"narrator",text:"唯一の同世代・アイドルまゆちゃん！三重町最後の希望だ！でももう引退したぞ！",expression:"a"},{speaker:"ナレーター",character:"narrator",text:"でももう引退したぞ！",expression:"a"},{speaker:"ナレーター",character:"narrator",text:"あと普通に同級生の親とかも通ってる！",expression:"a"},{speaker:"ナレーター",character:"narrator",text:"『シークレット』カラオケが盛り上がりすぎて会話できない！",expression:"a",background:"secret",se:"taiko_2ren"},{speaker:"ナレーター",character:"narrator",text:"最高なフィリピンママによるネイティブ洋楽とフィリピン料理が魅力！",expression:"a"},{speaker:"ナレーター",character:"narrator",text:"料金はちょっと不安になるくらい安いぞ！",expression:"a"},{speaker:"ナレーター",character:"narrator",text:"その他にも",expression:"a"},{speaker:"ナレーター",character:"narrator",text:"『花市場』",expression:"a",background:"hanaichiba",se:"don"},{speaker:"ナレーター",character:"narrator",text:"『じょいりん』！",expression:"a",background:"joelyn",se:"don"},{speaker:"ナレーター",character:"narrator",text:"『さくら』！！",expression:"a",background:"sunakku_sa",se:"don"},{speaker:"ナレーター",character:"narrator",text:"『クール』！！！",expression:"a",background:"cool",se:"taiko_2ren"},{speaker:"ナレーター",character:"narrator",text:"他にも愉快なスナックが勢揃いだ！",expression:"a"},{speaker:"ナレーター",character:"narrator",text:"4時間後",expression:"a"},{speaker:"ひろかず",character:"hirokazu",text:"やっぱスナックのあとに、コンビニで3次会するのが最高なんだよな〜",background:"seven2",expression:"a"},{speaker:"ナレーター",character:"narrator",text:"三重町の夜は、まだまだ寝かせてくれない。",expression:"a"}]},momoiro_jyogakuenn:{background:"momoiro",bgm:"togetogetarumeiro",conversations:[{character:"narrator",text:"ここに、二匹の狼がいた。",expression:"a"},{character:"narrator",text:"賢い狼と、気のいい狼。二匹は共に狩りや水浴びをするほど仲がよかった。",expression:"a"},{character:"narrator",text:"あるとき、賢い狼が言った。",expression:"a"},{character:"narrator",text:"「獲物を追いかけるより、待ち伏せをしよう。」",expression:"a"},{character:"narrator",text:"「そうすれば遠くまで出かけずとも、獲物のほうからやって来るだろう」",expression:"a"},{character:"narrator",text:"気のいい狼は二つ返事でうなずいた。だが、二匹には待ち伏せに適した場所の心当たりがなかった。",background:"ookami",expression:"a"},{character:"narrator",text:"そこで二匹は、村の物知りな狼に相談することにした。",expression:"a"},{character:"narrator",text:"物知りな狼は言った。",expression:"a"},{character:"narrator",text:"「知りたければ、対価を払いなさい」",expression:"a"},{character:"narrator",text:"二匹はしぶしぶ、以前に狩った獲物を物知りな狼に分け与えた。",expression:"a"},{character:"narrator",text:"満足そうにうなずいた物知りな狼は答えた。",expression:"a"},{character:"narrator",text:"「村の外れに、使われていない洞窟が二か所ある。人目につきにくく、狩りには最適だ」",expression:"a"},{character:"narrator",text:"「そこは自然も豊かで、獲物も多く、丸々太ってうまそうに見える」とも。",expression:"a"},{character:"narrator",text:"物知りな狼は続けた。",expression:"a"},{character:"narrator",text:'「ただし、そこから帰るには"対価"が必要だ。その対価はわしにも分からん」',expression:"a"},{character:"narrator",text:"少しの疑念を抱きながらも、二匹の狼は洞窟へ向かった。",expression:"a"},{character:"narrator",text:"日が沈み、夜が更けるころ、二つの気配が近づいてきた。",expression:"a"},{character:"narrator",text:"夜闇にまぎれて獲物の全貌は見えない。それでも二匹は息を潜め、洞窟で待ち伏せを続けた。",expression:"a"},{character:"narrator",text:"やがて、二匹の獲物が洞窟に入る。",expression:"a"},{character:"narrator",text:"その瞬間、二匹の狼は獲物をとらえるため、行動を起こした",expression:"a"},{character:"narrator",text:"しかし、２匹の狼は行動を停止した。狩りの本能も急止した。",expression:"a"},{character:"narrator",text:"理由は簡単だった、目の前の獲物が、たいそう好みではなかったのだ。端的に言えば——マズそう、だった。",expression:"a"},{character:"narrator",text:"それでも二匹は引けなかった。ここに至るまでに、物知りな狼に対価を払ってしまっていたからだ。",expression:"a"},{character:"narrator",text:"何も、しないで帰ることは、二匹のプライドが許さなかった。",expression:"a"},{character:"narrator",text:"——狩りは終わった。昇る朝日を背に、肩を落とした帰り道に、ぽつりと気のいい狼が言葉をこぼした。",background:"yuuhiload",expression:"a"},{character:"narrator",text:"「あの日、僕らは大人になった」",expression:"a"},{character:"narrator",text:"賢い狼は、それを苦い顔で聞き流した。",expression:"a"}]},daichi_conversation:{background:"taiikukann",bgm:"Fantasy",conversations:[{speaker:"だいち",character:"daichi",text:"副リーダーとかいうの嫌すぎるな",expression:"i"},{speaker:"だいち",character:"daichi",text:"どっかでサボろうぜ",expression:"i"},{speaker:"だいち",character:"daichi",text:"またおかがみに怒られるだけかもだけど...",expression:"i"},{speaker:"ひろかず",character:"hirokazu",text:"だいちはいっつも冷めてるよな",expression:"o"},{speaker:"ひろかず",character:"hirokazu",text:"まあ、いいやチョロQ持ってきてるからこれで遊ぶぞ",expression:"o"},{speaker:"ひろかず",character:"hirokazu",text:"それか、このバス釣りの雑誌みんなで見ようぜ",expression:"o"},{speaker:"だいち",character:"daichi",text:"いつもの流れだけど、これが一番楽しいよな笑",expression:"i"}]},otsuka_senpai:{background:"taiikukann",bgm:"megarovania",conversations:[{speaker:"大塚先輩",character:"ootuka",text:"あそこの階段で隠れてると女の子のパ◯ツが見れるってことをお前だけに教えてやる",expression:"a"},{speaker:"大塚先輩",character:"ootuka",text:"感謝してくれて良いよ",expression:"a"},{speaker:"大塚先輩",character:"ootuka",text:"さて、俺はこれにて体育館の倉庫でサボるわ..",expression:"a"},{type:"choice",choiceId:"hirokazu_choice",choices:[{id:"lifetime",text:"一生ついていきます!!!!!",result:"correct",nextMessages:[{speaker:"ひろかず",character:"hirokazu",text:"一生ついていきます！",expression:"o"}]},{id:"sometimes",text:"まじめに部活をする",result:"wrong",nextMessages:[{speaker:"ひろかず",character:"hirokazu",text:"おかがみがあり得ないくらいキレるので、戻りましょう",expression:"o"},{speaker:"大塚先輩",character:"ootuka",text:"いや、俺は行く",expression:"a"}]},{id:"never",text:"おかがみにチクる",result:"wrong",nextMessages:[{speaker:"ひろかず",character:"hirokazu",text:"おかがみにいいますよ",expression:"o"},{speaker:"大塚先輩",character:"ootuka",text:"おまえとは馬が合いそうにないな",expression:"a"}]}]}]},tatuharu:{background:"taiikukann",bgm:"unオーエン彼女なのか？",conversations:[{speaker:"たつはる",character:"tatuharu",text:"俺この前、スラムダンク読んだわ",expression:"a"},{speaker:"たつはる",character:"tatuharu",text:"俺は",expression:"a"},{speaker:"たつはる",character:"tatuharu",text:"俺は強くなる...!",expression:"a"},{speaker:"たつはる",character:"tatuharu",text:"ところでバス釣り行かね？",expression:"a"},{speaker:"ひろかず",character:"hirokazu",text:"バス釣りは毎週行ってるだろ",expression:"o"},{speaker:"ひろかず",character:"hirokazu",text:"そんなに焦るなよ笑",expression:"o"}]},tanabata:{background:"bunngoriver",bgm:"blinding_lights",conversations:[{speaker:"だいち",character:"daichi",text:"この豊後川とかいうところに願い事書いて、笹を流せば願い事かなうってよ",expression:"e"},{speaker:"なおき",character:"naoki",text:"じゃあ、この０点のテストの回答を流そう",expression:"c"},{speaker:"かなと",character:"kanato",text:"いや、それ俺のな",expression:"c"},{speaker:"ナレーター",character:"narrator",text:"、、、、、",expression:"a"},{speaker:"だいち",character:"daichi",text:"おらぁ、、、、、！！！！！",expression:"e"},{speaker:"なおき,かなと",character:"naoki,kanato",text:"、、、、、、",expression:"c,c"},{speaker:"だいち",character:"daichi",text:"で?、０点の答案って、どういう意味の願い事になんの？",expression:"e"},{speaker:"なおき",character:"naoki",text:"さぁ？",expression:"c"},{speaker:"かなと",character:"kanato",text:"０点が願い事みたいになってんじゃん",expression:"c"},{speaker:"かなと",character:"kanato",text:"また、０点とったらどうすんだよ",expression:"c"},{speaker:"だいち",character:"daichi",text:"笑うしないな",expression:"c"},{speaker:"かなと",character:"kanato",text:"くたばれ、この野郎",expression:"c"}]}};class r{constructor(){this.conversations=s,this.currentEvent=null,this.resourceManager=null}setResourceManager(e){this.resourceManager=e}getConversation(e){return this.conversations[e]||null}getAvailableEvents(){return Object.keys(this.conversations)}async loadMap(e="miemachi"){if(!this.resourceManager)throw new Error("ResourceManager not set");try{return await this.resourceManager.loadMapResources(e),!0}catch(e){throw console.error("マップ読み込みエラー:",e),e}}async startEvent(e){if(!this.resourceManager)throw new Error("ResourceManager not set");try{return await this.resourceManager.loadEventResources(e,this.conversations),this.currentEvent=e,!0}catch(e){throw console.error("Failed to start event:",e),e}}endEvent(){this.resourceManager&&this.resourceManager.unloadResources(),this.currentEvent=null}addConversation(e,t){this.conversations[e]=t}updateConversation(e,t){return!!this.conversations[e]&&(this.conversations[e]=t,!0)}}},364:(e,t,a)=>{a.d(t,{AreaConfig:()=>s});const s={select_screen:{bgm:{menu:"assets/audio/bgm/zelda_menu_select.mp3"},se:{touch:"assets/audio/se/touch_1.mp3"}},stage_select:{bgm:{menu:"assets/audio/bgm/zelda_menu_select.mp3"},se:{touch:"assets/audio/se/touch_1.mp3"}},stages:{stage1:{bgm:{map:"assets/audio/bgm/nightbarth.mp3"}},stage2:{bgm:{map:"assets/audio/bgm/stage2/Pollyanna.mp3"}},stage3:{bgm:{map:"assets/audio/bgm/stage3.mp3"}}},miemachistage:{mapKey:"miemachi",tilesetKey:"miemachi",mapTitle:"三重町マップ",folderName:"miemachi",mapFileName:"miemachi",tilesetFileName:"miemachi",bgm:{map:"assets/audio/bgm/kessen_diaruga.mp3"},se:{se_touch:"assets/audio/se/touch_7.mp3",se_map_touch:"assets/audio/se/touch_2.mp3"},areas:[{name:"oreno_koto",scene:null,conversationId:"oreno_koto"},{name:"momoiro_jyogakuenn",scene:null,conversationId:"momoiro_jyogakuenn"},{name:"drinking_dutu",scene:null,conversationId:"drinking_dutu"},{name:"Weeds_burn",scene:null,conversationId:"Weeds_burn"},{name:"mie_high_school",scene:"startPhaserGame",sceneParam:"mie_high_school",conversationId:null},{name:"raizu",scene:null,conversationId:"raizu"},{name:"snack_street_night",scene:null,conversationId:"snack_street_night"},{name:"souce",scene:null,conversationId:"souce"},{name:"koutaroupoteto",scene:null,conversationId:"koutaroupoteto"},{name:"seven",scene:null,conversationId:"seven"},{name:"tanabata",scene:null,conversationId:"tanabata"}]},taketastage:{mapKey:"taketa",tilesetKey:"taketa",mapTitle:"竹田ステージ",folderName:"taketa",mapFileName:"taketa",tilesetFileName:"taketa",bgm:{map:"assets/audio/bgm/Spain.mp3"},se:{se_touch:"assets/audio/se/touch_7.mp3",se_map_touch:"assets/audio/se/touch_2.mp3"},areas:[{name:"train_no_poop_man",scene:null,conversationId:"train_no_poop_man"},{name:"taketa_high_school",scene:"startPhaserGame",sceneParam:"taketa_highschool",conversationId:null},{name:"galaxy_water",scene:null,conversationId:"galaxy_water"},{name:"udefuriojisann",scene:null,conversationId:"udefuriojisann"},{name:"working_go_to_home_miemachi",scene:null,conversationId:"working_go_to_home_miemachi"},{name:"kannnamu_kudou",scene:null,conversationId:"kannnamu_kudou"}]},japanstage:{mapKey:"japan",tilesetKey:"japan",mapTitle:"日本マップ",folderName:"japan",mapFileName:"japan",tilesetFileName:"japan",bgm:{map:"assets/audio/bgm/Theme_from_Back_To_The_Future.mp3"},se:{se_touch:"assets/audio/se/touch_7.mp3",se_map_touch:"assets/audio/se/touch_2.mp3"},areas:[{name:"computer",scene:null,conversationId:"computer"},{name:"breaking_car",scene:null,conversationId:"breaking_car"},{name:"special_scam",scene:null,conversationId:"special_scam"},{name:"rojyounopenki",scene:null,conversationId:"rojyounopenki"},{name:"tereapo",scene:null,conversationId:"tereapo"},{name:"first_rising_sun",scene:null,conversationId:"first_rising_sun"},{name:"arechi",scene:null,conversationId:"arechi"}]}}},527:(e,t,a)=>{a.r(t),a.d(t,{JapanConversationManager:()=>r,japanConversationData:()=>s});const s={computer:{background:"asokonnroom",bgm:"togetogetarumeiro",conversations:[{speaker:"narrator",character:"narrator",text:"ある深夜の夜、、、、",expression:"a",se:"don",background:"xxxxxx"},{speaker:"だいち",character:"daichi",text:"なんか疲れてそうだけど、大丈夫か？",expression:"d"},{speaker:"ひろかず",character:"hirokazu",text:"んー、まあなんとかやってはいる！",expression:"k"},{speaker:"だいち",character:"daichi",text:"やりたいことってないの？",expression:"d"},{speaker:"ひろかず",character:"hirokazu",text:"やりたいこと、、、、、",expression:"k"},{speaker:"ひろかず",character:"hirokazu",text:"やっぱり絵を描きたいな",expression:"g"},{speaker:"だいち",character:"daichi",text:"絵をきながら、ちゃんと収入がある形がいいよね",expression:"e"},{speaker:"ひろかず",character:"hirokazu",text:"まさしくその通りなんだよな",expression:"e"},{speaker:"だいち",character:"daichi",text:"エンジニアになって、実力がついてくれば時間に縛れず、絵を描く時間が取れるかもよ",expression:"d"},{speaker:"ひろかず",character:"hirokazu",text:"一回、なろうとして挫折した過去があるから、厳しい気がする・・・",expression:"e"},{speaker:"だいち",character:"daichi",text:"んじゃ、僕がサポートするわ!!!",expression:"d",se:"don"},{speaker:"ひろかず",character:"hirokazu",text:"まじか・・・・",expression:"i"},{speaker:"だいち",character:"daichi",text:"もう一回チャレンジしてみね？なおきとかも誘ってみんなでプロジェクトやったりしてみて、そこでポートフォリオ作って転職目指そうぜ！",expression:"c"},{speaker:"ひろかず",character:"hirokazu",text:"・・・・、ありがとう・・・、すまねえな・・・",expression:"g"},{speaker:"だいち",character:"daichi",text:"やるからには、絶対何かしらいい形に持っていこう！",expression:"b"},{speaker:"narrator",character:"narrator",text:"とあるプロジェクトが初まる",expression:"a",se:"don",background:"xxxxxx"},{speaker:"ひろかず",character:"hirokazu",text:"前勤めてた会社のシステム作らせてもらえそう！！",expression:"l",se:"don"},{speaker:"だいち",character:"daichi",text:"お！いいね！いっちょやってみるか！！",expression:"c"},{speaker:"だいち",character:"daichi",text:"たくみっていう僕の友達も誘って一緒に頑張ろう！！",expression:"c"},{speaker:"ひろかず",character:"hirokazu",text:"やるぞーーー！！！",expression:"l"},{speaker:"narrator",character:"narrator",text:"とあるプロジェクトを初めて半年",expression:"a",se:"wadodon"},{speaker:"ひろかず",character:"hirokazu",text:"なんとなく形にはなってきたな",expression:"l"},{speaker:"だいち",character:"daichi",text:"そろそろ完璧な仕様を固めて形にしていきたいね",expression:"c"},{speaker:"たくみ",character:"takumi",text:"そうだね、これ導入できたらかなりでかい結果残せそう！！",expression:"a"},{speaker:"だいち",character:"daichi",text:"週に3日ぐらい夜集まって、あとは各々作業してっていう感じでかなりの時間費やしたから実って欲しい・・",expression:"d"},{speaker:"narrator",character:"narrator",text:"とあるプロジェクトを初めて半年",expression:"a",se:"don",background:"xxxxxx"},{speaker:"ひろかず",character:"hirokazu",text:"元々いた会社の、役員の人たちのところで紹介してきた！",expression:"i"},{speaker:"たくみ",character:"takumi",text:"流石に緊張したなあ〜〜",expression:"a"},{speaker:"だいち",character:"daichi",text:"二人ともお疲れ様！どういった印象を持ってそうだった？",expression:"d"},{speaker:"ひろかず",character:"hirokazu",text:"まだなんとも言えないな〜〜",expression:"i"},{speaker:"たくみ",character:"takumi",text:"ちょっと掴めない感じだったから、わからないな〜〜",expression:"a"},{speaker:"だいち",character:"daichi",text:"んー、そうか〜〜、とりあえず最終的な仕様も固まったことだしラストスパート！！",expression:"d"},{speaker:"narrator",character:"narrator",text:"、、、",expression:"a",background:"xxxxxx"},{speaker:"narrator",character:"narrator",text:"、、、、、、、、、",expression:"a"},{speaker:"narrator",character:"narrator",text:"、、、、、、、、、、、、、、",expression:"a"},{speaker:"narrator",character:"narrator",text:"それから、、、、、",expression:"a",se:"don"},{speaker:"だいち",character:"daichi",text:"・・・・・",expression:"d"},{speaker:"ひろかず",character:"hirokazu",text:"・・・・・",expression:"k"},{speaker:"たくみ",character:"takumi",text:"・・・・・",expression:"a"},{speaker:"ひろかず",character:"hirokazu",text:"すまん、急にこのプロジェクト爆散することになった・・・",expression:"k"},{speaker:"だいち",character:"daichi",text:"おう・・・・",expression:"d"},{speaker:"たくみ",character:"takumi",text:"あひ・・・・・",expression:"a"},{speaker:"ひろかず",character:"hirokazu",text:"なんかここまで付き合わせて、こんな結果になってしまってごめんな・・・",expression:"k"},{speaker:"だいち",character:"daichi",text:"まあ、仕方ない！こっちが急にシステム入れたら絶対効率良くなるって思って盲信してた部分が大きいからね",expression:"d"},{speaker:"たくみ",character:"takumi",text:"くやしいけど、こればっかりはどうしようもないね",expression:"a"},{speaker:"ひろかず",character:"hirokazu",text:"・・・・、、、、これにて、このプロジェクトを解散します！！(涙)",expression:"g"},{speaker:"だいち",character:"daichi",text:"2年後にシャボンディ諸島で！！",expression:"e",se:"wadodon"}]},breaking_car:{background:"donnki",bgm:"rydeen",conversations:[{speaker:"narrator",character:"narrator",text:"〜大学時代〜",expression:"a"},{speaker:"ひろかず",character:"hirokazu",text:"車欲しくね？、みんなで金出し合って買うか〜",expression:"b"},{speaker:"友人ズ",character:"frends",text:"いいね〜、何買うかな",expression:"a"},{speaker:"ひろかず",character:"hirokazu",text:"このBMWクソ安いな笑",expression:"c"},{speaker:"ひろかず",character:"hirokazu",text:"外車だからかっこいいし、これしかねえだろ！！",expression:"c"},{type:"choice",choiceId:"breaking_car_choice",choices:[{id:"inspect",text:"整備記録や走行距離をちゃんと確認する",result:"correct",nextMessages:[{speaker:"友人ズ",character:"frends",text:"そうだな、激安には理由があるし慎重にいこう",expression:"a"},{speaker:"ひろかず",character:"hirokazu",text:"たしかに。事故歴や消耗品も見とくか",expression:"b"}]},{id:"rush",text:"安いし即決で買う！",result:"wrong",nextMessages:[{speaker:"友人ズ",character:"frends",text:"え、ほんとに？ ちょっと不安かも…",expression:"b"}]},{id:"walkaway",text:"やめとく。別の車を探す",result:"wrong",nextMessages:[{speaker:"ひろかず",character:"hirokazu",text:"まぁ無理はしないのも選択だな。別候補も見てみるか",expression:"a"}]}]},{speaker:"narrator",character:"narrator",text:"その後、この激安BMWを購入し、ブイブイいわせていたという、、、",expression:"a"}]},special_scam:{background:"kouenn",bgm:"まどいの水源",conversations:[{speaker:"ひろかず",character:"hirokazu",text:"友達の結婚式よかったな、、、",expression:"e"},{speaker:"ひろかず",character:"hirokazu",text:"ネカフェに泊まって体バキバキだし、とりあえず一服するか",expression:"e"},{speaker:"ひろかず",character:"hirokazu",text:"ふぅ、、、、、、",expression:"c"},{speaker:"知らないおじさん",character:"stranger",text:"――――ちょっとお兄さん、ここらへんで有名な居酒屋知らない？",expression:"a"},{speaker:"ひろかず",character:"hirokazu",text:"えっ、、、",expression:"i"},{speaker:"ひろかず",character:"hirokazu",text:"俺も久しぶりに鹿児島寄ったので、、、とりあえず知っているところでよければ、、、",expression:"i"},{speaker:"ひろかず",character:"hirokazu",text:"ここなんかは有名ですかねぇ",expression:"i"},{speaker:"知らないおじさん",character:"stranger",text:"あぁ、ありがとうありがとう",expression:"a"},{speaker:"知らないおじさん",character:"stranger",text:"そうだ、お兄さんいい人だから、俺もいろいろ話したくなっちゃった",expression:"a"},{speaker:"知らないおじさん",character:"stranger",text:"実は俺、宝くじ当たったから働く必要なくなって鹿児島観光してたんだわ",expression:"a"},{speaker:"知らないおじさん",character:"stranger",text:"お兄さんはいつ発つの？明日？",expression:"a"},{speaker:"ひろかず",character:"hirokazu",text:"はぁ、、、まぁ、、、",expression:"i"},{speaker:"知らないおじさん",character:"stranger",text:"じゃあ今からちょっと話そうよ、飯いこう！",expression:"a"},{speaker:"知らないおじさん",character:"stranger",text:"ここの焼き鳥とかにいこうよ",expression:"a"},{speaker:"ひろかず（心の声）",character:"hirokazu",text:"、、、ん？俺が言ったところと違うけど、まぁいいか、、、",expression:"k"},{speaker:"ひろかず",character:"hirokazu",text:"あっ、わかりました",expression:"i"},{speaker:"narrator",character:"narrator",text:"焼き鳥屋にて、、、食事を終え、、、",expression:"a",background:"yakitori"},{speaker:"narrator",character:"narrator",text:"再び公園にて、、、",expression:"a",background:"kouenn"},{speaker:"ひろかず",character:"hirokazu",text:"焼き鳥美味しかったですね",expression:"e"},{speaker:"知らないおじさん",character:"stranger",text:"美味しかったね",expression:"a"},{speaker:"知らないおじさん",character:"stranger",text:"もうちょっと話したいね、そこのベンチに座ろう",expression:"a"},{speaker:"知らないおじさん",character:"stranger",text:"――――お兄さん、さっきも思ったけど、だいぶ悩み抱えてるでしょ",expression:"a"},{speaker:"知らないおじさん",character:"stranger",text:"ため込むのはよくないからさ、話しちゃいなよ。友達にも吐き出せないこととか、あるでしょ？",expression:"a"},{speaker:"ひろかず（心の声）",character:"hirokazu",text:"、、、この人、なんでわかるんだ、、、",expression:"k"},{speaker:"ひろかず（心の声）",character:"hirokazu",text:"確かにそうだけど、でも、さっき会ったばかりの人に、、、",expression:"k"},{speaker:"ひろかず（心の声）",character:"hirokazu",text:"、、、いや、よく知らない人だからこそ言えることもあるか、、、？",expression:"k"},{speaker:"ひろかず（心の声）",character:"hirokazu",text:"最近しんどいし、、、なんだか酔いも回っちゃってるし、、、",expression:"k"},{speaker:"ひろかず",character:"hirokazu",text:"、、、あの、仕事とかあんまりうまくいってなくて、家族にもいろいろあって",expression:"h"},{speaker:"ひろかず",character:"hirokazu",text:"彼女とも大変で、そのうえ生活費出すのもギリギリで、、、",expression:"h"},{speaker:"ひろかず",character:"hirokazu",text:"うぅ、、、、くぅ、、、、",expression:"h"},{speaker:"知らないおじさん",character:"stranger",text:"そっか、大変だったんだな",expression:"a"},{speaker:"知らないおじさん",character:"stranger",text:"そうだな、、、うん！俺、宝くじ１億円当たってるし、５０万あげるよ！",expression:"a"},{speaker:"ひろかず",character:"hirokazu",text:"えっ、、、マジっすか！？",expression:"l"},{speaker:"知らないおじさん",character:"stranger",text:"それで今日はもうさ、綺麗なおねーちゃんがいるところ行ってパーっと遊ぼうよ！",expression:"a"},{speaker:"知らないおじさん",character:"stranger",text:"、、、だけどそうだな、、、このまま５０万円上げるのは簡単だけど",expression:"a"},{speaker:"知らないおじさん",character:"stranger",text:"お兄さんの今後のためにそのまま渡すだけでは意味ないな、、、",expression:"a"},{speaker:"知らないおじさん",character:"stranger",text:"お兄さんならどうする？",expression:"a"},{speaker:"ひろかず",character:"hirokazu",text:"ど、どうすかね、、、",expression:"k"},{speaker:"知らないおじさん",character:"stranger",text:"こうするのがいいよ",expression:"a"},{speaker:"知らないおじさん",character:"stranger",text:"俺、金（きん）を扱うトレーダーをしているんだ",expression:"a"},{speaker:"知らないおじさん",character:"stranger",text:"日本で買って、中国とかで売るって感じかな",expression:"a"},{speaker:"知らないおじさん",character:"stranger",text:"中国では金（きん）の価値がめっちゃ上がっているんだよ",expression:"a"},{speaker:"知らないおじさん",character:"stranger",text:"で、今ちょうど一口あいてて",expression:"a"},{speaker:"知らないおじさん",character:"stranger",text:"５０万とか入れたら確定で１倍以上、、、２倍とかになるから",expression:"a"},{speaker:"知らないおじさん",character:"stranger",text:"その一口をあげるよ",expression:"a"},{speaker:"知らないおじさん",character:"stranger",text:"ただし、まず金（きん）を買う５０万円は自分で準備してね",expression:"a"},{speaker:"知らないおじさん",character:"stranger",text:"要は５０万を手に入れられる手段をあげたってわけ",expression:"a"},{speaker:"知らないおじさん",character:"stranger",text:"どうする？",expression:"a"},{speaker:"ひろかず",character:"hirokazu",text:"、、、うっ、、、",expression:"c"},{speaker:"ひろかず（心の声）",character:"hirokazu",text:"状況を整理しよう",expression:"h"},{speaker:"ひろかず（心の声）",character:"hirokazu",text:"今、俺は貯金ゼロ、友達の祝儀３万とかでカツカツ、、、",expression:"h"},{speaker:"ひろかず（心の声）",character:"hirokazu",text:"しかも今ニート、、、",expression:"h"},{speaker:"ひろかず（心の声）",character:"hirokazu",text:"お金が欲しい、、、",expression:"h"},{speaker:"ひろかず（心の声）",character:"hirokazu",text:"でも、お金を増やすにはお金がいる、、、",expression:"h"},{speaker:"ひろかず（心の声）",character:"hirokazu",text:"、、、どうしよう、、、",expression:"h"},{speaker:"ひろかず（心の声）",character:"hirokazu",text:"借りるしかないよな、、、",expression:"h"},{speaker:"ひろかず（心の声）",character:"hirokazu",text:"借りるしか、、、",expression:"h"},{speaker:"ひろかず",character:"hirokazu",text:"、、、ちょっと待ってください",expression:"i"},{speaker:"ひろかず",character:"hirokazu",text:"俺、今カツカツなので、消費者金融をあたらせてください",expression:"i"},{speaker:"ひろかず（心の声）",character:"hirokazu",text:"ニートでも行ける消費者金融を探すか、、、",expression:"i"},{speaker:"ひろかず",character:"hirokazu",text:"中々ないか、、、",expression:"k"},{speaker:"ひろかず",character:"hirokazu",text:"あった、ここだ、、、、",expression:"i"},{speaker:"ひろかず",character:"hirokazu",text:"あっ、５０万、、、借りました",expression:"i"},{speaker:"知らないおじさん",character:"stranger",text:"よし、じゃあ今から連れて行くところに金（きん）があるんだよね",expression:"a"},{speaker:"知らないおじさん",character:"stranger",text:"そこで買って、郵送とか全部俺がして届けるから",expression:"a"},{speaker:"知らないおじさん",character:"stranger",text:"そのあと一緒に今日お酒飲んだり、綺麗なおねーちゃんの店行ったり、パーっと遊ぼう！",expression:"a"},{speaker:"知らないおじさん",character:"stranger",text:"で、場所なんだけど、、、ドン・キホーテ、、、",expression:"a"},{speaker:"知らないおじさん",character:"stranger",text:"ドン・キホーテに金（きん）が売っているから、とりあえず先に口座でお金おろしてきてね",expression:"a"},{speaker:"ひろかず",character:"hirokazu",text:"わかりました！",expression:"e"},{speaker:"narrator",text:"ガラガラ、、、",expression:"a",se:"garagara"},{speaker:"ひろかず（心の声）",character:"hirokazu",text:"５０万円の札束、、、うわ、、、これが５０万なんだ、、、",expression:"i"},{speaker:"ひろかず",character:"hirokazu",text:"これが５０万円なんすね、すごいっすね、、、",expression:"e"},{speaker:"知らないおじさん",character:"stranger",text:"いや、もっと増えるから",expression:"a"},{speaker:"知らないおじさん",character:"stranger",text:"こんなもんじゃないよ",expression:"a"},{speaker:"ひろかず",character:"hirokazu",text:"マジっすか、、、",expression:"i"},{speaker:"知らないおじさん",character:"stranger",text:"とりあえず、この場でパッと渡すと怪しまれるから",expression:"a"},{speaker:"知らないおじさん",character:"stranger",text:"ちょっとそこの通りを歩いて、人目のつかない場所に行こうか",expression:"a"},{character:"narrator",text:"（人気のない路地裏に移動し、、、）",expression:"a"},{speaker:"ひろかず",character:"hirokazu",text:"じゃあ、これよろしくお願いしますね",expression:"e"},{speaker:"知らないおじさん",character:"stranger",text:"うん、じゃあドン・キホーテに行って金（きん）を買おうか",expression:"a"},{speaker:"narrator",character:"narrator",text:"ドン・キホーテに着、、、、",expression:"a",background:"donnki"},{speaker:"知らないおじさん",character:"stranger",text:"、、、さて、ドン・キホーテに着いたけど、俺金（きん）を買ってくるからちょっとここで待っててね",expression:"a"},{speaker:"知らないおじさん",character:"stranger",text:"――――絶対待っててよ！",expression:"a"},{speaker:"ひろかず",character:"hirokazu",text:"わかりました！！",expression:"e"},{speaker:"reset",character:"narrator",text:"",expression:"a",background:"donnki"},{character:"narrator",text:"――数分後――",expression:"b"},{speaker:"ひろかず",character:"hirokazu",text:"もうそろそろかな、、、",expression:"i"},{character:"narrator",text:"――数十分後――",expression:"b"},{speaker:"ひろかず",character:"hirokazu",text:"、、、まぁまぁまぁまぁ、、、金（きん）を買うんだから、これぐらいかかるんだろうな、、、",expression:"k"},{speaker:"ひろかず",character:"hirokazu",text:"いい人だったしな、、、まぁ、ないよな、、、そんなこと、、、",expression:"k"},{character:"narrator",text:"――さらに数十分後――",expression:"b"},{speaker:"ひろかず",character:"hirokazu",text:"あっ、あへぇ、、、あれ、、、おかしいな、、、おそいな、、、",expression:"g"},{speaker:"ひろかず",character:"hirokazu",text:"んん、、、あれ、、、あへぇぇ、、、ほんとに、、、おそいな、、、おそ、、、",expression:"g"},{speaker:"ひろかず",character:"hirokazu",text:"あっ、、、、、、あっあっ、、、ア、、、いや、、、あっ、、、",expression:"g"},{speaker:"ひろかず",character:"hirokazu",text:"、、、あっ、騙された、、、、、、、、、、、、、、",expression:"k"},{speaker:"ひろかず",character:"hirokazu",text:"はっ、っは、、、はぁ、はぁ、うぅ、、、、、、はぁ、はぁ、、、、、、",expression:"g"},{speaker:"ひろかず",character:"hirokazu",text:"ぁぁあああ、、、、、、ああああああああぁぁぁああぁぁ、、、、、、",expression:"g"},{speaker:"ひろかず",character:"hirokazu",text:"とっ、とりあえず、顔見知りの居酒屋のオーナーにそっ、相談しよう",expression:"k"},{character:"narrator`",text:"プルルルルルル",expression:"a",se:"pururu"},{speaker:"ひろかず",character:"hirokazu",text:"、、、、、、あああああ、、、だっ、、、",expression:"k"},{speaker:"ひろかず",character:"hirokazu",text:"騙されました、どうしましょう、、、",expression:"k"},{speaker:"親切な居酒屋の店主",character:"owner",text:"落ち着けって、とりあえず交番に行きな",expression:"a"},{speaker:"ひろかず",character:"hirokazu",text:"、、、、、、",expression:"k"},{speaker:"narrator",character:"narrator",text:"交番にて、、",expression:"a",se:"don",background:"koubann"},{speaker:"交番",character:"police",text:"どうされました？",expression:"a"},{speaker:"ひろかず",character:"hirokazu",text:"うっ、、、うぅ、、、騙されました、、、、、、",expression:"k"},{speaker:"ひろかず",character:"hirokazu",text:"５０万をかりでぇ、、、そいで、ドンキでお金渡してぇ、、、、、",expression:"k"},{speaker:"ひろかず",character:"hirokazu",text:"うぅ、、、うっ、、、、、、",expression:"k"},{speaker:"交番",character:"police",text:"証拠はありますでしょうか？",expression:"a"},{speaker:"ひろかず",character:"hirokazu",text:"なっ、、、ないです、、、、、、",expression:"k"},{speaker:"交番",character:"police",text:"その人はどんな顔だった？",expression:"a"},{speaker:"ひろかず",character:"hirokazu",text:"あっ、えっ、絵は得意なので、、、",expression:"k"},{speaker:"ひろかず",character:"hirokazu",text:"うぅ、、、かっ、描きます、、、、、、",expression:"k"},{speaker:"交番",character:"police",text:"、、、、、、",expression:"a"},{speaker:"交番",character:"police",text:"、、、、、、、、、",expression:"a"},{speaker:"交番",character:"police",text:"一応、これで捜査はしてみますが、、、",expression:"a"},{speaker:"交番",character:"police",text:"、、、こりゃ、、、見つかりはせんで、、、、、、",expression:"a"},{speaker:"ひろかず",character:"hirokazu",text:"、、、、、、、、、",expression:"k"},{speaker:"ひろかず",character:"h",text:"――――結局、",expression:"c"},{speaker:"ひろかず",character:"h",text:"その５０万円は帰ってくることはなかった、、、",expression:"c"},{character:"h",text:"ひろかずは目の前が真っ暗になった",expression:"c"}]},arechi:{background:"nichijyou_3",bgm:"rainbow_Seeker_II",conversations:[{speaker:"かなと",character:"kanato",text:"さてさて、我々zossoft",expression:"c"},{speaker:"かなと",character:"kanato",text:"ここのイベント（荒地）は実はめっちゃ書きたいものがあったんですけどね",expression:"d"},{speaker:"かなと",character:"kanato",text:"まぁ、書きたいけど書けないって事があるんですわ",expression:"c"},{speaker:"かなと",character:"kanato",text:"一応結婚式で使うゲームですからね、一応",expression:"d"},{speaker:"こうたろう",character:"koutarou",text:"まことに遺憾です",expression:"c"},{speaker:"なおき",character:"naoki",text:"結構間引いたしな、書きたいイベントもわっさわっさで、もっとあるからな",expression:"c"},{speaker:"だいち",character:"daichi",text:"どうしても書きたかったものは濁したしな",expression:"e"},{speaker:"かなと",character:"kanato",text:"それでも、このゲーム作ってたら山のように、",expression:"c"},{speaker:"かなと",character:"kanato",text:"イベントが出てくるわ出てくるわで",expression:"d"},{speaker:"かなと",character:"kanato",text:"普通にプレイしていたら30分から１時間はかかるんじゃないか？",expression:"c"},{speaker:"こうたろう",character:"koutarou",text:"全部書いていたら、きりがないわけで、、、",expression:"b"},{speaker:"だいち",character:"daichi",text:"ギリギリを見極めるのが難しかったっす",expression:"f"},{speaker:"かなと",character:"kanato",text:"ぶっちゃけ、作るのに苦労しましたわ、３か月ですよ、３か月",expression:"c"},{speaker:"かなと",character:"kanato",text:"感謝が欲しいです",expression:"d"},{speaker:"こうたろう",character:"koutarou",text:"まぁ、それはともかくここを読んでくれているということは、",expression:"c"},{speaker:"こうたろう",character:"koutarou",text:"遊んでくれているわけですよ、そこの君",expression:"b"},{speaker:"かなと",character:"kanato",text:"そのことにとても感謝したいです。",expression:"c"},{speaker:"かなと",character:"kanato",text:"遊んでもらって、ゲームは完成するもんですからね",expression:"d"},{speaker:"なおき",character:"naoki",text:"お前玄人みたいなこと言っているけど、ゲーム作ったのはじめてだろ",expression:"c"},{speaker:"かなと",character:"kanato",text:"はい、そうです",expression:"c"},{speaker:"なおき",character:"naoki",text:"おらぁ！！！、玄人ぶるな",expression:"a"},{speaker:"かなと",character:"kanato",text:"すみません",expression:"c"},{speaker:"かなと",character:"kanato",text:"、、、、、、",expression:"d"},{speaker:"かなと",character:"kanato",text:"全員とは言わないから、来た人の３割はプレイしてくれたらいいな",expression:"c"},{speaker:"だいち",character:"daichi",text:"その方がひろかずも怒られないですみそうだからな",expression:"b"},{speaker:"かなと",character:"kanato",text:"プレイの母数が減ればその分、見る人も少ないしな",expression:"c"},{speaker:"こうたろう",character:"koutarou",text:"エピソードはえらんだつもりだけどな、、、",expression:"c"},{speaker:"なおき",character:"naoki",text:"",expression:"d"},{speaker:"ナレーター",character:"narrator",text:"、、、、、",expression:"a"},{speaker:"ナレーター",character:"narrator",text:"ここで謝辞を述べさせていただきます。",expression:"a"},{speaker:"ナレーター",character:"narrator",text:"このたびはプレイしていただき、ありがとうございました。",expression:"a"},{speaker:"ナレーター",character:"narrator",text:"zossoft一同、悪戦苦闘しながら、作成しましたが、皆様に楽しんでいただけたなら幸いです。",expression:"a"},{speaker:"ナレーター",character:"narrator",text:"プレイしてくださり、心より感謝申し上げます。",expression:"a"},{speaker:"ナレーター",character:"narrator",text:"zossoft一同",expression:"a"}]},telephone_appointment:{background:"test_1",bgm:"curono",conversations:[{speaker:"ひろかず",character:"hirokazu",text:"なぁ、めっちゃ時給いいバイト見つけたわ",expression:"e"},{speaker:"イワカワ",character:"iwakawa",text:"どんな？",expression:"a"},{speaker:"ひろかず",character:"hirokazu",text:"太陽光発電のテレアポ！一緒にやろうぜ",expression:"e"},{speaker:"イワカワ",character:"iwakawa",text:"ほーん、まあやってみるか",expression:"a"},{speaker:"ひろかず",character:"hirokazu",text:"じゃあ連絡してみるわ！",expression:"e"},{character:"narrator",text:"──バイトを始めて数日──",expression:"a"},{speaker:"イワカワ",character:"iwakawa",text:"…なぁ、なんかこの会社、色々やばくね？",expression:"b"},{speaker:"ひろかず",character:"hirokazu",text:"そうか？",expression:"i"},{speaker:"イワカワ",character:"iwakawa",text:'まず社長の名前。ググったら"詐欺師"って出てきたぞ',expression:"b"},{speaker:"ひろかず",character:"hirokazu",text:"ネットの噂じゃん、気にすんな",expression:"e"},{speaker:"イワカワ",character:"iwakawa",text:"そうかなぁ…？",expression:"b"},{speaker:"ひろかず",character:"hirokazu",text:"まあ時給いいから！",expression:"l"},{speaker:"イワカワ",character:"iwakawa",text:"あと、会社名も半年ごとに変わってるみたいだし",expression:"b"},{speaker:"ひろかず",character:"hirokazu",text:"イメチェン大事だろ",expression:"i"},{speaker:"イワカワ",character:"iwakawa",text:"いや怪しいだろ",expression:"b"},{speaker:"ひろかず",character:"hirokazu",text:"でも時給いいから！",expression:"l"},{speaker:"イワカワ",character:"iwakawa",text:'つか、折り返し電話が嫌だから"番号の下1桁わざと間違えて教える"ルールとか、もうアウトだろ',expression:"b"},{speaker:"ひろかず",character:"hirokazu",text:"うん、でも時給いいから！",expression:"l"},{speaker:"イワカワ",character:"iwakawa",text:"魔法の言葉かよそれ",expression:"b"},{character:"narrator",text:"──数週間後──",expression:"a"},{speaker:"イワカワ（心の声）",character:"iwakawa",text:"…あれ？河室のアポ件数、俺の3分の1じゃん",expression:"b"},{speaker:"ひろかず",character:"hirokazu",text:"よーし、今日もバリバリ取ったで！",expression:"e"},{speaker:"イワカワ（心の声）",character:"iwakawa",text:"…あれだけポジティブなのに、こいつ…向いてないんじゃ…？",expression:"b"},{character:"narrator",text:"──また数週間後──",expression:"a"},{speaker:"ひろかず",character:"hirokazu",text:"そうだ！俺ちょっとフィリピン行って語学留学してくるわ！",expression:"e"},{speaker:"イワカワ",character:"iwakawa",text:"は？え？まじで？",expression:"b"},{speaker:"ひろかず",character:"hirokazu",text:"うん！そういうことだから、バイト辞めます！",expression:"e"},{speaker:"イワカワ",character:"iwakawa",text:"……………………",expression:"a"},{speaker:"イワカワ",character:"iwakawa",text:"……結局俺だけ残るんかい",expression:"b"}]},road_paint:{background:"test_1",bgm:"curono",conversations:[{speaker:"ひろかず",character:"hirokazu",text:"よし…今日から俺の画家活動、『路上のペンキ』としてのデビューだ！早速路上で売っていくぞ〜",expression:"e"},{speaker:"ひろかず",character:"hirokazu",text:"この駅前なら人通りも多いし、みんなに見てもらえるな。さて、けろけろけろっぴのシートを敷いて、作品を並べてっと…",expression:"e"},{speaker:"警察",character:"police",text:"すいませんお兄さん。ここでの物の陳列、許可は取ってますか？",expression:"a"},{speaker:"ひろかず",character:"hirokazu",text:"は、え、誰、許可…？",expression:"k"},{speaker:"警察",character:"police",text:"警察署のものです。路上での物販行為は許可が必要なんですよ",expression:"a"},{speaker:"ひろかず",character:"hirokazu",text:"いや、あのー…あ！販売じゃなくて展示です！",expression:"e"},{speaker:"警察",character:"police",text:"展示でも、路上で物を並べる行為は物販扱いなので許可が必要です",expression:"a"},{speaker:"ひろかず",character:"hirokazu",text:"は、はぁ…物販扱い…？",expression:"k"},{speaker:"ひろかず",character:"hirokazu",text:"いや、でも、ほら見てくださいよ、この色のグラデーション…！",expression:"e"},{speaker:"警察",character:"police",text:"グラデーションは関係ありません。規則ですので、撤収してください",expression:"a"},{speaker:"ひろかず",character:"hirokazu",text:"いや、その、あの俺、今日がデビューで…名前も『路上のペンキ』って言って…",expression:"k"},{speaker:"警察",character:"police",text:"名前も関係ありません。今度から許可取ってくださいね",expression:"a"},{speaker:"ひろかず",character:"hirokazu",text:"見てもらうだけなんです！無料です！無料アートです！",expression:"e"},{speaker:"警察",character:"police",text:"無料でも同じですよ。路上に物を並べてるでしょ。撤収をお願いします",expression:"a"},{speaker:"ひろかず",character:"hirokazu",text:"いや、でも、見てくださいよ！この色の重なりとか、光の反射とか…ほら！",expression:"e"},{speaker:"警察",character:"police",text:"色の説明はいいですから",expression:"a"},{speaker:"ひろかず",character:"hirokazu",text:"じゃあ…ほら、指でなぞって色の感触だけでも…。あと絵の具の香りも…",expression:"e"},{speaker:"警察",character:"police",text:"いや感触も香りも知りませんよ。早く撤収してください",expression:"a"},{speaker:"ひろかず",character:"hirokazu",text:"…はい…",expression:"k"},{speaker:"ひろかず",character:"hirokazu",text:"はぁ…路上のペンキ、開始数分で散る…",expression:"k"},{speaker:"ひろかず",character:"hirokazu",text:"でも、これが始まりだ……！俺の戦いはこれからだ！",expression:"l"},{speaker:"警察",character:"police",text:"早く撤収しろって",expression:"a"}]},first_sunrise:{background:"test_1",bgm:"curono",conversations:[{speaker:"ひろかず",character:"hirokazu",text:"初日の出を見にくるのも毎年恒例になってるけど、成功率ゼロって珍しいよな",expression:"c"},{speaker:"こうたろう",character:"koutarou",text:"一回もちゃんと見れてないの面白すぎる",expression:"a"},{speaker:"ひろかず",character:"hirokazu",text:"見にくるメンバーも年々減っちゃったし…。色々あったな…",expression:"i"},{character:"narrator",text:"――1年目――",expression:"a"},{speaker:"ひろかず",character:"hirokazu",text:"…地元の丘なら楽勝だろうって言ったの誰でしたっけ",expression:"k"},{speaker:"かなと",character:"kanato",text:"すいません、正直舐めてました",expression:"c"},{speaker:"だいち",character:"daichi",text:"完全に目の前の林に隠れてるじゃねえか",expression:"d"},{speaker:"こうたろう",character:"koutarou",text:"もう周り明るいんだけど。ちゃんとした朝じゃん",expression:"c"},{speaker:"なおき",character:"naoki",text:"てか寒すぎる…。一旦車戻ろうぜ",expression:"c"},{speaker:"全員",character:"all",text:"そうだな…",expression:"a"},{character:"narrator",text:"（車に戻ろうと全員後ろを向く）",expression:"a"},{speaker:"太陽",character:"sun",text:"ピカーーーー！！！！",expression:"a"},{speaker:"なおき",character:"naoki",text:"……え、ちょっと待って！この影、もう出てね！？",expression:"b"},{speaker:"だいち",character:"daichi",text:"うわ、ほんとだ！",expression:"e"},{speaker:"こうたろう",character:"koutarou",text:"このタイミングで出るんかい！見逃したわ！",expression:"a"},{speaker:"全員",character:"all",text:"………………",expression:"a"},{speaker:"ひろかず",character:"hirokazu",text:"…帰るか…",expression:"k"},{character:"narrator",text:"――2年目――",expression:"a"},{speaker:"ひろかず",character:"hirokazu",text:"海なら絶対大丈夫、って自信満々だったんだけどな",expression:"k"},{speaker:"かなと",character:"kanato",text:"あの水平線から見える予定だったんだけど…",expression:"c"},{character:"narrator",text:"（水平線、日の出の位置にピンポイントで雲がある）",expression:"a"},{speaker:"こうたろう",character:"koutarou",text:"こんなに晴れてるのに、あの位置だけピンポイントで雲かかるってありえる？",expression:"c"},{speaker:"だいち",character:"daichi",text:"ここまできたら面白い",expression:"e"},{speaker:"太陽",character:"sun",text:"（雲の隙間からチラッ）",expression:"a"},{speaker:"ひろかず",character:"hirokazu",text:"…あ！出た！太陽出たぞ！初日の出だ！",expression:"l"},{speaker:"かなと",character:"kanato",text:"ありがたや……",expression:"c"},{speaker:"だいち",character:"daichi",text:"よし、初日の出見れたな！これが初日の出だ！終了！帰宅！",expression:"d"},{speaker:"こうたろう",character:"koutarou",text:"これでいいのか…？",expression:"b"},{character:"narrator",text:"――3年目――",expression:"a"},{speaker:"ひろかず",character:"hirokazu",text:"今年こそ完璧だ。高い山、雲なし、視界良好",expression:"e"},{speaker:"こうたろう",character:"koutarou",text:"……で、ここは？",expression:"c"},{speaker:"かなと",character:"kanato",text:"車の中",expression:"c"},{speaker:"ひろかず",character:"hirokazu",text:"時間潰しのカラオケが楽しすぎました。完全に遅刻です",expression:"k"},{speaker:"かなと",character:"kanato",text:"ここまでくると才能だろ",expression:"c"},{speaker:"こうたろう",character:"koutarou",text:"もうわざと見逃しにいってるとこある",expression:"c"},{character:"narrator",text:"――数年後――",expression:"a"},{speaker:"ひろかず",character:"hirokazu",text:"…やっとちゃんと見れたな",expression:"k"},{speaker:"こうたろう",character:"koutarou",text:"正直、感動よりもノルマ達成感の方が強いな。なんだかんだ来れるメンバーも減ってきたし…",expression:"b"},{speaker:"ひろかず",character:"hirokazu",text:"確かに。わざわざ眠い思いして見るほどじゃなかった",expression:"k"},{speaker:"こうたろう",character:"koutarou",text:"結局、太陽なんて毎日昇ってるんだよな",expression:"c"},{speaker:"ひろかず",character:"hirokazu",text:"…腹減ったし、ジョイフルで朝飯食うか",expression:"k"},{character:"narrator",text:"（帰り道の車内、静寂）",expression:"a"},{speaker:"ひろかず（心の声）",character:"hirokazu",text:"…でもまあ、このくだらなさも、あと何回やれるんだろうな",expression:"h"}]}};class r{constructor(){this.conversationData=s,this.currentEvent=null,this.resourceManager=null}setResourceManager(e){this.resourceManager=e}async loadMap(e="japan"){if(!this.resourceManager)throw new Error("ResourceManager not set");try{return console.log(`日本マップ「${e}」を読み込み中...`),await this.resourceManager.loadMapResources(e),console.log(`日本マップ「${e}」の読み込み完了`),!0}catch(e){throw console.error("マップ読み込みエラー:",e),e}}getConversation(e){return this.conversationData[e]||null}getAvailableEvents(){return Object.keys(this.conversationData)}async startEvent(e){if(!this.resourceManager)throw new Error("ResourceManager not set");try{return await this.resourceManager.loadEventResources(e,this.conversationData),this.currentEvent=e,!0}catch(e){throw console.error("Failed to start event:",e),e}}endEvent(){this.resourceManager&&this.resourceManager.unloadResources(),this.currentEvent=null}addConversation(e,t){this.conversationData[e]=t}updateConversation(e,t){this.conversationData[e]=t}}},555:(e,t,a)=>{a.r(t),a.d(t,{startPhaserGame:()=>z});const s=function(){let e,t;document.fullscreenElement?(e=screen.width,t=screen.height):(e=window.innerWidth,window.visualViewport?t=window.visualViewport.height:(t=window.innerHeight,/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)&&(t=Math.min(window.innerHeight,window.screen.height-100))));let a=e,s=t;return a=Math.max(320,a),s=Math.max(240,s),{width:a,height:s}}(),r=/iPad|iPhone|iPod/i.test(navigator.userAgent),n={type:Phaser.AUTO,width:s.width,height:s.height,backgroundColor:"#87CEEB",parent:"game-container",audio:{disableWebAudio:r,noAudio:!1},scale:{mode:Phaser.Scale.RESIZE,autoCenter:Phaser.Scale.CENTER_BOTH,expandParent:!0,fullscreenTarget:"game-container",resizeCallback:function(){}},physics:{default:"arcade",arcade:{gravity:{y:0},debug:!1,fps:60,timeScale:1,skipQuadTree:!1,maxEntries:12,tileBias:16,forceX:!1,overlapBias:4}},render:{antialias:!0,pixelArt:!1,clearBeforeRender:!0,preserveDrawingBuffer:!1,failIfMajorPerformanceCaveat:!1,powerPreference:"default"}};class o{constructor(e){this.scene=e,this.activeEffects=[]}showTouchRipple(e,t,a=65280,s=400){const r=this.scene.add.circle(e,t,10,a,.7);r.setDepth(9999),this.scene.tweens.add({targets:r,scaleX:5,scaleY:5,alpha:0,duration:s,ease:"Power2",onComplete:()=>{r.destroy()}}),this.activeEffects.push(r)}showObjectRipple(e,t,a,s,r=16711680,n=400){const o=Math.max(a,s)/2,i=this.scene.add.circle(e,t,o,r,.7);i.setDepth(9999),this.scene.tweens.add({targets:i,scaleX:3,scaleY:3,alpha:0,duration:n,ease:"Power2",onComplete:()=>{i.destroy()}}),this.activeEffects.push(i)}showButtonHover(e,t=1.2,a=16766720,s=.7){e.setScale&&e.setScale(t),e.setFillStyle&&e.setFillStyle(a,s)}resetButtonState(e,t=1,a=4286945,s=.7){e.setScale&&e.setScale(t),e.setFillStyle&&e.setFillStyle(a,s)}showSelectionEffect(e,t,a=16776960,s=16711680){const r=this.scene.add.circle(e,t,30,a,.6);r.setStrokeStyle(4,s),this.scene.tweens.add({targets:r,scaleX:2,scaleY:2,alpha:0,duration:800,ease:"Power2",onComplete:()=>{r.destroy()}}),this.activeEffects.push(r)}destroy(){this.activeEffects&&this.activeEffects.length>0&&(this.activeEffects.forEach((e=>{e&&e.destroy&&e.destroy()})),this.activeEffects=[]),this.scene=null}}var i=a(327),c=a(362),h=a(527);class l{constructor(){this.storageKey="event_completed_",this.excludedAreas=["mie_high_school","taketa_high_school"]}isAreaCompleted(e){return!this.excludedAreas.includes(e)&&"true"===localStorage.getItem(this.storageKey+e)}markAreaAsCompleted(e){this.excludedAreas.includes(e)||localStorage.setItem(this.storageKey+e,"true")}resetAllCompletions(){Object.keys(localStorage).forEach((e=>{e.startsWith(this.storageKey)&&localStorage.removeItem(e)}))}getCompletedAreas(){const e=[];return Object.keys(localStorage).forEach((t=>{if(t.startsWith(this.storageKey)){const a=t.replace(this.storageKey,"");this.excludedAreas.includes(a)||e.push(a)}})),e}}class p{constructor(e){this.scene=e,this.areas=[],this.areaSprites=[],this.selectedArea=null,this.completionManager=new l,this.isInteractive=!0,this.hoverEffect=null,this.isMobile=this.scene.sys.game.device.input.touch,this.touchStartTime=0,this.touchThreshold=200,this.visualFeedback=new o(e),this.isConfirmDialogActive=!1,this.currentDialog=null}setupAreas(e){console.log("[AreaSelectionManager] setupAreas開始: areas="+(e?e.length:"undefined")),this.destroy(),this.areaSprites=[],e&&Array.isArray(e)?(this.areas=e.map((e=>({...e,description:this.getAreaDescription(e.name)}))),console.log("[AreaSelectionManager] エリアデータ設定完了: "+this.areas.length+"個")):(this.areas=[],console.warn("[AreaSelectionManager] 無効なエリアデータ:",e)),console.log("[AreaSelectionManager] マーカー作成開始: "+this.areas.length+"個のエリア"),this.areas.forEach(((e,t)=>{if(e){console.log("[AreaSelectionManager] エリア"+t+"のマーカー作成: "+e.name+" (x:"+e.x+", y:"+e.y+", w:"+e.width+", h:"+e.height+")");const a=this.createAreaMarker(e);a?(this.areaSprites.push(a),console.log("[AreaSelectionManager] マーカー作成成功: "+e.name)):console.warn("[AreaSelectionManager] マーカー作成失敗: "+e.name)}else console.warn("[AreaSelectionManager] 無効なエリアデータ: index="+t)})),console.log("[AreaSelectionManager] マーカー作成完了: "+this.areaSprites.length+"個のマーカー");const t=this.areaSprites.find((e=>e&&"train_no_poop_man"===e.getData("areaName")));t?console.log("[AreaSelectionManager] train_no_poop_man マーカー発見:",t):(console.warn("[AreaSelectionManager] train_no_poop_man マーカーが見つかりません！"),console.log("[AreaSelectionManager] areaSpritesの内容:",this.areaSprites.map((e=>e?e.getData("areaName"):"null")))),this.setupInteractionEvents(),console.log("[AreaSelectionManager] setupAreas完了");try{this._onConvEndedBound&&this.scene.events.off("conversation-ended",this._onConvEndedBound)}catch(e){}this._onConvEndedBound=({eventId:e,cleared:t,hasChoices:a})=>{if(console.log("[AreaSelectionManager] conversation-ended受信:",{eventId:e,cleared:t,hasChoices:a}),e){if(!a)try{localStorage.setItem("event_completed_"+e,"true")}catch(e){}console.log("[AreaSelectionManager] updateAreaCompletionDisplay呼び出し:",e),console.log("[AreaSelectionManager] 利用可能なareaName一覧:",this.areaSprites.map((e=>e.getData("areaName")))),this.updateAreaCompletionDisplay(e)}},this.scene.events.on("conversation-ended",this._onConvEndedBound)}getAreaDescription(e){return{oreno_koto:"俺",momoiro_jyogakuenn:"２匹の狼と獲物",drinking_dutu:"づつ",Weeds_burn:"雑草ファイヤー",mie_high_school:"三重中学校",raizu:"ライズ",snack_street_night:"三重町の大歓楽街",souce:"しょうゆ",koutaroupoteto:"こうたろうポテト",seven:"セブン",tanabata:"七夕川流し",train_no_poop_man:"うんこおじさん事件",kannnamu_kudou:"電車の工藤くん",taketa_high_school:"竹田高校",galaxy_water:"銀河水",udefuriojisann:"ウデフリオジサン",working_go_to_home_miemachi:"飲み会後三重町まで歩くぞ",computer:"エンジニア",breaking_car:"BMW",special_scam:"特殊詐欺",rojyounopenki:"路上のペンキ",tereapo:"テレアポ",first_rising_sun:"初日の出",arechi:"荒地"}[e]||e}createAreaMarkers(){if(console.log(`[AreaSelectionManager] createAreaMarkers開始: areas=${this.areas?this.areas.length:"undefined"}`),this.areaSprites=[],!this.areas||0===this.areas.length)return void console.warn("[AreaSelectionManager] エリアデータがありません: areas=",this.areas);console.log(`[AreaSelectionManager] エリア数: ${this.areas.length}`),this.areas.forEach(((e,t)=>{if(e){console.log(`[AreaSelectionManager] エリア${t}: ${e.name}`);const a=this.createAreaMarker(e);a&&this.areaSprites.push(a)}})),console.log(`[AreaSelectionManager] createAreaMarkers完了: 作成されたマーカー数=${this.areaSprites.length}`);const e=this.areaSprites.find((e=>e&&"train_no_poop_man"===e.getData("areaName")));e?console.log("[AreaSelectionManager] train_no_poop_man マーカー発見:",e):(console.warn("[AreaSelectionManager] train_no_poop_man マーカーが見つかりません！"),console.log("[AreaSelectionManager] areaSpritesの内容:",this.areaSprites.map((e=>e?e.getData("areaName"):"null"))))}createAreaMarker(e){const t=this.scene.add.container(0,0);t.setData("markerType","areaMarker"),t.setData("areaName",e.name),t.setData("markerId",`marker_${e.name}_${Date.now()}_${Math.random().toString(36).substr(2,9)}`);const a=this.scene.mapManager?.mapScaleX||1,s=Math.max(10,Math.floor(10*a))+"px",r=Math.max(15,15*a),n=e.width||100,o=e.height||100,i=e.x,c=e.y,h=e.ellipse||!1,l=e.rotation||0,{color:p,completed:g}=this._computeAreaColor(e);"train_no_poop_man"===e.name&&(console.log(`[AreaSelectionManager] train_no_poop_man 完了状態: ${g}`),console.log(`[AreaSelectionManager] train_no_poop_man excludedAreas: ${this.completionManager.excludedAreas.includes(e.name)}`));const d=i+n/2,u=c+o/2;let m,x=d,k=u;if(0!==l){const e=l*Math.PI/180,t=d-i,a=u-c;x=i+(t*Math.cos(e)-a*Math.sin(e)),k=c+(t*Math.sin(e)+a*Math.cos(e))}p?(m=h?this.scene.add.ellipse(x,k,n,o,p,16711680===p?.25:.3):this.scene.add.rectangle(x,k,n,o,p,16711680===p?.25:.3),65280===p&&(m.setAlpha(.7),this.scene.tweens.add({targets:m,alpha:1,duration:1500,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"}))):m=h?this.scene.add.ellipse(x,k,n,o,4286945,0):this.scene.add.rectangle(x,k,n,o,4286945,0),m&&(m.setData("markerType","areaMarker"),m.setData("areaName",e.name),m.setData("isCompleted",g),m.setOrigin(.5,.5),0!==l&&m.setRotation(l*Math.PI/180));const y=this.scene.add.text(i+n/2,c-r,e.description,{fontSize:s,fill:65280===p?"#00AA00":16711680===p?"#AA0000":"#000000",backgroundColor:65280===p?"#90EE90":16711680===p?"#FFCCCC":"#FFFFFF",padding:{x:3*a,y:1*a},borderRadius:2*a});if(y.setOrigin(.5,.5),y.setData("markerType","areaMarker"),y.setData("areaName",e.name),y.setData("isCompleted",g),65280===p){const s=Math.max(8,Math.floor(12*a)),o=this.scene.add.text(i+n/2,c-r-s/2,"✓",{fontSize:s+"px",fill:"#00FF00",fontWeight:"bold"});o.setOrigin(.5,.5),o.setData("markerType","areaMarker"),o.setData("areaName",e.name),t&&t.add&&t.add(o)}m&&t.add(m),t.add(y),m.setInteractive(),m.setData("area",e),this.setupMarkerHover(m,y),this.setupMarkerClick(m);try{this.scene.add.existing?this.scene.add.existing(t):this.scene.children.add(t)}catch(t){console.error(`[AreaSelectionManager] マーカーをシーンに追加失敗: ${e.name}`,t)}return t}setupMarkerHover(e,t){e.on("pointerover",(()=>{this.isMobile||(this.visualFeedback.showButtonHover(e,1.2,16766720,.3),t.setStyle({fill:"#FF0000"}))})),e.on("pointerout",(()=>{this.isMobile||(this.visualFeedback.resetButtonState(e,1,4286945,.1),t.setStyle({fill:"#000000"}))}))}setupMarkerClick(e){e.on("pointerdown",(()=>{this.isConfirmDialogActive||this.isConversationActive()||this.isMobile&&(this.touchStartTime=Date.now())})),e.on("pointerup",(()=>{if(this.isConfirmDialogActive)return;if(this.isConversationActive())return;const t=e.getData("area");this.isMobile?Date.now()-this.touchStartTime<this.touchThreshold&&this.selectArea(t):this.selectArea(t)}))}setupInteractionEvents(){this.scene.input.on("pointerdown",(e=>{try{if(this.scene.sound&&this.scene.sound.locked){try{this.scene.sound.context&&"running"!==this.scene.sound.context.state&&this.scene.sound.context.resume()}catch(e){console.warn("[AreaSelectionManager] 音声コンテキスト復帰エラー:",e)}try{const e=this.scene.sound.context;if(e&&"function"==typeof e.createOscillator){const t=e.createOscillator(),a=e.createGain();a.gain.value=1e-4,t.connect(a).connect(e.destination),t.start(),t.stop(e.currentTime+.05)}}catch(e){console.warn("[AreaSelectionManager] 無音オシレーター作成エラー:",e)}}}catch(e){console.warn("[AreaSelectionManager] 音声コンテキスト処理エラー:",e)}this.lastTapX=e.x,this.lastTapY=e.y})),this.scene.input.on("pointerup",(e=>{Math.abs(e.x-this.lastTapX),Math.abs(e.y-this.lastTapY)}))}selectArea(e){try{if(!this.isInteractive)return;if(this.isConfirmDialogActive)return;this.selectedArea=e,this.showSelectionEffect(e),this.playSelectionSound()}catch(t){console.error(`[AreaSelectionManager] selectAreaエラー: ${e.name}`,t)}}showSelectionEffect(e){this.showConfirmDialog(e)}resetAllObjectColors(){this.areaSprites.forEach((e=>{const t=e.getAt(0);if(t&&t.setFillStyle){const e=t.getData("area"),{color:a,completed:s}=this._computeAreaColor(e),r=65280===a,n=16711680===a;if(t.setFillStyle(a||4286945,n?.25:a?.3:.1),r)this.scene.tweens.add({targets:t,alpha:.6,duration:1500,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"});else try{this.scene.tweens.killTweensOf(t)}catch(e){}t.setData("isCompleted",!!s)}}))}resetSelectedObjectColor(){this.selectedArea&&this.areaSprites.forEach((e=>{const t=e.getAt(0);if(t&&t.setFillStyle){const e=t.getData("area");if(e&&e.name===this.selectedArea.name){const{color:a,completed:s}=this._computeAreaColor(e),r=16711680===a;t.setFillStyle(a||4286945,r?.25:a?.3:.1),t.setData("isCompleted",!!s)}}}))}showConfirmDialog(e){if(this.isConfirmDialogActive)return;this.isConfirmDialogActive=!0;const t=this.scene.add.container(this.scene.cameras.main.worldView.centerX,this.scene.cameras.main.worldView.centerY);this.currentDialog=t;const a=this.scene.add.rectangle(0,0,300,150,0,.8);a.setStrokeStyle(2,16777215);const s=this.scene.add.text(0,-40,e.description,{fontSize:"18px",fill:"#FFFFFF",align:"center"});s.setOrigin(.5);const r=this.scene.add.text(0,-10,"この場所に移動しますか？",{fontSize:"14px",fill:"#FFFFFF",align:"center"});r.setOrigin(.5);const n=this.scene.add.text(-60,30,"はい",{fontSize:"16px",fill:"#00FF00",backgroundColor:"#333333",padding:{x:10,y:5}});n.setOrigin(.5),n.setInteractive();const o=this.scene.add.text(60,30,"いいえ",{fontSize:"16px",fill:"#FF0000",backgroundColor:"#333333",padding:{x:10,y:5}});o.setOrigin(.5),o.setInteractive(),t.add([a,s,r,n,o]);const i=()=>{t.active&&t.destroy(),this.isConfirmDialogActive=!1,this.currentDialog=null};n.on("pointerdown",(()=>{try{if(this.scene){if(this.scene._suppressMapBgm=!0,this.scene._bgmRetry&&this.scene._bgmRetry.remove){try{this.scene._bgmRetry.remove(!1)}catch(e){}this.scene._bgmRetry=null}try{this.scene._htmlBgm&&!this.scene._htmlBgm.paused&&this.scene._htmlBgm.pause()}catch(e){}}}catch(e){}i(),this.handleAreaSelection(e)})),o.on("pointerdown",(()=>{i()})),this.scene.time.delayedCall(5e3,(()=>{t.active&&i()}))}handleAreaSelection(e){if(this.scene.mapConfig&&"taketa"===this.scene.mapConfig.mapKey)this.handleTaketaConversation(e);else if(this.scene.mapConfig&&"miemachi"===this.scene.mapConfig.mapKey)try{this.handleMiemachiConversation(e)}catch(e){console.error("[AreaSelectionManager] handleAreaSelection: handleMiemachiConversation呼び出しエラー:",e)}else this.scene.mapConfig&&"japan"===this.scene.mapConfig.mapKey?this.handleJapanConversation(e):this.scene.time.delayedCall(1e3,(()=>{this.navigateToArea(e)}))}handleTaketaConversation(e){let t=null;if(e.conversationId&&null!==e.conversationId)t=e.conversationId;else switch(e.name){case"train_no_poop_man":t="train_no_poop_man";break;case"kannnamu_kudou":t="kannnamu_kudou";break;case"galaxy_water":t="galaxy_water";break;case"udefuriojisann":t="udefuriojisann";break;case"working_go_to_home_miemachi":t="working_go_to_home_miemachi";break;default:return void this.scene.time.delayedCall(1e3,(()=>{this.navigateToArea(e)}))}const a=this.scene.mapConfig?.mapKey||"unknown";this.getConversationData(a,t)?this.startDynamicConversation(t):this.scene.time.delayedCall(1e3,(()=>{this.navigateToArea(e)}))}handleJapanConversation(e){console.log("[AreaSelectionManager] handleJapanConversation開始:",e);let t=null;if(e.conversationId&&null!==e.conversationId)t=e.conversationId,console.log("[AreaSelectionManager] conversationIdから取得:",t);else switch(e.name){case"computer":t="computer";break;case"breaking_car":t="breaking_car";break;case"special_scam":t="special_scam";break;case"rojyounopenki":t="rojyounopenki";break;case"tereapo":t="tereapo";break;case"first_rising_sun":t="first_rising_sun";break;case"arechi":t="arechi";break;default:return void this.scene.time.delayedCall(1e3,(()=>{this.navigateToArea(e)}))}const a=this.scene.mapConfig?.mapKey||"unknown";this.getConversationData(a,t)?this.startDynamicConversation(t):this.scene.time.delayedCall(1e3,(()=>{this.navigateToArea(e)}))}handleMiemachiConversation(e){let t=null;if(e.conversationId&&null!==e.conversationId)t=e.conversationId;else switch(e.name){case"oreno_koto":t="oreno_koto";break;case"raizu":t="raizu";break;case"souce":t="souce";break;case"Weeds_burn":t="Weeds_burn";break;case"koutaroupoteto":t="koutaroupoteto";break;case"drinking_dutu":t="drinking_dutu";break;case"snack_street_night":t="snack_street_night";break;case"momoiro_jyogakuenn":t="momoiro_jyogakuenn";break;case"Flash_land_mie":t="flash_land_mie";break;default:return void this.scene.time.delayedCall(1e3,(()=>{this.navigateToArea(e)}))}const a=this.scene.mapConfig?.mapKey||"unknown";this.getConversationData(a,t)?this.startDynamicConversation(t):this.scene.time.delayedCall(1e3,(()=>{this.navigateToArea(e)}))}startDynamicConversation(e){try{Promise.resolve().then(a.bind(a,92)).then((({DynamicConversationScene:t})=>{this.scene.scene.get(e)&&this.scene.scene.remove(e);try{this.scene.scene.add(e,t,!1,{eventId:e}),this.scene.time.delayedCall(300,(()=>{try{this.scene.scene.get(e)?this.scene.scene.start(e):this.scene.scene.launch(e)}catch(t){try{this.scene.scene.launch(e)}catch(t){console.error(`[AreaSelectionManager] シーン開始失敗: ${e}`,t)}}}))}catch(t){console.error(`[AreaSelectionManager] シーン登録エラー: ${e}`,t)}})).catch((t=>{console.error(`[AreaSelectionManager] DynamicConversationScene開始エラー: ${e}`,t)}))}catch(t){console.error(`[AreaSelectionManager] DynamicConversationScene開始エラー: ${e}`,t)}}getConversationData(e,t){let a;switch(e){case"miemachi":a=c.miemachiConversationData[t];break;case"taketa":a=i.taketaConversationData[t];break;case"japan":a=h.japanConversationData[t];break;default:a=c.miemachiConversationData[t]||i.taketaConversationData[t]||h.japanConversationData[t]}return a}navigateToArea(e){if(!e.sceneParam&&e.name){const t=this.scene.mapConfig?.areas?.find((t=>t.name===e.name));t&&(e.sceneParam=t.sceneParam,e.scene=t.scene)}if(e.scene)if("startPhaserGame"===e.scene){const t=this.scene.mapConfig?.mapKey||"unknown",s=e.sceneParam||1;window.returnToMap=()=>{if(!window.__navigating){window.__navigating=!0;try{window.game&&window.game.sound&&window.game.sound.stopAll()}catch(e){}try{if(window.game&&window.game.scene&&window.game.scene.getScenes){const e=window.game.scene.getScenes(!1)||[];for(const t of e){try{t.scene&&t.scene.stop&&t.scene.stop()}catch(e){}try{t.scene&&t.scene.remove&&t.scene.remove()}catch(e){}}}}catch(e){}try{window.game&&window.game.destroy(!0)}catch(e){}window.game=null,window.gameInstance=null,setTimeout((()=>{Promise.resolve().then(a.bind(a,555)).then((({startPhaserGame:e})=>{try{e(t)}finally{window.__navigating=!1}})).catch((()=>{window.__navigating=!1}))}),50)}},this.scene.scene.get("ConversationScene")&&this.scene.scene.remove("ConversationScene");try{this.scene.load&&this.scene.load.reset&&this.scene.load.reset()}catch(e){}try{this.scene.load&&this.scene.load.removeAllListeners&&this.scene.load.removeAllListeners()}catch(e){}try{this.scene.scene.stop()}catch(e){}Promise.resolve().then(a.bind(a,555)).then((({startPhaserGame:e})=>{try{e(s)}catch(e){}}))}else Promise.resolve().then(a.bind(a,555)).then((({startPhaserGame:t})=>{t(e.scene)}))}playSelectionSound(){try{this.scene.audioManager&&this.scene.audioManager.playSe("se_touch",.5)}catch(e){}}enableInteraction(){this.isInteractive=!0}disableInteraction(){this.isInteractive=!1}update(){}handleTouchAt(e,t){try{const a=this.findAreaAtPosition(e,t);if(a){if(this.isConversationActive())return;this.selectArea(a)}else this.scene.audioManager&&this.scene.audioManager.playSe("se_map_touch",.3)}catch(e){console.error("AreaSelectionManager: Error in handleTouchAt:",e)}}findAreaAtPosition(e,t){const a=20*(this.scene.mapManager?.mapScaleX||1);for(let s of this.areas)if(Math.sqrt(Math.pow(e-s.x,2)+Math.pow(t-s.y,2))<=a)return s;return null}getAreas(){return this.areas}findAreaByName(e){return this.areas.find((t=>t.name===e))}markAreaAsCompleted(e){this.completionManager.markAreaAsCompleted(e),this.updateAreaCompletionDisplay(e)}updateAreaCompletionDisplay(e){console.log("[AreaSelectionManager] updateAreaCompletionDisplay開始:",e),this.areaSprites.forEach((t=>{if(t&&t.getData("areaName")===e){console.log("[AreaSelectionManager] マーカー発見:",e);const a=t.getAt(0),s=t.getAt(1);if(a&&s){const e=a.getData("area"),{color:r,completed:n}=this._computeAreaColor(e),o=65280===r,i=16711680===r;if(console.log("[AreaSelectionManager] 色判定結果:",{color:r,completed:n,isGreen:o,isRed:i}),a.setFillStyle(r||4286945,i?.25:r?.3:.1),o)this.scene.tweens.add({targets:a,alpha:.6,duration:1500,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"});else try{this.scene.tweens.killTweensOf(a)}catch(e){}if(a.setData("isCompleted",!!n),s.setStyle({fill:o?"#00AA00":i?"#AA0000":"#000000",backgroundColor:o?"#90EE90":i?"#FFCCCC":"#FFFFFF"}),s.setData("isCompleted",!!n),o&&!t.getData("hasCheckmark")){const e=this.scene.add.text(0,0,"✓",{fontSize:"16px",fill:"#00AA00",fontFamily:"Arial"});e.setOrigin(.5),e.setPosition(a.x+(a.width||50)/2,a.y-10),t.add(e),t.setData("hasCheckmark",!0)}else if(!o&&t.getData("hasCheckmark")){const e=t.getAt(2);e&&e.destroy(),t.setData("hasCheckmark",!1)}}}}))}_computeAreaColor(e){try{if(!e)return{color:null,completed:!1};const t=e.conversationId||e.name;try{if(window.ChoiceManager){const e=new window.ChoiceManager,a=e.hasAnyChoiceRecorded(t);if(e.isEventCleared(t))return{color:65280,completed:!0};if(a)return{color:16711680,completed:!1}}}catch(e){}try{const e=localStorage.getItem("game_choices");if(e){const a=(JSON.parse(e)||{})[t]||{},s=Object.values(a);if(s.includes("correct"))return{color:65280,completed:!0};if(s.length>0)return{color:16711680,completed:!1}}}catch(e){}return"true"===localStorage.getItem("event_completed_"+t)?{color:65280,completed:!0}:{color:null,completed:!1}}catch(e){return{color:null,completed:!1}}}getCompletedAreas(){return this.completionManager.getCompletedAreas()}recreateMarker(e){try{const t=this.areaSprites.find((t=>t&&t.getData("areaName")===e));t&&t.destroy();const a=this.areas.find((t=>t.name===e));if(!a)return;this.createAreaMarker(a)&&this.completionManager.isAreaCompleted(e)&&this.updateAreaCompletionDisplay(e)}catch(t){console.error(`[AreaSelectionManager] マーカー ${e} の再作成に失敗:`,t)}}isConversationActive(){try{if(this.scene&&this.scene.scene){const e=this.scene.scene.get("ConversationScene");if(e&&e.scene&&e.scene.isActive())return!0}return!(!this.scene||!this.scene.conversationTrigger)&&this.scene.conversationTrigger.isActive()}catch(e){return console.warn("[AreaSelectionManager] 会話状態チェックエラー:",e),!1}}updateAreaPositions(e){e&&0!==e.length?(this.destroy(),this.scene&&this.scene.children&&this.scene.children.entries&&this.scene.children.entries.forEach((e=>{!e||"Container"!==e.type&&"Arc"!==e.type&&"Text"!==e.type||e.destroy&&e.destroy()})),this.areas=e.map((e=>{const t=this.areas.find((t=>t.name===e.name));let a=t?.sceneParam,s=t?.scene,r=t?.conversationId;if(!a||!s){const t=this.scene.mapConfig?.areas?.find((t=>t.name===e.name));t&&(a=t.sceneParam,s=t.scene,r=t.conversationId)}return{...e,sceneParam:a,scene:s,conversationId:r,description:this.getAreaDescription(e.name)}})),this.createAreaMarkers()):console.warn("AreaSelectionManager: No areas provided for marker update")}updateExistingMarkers(e){e&&Array.isArray(e)?(this.areas=e.map((e=>({...e,description:this.getAreaDescription(e.name)}))),this.areaSprites.forEach(((e,t)=>{if(e&&this.areas[t]){const a=this.areas[t];this.updateMarkerPosition(e,a)}}))):console.warn("[AreaSelectionManager] updateExistingMarkers: 無効なエリアデータ")}updateMarkerPosition(e,t){if(!e||!t)return;const a=this.scene.mapManager?.mapScaleX||1,s=Math.max(15,15*a);e.children&&e.children.entries&&e.children.entries.forEach((e=>{if(e&&e.getData&&"areaMarker"===e.getData("markerType"))if("Ellipse"===e.type||"Rectangle"===e.type){const a=t.x+(t.width||100)/2,s=t.y+(t.height||100)/2;e.setPosition(a,s),"Ellipse"===e.type?e.setRadius((t.width||100)/2,(t.height||100)/2):e.setSize(t.width||100,t.height||100)}else if("Text"===e.type){const r=t.x+(t.width||100)/2,n=t.y-s;e.setPosition(r,n);const o=10,i=Math.max(o,Math.floor(10*a))+"px";e.setStyle({fontSize:i})}}))}repositionMarkers(){const e=this.scene.mapManager?.mapScaleX||1,t=15*e;this.areaSprites.forEach(((a,s)=>{if(a&&this.areas[s]){const r=this.areas[s];a.children.entries.forEach((a=>{if("Arc"===a.type)a.setPosition(r.x,r.y),a.setRadius(10*e),a.setStrokeStyle(2*e,16777215);else if("Text"===a.type){a.setPosition(r.x,r.y-t);const s=Math.max(8,Math.floor(10*e))+"px";a.setStyle({fontSize:s})}}))}}))}destroy(){this.currentDialog&&this.currentDialog.active&&this.currentDialog.destroy(),this.isConfirmDialogActive=!1,this.currentDialog=null,this.forceRemoveGreenMarkers(),this.areaSprites&&Array.isArray(this.areaSprites)&&this.areaSprites.forEach(((e,t)=>{if(e)try{e.destroy&&e.destroy()}catch(e){console.warn(`[AreaSelectionManager] マーカー ${t} 削除エラー:`,e)}})),this.removeAllMarkerObjects(),this.areaSprites=[],this.selectedArea=null}removeAllMarkerObjects(){if(!this.scene||!this.scene.children||!this.scene.children.list)return;const e=[];[...this.scene.children.list].forEach((t=>{t&&t.getData&&"areaMarker"===t.getData("markerType")?e.push(t):t instanceof Phaser.GameObjects.Container&&t.each((a=>{a&&a.getData&&"areaMarker"===a.getData("markerType")&&(e.includes(t)||e.push(t))}))})),e.forEach((e=>{try{e.destroy&&e.destroy()}catch(e){console.warn("[AreaSelectionManager] オブジェクト削除エラー:",e)}}))}forceRemoveGreenMarkers(){if(!this.scene||!this.scene.children||!this.scene.children.list)return;const e=[];[...this.scene.children.list].forEach((t=>{if(t&&t.getData&&"areaMarker"===t.getData("markerType")){let a=!1;t instanceof Phaser.GameObjects.Container&&t.each((e=>{if(e&&void 0!==e.fillColor&&(65280!==e.fillColor&&9498256!==e.fillColor||(a=!0)),e&&e.style&&e.style.color){const t=e.style.color.toLowerCase();"#00ff00"!==t&&"#90ee90"!==t&&"#00aa00"!==t||(a=!0)}if(e&&e.style&&e.style.backgroundColor){const t=e.style.backgroundColor.toLowerCase();"#00ff00"!==t&&"#90ee90"!==t&&"#00aa00"!==t||(a=!0)}})),a&&e.push(t)}})),e.forEach((e=>{try{e.destroy&&e.destroy()}catch(e){console.warn("[AreaSelectionManager] 緑色マーカーコンテナ削除エラー:",e)}}))}}var g=a(728),d=a(296);class u{constructor(e){this.scene=e,this.tilemap=null,this.mapLayer=null,this.areas=[],this.mapWidth=0,this.mapHeight=0,this.mapScaleX=1,this.mapScaleY=1,this.scaledMapWidth=0,this.scaledMapHeight=0,this.currentMapKey=null,this.map=null,this.layers=[],this.npcSprites=new Map,this.objectGroup=null}createMap(e,t,a){return e&&t?this.createNewMap(e,t,a):this.createLegacyMap()}createNewMap(e){this.currentMapKey=e;try{if(this.tilemap=this.scene.make.tilemap({key:e}),this.map=this.tilemap,!this.tilemap)return void console.error("[MapManager] タイルマップの作成に失敗しました")}catch(e){throw console.error("[MapManager] タイルマップ作成エラー:",e),e}if(this.tilemap&&this.tilemap.tilesets&&this.tilemap.tilesets.length>0&&this.tilemap.tilesets.forEach((e=>{try{const t=Object.keys(this.scene.textures.list);let a=null;if(t.includes(e.name)&&(a=e.name),!a){const s=t.find((t=>e.name.includes(t)||t.includes(e.name)));s&&(a=s)}a&&this.tilemap&&this.tilemap.addTilesetImage(e.name,a)}catch(t){console.error(`[MapManager] タイルセット処理エラー: ${e.name}`,t)}})),!(this.tilemap&&this.tilemap.layers&&this.tilemap.layers.length>0))return console.error("[MapManager] Tiledマップにレイヤーが定義されていません"),this.tilemap;if(this.layers=[],this.tilemap.layers.forEach(((e,t)=>{try{if(this.tilemap&&this.tilemap.tilesets){const a=this.tilemap.createLayer(e.name,this.tilemap.tilesets,0,0);a&&(this.layers.push(a),0===t&&(this.mapLayer=a))}}catch(a){console.error(`[MapManager] ❌ レイヤー${t+1}作成エラー: ${e.name}`,a)}})),0===this.layers.length)return console.error("[MapManager] レイヤーが作成されていません"),this.tilemap;this.tilemap?(this.mapWidth=this.tilemap.widthInPixels||this.tilemap.width*this.tilemap.tileWidth||0,this.mapHeight=this.tilemap.heightInPixels||this.tilemap.height*this.tilemap.tileHeight||0):(this.mapWidth=0,this.mapHeight=0),this.scaleMapToScreen();const t=this.getObjectLayerName(e);this.extractAreaData(t),this.mapLayer&&(this.mapLayer.setVisible(!0),this.mapLayer.setDepth(0))}createLegacyMap(){try{const e=this.currentMapKey;if(!e)return void console.error("[MapManager] マップキーが設定されていません");if(this.tilemap=this.scene.make.tilemap({key:e}),this.map=this.tilemap,!this.tilemap)return void console.error("[MapManager] タイルマップの作成に失敗しました");if(e&&(e.includes("taketa_highschool")||e.includes("mie_high_school"))){if(this.tilemap&&this.tilemap.tilesets&&this.tilemap.tilesets.length>0&&this.tilemap.tilesets.forEach((e=>{try{const t=Object.keys(this.scene.textures.list);let a=null;if(t.includes(e.name)&&(a=e.name),!a){const s=t.find((t=>t.includes(e.name)));s&&(a=s)}a&&this.tilemap.addTilesetImage(e.name,a)}catch(t){console.error(`[MapManager] タイルセット処理エラー: ${e.name}`,t)}})),this.tilemap&&this.tilemap.layers&&this.tilemap.layers.length>0){if(this.layers=[],this.tilemap.layers.forEach(((e,t)=>{try{const a=[];this.tilemap.tilesets.forEach((e=>{if(e&&e.name){const t=Object.keys(this.scene.textures.list).find((t=>t.includes(e.name)));if(t){const s=this.tilemap.addTilesetImage(e.name,t);s&&a.push(s)}}})),0===a.length&&console.warn(`[MapManager] ⚠️ レイヤー${t+1}用の実際のタイルセットがありません: ${e.name}`);const s=this.tilemap.createLayer(e.name,a,0,0);if(s){let a;a=e.name.includes("床")?0:50+t,s.setDepth(a),s.setVisible(!0),this.layers.push(s),0===t&&(this.mapLayer=s)}}catch(a){console.error(`[MapManager] ❌ レイヤー${t+1}作成エラー: ${e.name}`,a)}})),this.mapWidth=this.tilemap.widthInPixels||this.tilemap.width*this.tilemap.tileWidth||0,this.mapHeight=this.tilemap.heightInPixels||this.tilemap.height*this.tilemap.tileHeight||0,this.tilemap){const e=["オブジェクトレイヤー1","オブジェクトレイヤー2","オブジェクトレイヤー3"];console.log("[MapManager] オブジェクトレイヤー処理開始"),console.log(`[MapManager] tilemap情報: 幅=${this.tilemap.width}, 高さ=${this.tilemap.height}, タイル幅=${this.tilemap.tileWidth}, タイル高さ=${this.tilemap.tileHeight}`),e.forEach((e=>{const t=this.tilemap.getObjectLayer(e);if(t){const a=t.width||this.tilemap.widthInPixels||this.tilemap.width*this.tilemap.tileWidth||0,s=t.height||this.tilemap.heightInPixels||this.tilemap.height*this.tilemap.tileHeight||0;console.log(`[MapManager] オブジェクトレイヤー発見: ${e}, 幅: ${a}, 高さ: ${s}`),t.width=a,t.height=s,this.processObjectLayer(e)}else console.warn(`[MapManager] オブジェクトレイヤーが見つかりません: ${e}`)}))}else console.warn("[MapManager] tilemapが存在しません");if(this.tilemap&&this.tilemap.layers){const e=this.tilemap.layers.filter((e=>"objectgroup"===e.type));e.length>0&&this.extractAreaData(e[0].name)}}}else console.log("[MapManager] 従来のタイルセット処理は現在無効化されています")}catch(e){console.error("[MapManager] createLegacyMapエラー:",e)}}processObjectLayer(e){try{if(!this.tilemap)return void console.warn("[MapManager] tilemapが存在しません");const t=this.tilemap.getObjectLayer(e);if(!t)return void console.warn(`[MapManager] オブジェクトレイヤー '${e}' が見つかりません`);if(this.objectGroup||(this.objectGroup=this.scene.physics.add.staticGroup()),"オブジェクトレイヤー1"===e){console.log("[MapManager] 壁レイヤー処理開始（オブジェクトレイヤー1）");const e=t.objects.filter((e=>"wall"===e.type));e.length>0&&(console.log(`[MapManager] 壁オブジェクト ${e.length}個 を発見`),e.forEach(((e,t)=>{this.createWallObject(e,t)})));const a=t.objects.filter((e=>"wall"!==e.type));return void(a.length>0&&console.warn(`[MapManager] 壁レイヤーにwall以外のオブジェクト: ${a.map((e=>`${e.type} (${e.name})`)).join(", ")}`))}if("オブジェクトレイヤー2"===e){console.log("[MapManager] NPCレイヤー処理開始（オブジェクトレイヤー2）");const e=t.objects.filter((e=>"npc"===e.type));e.length>0&&(console.log(`[MapManager] NPCオブジェクト ${e.length}個 を発見`),console.log("[MapManager] NPCオブジェクトの詳細:",e.map((e=>({name:e.name,type:e.type,x:e.x,y:e.y})))),e.forEach((e=>{this.createNPCObject(e)})));const a=t.objects.filter((e=>"npc"!==e.type));return void(a.length>0&&console.warn(`[MapManager] NPCレイヤーにnpc以外のオブジェクト: ${a.map((e=>`${e.type} (${e.name})`)).join(", ")}`))}if("オブジェクトレイヤー3"===e){console.log("[MapManager] 移動レイヤー処理開始（オブジェクトレイヤー3）");const e=t.objects.filter((e=>"move"===e.type));e.length>0&&(console.log(`[MapManager] 移動オブジェクト ${e.length}個 を発見`),e.forEach(((e,t)=>{this.createMoveObject(e,t)})));const a=t.objects.filter((e=>"move"!==e.type));return void(a.length>0&&console.warn(`[MapManager] 移動レイヤーにmove以外のオブジェクト: ${a.map((e=>`${e.type} (${e.name})`)).join(", ")}`))}this.processGenericObjects(t,e)}catch(e){console.error("[MapManager] オブジェクトレイヤー処理エラー:",e)}}createWallObject(e,t){const a=e.width||32,s=e.height||32,r=e.name||`wall_${t}`,n=this.scene.add.rectangle(0,0,a,s,0,.5);this.processGenericObjectSetup(n,e,"wall",r),this.objectGroup.add(n),console.log(`[MapManager] 壁オブジェクト作成: ${r}, サイズ: ${a}x${s}`)}createNPCObject(e){const t=e.name||"npc";if(this.scene.stageConfig&&this.scene.stageConfig.currentFloor&&this.scene.stageConfig.currentFloor.npcs){const e=this.scene.stageConfig.currentFloor.npcs.find((e=>e.name===t));if(e&&e.sprite)return void console.log(`[MapManager] スプライト定義済みのNPCをスキップ: ${t} (StageSceneで管理)`)}const a=e.width||32,s=e.height||32,r=this.scene.add.rectangle(0,0,a,s,65280,.5);this.processGenericObjectSetup(r,e,"npc",t),this.objectGroup.add(r),r.setData("npcId",t),r.setData("npcType","npc"),r.setInteractive(),r.on("pointerdown",(()=>{this.makeNPCLookAtPlayer(r),this.scene.dialogSystem&&this.scene.dialogSystem.startDialog(t)}));const n=this.scene.add.text(r.x,r.y-s/2-10,`${t} (npc)`,{fontSize:"12px",fill:"#ffffff",backgroundColor:"#000000",padding:{x:2,y:1}});n.setOrigin(.5,1),n.setDepth(1e3),console.log(`[MapManager] NPCオブジェクト作成（▢マーク）: ${t}, サイズ: ${a}x${s}`)}getNPCObjectData(e){if(!this.map)return console.warn("[MapManager] マップが読み込まれていません"),null;const t=this.map.objects;for(let a=0;a<t.length;a++){const s=t[a];if(s.objects)for(let t=0;t<s.objects.length;t++){const a=s.objects[t];if(a.name===e)return{x:a.x+(a.width||32)/2,y:a.y-(a.height||32)/2,width:a.width||32,height:a.height||32,properties:a.properties||{}}}}return console.warn(`[MapManager] NPCオブジェクトが見つかりません: ${e}`),null}createNPCSprite(e,t){try{const a=this.scene.add.sprite(e.x,e.y,t);a.setFrame(0),a.setDisplaySize(48,48),this.scene.physics.add.existing(a),a.body.setSize(32,32),a.setInteractive(),a.on("pointerdown",(()=>{if(console.log(`[MapManager] NPCクリック: ${t}`),this.scene.stageConfig&&this.scene.stageConfig.currentFloor&&this.scene.stageConfig.currentFloor.npcs){const e=this.scene.stageConfig.currentFloor.npcs.find((e=>e.name===t));e&&e.eventId?(console.log(`[MapManager] eventIdベースの会話開始: ${t} -> ${e.eventId}`),this.scene.startConversation?this.scene.startConversation(e.eventId):console.error("[MapManager] startConversationメソッドが存在しません")):(console.log(`[MapManager] DialogSystemで会話開始: ${t}`),this.scene.dialogSystem?this.scene.dialogSystem.startDialog(t):console.log("[MapManager] DialogSystemが初期化されていません"))}else console.log(`[MapManager] DialogSystemで会話開始: ${t}`),this.scene.dialogSystem?this.scene.dialogSystem.startDialog(t):console.log("[MapManager] DialogSystemが初期化されていません")}));const s=this.scene.add.text(a.x,a.y-24,`${t} (sprite)`,{fontSize:"12px",fill:"#ffffff",backgroundColor:"#000000",padding:{x:2,y:1}});s.setOrigin(.5,1),s.setDepth(1e3),console.log(`[MapManager] NPCスプライト作成完了: ${t} at (${e.x}, ${e.y})`)}catch(e){console.error(`[MapManager] NPCスプライト作成エラー: ${t}`,e)}}createNPCTexture(e,t,a){const s=this.scene.add.graphics();s.fillStyle(65280),s.fillRect(0,0,t,a),s.lineStyle(2,32768),s.strokeRect(0,0,t,a),s.generateTexture(e,t,a),s.destroy()}createMoveObject(e,t){const a=e.width||32,s=e.height||32,r=e.name||`move_${t}`,n=this.scene.add.rectangle(0,0,a,s,255,.5);this.processGenericObjectSetup(n,e,"move",r),this.objectGroup.add(n),n.setData("moveId",r),n.setData("moveType","move");const o=this.scene.add.text(n.x,n.y-s/2-10,`${r} (move)`,{fontSize:"12px",fill:"#ffffff",backgroundColor:"#000000",padding:{x:2,y:1}});o.setOrigin(.5,1),o.setDepth(1e3),console.log(`[MapManager] moveオブジェクト作成: ${r}, サイズ: ${a}x${s}`),"move_3"===r&&console.log("[MapManager] ⭐ move_3オブジェクトを発見！物理ボディ設定:",n.body)}processGenericObjects(e,t){console.log(`[MapManager] 汎用レイヤー処理: ${t}`);const a=["wall","npc","move"];e.objects.forEach(((e,t)=>{if(a.includes(e.type))return void console.log(`[MapManager] ${e.type}オブジェクトは専用メソッドで処理済み: ${e.name}`);let s=e.x||0,r=e.y||0;const n=this.tilemap.scale||this.tilemap.scaleX||1;1!==n&&(s*=n,r*=n),s+=this.tilemap.x||this.tilemap.scrollX||0,r+=this.tilemap.y||this.tilemap.scrollY||0,this.mapLayer&&(s+=this.mapLayer.x||0,r+=this.mapLayer.y||0);const o=e.width||32,i=e.height||32,c=e.type||"object",h=e.name||`object_${t}`,l=s+o/2,p=r+i/2;let g=8421504;"item"===c?g=16766720:"enemy"===c&&(g=16711680);const d=this.scene.add.rectangle(l,p,o,i,g,.5);this.scene.physics.add.existing(d,!0),this.objectGroup.add(d);const u=this.scene.add.text(l,p-i/2-10,`${h} (${c})`,{fontSize:"12px",fill:"#ffffff",backgroundColor:"#000000",padding:{x:2,y:1}});u.setOrigin(.5,1),u.setDepth(1e3),d.setData("objectType",c),d.setData("objectName",h),d.setData("objectId",e.id),console.log(`[MapManager] 汎用オブジェクト作成: ${h} (${c}), 座標: (${l}, ${p}), サイズ: ${o}x${i}`)}))}processGenericObjectSetup(e,t,a,s){let r=t.x||0,n=t.y||0;const o=this.tilemap.scale||this.tilemap.scaleX||1;1!==o&&(r*=o,n*=o),r+=this.tilemap.x||this.tilemap.scrollX||0,n+=this.tilemap.y||this.tilemap.scrollY||0,this.mapLayer&&(r+=this.mapLayer.x||0,n+=this.mapLayer.y||0);const i=r+(t.width||32)/2,c=n+(t.height||32)/2;e.setPosition(i,c),this.scene.physics.add.existing(e,!0),e.setData("objectType",a),e.setData("objectName",s),e.setData("objectId",t.id)}scaleMapToScreen(){const e=this.scene.cameras.main.width,t=this.scene.cameras.main.height,a=e/this.mapWidth,s=t/this.mapHeight,r=Math.min(a,s);if(this.scene.cameraManager&&(this.scene.cameraManager.currentScale=r),this.mapScaleX=r,this.mapScaleY=r,this.mapLayer){this.mapLayer.setScale(this.mapScaleX,this.mapScaleY);const a=(e-this.mapWidth*this.mapScaleX)/2,s=(t-this.mapHeight*this.mapScaleY)/2;this.mapLayer.setPosition(a,s)}if(this.scaledMapWidth=this.mapWidth*this.mapScaleX,this.scaledMapHeight=this.mapHeight*this.mapScaleY,this.scene.cameraManager){this.scene.cameraManager.camera.setBounds(0,0,e,t),this.scene.cameraManager.camera.setBackgroundColor("#87CEEB");const a=this.mapLayer?this.mapLayer.x:0,s=this.mapLayer?this.mapLayer.y:0;this.scene.cameraManager.camera.centerOn(a+this.scaledMapWidth/2,s+this.scaledMapHeight/2)}this.updateObjectPositions(this.mapScaleX)}getObjectLayerName(){return this.currentMapKey&&this.currentMapKey.includes("highschool")?"オブジェクトレイヤー1":this.currentMapKey&&this.currentMapKey.includes("taketa")&&!this.currentMapKey.includes("highschool")?"taketa":this.currentMapKey&&this.currentMapKey.includes("miemachi")?"miemachi":this.currentMapKey&&this.currentMapKey.includes("japan")?"japan":"オブジェクトレイヤー1"}extractAreaData(e=null){if(!e){const t=this.scene.mapConfig?.mapKey||"taketa";e=this.getObjectLayerName(t)}if(console.log("[MapManager] extractAreaData開始: mapKey="+this.scene.mapConfig?.mapKey+", objectLayerName="+e),!e)return void console.warn(`MapManager: No object layer name found for mapKey '${this.scene.mapConfig?.mapKey}'`);let t=null;console.log("[MapManager] 利用可能なレイヤー:",this.tilemap.layers.map((e=>({name:e.name,type:e.type}))));try{"function"==typeof this.tilemap.getObjectLayer&&(t=this.tilemap.getObjectLayer(e),console.log("[MapManager] getObjectLayer結果:",t))}catch(e){console.error("[MapManager] getObjectLayerエラー:",e)}if(!t&&Array.isArray(this.tilemap.objects)&&(console.log("[MapManager] tilemap.objects:",this.tilemap.objects),t=this.tilemap.objects.find((t=>t&&t.name===e)),console.log("[MapManager] tilemap.objects検索結果:",t)),t||console.warn(`[MapManager] オブジェクトレイヤー'${e}'が見つかりません`),t&&t.objects)console.log("[MapManager] オブジェクトレイヤー発見: "+e+", オブジェクト数: "+t.objects.length),this.areas=[],this.areas=t.objects.map((e=>({id:e.id,name:e.name,originalX:e.x,originalY:e.y,originalWidth:e.width,originalHeight:e.height,x:e.x*this.mapScaleX+(this.mapLayer?this.mapLayer.x:0),y:e.y*this.mapScaleY+(this.mapLayer?this.mapLayer.y:0),width:e.width*this.mapScaleX,height:e.height*this.mapScaleY,ellipse:e.ellipse||!1,rotation:e.rotation||0,type:e.type||"location"}))),console.log("[MapManager] エリアデータ抽出完了: "+this.areas.length+"個");else{console.warn(`[MapManager] Object layer '${e}' not found or has no objects`);const t=this.tilemap.layers.find((e=>"objectgroup"===e.type));t&&this.extractAreaData(t.name)}}handleResize(){this.scaleMapToScreen();const e=this.scene.mapConfig?.mapKey||this.currentMapKey;if(e){const t=this.getObjectLayerName(e);this.extractAreaData(t)}}createFallbackImage(e){const t=this.scene.add.graphics();t.fillStyle(65280),t.fillRect(0,0,32,32),t.generateTexture(e,32,32),t.destroy()}getTilemap(){return this.tilemap}getMapLayer(){return this.mapLayer}getAreas(){return this.areas}getMapSize(){return{width:this.mapWidth,height:this.mapHeight,scaledWidth:this.scaledMapWidth,scaledHeight:this.scaledMapHeight}}getMapScale(){return{scaleX:this.mapScaleX,scaleY:this.mapScaleY}}updateObjectPositions(e){if(this.areas&&this.areas.length>0){const t=this.mapLayer?this.mapLayer.x:0,a=this.mapLayer?this.mapLayer.y:0;this.areas.forEach((s=>{s.x=s.originalX*e+t,s.y=s.originalY*e+a,s.width=s.originalWidth*e,s.height=s.originalHeight*e})),this.scaledMapWidth=this.mapWidth*e,this.scaledMapHeight=this.mapHeight*e,this.scene.areaSelectionManager&&this.scene.areaSelectionManager.updateAreaPositions([...this.areas])}else console.warn("MapManager: No areas available for position update")}getObjectGroup(){return this.objectGroup}getNpcSprite(e){return this.npcSprites.get(e)}makeNpcFacePlayer(e,t,a){const s=this.getNpcSprite(e);if(!s)return void console.warn(`NPC sprite not found: ${e}`);const r=t-s.x,n=a-s.y;let o,i;switch(o=Math.abs(r)>Math.abs(n)?r>0?"right":"left":n>0?"down":"up",o){case"down":default:i=1;break;case"left":i=4;break;case"right":i=7;break;case"up":i=10}s.setFrame(i)}destroy(){this.layers&&this.layers.length>0&&(this.layers.forEach((e=>{e&&e.destroy&&e.destroy()})),this.layers=[]),this.mapLayer&&this.mapLayer.destroy&&(this.mapLayer.destroy(),this.mapLayer=null),this.tilemap&&this.tilemap.destroy&&(this.tilemap.destroy(),this.tilemap=null),this.map&&this.map.destroy&&(this.map.destroy(),this.map=null),this.npcSprites&&(this.npcSprites.forEach((e=>{e&&e.destroy&&e.destroy()})),this.npcSprites.clear()),this.objectGroup&&this.objectGroup.destroy&&(this.objectGroup.destroy(),this.objectGroup=null),this.areas=[],this.mapWidth=0,this.mapHeight=0,this.mapScaleX=1,this.mapScaleY=1,this.scaledMapWidth=0,this.scaledMapHeight=0}makeNPCLookAtPlayer(e){if(!this.scene.playerController||!this.scene.playerController.player)return;const t=this.scene.playerController.player,a=e,s=t.x-a.x,r=t.y-a.y,n=Math.sqrt(s*s+r*r);if(n>0){const e=s/n,t=r/n;Math.abs(t)>Math.abs(e)?t<0?a.setFillStyle(65280,.8):a.setFillStyle(52224,.8):e<0?a.setFillStyle(43520,.8):a.setFillStyle(34816,.8)}}}class m{constructor(e){this.scene=e,this.camera=e.cameras.main,this.zoom=1,this.followTarget=null,this.bounds=null,this.currentScale=null}setupCamera(e,t,a){if(1===arguments.length&&"object"==typeof e&&e.width){const t=e;this.camera.setZoom(this.zoom);const a=this.scene.mapManager?.mapLayer,s=a?a.x:0,r=a?a.y:0,n=this.scene.cameras.main.width,o=this.scene.cameras.main.height;this.camera.setBounds(0,0,n,o),this.camera.centerOn(s+t.scaledWidth/2,r+t.scaledHeight/2)}else if(3===arguments.length){const s=e,r=t.widthInPixels,n=t.heightInPixels;s.cameras.main.setBounds(0,0,r,n),s.cameras.main.startFollow(a),s.physics.world.setBounds(0,0,r,n)}}setZoom(e){this.zoom=e,this.camera.setZoom(e)}centerOn(e,t){this.camera.centerOn(e,t)}setFollowTarget(e,t=.1){this.followTarget=e,this.camera.startFollow(e,!0,t,t)}stopFollow(){this.followTarget=null,this.camera.stopFollow()}setBackgroundColor(e){this.camera.setBackgroundColor(e)}fadeIn(e=1e3,t){this.camera.fadeIn(e,0,0,0,t)}fadeOut(e=1e3,t){this.camera.fadeOut(e,0,0,0,t)}shake(e=100,t=.02){this.camera.shake(e,t)}flash(e=100,t=16777215){this.camera.flash(e,t)}getBounds(){return this.bounds}getZoom(){return this.zoom}getWorldPoint(e,t){return this.camera.getWorldPoint(e,t)}getScreenPoint(e,t){return this.camera.getScreenPoint(e,t)}update(){}setupScrollControls(){let e=!1,t={x:0,y:0},a={x:0,y:0};this.scene.input.on("pointerdown",(s=>{e=!0,t={x:s.x,y:s.y},a={x:this.camera.scrollX,y:this.camera.scrollY}})),this.scene.input.on("pointermove",(s=>{if(e){const e=t.x-s.x,r=t.y-s.y,n=a.x+e,o=a.y+r;this.camera.setScroll(n,o)}})),this.scene.input.on("pointerup",(()=>{e=!1}))}setupPinchZoom(){let e=0,t=1;this.scene.input.on("pointerdown",(()=>{if(this.scene.input.pointers&&2===this.scene.input.pointers.length){const a=this.scene.input.pointers[0],s=this.scene.input.pointers[1];e=Phaser.Math.Distance.Between(a.x,a.y,s.x,s.y),t=this.camera.zoom}})),this.scene.input.on("pointermove",(()=>{if(this.scene.input.pointers&&2===this.scene.input.pointers.length){const a=this.scene.input.pointers[0],s=this.scene.input.pointers[1],r=Phaser.Math.Distance.Between(a.x,a.y,s.x,s.y)/e,n=Math.max(.5,Math.min(3,t*r));this.camera.setZoom(n)}}))}toggleMapScale(){if(1.5===(this.scene.mapManager?.mapScaleX||this.currentScale)){const e=this.scene.cameras.main.width,t=this.scene.cameras.main.height,a=e/this.scene.mapManager.mapWidth,s=t/this.scene.mapManager.mapHeight,r=Math.min(a,s);this.setMapScale(r)}else this.setMapScale(1.5)}setMapScale(e){if(this.currentScale=e,!this.scene.mapManager||!this.scene.mapManager.mapLayer)return;this.scene.mapManager.mapLayer.setScale(e,e),this.scene.mapManager.mapScaleX=e,this.scene.mapManager.mapScaleY=e;const t=this.scene.cameras.main.width,a=this.scene.cameras.main.height,s=this.scene.mapManager.mapWidth*e,r=this.scene.mapManager.mapHeight*e,n=(t-s)/2,o=(a-r)/2;if(this.scene.mapManager.mapLayer.setPosition(n,o),this.scene.mapManager.updateObjectPositions(e),this.scene.areaSelectionManager){const e=this.scene.mapManager.getAreas(),t=this.scene.mapConfig.areas,a=e.map((e=>{const a=t.find((t=>t.name===e.name));return{...e,scene:a?.scene||null}}));this.scene.areaSelectionManager.setupAreas(a)}1.5===e?this.camera.setBounds(n,o,s,r):(this.camera.setBackgroundColor("#87CEEB"),this.camera.setBounds(0,0,t,a)),this.camera.centerOn(n+s/2,o+r/2),console.log(`CameraManager: Scale changed to ${e}, map position: (${n}, ${o}), size: (${s}, ${r})`)}destroy(){this.stopFollow(),this.followTarget=null,this.bounds=null}}var x=a(364),k=a(863);class y{constructor(e){this.scene=e,this.scene.scene.key,this.conversationManager=new i.TaketaConversationManager,this.choiceManager=new k.ChoiceManager,this.isConversationActive=!1,this.triggeredEvents=new Set,this.currentConversationId=null,this.currentChoiceButtons=[]}getEventIdFromNPCName(e){const t=this.scene.stageConfig?.currentFloor;if(!t||!t.npcs)return console.warn("[ConversationTrigger] フロア設定またはNPC設定が見つかりません"),null;const a=t.npcs.find((t=>t.name===e));return a?a.eventId:(console.warn(`[ConversationTrigger] NPC ${e} の設定が見つかりません`),null)}startConversation(e){if(!this.isConversationActive){if(window.LoadingManager&&window.LoadingManager.show("会話を読み込み中...",0),this.isConversationActive=!0,this.scene.setConversationActive&&this.scene.setConversationActive(!0),!e)return console.error("[ConversationTrigger] イベントIDが渡されていません"),this.isConversationActive=!1,void(this.scene.setConversationActive&&this.scene.setConversationActive(!1));if(this.currentConversationId=e,this.scene.scene.launch("DynamicConversationScene",{eventId:e,originalSceneKey:this.scene.scene.key}),window.LoadingManager){console.log("[ConversationTrigger] 会話ローディング監視開始");let e=0;const t=200,a=()=>{e++,console.log(`[ConversationTrigger] 会話読み込みチェック ${e}/${t}`);const s=this.scene.scene.get("DynamicConversationScene");if(s&&s.resourcesLoaded)return console.log("[ConversationTrigger] 会話読み込み完了"),window.LoadingManager.updateProgress(100,"完了！"),void setTimeout((()=>{window.LoadingManager.hide()}),300);e>=t?window.LoadingManager.hide():setTimeout(a,100)};a()}}}startVisualNovelConversation(e,t=null,a=null){if(!this.scene||!this.scene.scene)return void console.warn("[ConversationTrigger] Scene is not available for conversation");this.currentConversationId=a||t,this.isConversationActive&&(this.scene.scene.stop("ConversationScene"),this.isConversationActive=!1);const s=this.scene.scene.get("ConversationScene");s&&s.scene.isActive()&&this.scene.scene.stop("ConversationScene"),this.isConversationActive=!0;const r={...e,areaName:t};try{const e=this.scene.scene,t=e.get("ConversationScene");if(!t)return console.error("[ConversationTrigger] ConversationScene not found"),void(this.isConversationActive=!1);if(!t.scene.isActive())return void this.scene.scene.launch("DynamicConversationScene",{eventId:a});try{try{e.bringToTop("ConversationScene")}catch(e){}t.scene.setVisible(!0),t.scene.setActive(!0),t.startConversation(r)}catch(e){console.error("[ConversationTrigger] start on active error:",e),this.isConversationActive=!1}try{t.events.once("conversationEnded",(()=>{try{e.stop("ConversationScene")}catch(e){}this.isConversationActive=!1})),t.events.once("conversationInterrupted",(()=>{try{e.stop("ConversationScene")}catch(e){}this.isConversationActive=!1}))}catch(e){}}catch(e){console.error("[ConversationTrigger] startVisualNovelConversation()でエラーが発生:",e),console.error("[ConversationTrigger] エラースタック:",e.stack),this.isConversationActive=!1}}startSimpleDialog(e){this.scene.collisionManager&&this.scene.collisionManager.getDialogSystem()&&this.scene.collisionManager.getDialogSystem().startDialog(e)}setupNpcClickHandler(e,t){e.setInteractive(),e.on("pointerdown",(()=>{this.isConversationActive||this.startConversation(t)}))}setupAreaTrigger(e,t,a,s,r){const n=this.scene.add.rectangle(e,t,a,s,0,0);return n.setInteractive(),this.scene.physics.add.existing(n),n.body.setSize(a,s),this.scene.physics.add.overlap(this.scene.playerController.player,n,(()=>{this.isConversationActive||this.triggeredEvents.has(r)||(this.triggeredEvents.add(r),this.startConversation(r))}),null,this.scene),n}setupProximityTrigger(e,t,a,s){const r=this.scene.add.circle(e,t,a,0,0);return this.scene.physics.add.existing(r),r.body.setCircle(a),this.scene.physics.add.overlap(this.scene.playerController.player,r,(()=>{this.isConversationActive||this.triggeredEvents.has(s)||(this.triggeredEvents.add(s),this.startConversation(s))}),null,this.scene),r}isActive(){return this.isConversationActive}destroy(){this.isConversationActive&&(this.scene.scene.stop("ConversationScene"),this.isConversationActive=!1),this.triggeredEvents.clear(),this.scene=null,this.conversationManager&&(this.conversationManager=null)}showChoices(e,t){this.clearChoiceButtons(),e.forEach(((e,a)=>{const s=this.createChoiceButton(e,t,a);this.currentChoiceButtons.push(s)}))}createChoiceButton(e,t,a){const s=this.scene.cameras.main.centerX,r=this.scene.cameras.main.centerY+100+60*a,n=this.scene.add.container(s,r),o=this.scene.add.graphics();o.fillStyle(2763306,.9),o.fillRoundedRect(-100,-25,200,50,8),n.add(o);const i=this.scene.add.text(0,0,e.text,{fontSize:"16px",fill:"#ffffff",fontFamily:"Arial"}).setOrigin(.5);return n.add(i),n.setInteractive(new Phaser.Geom.Rectangle(-100,-25,200,50),Phaser.Geom.Rectangle.Contains),n.on("pointerdown",(()=>{this.handleChoice(e,t)})),n.on("pointerover",(()=>{o.fillStyle(4868682,.9),o.fillRoundedRect(-100,-25,200,50,8)})),n.on("pointerout",(()=>{o.fillStyle(2763306,.9),o.fillRoundedRect(-100,-25,200,50,8)})),n}handleChoice(e,t){this.choiceManager.saveChoice(this.currentConversationId,t,e.result),this.clearChoiceButtons(),e.nextMessages&&this.showChoiceMessages(e.nextMessages),this.choiceManager.checkEndingCondition()&&(this.scene.endingUnlocked=!0)}showChoiceMessages(e){if(this.scene.scene.isActive("DynamicConversationScene")){const t=this.scene.scene.get("DynamicConversationScene");t&&t.showMessages&&t.showMessages(e)}}clearChoiceButtons(){this.currentChoiceButtons.forEach((e=>{e&&e.destroy&&e.destroy()})),this.currentChoiceButtons=[]}checkEndingCondition(){return this.choiceManager.checkEndingCondition()}}class S extends Phaser.Scene{constructor(){super({key:"ConversationScene"}),this.currentConversationIndex=0,this.currentConversation=null,this.isTextAnimating=!1,this.textSpeed=30,this.originalBgm=null,this.eventBgm=null,this.nameboxLeftMargin=30,this._eventBgmStarted=!1,this._originalBgmKey=null,this._eventHtmlBgm=null,this._pausedHtmlMapBgm=!1,this.currentChoiceButtons=[],this.choiceManager=null,this.uiManager=null,this._hasAnyChoices=!1}init(e){this.audioManager=e.audioManager,this._pendingConversation=e&&e.conversations?e.conversations:null,this.originalSceneKey=e&&e.originalSceneKey?e.originalSceneKey:null,this.areaName=e&&e.areaName?e.areaName:null,this.currentState=e&&e.currentState?e.currentState:null,this.conversationId=e&&e.conversationId?e.conversationId:null,this.originalSceneKey&&(this.originalSceneKey=this.originalSceneKey.replace(/\s+/g,""))}create(){if(!this.sys)return void console.error("[ConversationScene] this.sys が undefined です");if(!this.sys.game)return void console.error("[ConversationScene] this.sys.game が undefined です");this.cleanupCharacterSprites(),this.currentTextTimer&&(this.currentTextTimer.destroy(),this.currentTextTimer=null);const e=this.sys?.game?.canvas?.width||this.sys?.game?.config?.width||800,t=this.sys?.game?.canvas?.height||this.sys?.game?.config?.height||600,s=t>e;if(this.characterContainer=this.add.container(0,0),Promise.resolve().then(a.bind(a,728)).then((({UIManager:e})=>{this.uiManager=new e(this),this.uiManager.createConversationBackButton(this)})).catch((e=>{console.error("[ConversationScene] UIManager初期化エラー:",e)})),this.disableBackgroundInteraction(),this.textures.exists("textbox"))this.textbox=this.add.image(e/2,t-80,"textbox");else{const a=s?e-20:e-60,r=s?140:90;this.textbox=this.add.rectangle(e/2,t-(s?70:60),a,r,0,.9),this.textbox.setStrokeStyle(2,16777215,1)}if(this.textbox.setOrigin(.5,.5),this.textures.exists("namebox"))this.namebox=this.add.image(this.nameboxLeftMargin,t-123,"namebox");else{const a=Math.min(200,.3*e),s=Math.min(30,.1*t);this.namebox=this.add.rectangle(this.nameboxLeftMargin,t-123,a,s,3355443,.9),this.namebox.setStrokeStyle(2,8947848,.8)}this.namebox.setOrigin(0,.5);try{this.textbox&&void 0!==this.textbox.depth&&this.namebox.setDepth(this.textbox.depth+1)}catch(e){}this.createDecorationsForConversationUI();const r=s?0:20,n=Math.min((this.textbox?.displayWidth||e-60)-(r+20),800),o=e<600?"18px":"22px",i=this.textbox?.displayWidth||e-60,c=this.textbox?.displayHeight||(s?140:120),h=(this.textbox?.x||e/2)-i/2+r,l=(this.textbox?.y||t-(s?70:60))-c/2+7;this.dialogText=this.add.text(h,l,"",{fontSize:o,fill:"#ffffff",lineSpacing:8,padding:{x:10,y:10},wordWrap:{width:n,useAdvancedWrap:!0}}),this.dialogText.setOrigin(0,0),this.dialogText&&this.dialogText.setShadow&&this.dialogText.setShadow(2,2,"#000000",4,!1,!0);try{const t=(this.textbox?.x||e/2)-i/2+r,a=l-10,n=Math.max(1,(this.textbox?.displayWidth||e-60)-(r+20)),o=Math.max(1,(this.textbox?.displayHeight||(s?140:90))-20);this._textMaskGraphics=this.add.graphics(),this._textMaskGraphics.fillStyle(16777215,1),this._textMaskGraphics.fillRect(t,a,n,o);const c=this._textMaskGraphics.createGeometryMask();this.dialogText.setMask(c),this._textMaskGraphics.setVisible(!1)}catch(e){}const p=e<600?"16px":"20px";this.nameText=this.add.text(this.nameboxLeftMargin+(this.namebox.displayWidth||0)/2,t-130,"",{fontSize:p,fill:"#ffffff",fontStyle:"bold",padding:{x:10,y:10},fixedHeight:50}),this.nameText.setOrigin(.5,s?.35:.4);try{this.namebox&&void 0!==this.namebox.depth&&this.nameText.setDepth(this.namebox.depth+1)}catch(e){}this.nameText&&this.nameText.setShadow&&this.nameText.setShadow(1,1,"#000000",3,!1,!0);try{const e=this.namebox?.displayWidth||0;this.nameText.setPosition(this.nameboxLeftMargin+e/2,this.namebox.y)}catch(e){}this._repositionNamebox(e,t),this.redrawNameboxDecorations&&this.redrawNameboxDecorations(),this.input.removeAllListeners("pointerdown"),this.input.on("pointerdown",(()=>{this.currentChoiceButtons&&this.currentChoiceButtons.length>0||this.nextDialog()})),this.input.keyboard.on("keydown-SPACE",(()=>{this.nextDialog()}));try{!this._onResizeBound&&this.scale&&this.scale.on&&(this.scale.on("resize",this.resize,this),this._onResizeBound=!0),this.events.once("shutdown",(()=>{try{this._onResizeBound&&this.scale&&this.scale.off&&this.scale.off("resize",this.resize,this)}catch(e){}this._onResizeBound=!1}))}catch(e){}if(this._pendingConversation){try{this.startConversation(this._pendingConversation)}catch(e){console.error("[ConversationScene] pending conversation start error:",e)}this._pendingConversation=null}}interruptConversation(){try{try{this._eventHtmlBgm&&(this._eventHtmlBgm.pause(),this._eventHtmlBgm=null)}catch(e){console.warn("[ConversationScene] イベントBGM停止エラー:",e)}this.restoreOriginalBgm(),this.cleanupCharacterSprites(),this.cleanupBackButton(),this.currentTextTimer&&(this.currentTextTimer.destroy(),this.currentTextTimer=null),this.resetUI(),this.events.emit("conversationInterrupted");try{const e=this.scene.get("MiemachiStage")||this.scene.get("TaketastageStage")||this.scene.get("JapanStage");e&&e.conversationTrigger&&(e.conversationTrigger.isConversationActive=!1)}catch(e){console.warn("[ConversationScene] ConversationTriggerフラグリセットエラー:",e)}this.returnToOriginalScene()}catch(e){console.error("[ConversationScene] Error in interruptConversation:",e);try{this.returnToOriginalScene()}catch(e){console.error("[ConversationScene] Error returning to original scene:",e)}}}resetUI(){this.dialogText&&this.dialogText.setText(""),this.nameText&&this.nameText.setText(""),this.background&&(this.background.destroy(),this.background=null),this.textboxDecoFrame&&(this.textboxDecoFrame.destroy(),this.textboxDecoFrame=null),this.textboxDecoShine&&(this.textboxDecoShine.destroy(),this.textboxDecoShine=null),this.nameboxDecoFrame&&(this.nameboxDecoFrame.destroy(),this.nameboxDecoFrame=null),this.nameboxDecoShine&&(this.nameboxDecoShine.destroy(),this.nameboxDecoShine=null)}createDecorationsForConversationUI(){this.redrawTextboxDecorations(),this.redrawNameboxDecorations()}redrawTextboxDecorations(){if(!this.textbox)return;const e=this.textbox.displayWidth||this.textbox.width||0,t=this.textbox.displayHeight||this.textbox.height||0,a=(this.textbox.x||0)-e/2,s=(this.textbox.y||0)-t/2,r=Math.max(8,Math.min(20,Math.floor(t/3)));this.textboxDecoFrame||(this.textboxDecoFrame=this.add.graphics());const n=this.textboxDecoFrame;n.clear(),n.lineStyle(3,16758741,.9),n.strokeRoundedRect(a-4,s-4,e+8,t+8,r+6),n.lineStyle(2,12966143,.9),n.strokeRoundedRect(a+2,s+2,e-4,t-4,Math.max(6,r-4)),n.fillStyle(16770802,.95),n.fillCircle(a+10,s+10,3),n.fillCircle(a+e-10,s+10,3),n.fillCircle(a+10,s+t-10,3),n.fillCircle(a+e-10,s+t-10,3),this.textboxDecoShine||(this.textboxDecoShine=this.add.graphics());const o=this.textboxDecoShine;o.clear(),o.fillStyle(16777215,.1);const i=Math.max(8,Math.floor(.22*t));o.fillRoundedRect(a+6,s+6,e-12,i,Math.max(4,r-6))}redrawNameboxDecorations(){if(!this.namebox)return;const e=this.namebox.displayWidth||this.namebox.width||0,t=this.namebox.displayHeight||this.namebox.height||0,a=this.namebox.x||0,s=(this.namebox.y||0)-t/2,r=Math.max(6,Math.min(14,Math.floor(t/2)));this.nameboxDecoFrame||(this.nameboxDecoFrame=this.add.graphics());const n=this.nameboxDecoFrame;n.clear(),n.lineStyle(2,13154047,.9),n.strokeRoundedRect(a-6,s-4,e+12,t+8,r+4),n.lineStyle(2,16758741,.9),n.strokeRoundedRect(a+1,s+1,e-2,t-2,Math.max(4,r-2)),n.fillStyle(16770802,.95),n.fillCircle(a+6,s+t/2,2.5),n.fillCircle(a+e-6,s+t/2,2.5),this.nameboxDecoShine||(this.nameboxDecoShine=this.add.graphics());const o=this.nameboxDecoShine;o.clear(),o.fillStyle(16777215,.12);const i=Math.max(4,Math.floor(.4*t));o.fillRoundedRect(a+4,s+3,e-8,i,Math.max(3,r-3))}startConversation(e){this.currentConversation=e,this.currentConversationIndex=0,this._hasAnyChoices=!1,this.areaName&&(this.currentConversation.areaName=this.areaName),this.events.emit("conversationStarted");try{const e=this.scene.get("mie_high_school")||this.scene.get("TaketastageStage")||this.scene.get("JapanStage");e&&e.audioManager&&e.audioManager.bgm&&(this._originalBgmKey=e.audioManager.bgm.key)}catch(e){console.warn("[ConversationScene] 元のBGMキー取得エラー:",e)}e.background&&this.updateBackground(e.background),e.bgm&&this.switchToEventBgm(e.bgm);try{const e=this.scene.get("mie_high_school")||this.scene.get("TaketastageStage")||this.scene.get("JapanStage");if(e){if(e._suppressMapBgm=!0,e._bgmRetry&&e._bgmRetry.remove){try{e._bgmRetry.remove(!1)}catch(e){}e._bgmRetry=null}try{e._htmlBgm&&!e._htmlBgm.paused&&e._htmlBgm.pause()}catch(e){}}}catch(e){}this.showDialog()}nextDialog(){console.log("[ConversationScene] nextDialog開始:",{currentIndex:this.currentConversationIndex,totalLength:this.currentConversation.conversations.length}),this.isTextAnimating?this.completeTextAnimation():this.currentChoiceButtons&&this.currentChoiceButtons.length>0||(this.currentConversationIndex++,this.currentConversationIndex<this.currentConversation.conversations.length?this.showDialog():(console.log("[ConversationScene] 会話終了、endConversation呼び出し"),this.endConversation()))}showDialog(){console.log("[ConversationScene] showDialog開始:",{currentIndex:this.currentConversationIndex,totalLength:this.currentConversation.conversations.length});const e=this.currentConversation.conversations[this.currentConversationIndex],t=!e.speaker||"narrator"===e.character;t?this.characterSprites&&Object.values(this.characterSprites).forEach((e=>{e&&e.setVisible&&e.setVisible(!1)})):(this.characterSprites&&Object.values(this.characterSprites).forEach((e=>{e&&e.setVisible&&e.setVisible(!0)})),this.updateCharacterSprite(e.character,e.expression),this.layoutVisibleCharacters()),t?(this.nameText.setText(""),this.namebox&&this.namebox.setVisible(!1),this.nameText&&this.nameText.setVisible(!1),this.nameboxDecoFrame&&this.nameboxDecoFrame.setVisible(!1),this.nameboxDecoShine&&this.nameboxDecoShine.setVisible(!1)):(this.namebox&&this.namebox.setVisible(!0),this.nameText&&this.nameText.setVisible(!0),this.nameText.setText(e.speaker||""),e.speaker&&this.adjustNameboxWidth(e.speaker)),e.text&&""!==e.text.trim()?(this.animateText(e.text),this.textbox&&(this.textbox.setVisible(!0),this.textbox.setStrokeStyle(2,16777215,1)),this.dialogText&&this.dialogText.setVisible(!0),this.namebox&&(this.namebox.setVisible(!0),this.namebox.setStrokeStyle(2,8947848,.8)),this.nameText&&this.nameText.setVisible(!0),this.textboxDecoFrame&&this.textboxDecoFrame.setVisible(!0),this.textboxDecoShine&&this.textboxDecoShine.setVisible(!0),this.nameboxDecoFrame&&this.nameboxDecoFrame.setVisible(!0),this.nameboxDecoShine&&this.nameboxDecoShine.setVisible(!0)):(this.textbox&&(this.textbox.setVisible(!1),this.textbox.setStrokeStyle(0,0,0)),this.dialogText&&this.dialogText.setVisible(!1),this.namebox&&(this.namebox.setVisible(!1),this.namebox.setStrokeStyle(0,0,0)),this.nameText&&this.nameText.setVisible(!1),this.textboxDecoFrame&&this.textboxDecoFrame.setVisible(!1),this.textboxDecoShine&&this.textboxDecoShine.setVisible(!1),this.nameboxDecoFrame&&this.nameboxDecoFrame.setVisible(!1),this.nameboxDecoShine&&this.nameboxDecoShine.setVisible(!1)),e.background&&this.updateBackground(e.background),"reset"===e.speaker&&(this.cleanupCharacterSprites(),e.character&&e.expression?(this.updateCharacterSprite(e.character,e.expression),this.characterContainer?this.characterContainer.setVisible(!0):console.warn("[ConversationScene] characterContainerがnullです")):console.warn("[ConversationScene] reset後、characterまたはexpressionが指定されていません")),"narrator"===e.speaker?this.characterContainer&&this.characterContainer.setVisible(!1):e.character&&e.expression?(this.updateCharacterSprite(e.character,e.expression),this.characterContainer&&this.characterContainer.setVisible(!0)):this.characterContainer&&this.characterContainer.setVisible(!0),e.se&&this.playDialogSE(e.se),"choice"===e.type&&(this._hasAnyChoices=!0,this.showChoices(e.choices,e.choiceId))}updateCharacterSprite(e,t){if(this.characterSprites||(this.characterSprites={}),this.characterContainer){if(e&&t){const a=this.resolveExistingSpriteKey(e,t);if(!a)return void console.warn("[ConversationScene] no spriteKey found, returning");const s=this.sys?.game?.canvas?.width||this.sys?.game?.config?.width||800,r=this.sys?.game?.canvas?.height||this.sys?.game?.config?.height||600;let n={x:.5*s,y:.4*r};if(this.characterSprites[e]){const t=this.characterSprites[e];t.texture.key!==a&&(t.setTexture(a),this.applyPortraitScale(t))}else{const t=this.add.image(n.x,n.y,a);t.setOrigin(.5,.5);const s=this.getPortraitTargetScale(t.width,t.height);t.height*s>=.95*r&&(n={...n,y:.5*r},t.setPosition(n.x,n.y)),t.setAlpha(0),t.setScale(Math.max(.1,.9*s)),this.characterContainer.add(t),this.characterSprites[e]=t,this.tweens.add({targets:t,alpha:1,scaleX:s,scaleY:s,duration:500,ease:"Power2"})}this.dimOtherCharacters(e)}}else console.warn("characterContainer is not initialized yet")}resolveExistingSpriteKey(e,t){const a=[];a.push({ch:e,ex:t});const s=["L","A","B","C","D","E","F","G","H","I","J","K","M","N","R","S"];if(s.forEach((s=>{s!==t&&a.push({ch:e,ex:s})})),/_young$/.test(e)){const r=e.replace(/_young$/,"");a.push({ch:r,ex:t}),s.forEach((e=>{e!==t&&a.push({ch:r,ex:e})}))}for(const{ch:e,ex:t}of a){const a=`${e}_${t}`;if(this.textures&&this.textures.exists&&this.textures.exists(a))return a}return null}layoutVisibleCharacters(){if(!this.characterSprites)return;const e=Object.values(this.characterSprites).filter((e=>e&&!1!==e.visible)),t=e.length;if(0===t)return;const a=this.sys?.game?.canvas?.width||this.sys?.game?.config?.width||800,s=this.sys?.game?.canvas?.height||this.sys?.game?.config?.height||600;if(s>a){const r=Math.floor(.32*s),n=Math.floor(.58*s),o=.1*a,i=.9*a,c=t<=2?.8:t<=3?.75:.65,h=Math.min(3,t),l=e=>{if(e<=0)return[];if(1===e)return[.5*a];if(2===e)return[.35*a,.65*a];const t=i-o;return[0,1,2].slice(0,e).map((a=>o+t*(a/(e-1))))},p=l(Math.max(0,t-h)),g=l(h),d=[],u=[];e.forEach(((e,t)=>{const a=this.getPortraitTargetScale(e.width,e.height)*c;if(t<h)e.setPosition(g[t],n),d.push(e);else{const a=t-h;e.setPosition(p[a],r),u.push(e)}e.setScale(a)}));try{d.forEach((e=>{try{this.characterContainer.bringToTop(e)}catch(e){}}))}catch(e){}return}const r=.08*a,n=.92*a,o=.5*a,i=e.map((e=>this.getPortraitTargetScale(e.width,e.height))),c=e.map(((e,t)=>e.width*i[t]));let h=1.05*Math.max.apply(null,c);const l=n-r;t>1&&(h=Math.min(h,l/(t-1)));const p=new Array(t),g=(t-1)/2;for(let e=0;e<t;e++){const t=e-g;p[e]=o+t*h}const d=r,u=n,m=p[0],x=p[t-1];let k=0;if(m<d&&(k=d-m),x>u&&(k=Math.min(k,u-x)),0!==k)for(let e=0;e<t;e++)p[e]+=k;e.forEach(((e,t)=>{const a=i[t],r=e.height*a>=.95*s?.5*s:.4*s,n=Math.max(0,r-30);e.setPosition(p[t],n),this.applyPortraitScale(e)}))}getPortraitTargetScale(e,t){const a=this.sys?.game?.canvas?.width||this.sys?.game?.config?.width||800,s=this.sys?.game?.canvas?.height||this.sys?.game?.config?.height||600,r=Math.max(1,s),n=Math.max(1,a),o=r/Math.max(1,t),i=n/Math.max(1,e);return Math.min(o,i)}applyPortraitScale(e){if(!e||!e.texture)return;const t=e.width,a=e.height,s=this.getPortraitTargetScale(t,a);e.setScale(s)}dimOtherCharacters(e){this.characterSprites&&Object.keys(this.characterSprites).forEach((t=>{const a=this.characterSprites[t];t===e?(a.setTint(16777215),a.setAlpha(1),a.setScale(1.2*a.scaleX,1.2*a.scaleY)):(a.setTint(6710886),a.setAlpha(.8),a.setScale(a.scaleX/1.2,a.scaleY/1.2),this.tweens.killTweensOf(a))}))}isMobile(){return/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)}animateText(e){if(this.isTextAnimating=!0,this.dialogText.setText(""),this.adjustTextDisplayHeight(e),this.isMobile())return this.dialogText.setText(e),void(this.isTextAnimating=!1);let t="",a=0;const s=this.time.addEvent({delay:this.textSpeed,callback:()=>{a<e.length?(t+=e[a],this.dialogText.setText(t),a++):(this.isTextAnimating=!1,s.destroy())},loop:!0});this.currentTextTimer=s}adjustTextDisplayHeight(){}adjustNameboxWidth(e){if(!this.namebox||!this.nameText)return;const t=this.sys?.game?.canvas?.width||this.sys?.game?.config?.width||800,a=Math.min(600,.6*t);this.nameText.setText(e);const s=this.nameText.width,r=Math.max(160,Math.min(a,s+30));if(this.textures.exists("namebox"));else{const e=this.namebox.displayHeight;this.namebox.setDisplaySize(r,e),this.namebox.setStrokeStyle(2,8947848,.8)}const n=this.namebox?.displayWidth||0;this.nameText.setPosition(this.nameboxLeftMargin+n/2,this.namebox.y),this.redrawNameboxDecorations&&this.redrawNameboxDecorations()}completeTextAnimation(){this.currentTextTimer&&this.currentTextTimer.destroy();const e=this.currentConversation.conversations[this.currentConversationIndex];this.dialogText.setText(e.text),this.adjustTextDisplayHeight(e.text),this.isTextAnimating=!1}updateBackground(e){if(e&&this.textures.exists(e)){this.background&&this.background.destroy();const t=this.sys?.game?.canvas?.width||this.sys?.game?.config?.width||800,a=this.sys?.game?.canvas?.height||this.sys?.game?.config?.height||600;this.background=this.add.image(t/2,a/2,e),this.background.setOrigin(.5,.5),this._fitConversationBackground(),this.background.setDepth(-1)}}_fitConversationBackground(){if(!this.background)return;const e=this.sys?.game?.canvas?.width||this.sys?.game?.config?.width||800,t=this.sys?.game?.canvas?.height||this.sys?.game?.config?.height||600,a=this.background.texture,s=a&&a.getSourceImage?a.getSourceImage():null,r=s&&s.width||this.background.width,n=s&&s.height||this.background.height;this.background.setScale(1);const o=t/n,i=e/r,c=Math.max(i,o);this.background.setScale(c),this.background.setPosition(e/2,t/2)}async switchToEventBgm(e){this.stopOriginalBgm(),e&&this.audioManager&&(await this.audioManager.playConversationBgm(e,void 0,!0)?(this._eventBgmStarted=!0,this.audioManager.bgm?this._eventHtmlBgm=this.audioManager.bgm:console.warn("[ConversationScene] AudioManagerからBGMオブジェクトが取得できません")):console.warn("[ConversationScene] イベントBGM開始失敗:",e))}stopOriginalBgm(){try{const e=this.scene.get("Stage1Scene")||this.scene.get("Stage2Scene")||this.scene.get("Stage3Scene")||this.scene.get("MiemachiStage")||this.scene.get("TaketastageStage")||this.scene.get("JapanStage");e&&e.audioManager&&e.audioManager.stopBgm(!1),e&&e._htmlBgm&&(e._htmlBgm.pause(),this._pausedHtmlMapBgm=!0)}catch(e){console.warn("[ConversationScene] stopOriginalBgm error:",e)}}async getOriginalBgmKeyAsync(e){try{if(e&&e.audioManager){const t=await e.audioManager.getDefaultBgmKey();this._originalBgmKey=t}}catch(e){console.warn("[ConversationScene] 非同期BGMキー取得エラー:",e),this._originalBgmKey="bgm_default"}}async restoreOriginalBgm(){try{try{this._eventHtmlBgm&&(this._eventHtmlBgm.pause(),this._eventHtmlBgm=null),this.audioManager&&this.audioManager.bgm&&(this.audioManager.bgm.pause(),this.audioManager.bgm=null),this._eventBgmStarted&&(this._eventBgmStarted=!1)}catch(e){console.warn("[ConversationScene] イベントBGM停止エラー:",e)}if(this.originalSceneKey){const e=this.scene.manager;if(e){const t=e.getScene(this.originalSceneKey);if(t&&t.audioManager){try{const e=await t.audioManager.getDefaultBgmKey();t.audioManager.playBgm(e,void 0,!0)}catch(e){console.warn("[ConversationScene] BGM再開エラー:",e)}try{t._suppressMapBgm=!1}catch(e){}}}}else{const e=this.scene.get("Stage1Scene")||this.scene.get("Stage2Scene")||this.scene.get("Stage3Scene")||this.scene.get("MiemachiStage")||this.scene.get("TaketastageStage")||this.scene.get("JapanStage")||this.scene.get("taketa_highschool")||this.scene.get("mie_high_school");if(e&&e.audioManager){try{const t=await e.audioManager.getDefaultBgmKey();e.audioManager.playBgm(t,void 0,!0)}catch(e){console.warn("[ConversationScene] マップBGM再開失敗:",e)}try{e._suppressMapBgm=!1}catch(e){}}}}catch(e){console.error("[ConversationScene] restoreOriginalBgm エラー:",e)}}async endConversation(){console.log("[ConversationScene] endConversation開始");try{this.events.emit("conversationEnded");try{console.log("[ConversationScene] 会話結果通知開始");const e=this.scene.manager,t=this.originalSceneKey?e.getScene(this.originalSceneKey):null;console.log("[ConversationScene] originalScene:",t?"見つかった":"見つからない",this.originalSceneKey);let s=!1,r=!!this._hasAnyChoices;if(r)try{if(!this.choiceManager)if(window.ChoiceManager)this.choiceManager=window.ChoiceManager.getInstance();else{const e=await Promise.resolve().then(a.bind(a,863));this.choiceManager=e.ChoiceManager.getInstance()}this.choiceManager&&this.conversationId&&(s=!!this.choiceManager.isEventCleared(this.conversationId),console.log("[ConversationScene] 選択肢ありイベント判定:",{conversationId:this.conversationId,cleared:s,choices:this.choiceManager.choices[this.conversationId]}))}catch(e){console.warn("[ConversationScene] ChoiceManager判定失敗:",e)}else s=!0,console.log("[ConversationScene] 選択肢なしイベント:",{conversationId:this.conversationId,cleared:s});if(!r&&this.conversationId)try{localStorage.setItem("event_completed_"+this.conversationId,"true")}catch(e){}t&&t.events&&this.conversationId&&(console.log("[ConversationScene] conversation-endedイベント発火:",{eventId:this.conversationId,cleared:s,hasChoices:r}),t.events.emit("conversation-ended",{eventId:this.conversationId,cleared:s,hasChoices:r}))}catch(e){console.warn("[ConversationScene] 会話結果通知エラー:",e)}this.markAreaAsCompleted(),this.restoreOriginalBgm(),this.cleanupCharacterSprites(),this.cleanupBackButton(),this.currentTextTimer&&(this.currentTextTimer.destroy(),this.currentTextTimer=null),this.resetUI(),this.returnToOriginalScene()}catch(e){console.error("[ConversationScene] Error in endConversation:",e);try{this.returnToOriginalScene()}catch(e){console.error("[ConversationScene] Error returning to original scene:",e)}}}returnToOriginalScene(){if("taketa_highschool"===this.originalSceneKey)try{const e=this.scene.manager.getScene("taketa_highschool");e&&e.setConversationActive&&e.setConversationActive(!1)}catch(e){console.warn("[ConversationScene] StageSceneのフラグリセットエラー:",e)}else if("mie_high_school"===this.originalSceneKey)try{const e=this.scene.manager.getScene("mie_high_school");e&&e.setConversationActive&&e.setConversationActive(!1)}catch(e){console.warn("[ConversationScene] StageSceneのフラグリセットエラー（三重町）:",e)}if(this.restoreOriginalBgm(),this.originalSceneKey)try{!this.currentState||"taketa_highschool"!==this.originalSceneKey&&"mie_high_school"!==this.originalSceneKey?(this.scene.stop(),this.scene.start(this.originalSceneKey)):(this.scene.stop(),this.scene.start(this.originalSceneKey,{restoreState:!0,targetFloor:this.currentState.floor,playerPosition:this.currentState.playerPosition,mapKey:this.currentState.mapKey}))}catch(e){console.error("[ConversationScene] 元のシーン復元エラー:",e),this.scene.start(this.originalSceneKey)}else console.error("[ConversationScene] 元のシーンキーが設定されていません");this.scene.stop()}markAreaAsCompleted(){try{if(this.currentConversation&&this.currentConversation.areaName){const e=this.currentConversation.areaName;this.completedAreaName=e}}catch(e){console.error("[ConversationScene] エリア完了設定エラー:",e)}}cleanupCharacterSprites(){this.characterSprites&&(Object.values(this.characterSprites).forEach((e=>{e&&e.destroy&&e.destroy()})),this.characterSprites={}),this.characterContainer&&this.characterContainer.removeAll()}cleanupBackButton(){}resize(e){const{width:t,height:a}=e;if(this.background)try{this._fitConversationBackground()}catch(e){this.background.setPosition(t/2,a/2);const s=t/this.background.width,r=a/this.background.height,n=Math.max(s,r);this.background.setScale(n)}if(this.textbox){const e=a>t;if(this.textures.exists("textbox"))this.textbox.setPosition(t/2,a-(e?70:60));else{const s=e?t-20:t-60,r=e?140:90;this.textbox.setDisplaySize(s,r),this.textbox.setPosition(t/2,a-(e?70:60)),this.textbox.setStrokeStyle(2,16777215,1)}this.redrawTextboxDecorations&&this.redrawTextboxDecorations()}if(this.namebox){if(this.textures.exists("namebox"))this._repositionNamebox(t,a);else{const e=Math.min(200,.3*t),s=Math.min(30,.1*a);this.namebox.setDisplaySize(e,s),this._repositionNamebox(t,a),this.namebox.setStrokeStyle(2,8947848,.8)}this.redrawNameboxDecorations&&this.redrawNameboxDecorations()}if(this.dialogText){const e=a>t,s=e?0:20,r=20,n=Math.min((this.textbox?.displayWidth||t-60)-(s+r),800),o=t<600?"18px":"24px",i=this.textbox?.displayWidth||t-60,c=this.textbox?.displayHeight||(e?140:120),h=(this.textbox?.x||t/2)-i/2+s,l=(this.textbox?.y||a-(e?70:60))-c/2+2;this.dialogText.setPosition(h,l),this.dialogText.setWordWrapWidth(n),this.dialogText.setFontSize(o),this.dialogText.setShadow&&this.dialogText.setShadow(2,2,"#000000",4,!1,!0);try{this._textMaskGraphics&&this._textMaskGraphics.destroy(),this._textMaskGraphics=this.add.graphics(),this._textMaskGraphics.fillStyle(16777215,1);const a=(this.textbox?.x||t/2)-i/2+s,n=l-10,o=Math.max(1,(this.textbox?.displayWidth||t-60)-(s+r)),c=Math.max(1,(this.textbox?.displayHeight||(e?140:90))-20);this._textMaskGraphics.fillRect(a,n,o,c);const h=this._textMaskGraphics.createGeometryMask();this._textMaskGraphics.setVisible(!1),this.dialogText.setMask(h)}catch(e){}}if(this.nameText){const e=t<600?"16px":"20px",a=this.namebox?.displayWidth||0;this.nameText.setPosition(this.nameboxLeftMargin+a/2,this.namebox.y),this.nameText.setFontSize(e),this.nameText.setShadow&&this.nameText.setShadow(1,1,"#000000",3,!1,!0),this.nameText.text&&""!==this.nameText.text&&this.adjustNameboxWidth(this.nameText.text)}this.currentChoiceButtons&&this.currentChoiceButtons.length>0&&this.repositionChoiceButtons(t,a)}repositionCharacterSprites(){this.layoutVisibleCharacters()}repositionChoiceButtons(e,t){if(!this.currentChoiceButtons||0===this.currentChoiceButtons.length)return;const a=t>e,s=this.currentChoiceButtons.length;let r=a?50:0;s>=3&&(r+=30),this.currentChoiceButtons.forEach(((a,n)=>{if(a&&a.setPosition){const o=e/2;let i;i=s>=3?t-250+70*n-r:t-200+60*n-r,a.setPosition(o,i)}}))}_repositionNamebox(e,t){try{const e=this.textbox;if(!e||!this.namebox)return;const a=e.displayHeight||90,s=(e.y||t-60)-a/2-20;if(this.namebox.setPosition(this.nameboxLeftMargin,s),this.nameText){const e=this.namebox.displayWidth||0;this.nameText.setPosition(this.nameboxLeftMargin+e/2,s)}}catch(e){}}playDialogSE(e){this.audioManager?this.audioManager.playSe(e):console.warn("[ConversationScene] AudioManagerが見つかりません:",this.audioManager)}disableBackgroundInteraction(){this.input.on("pointerdown",(e=>{if(this.currentChoiceButtons&&this.currentChoiceButtons.length>0&&!this.currentChoiceButtons.some((t=>{if(t&&t.getBounds){const a=t.getBounds();return e.x>=a.x&&e.x<=a.x+a.width&&e.y>=a.y&&e.y<=a.y+a.height}return!1})))return!1;return!(e.x<50||e.x>150||e.y<50||e.y>100)&&void 0}))}showChoices(e,t){this.clearChoiceButtons();const a=e.length;this.currentChoiceButtons.length>0&&(console.warn("[ConversationScene] 警告: 選択肢ボタンが既に存在します"),this.clearChoiceButtons()),e.forEach(((e,s)=>{const r=this.createChoiceButton(e,t,s,a);this.currentChoiceButtons.push(r)}))}createChoiceButton(e,t,a,s){const r=this.sys?.game?.canvas?.width||this.sys?.game?.config?.width||800,n=this.sys?.game?.canvas?.height||this.sys?.game?.config?.height||600,o=s||1;let i=n>r?50:0;o>=3&&(i+=30);const c=r/2;let h;h=o>=3?n-250+70*a-i:n-200+60*a-i;const l=this.add.container(c,h),p=this.add.graphics();p.fillStyle(2763306,.9),p.fillRoundedRect(-150,-30,300,60,10),l.add(p);const g=this.add.text(0,0,e.text,{fontSize:"18px",fill:"#ffffff",fontFamily:"Arial",wordWrap:{width:280,useAdvancedWrap:!0},align:"center"}).setOrigin(.5);return l.add(g),l.setInteractive(new Phaser.Geom.Rectangle(-150,-30,300,60),Phaser.Geom.Rectangle.Contains),l.on("pointerdown",(()=>{this.handleChoice(e,t)})),l.on("pointerover",(()=>{p.fillStyle(4868682,.9),p.fillRoundedRect(-150,-30,300,60,10)})),l.on("pointerout",(()=>{p.fillStyle(2763306,.9),p.fillRoundedRect(-150,-30,300,60,10)})),l}async handleChoice(e,t){if(console.log("[ConversationScene] handleChoice開始:",{conversationId:this.conversationId,choiceId:t,result:e.result}),this.conversationId){if(!this.choiceManager)if(window.ChoiceManager)this.choiceManager=window.ChoiceManager.getInstance();else{const{ChoiceManager:e}=await Promise.resolve().then(a.bind(a,863));this.choiceManager=e.getInstance()}try{this.choiceManager.saveChoice(this.conversationId,t,e.result),console.log("[ConversationScene] 選択保存完了:",{conversationId:this.conversationId,choiceId:t,result:e.result}),console.log("[ConversationScene] 保存後のChoiceManager状態:",this.choiceManager.choices)}catch(e){console.error("[ConversationScene] 選択保存エラー:",e)}}else console.warn("[ConversationScene] conversationIdが設定されていません");this.clearChoiceButtons(),e.nextMessages?(console.log("[ConversationScene] nextMessages発見:",e.nextMessages),this.showChoiceMessages(e.nextMessages)):console.log("[ConversationScene] nextMessagesが存在しません")}showChoiceMessages(e){console.log("[ConversationScene] showChoiceMessages開始:",e),this.displayChoiceMessagesSequentially(e,0)}displayChoiceMessagesSequentially(e,t){if(console.log("[ConversationScene] displayChoiceMessagesSequentially:",{index:t,totalLength:e.length}),t>=e.length)return console.log("[ConversationScene] 全ての選択後メッセージ表示完了、共通会話に移行"),void this.skipToCommonDialog();const a=e[t];console.log("[ConversationScene] 選択後メッセージ表示:",a),this.displaySingleMessage(a),this.input.removeAllListeners("pointerdown"),this.input.once("pointerdown",(()=>{console.log("[ConversationScene] クリック検出、次のメッセージに進む"),this.displayChoiceMessagesSequentially(e,t+1)}))}displaySingleMessage(e){e.speaker&&"narrator"!==e.character?(this.characterSprites&&Object.values(this.characterSprites).forEach((e=>{e&&e.setVisible&&e.setVisible(!0)})),this.updateCharacterSprite(e.character,e.expression),this.layoutVisibleCharacters()):this.characterSprites&&Object.values(this.characterSprites).forEach((e=>{e&&e.setVisible&&e.setVisible(!1)})),e.speaker&&"narrator"!==e.character?(this.namebox&&(this.namebox.setVisible(!0),this.namebox.setStrokeStyle(2,8947848,.8)),this.nameText&&this.nameText.setVisible(!0),this.nameText.setText(e.speaker||""),e.speaker&&this.adjustNameboxWidth(e.speaker),this.nameboxDecoFrame&&this.nameboxDecoFrame.setVisible(!0),this.nameboxDecoShine&&this.nameboxDecoShine.setVisible(!0)):(this.nameText.setText(""),this.namebox&&this.namebox.setVisible(!1),this.nameText&&this.nameText.setVisible(!1),this.nameboxDecoFrame&&this.nameboxDecoFrame.setVisible(!1),this.nameboxDecoShine&&this.nameboxDecoShine.setVisible(!1)),this.textbox&&(this.textbox.setVisible(!0),this.textbox.setStrokeStyle(2,16777215,1)),this.dialogText&&this.dialogText.setVisible(!0),this.dialogContainer&&this.dialogContainer.setVisible(!0),this.textboxDecoFrame&&this.textboxDecoFrame.setVisible(!0),this.textboxDecoShine&&this.textboxDecoShine.setVisible(!0),this.animateText(e.text),e.background&&this.updateBackground(e.background),e.se&&this.playDialogSE(e.se)}skipToCommonDialog(){const e=this.currentConversation.conversations;let t=this.currentConversationIndex;for(;t<e.length;){const a=e[t];if("choice"!==a.type&&!a.choiceId)break;t++}this.input.removeAllListeners("pointerdown"),this.input.on("pointerdown",(()=>{this.currentChoiceButtons&&this.currentChoiceButtons.length>0||this.nextDialog()})),this.currentConversationIndex=t,this.showDialog()}clearChoiceButtons(){this.currentChoiceButtons&&this.currentChoiceButtons.forEach((e=>{e&&e.destroy&&e.destroy()})),this.currentChoiceButtons=[]}}class b extends Phaser.Scene{constructor(e){super({key:e.sceneKey}),this.mapConfig=e.mapConfig,this.mapId=e.mapId,this.mapManager=null,this.areaSelectionManager=null,this.uiManager=null,this.cameraManager=null,this.audioManager=null,this.visualFeedbackManager=null,this.isMobile=!1,this.scaleToggleButton=null,this.scaleToggleButtonGraphics=null,this._bgmStarted=!1,this._suppressMapBgm=!1,this._bgmRetry=null,this._isInConversation=!1,this.choiceManager=null,this.endingButton=null}preload(){const e=this.mapConfig.folderName||this.mapId,t=this.mapConfig.mapFileName||this.mapConfig.mapKey,a=this.mapConfig.tilesetFileName||this.mapConfig.tilesetKey;this.load.tilemapTiledJSON(this.mapConfig.mapKey,`assets/maps/${e}/${t}.tmj`),this.load.image(this.mapConfig.tilesetKey,`assets/maps/${e}/${a}.png`),this.load.on("fileerror",(e=>{console.error(`File not found: ${e.key}, path: ${e.url}`)})),this.load.on("progress",(e=>{window.LoadingManager&&window.LoadingManager.updateProgress(100*e)})),this.load.on("loaderror",(e=>{console.error(`[MapSelectionStage] ファイル読み込みエラー: ${e.key}, error:`,e),window.LoadingManager&&window.LoadingManager.hide()})),this.loadMinimalResources(),this.load.on("fileerror",(e=>{console.warn(`File not found: ${e.key}, using fallback`),this.mapManager?.createFallbackImage(e.key)})),this.load.on("complete",(()=>{window.LoadingManager&&(window.LoadingManager.updateProgress(100,"完了！"),setTimeout((()=>{window.LoadingManager.hide()}),500)),this.createMap()}))}setupConversationEventListeners(){this.events.on("conversationStarted",(()=>{this._isInConversation=!0})),this.events.on("conversationEnded",(()=>{this._isInConversation=!1})),this.events.on("conversationInterrupted",(()=>{this._isInConversation=!1}))}checkAndShowEndingButton(){if(console.log("[MapSelectionStage] エンディングボタンの表示条件をチェック中..."),window.__justReset)return void console.log("[MapSelectionStage] リセット直後のため、エンディングボタンの表示をスキップします");if(!this.choiceManager)return void console.log("[MapSelectionStage] ChoiceManagerが初期化されていません");this.choiceManager.choices=this.choiceManager.loadChoices(),console.log("[MapSelectionStage] 選択データを再読み込みしました"),this.choiceManager.debugChoices();const e=this.choiceManager.checkEndingCondition();console.log("[MapSelectionStage] エンディング条件達成:",e),e?(console.log("[MapSelectionStage] エンディングボタンを表示します"),this.showEndingButton()):(console.log("[MapSelectionStage] エンディング条件未達成のため、ボタンを表示しません"),console.log("[MapSelectionStage] 現在の選択データ:",this.choiceManager.choices))}showEndingButton(){const e=this.sys.game.canvas.width,t=this.sys.game.canvas.height,a=200,s=e-100-20,r=t-25-20,n=this.add.container(s,r),o=this.add.graphics();o.fillStyle(9127187,.9),o.fillRoundedRect(-100,-25,a,50,10),n.add(o);const i=this.add.text(0,0,"エンディング",{fontSize:"20px",fill:"#FFFFFF",fontFamily:"Arial",fontStyle:"bold"}).setOrigin(.5);n.add(i),n.setInteractive(new Phaser.Geom.Rectangle(-100,-25,a,50),Phaser.Geom.Rectangle.Contains),n.on("pointerdown",(()=>{this.startEnding()})),n.on("pointerover",(()=>{o.fillStyle(10506797,.9),o.fillRoundedRect(-100,-25,a,50,10)})),n.on("pointerout",(()=>{o.fillStyle(9127187,.9),o.fillRoundedRect(-100,-25,a,50,10)})),this.endingButton=n}startEnding(){this.sound&&this.sound.stopAll&&this.sound.stopAll(),this._htmlBgm&&(this._htmlBgm.pause(),this._htmlBgm=null),this._eventHtmlBgm&&(this._eventHtmlBgm.pause(),this._eventHtmlBgm=null),window.game&&window.game.sound&&window.game.sound.stopAll(),window.game&&window.game.scene&&window.game.scene.getScenes&&((window.game.scene.getScenes(!1)||[]).forEach(((e,t)=>{try{e.sound&&e.sound.stopAll&&e.sound.stopAll(),e._htmlBgm&&(e._htmlBgm.pause(),e._htmlBgm=null),e._eventHtmlBgm&&(e._eventHtmlBgm.pause(),e._eventHtmlBgm=null)}catch(e){console.error(`[MapSelectionStage] シーン${t}のBGM停止エラー:`,e)}})),console.log("[MapSelectionStage] 全シーンのBGM停止完了"));try{window.audioManager&&(console.log("[MapSelectionStage] AudioManagerのBGM停止開始"),window.audioManager.stopAll&&window.audioManager.stopAll(),window.audioManager.stopBgm&&window.audioManager.stopBgm(),console.log("[MapSelectionStage] AudioManagerのBGM停止完了"))}catch(e){console.error("[MapSelectionStage] AudioManagerのBGM停止エラー:",e)}try{const e=document.querySelectorAll("audio");console.log("[MapSelectionStage] 検出されたaudio要素数:",e.length),e.forEach(((e,t)=>{console.log(`[MapSelectionStage] audio要素${t}を停止`),e.pause(),e.currentTime=0,e.src=""}))}catch(e){console.error("[MapSelectionStage] BGM強制停止エラー:",e)}console.log("[MapSelectionStage] BGM停止完了"),window.startPhaserGame?window.startPhaserGame("ending"):console.error("[MapSelectionStage] startPhaserGameが見つかりません")}loadMinimalResources(){if(this.loadMapSeFiles(),this.mapConfig.bgm&&"object"==typeof this.mapConfig.bgm){const e=Object.keys(this.mapConfig.bgm)[0];e&&this.load.audio(`bgm_${e}`,this.mapConfig.bgm[e])}}loadMapSeFiles(){this.mapConfig.se?["se_touch","se_map_touch"].forEach((e=>{if(this.mapConfig.se[e]){const t=this.mapConfig.se[e];this.load.audio(e,t)}})):console.warn("[MapSelectionStage] mapConfig.se が定義されていません")}createMap(){try{const e=/iPad|iPhone|iPod/i.test(navigator.userAgent);if(this.isMobile=this.sys.game.device.input.touch,this._isShuttingDown=!1,this._suppressMapBgm=!1,this.cameraManager=new m(this),this.cameraManager.setBackgroundColor("#87CEEB"),this.mapManager=new u(this),this.mapManager.createMap(this.mapConfig.mapKey,this.mapConfig.tilesetKey),this.mapManager.scaleMapToScreen(),this.cameraManager.setupCamera(this.mapManager.getMapSize()),this.areaSelectionManager=new p(this),this.visualFeedbackManager=new o(this),this.choiceManager=new k.ChoiceManager,"taketa"===this.mapConfig.mapKey||"miemachi"===this.mapConfig.mapKey||"japan"===this.mapConfig.mapKey){this.conversationTrigger=new y(this);try{this.scene.manager&&this.scene.manager.keys&&this.scene.manager.keys.ConversationScene||this.scene.add("ConversationScene",S)}catch(e){}this.setupConversationEventListeners()}const t=this.mapManager.getAreas(),a=this.mapConfig.areas;console.log("[MapSelectionStage] エリアデータ処理開始: mapAreas="+(t?t.length:"undefined")+", configAreas="+(a?a.length:"undefined")),console.log("[MapSelectionStage] mapAreas:",t),console.log("[MapSelectionStage] configAreas:",a);const s=t.map((e=>{const t=a.find((t=>t.name===e.name));return{...e,scene:t?.scene||null,sceneParam:t?.sceneParam||null,conversationId:t?.conversationId||null}}));console.log("[MapSelectionStage] mergedAreas:",s),console.log("[MapSelectionStage] マージ後のエリア数: "+s.length),this.areaSelectionManager.setupAreas(s),this.uiManager=new g.UIManager,this.uiManager.createMapUI(this,this.mapConfig.mapTitle),this.time.delayedCall(100,(()=>{try{this.uiManager.createBackButton(this),console.log("[MapSelectionStage] 戻るボタンを作成しました")}catch(e){console.error("[MapSelectionStage] 戻るボタンの作成に失敗:",e)}})),this.setupTouchEvents(),this.createScaleToggleButton(),this.checkAndApplyCompletedAreas(),this.time.delayedCall(100,(()=>{window.__justReset?console.log("[MapSelectionStage] リセット直後のため、エンディングボタンの表示をスキップします"):this.checkAndShowEndingButton()}));try{this.audioManager=new d.AudioManager(this);const t=()=>{try{if(!this.sys||!this.sys.isActive||!this.sys.isActive())return}catch(e){}if(!this._suppressMapBgm)try{try{this.sound&&this.sound.stopAll&&this.sound.stopAll()}catch(e){}try{this.audioManager&&this.audioManager.stopAll&&this.audioManager.stopAll()}catch(e){}if(e&&this.mapConfig?.bgm?.map){if(this._htmlBgm||(this._htmlBgm=new Audio(this.mapConfig.bgm.map),this._htmlBgm.loop=!0,this._htmlBgm.volume=this.audioManager.bgmVolume,this._htmlBgm.onended=()=>{try{this._htmlBgm.currentTime=0;const e=this._htmlBgm.play();e&&e.catch&&e.catch((()=>{}))}catch(e){}}),!this._htmlBgm.paused&&!this._htmlBgm.ended)return;try{this._htmlBgm.currentTime=0}catch(e){}const e=this._htmlBgm.play();e&&"function"==typeof e.then?e.then((()=>{this._bgmStarted=!0})).catch((()=>{this._bgmStarted=!1})):this._bgmStarted=!0}else{const e=()=>{try{this.audioManager.playBgm("bgm_map"),this._bgmStarted=!0}catch(e){}};try{this.time.delayedCall(0,e)}catch(t){e()}}}catch(e){this._bgmStarted=!1}};this.sound&&this.sound.locked?(this.sound.once("unlocked",(()=>{try{this.sound.context&&"running"!==this.sound.context.state&&this.sound.context.resume()}catch(e){}t()})),this.input.once("pointerdown",(()=>{try{this.sound.context&&"running"!==this.sound.context.state&&this.sound.context.resume()}catch(e){}try{const e=this.sound.context;if(e&&"running"!==e.state&&e.resume(),e&&"function"==typeof e.createOscillator){const t=e.createOscillator(),a=e.createGain();a.gain.value=1e-4,t.connect(a).connect(e.destination),t.start(),t.stop(e.currentTime+.05)}}catch(e){}t()}))):(t(),this.input.once("pointerdown",(()=>{try{this.sound.context&&"running"!==this.sound.context.state&&this.sound.context.resume()}catch(e){}try{const e=this.sound.context;if(e&&"running"!==e.state&&e.resume(),e&&"function"==typeof e.createOscillator){const t=e.createOscillator(),a=e.createGain();a.gain.value=1e-4,t.connect(a).connect(e.destination),t.start(),t.stop(e.currentTime+.05)}}catch(e){}this.audioManager?.bgm&&this.audioManager.bgm.isPlaying||t()}))),this._bgmRetry=this.time.addEvent({delay:400,repeat:2,callback:()=>{const a=!(!e||!this._htmlBgm)&&(this._htmlBgm.paused||this._htmlBgm.ended),s=!(e||this.audioManager?.bgm&&this.audioManager.bgm.isPlaying);if(!this._suppressMapBgm&&(a||s)){try{this.sound.context&&"running"!==this.sound.context.state&&this.sound.context.resume()}catch(e){}t()}}})}catch(e){}this.scale.on("resize",this.handleResize,this),this._onResizeBound=!0,this.events.on("shutdown",(()=>{try{this.load&&this.load.reset&&this.load.reset()}catch(e){}try{this.load&&this.load.removeAllListeners&&this.load.removeAllListeners()}catch(e){}this.shutdown()}),this)}catch(e){console.error("[MapSelectionStage] マップ作成エラー:",e)}}setupTouchEvents(){this.input.on("pointerdown",(e=>{this.handleTouch(e)})),this.cameraManager.setupScrollControls(),this.cameraManager.setupPinchZoom()}handleTouch(e){try{if(this._isInConversation)return void console.log("[MapSelectionStage] 会話中は他のエリアをタップできません");if(this.sound&&this.sound.locked){try{this.sound.context&&"running"!==this.sound.context.state&&this.sound.context.resume()}catch(e){}try{const e=this.sound.context;if(e&&"running"!==e.state&&e.resume(),e&&"function"==typeof e.createOscillator){const t=e.createOscillator(),a=e.createGain();a.gain.value=1e-4,t.connect(a).connect(e.destination),t.start(),t.stop(e.currentTime+.05)}}catch(e){}}if(!this.cameras||!this.cameras.main)return void console.error(`${this.mapConfig.mapTitle}: Camera not available`);const t=this.cameras.main.getWorldPoint(e.x,e.y),a=t.x,s=t.y;this.areaSelectionManager&&this.areaSelectionManager.handleTouchAt(a,s),this.visualFeedbackManager&&this.visualFeedbackManager.showTouchRipple(a,s)}catch(e){console.error(`${this.mapConfig.mapTitle}: Error in handleTouch:`,e)}}createScaleToggleButton(){if(this._isShuttingDown||!this.sys||!this.sys.isActive||!this.add)return;this.scaleToggleButton&&(this.scaleToggleButton.destroy(),this.scaleToggleButton=null),this.scaleToggleButtonGraphics&&(this.scaleToggleButtonGraphics.destroy(),this.scaleToggleButtonGraphics=null);const e=this.add.graphics();this.scaleToggleButtonGraphics=e;const t=(t,a=!1)=>{e.clear();const s=43+(t.length>2?15*(t.length-2)+5:0),r=a?.4:.3,n=a?3815994:2763306,o=a?.98:.95,i=a?.15:.1;e.fillStyle(0,r),e.fillRoundedRect(4.5,40,s,30,8),e.fillStyle(n,o),e.fillRoundedRect(2.5,38,s,30,8),e.fillStyle(16777215,i),e.fillRoundedRect(2.5,38,s,15,8)};t("拡大"),e.setScrollFactor(0),e.setDepth(1e3);const a=this.add.text(7.5,43,"拡大",{fontSize:"16px",fill:"#ffffff",fontWeight:"bold",fontFamily:"Arial"});this.scaleToggleButton=a,a.setScrollFactor(0),a.setDepth(1002),a.setInteractive(),a.on("pointerdown",(()=>{this.cameraManager.toggleMapScale(),1.5===(this.cameraManager.scene.mapManager?.mapScaleX||this.cameraManager.currentScale)?(a.setText("全体マップ表示"),t("全体マップ表示")):(a.setText("拡大"),t("拡大"))})),a.on("pointerover",(()=>{const e=a.text;t(e,!0)})),a.on("pointerout",(()=>{const e=a.text;t(e,!1)})),a.setText("拡大")}handleResize(e){try{if(this._isShuttingDown||!this.sys||!this.sys.isActive)return;if(!this.cameras||!this.cameras.main)return;if(!this.mapManager)return;if(this.mapManager?.handleResize(e),this.cameraManager&&this.mapManager&&this.cameraManager.setupCamera(this.mapManager.getMapSize()),this.areaSelectionManager){this.areaSelectionManager.destroy(),this.areaSelectionManager=new p(this);const e=this.mapManager.getAreas(),t=this.mapConfig.areas,a=e.map((e=>{const a=t.find((t=>t.name===e.name));return{...e,scene:a?.scene||null}}));this.areaSelectionManager.setupAreas(a)}this.uiManager?.updateMapUI(e),this.createScaleToggleButton()}catch(e){console.error("Error handling resize:",e)}}update(){this.areaSelectionManager?.update(),this.cameraManager?.update()}checkAndApplyCompletedAreas(){try{const e=this.scene.manager.getScene("ConversationScene");if(e&&e.completedAreaName){const t=e.completedAreaName;console.log(`[MapSelectionStage] 完了状態を適用: ${t}`),this.areaSelectionManager.markAreaAsCompleted(t),e.completedAreaName=null,console.log(`[MapSelectionStage] 完了状態をクリア: ${t}`)}}catch(e){console.error("[MapSelectionStage] 完了状態適用エラー:",e)}}destroy(){this.shutdown(),super.destroy()}shutdown(){if(this._isShuttingDown=!0,this.audioManager&&(this.audioManager.stopAll(),this.audioManager.destroy(),this.audioManager=null),this._htmlBgm){try{this._htmlBgm.pause()}catch(e){}this._htmlBgm=null}this._bgmStarted=!1,this.mapManager&&(this.mapManager.destroy(),this.mapManager=null),this.areaSelectionManager&&(this.areaSelectionManager.destroy(),this.areaSelectionManager=null),this.uiManager&&(this.uiManager.destroy(),this.uiManager=null),this.cameraManager&&(this.cameraManager.destroy(),this.cameraManager=null),this.visualFeedbackManager&&(this.visualFeedbackManager.destroy(),this.visualFeedbackManager=null),this.conversationTrigger&&(this.conversationTrigger.destroy(),this.conversationTrigger=null),this.scaleToggleButton&&(this.scaleToggleButton.destroy(),this.scaleToggleButton=null),this.scaleToggleButtonGraphics&&(this.scaleToggleButtonGraphics.destroy(),this.scaleToggleButtonGraphics=null);try{this.sound&&this.sound.stopAll&&this.sound.stopAll()}catch(e){}try{this._onResizeBound&&this.scale&&this.scale.off&&this.scale.off("resize",this.handleResize,this)}catch(e){}this._onResizeBound=!1}}function v(e,t){const a=x.AreaConfig[e];return a?new b({sceneKey:t,mapConfig:a,mapId:e}):(console.error(`Map config not found for: ${e}`),null)}class f{constructor(e){this.scene=e,this.dialogSystem=null,this.collisionGroups={walls:null,npcs:null,items:null,enemies:null}}setDialogSystem(e){this.dialogSystem=e}setupCollisionGroups(){this.collisionGroups.walls=this.scene.physics.add.staticGroup(),this.collisionGroups.npcs=this.scene.physics.add.staticGroup(),this.collisionGroups.items=this.scene.physics.add.group(),this.collisionGroups.enemies=this.scene.physics.add.group()}addObjectToCollision(e,t){const a=t.type||"wall";this.scene.physics.add.existing(e,"item"!==a&&"enemy"!==a);const s=t.width||32,r=t.height||32;switch(e.body.setSize(s,r),a){case"npc":this.collisionGroups.npcs.add(e),e.setInteractive(),e.on("pointerdown",(()=>{this.scene.isConversationActive&&this.scene.isConversationActive()?console.log("[CollisionManager] 会話中のため、NPCクリックを無視します"):(console.log(`[CollisionManager] NPCクリック: ${t.name}`),this.scene.usedConversations&&this.scene.usedConversations.has(t.name)?this.scene.dialogSystem&&this.scene.dialogSystem.hasDialog(t.name)?this.scene.dialogSystem.showDialog(t.name):this.startConversation(t.name):(this.startConversation(t.name),this.scene.usedConversations?this.scene.usedConversations.add(t.name):console.warn("[CollisionManager] usedConversationsが存在しません")))}));break;case"move":this.collisionGroups.items.add(e),e.setData("moveId",t.name),e.setData("moveType",t.type);break;case"item":this.collisionGroups.items.add(e),e.setData("itemId",t.name);break;case"enemy":this.collisionGroups.enemies.add(e),e.setData("enemyId",t.name);break;default:this.collisionGroups.walls.add(e)}}setupPlayerCollisions(e){this.scene.physics.add.collider(e,this.collisionGroups.walls),this.scene.physics.add.collider(e,this.collisionGroups.npcs),this.scene.physics.add.overlap(e,this.collisionGroups.items,this.collectItem,null,this.scene),this.scene.physics.add.overlap(e,this.collisionGroups.enemies,this.encounterEnemy,null,this.scene)}collectItem(e,t){"move"===t.getData("moveType")?this.handleMoveObject(e,t):t.destroy()}handleMoveObject(e,t){const a=t.getData("moveId");console.log(`[CollisionManager] 移動オブジェクトに触れました: ${a}`);const s=this.scene.stageConfig?.floors?.length||1;console.log(`[CollisionManager] 現在のステージの最大フロア数: ${s}`);let r=1;if(a&&a.startsWith("move_")){const e=parseInt(a.replace("move_",""));if(!(!isNaN(e)&&e>0&&e<=s))return void console.warn(`[CollisionManager] 無効なフロア番号: ${a} (1-${s}の範囲外)`);r=e,console.log(`[CollisionManager] moveオブジェクト ${a} からフロア ${r} への移動を検出`)}else{if("move"!==a)return void console.warn(`[CollisionManager] 不明なmoveオブジェクト: ${a}`);1===this.scene.currentFloor?r=2:2===this.scene.currentFloor?r=s>=3?3:1:3===this.scene.currentFloor&&(r=2),console.log(`[CollisionManager] 従来の命名規則を使用: フロア ${this.scene.currentFloor} → ${r}`)}console.log(`[CollisionManager] (${r}) を呼び出し`),this.scene.changeFloor(r)}startConversation(e){console.log(`[CollisionManager] 会話開始: ${e}`),console.log(`[CollisionManager] 現在の会話中フラグ: ${this.scene.isConversationActive?this.scene.isConversationActive():"undefined"}`);const t=this.getEventIdFromNPCName(e);if(t){if(this.scene.playerController&&this.scene.playerController.player&&this.scene.mapManager){const t=this.scene.playerController.getPosition();this.scene.mapManager.makeNpcFacePlayer(e,t.x,t.y)}this.scene.conversationTrigger?this.scene.conversationTrigger.startConversation(t):this.dialogSystem&&this.dialogSystem.startDialog(t)}else this.scene.dialogSystem&&this.scene.dialogSystem.hasDialog(e)?this.scene.dialogSystem.showDialog(e):console.warn(`[CollisionManager] NPC ${e} のダイアログが見つかりません`)}getEventIdFromNPCName(e){const t=this.scene.stageConfig?.currentFloor;if(!t||!t.npcs)return console.warn("[CollisionManager] currentFloorまたはnpcsが存在しません"),null;const a=t.npcs.find((t=>t.name===e));return a||(console.warn(`[CollisionManager] NPC名 "${e}" がフロア${t.number}で見つかりません`),console.log("[CollisionManager] 利用可能なNPC名:",t.npcs.map((e=>e.name)))),a?a.eventId:null}isDialogActive(){return!!this.dialogSystem&&this.dialogSystem.isDialogActive()}getDialogSystem(){return this.dialogSystem}setupAllCollisions(e,t){this.setupTileCollisions(e,t),this.setupObjectCollisions(e,t),this.setupPlayerCollisions(e)}setupObjectCollisions(e,t){t&&t.objectGroup?t.objectGroup.children.entries.forEach((t=>{const a=t.getData("objectType"),s=t.getData("objectName");"wall"===a||"壁"===a||"Wall"===a?this.scene.physics.add.collider(e,t):"npc"===a?(t.setInteractive(),t.on("pointerdown",(()=>{console.log(`[CollisionManager] NPCをクリック: ${s}`),this.startConversation(s)})),this.scene.physics.add.collider(e,t)):"move"===a&&this.scene.physics.add.overlap(e,t,(()=>{this.handleMoveObject(e,t)}),null,this.scene)})):console.warn("[CollisionManager] objectGroupが見つかりません")}setupTileCollisions(e,t){t&&t.layers&&t.layers.forEach((t=>{t&&this.scene.physics.add.collider(e,t)}))}destroy(){this.collisionGroups&&(Object.keys(this.collisionGroups).forEach((e=>{this.collisionGroups[e]&&(this.collisionGroups[e].clear(),this.collisionGroups[e]=null)})),this.collisionGroups=null),this.dialogSystem=null,this.scene=null}startConversationFromNPCName(e){const t=this.scene.stageConfig.currentFloor;if(!t||!t.npcs)return void console.error("[CollisionManager] 現在のフロアのNPC設定が見つかりません");const a=t.npcs.find((t=>t.name===e));if(!a)return void console.error(`[CollisionManager] NPC名 "${e}" が現在のフロアで見つかりません`);const s=a.eventId;s?this.scene.conversationTrigger?this.scene.conversationTrigger.startConversation(s):console.error("[CollisionManager] ConversationTriggerが初期化されていません"):this.scene.dialogSystem&&this.scene.dialogSystem.hasDialog(e)?this.scene.dialogSystem.showDialog(e):console.warn(`[CollisionManager] NPC ${e} のダイアログが見つかりません`)}setupNpcInteraction(e){e&&e.name?this.scene.isConversationActive&&this.scene.isConversationActive()?console.log("[CollisionManager] 会話中のため、NPCクリックを無視します"):(e.setInteractive(),e.on("pointerdown",(()=>{this.scene.isConversationActive&&this.scene.isConversationActive()?console.log("[CollisionManager] 会話中のため、NPCクリックを無視します"):this.scene.conversationTrigger?this.scene.conversationTrigger.startConversation(e.name):console.error("[CollisionManager] ConversationTriggerが初期化されていません")}))):console.warn("[CollisionManager] NPC設定が不完全です:",e)}}class M{constructor(e){this.scene=e,this.player=null,this.cursors=null,this.wasd=null,this.speed=300}createPlayer(e,t){this.player=this.scene.physics.add.sprite(e,t,"player_sprite"),this.player.setDisplaySize(32,32),this.player.setDepth(40),this.player.setFrame(0),this.player.setCollideWorldBounds(!0),this.player.setBounce(0),this.player.setDrag(200),this.setupPlayerAnimations()}setupPlayerAnimations(){this.scene.anims.exists("player_walk_down")||this.scene.anims.create({key:"player_walk_down",frames:this.scene.anims.generateFrameNumbers("player_sprite",{start:0,end:2}),frameRate:8,repeat:-1}),this.scene.anims.exists("player_walk_left")||this.scene.anims.create({key:"player_walk_left",frames:this.scene.anims.generateFrameNumbers("player_sprite",{start:3,end:5}),frameRate:8,repeat:-1}),this.scene.anims.exists("player_walk_right")||this.scene.anims.create({key:"player_walk_right",frames:this.scene.anims.generateFrameNumbers("player_sprite",{start:6,end:8}),frameRate:8,repeat:-1}),this.scene.anims.exists("player_walk_up")||this.scene.anims.create({key:"player_walk_up",frames:this.scene.anims.generateFrameNumbers("player_sprite",{start:9,end:11}),frameRate:8,repeat:-1})}setInputKeys(e,t){this.cursors=e,this.wasd=t}update(){if(this.player&&this.cursors&&this.wasd){let e=0,t=0;this.cursors.left.isDown||this.wasd.A.isDown?e=-this.speed:(this.cursors.right.isDown||this.wasd.D.isDown)&&(e=this.speed),this.cursors.up.isDown||this.wasd.W.isDown?t=-this.speed:(this.cursors.down.isDown||this.wasd.S.isDown)&&(t=this.speed),this.player.setVelocityX(e),this.player.setVelocityY(t),this.handlePlayerAnimation(e,t)}}handlePlayerAnimation(e,t){if(0!==e||0!==t)Math.abs(t)>Math.abs(e)?t<0?(this.player.anims.play("player_walk_up",!0),this.lastDirection="up"):(this.player.anims.play("player_walk_down",!0),this.lastDirection="down"):e<0?(this.player.anims.play("player_walk_left",!0),this.lastDirection="left"):(this.player.anims.play("player_walk_right",!0),this.lastDirection="right");else if(this.player.anims.stop(),this.lastDirection)switch(this.lastDirection){case"up":this.player.setFrame(9);break;case"down":this.player.setFrame(0);break;case"left":this.player.setFrame(3);break;case"right":this.player.setFrame(6)}}setVelocity(e,t){this.player&&(this.player.setVelocityX(e),this.player.setVelocityY(t),this.handlePlayerAnimation(e,t))}getPosition(){return this.player?{x:this.player.x,y:this.player.y}:{x:0,y:0}}destroy(){try{this.player&&(this.player.destroy(),this.player=null),this.cursors=null,this.wasd=null}catch(e){console.error("Error during PlayerController cleanup:",e)}}}class _{constructor(e,t,a="se_touch"){this.scene=e,this.player=t,this.seKey=a,this.visualFeedback=new o(e),this.touchStartX=0,this.touchStartY=0,this.isPointerDown=!1,this.targetX=0,this.targetY=0,this.setupVirtualGamepad(),this.scene.input.on("pointerdown",(e=>{try{if(this.scene.sound&&this.scene.sound.locked){try{this.scene.sound.context&&"running"!==this.scene.sound.context.state&&this.scene.sound.context.resume()}catch(e){}try{const e=this.scene.sound.context;if(e&&"function"==typeof e.createOscillator){const t=e.createOscillator(),a=e.createGain();a.gain.value=1e-4,t.connect(a).connect(e.destination),t.start(),t.stop(e.currentTime+.05)}}catch(e){}}}catch(e){}if(this.scene.cameras&&this.scene.cameras.main){const t=this.scene.cameras.main.getWorldPoint(e.x,e.y);this.showTouchFeedback(t.x,t.y)}else this.showTouchFeedback(e.x,e.y)}))}setupVirtualGamepad(){const e=this.scene.scale.width-120,t=this.scene.scale.height-120;this.baseCircle=this.scene.add.circle(e,t,50,3355443,.6),this.baseCircle.setScrollFactor(0),this.baseCircle.setStrokeStyle(2,5592405),this.baseCircle.setDepth(1e3),this.stickCircle=this.scene.add.circle(e,t,20,8947848,.9),this.stickCircle.setScrollFactor(0),this.stickCircle.setStrokeStyle(2,11184810),this.stickCircle.setDepth(1001),this.centerX=e,this.centerY=t,this.maxDistance=40,this.currentInput={x:0,y:0},this.isStickActive=!1,this.currentPointerId=null;const a=this.scene.add.circle(e,t,80,0,.01);a.setScrollFactor(0),a.setDepth(999),a.setInteractive(),this.touchArea=a,a.on("pointerdown",(e=>{null===this.currentPointerId&&this.startStickControl(e)})),this.scene.input.on("pointermove",(e=>{this.isStickActive&&e.id===this.currentPointerId&&this.updateStick(e.x,e.y)})),this.scene.input.on("pointerup",(e=>{this.isStickActive&&e.id===this.currentPointerId&&this.endStickControl()})),this.scene.scale.on("resize",this.handleResize,this)}startStickControl(e){this.isStickActive=!0,this.currentPointerId=e.id,this.stickCircle.setAlpha(1),this.baseCircle.setAlpha(.8),this.updateStick(e.x,e.y)}endStickControl(){this.isStickActive=!1,this.currentPointerId=null,this.resetStick(),this.stickCircle.setAlpha(.9),this.baseCircle.setAlpha(.6)}handleResize(){const e=this.scene.scale.width,t=this.scene.scale.height;this.centerX=e-120,this.centerY=t-120,this.baseCircle.setPosition(this.centerX,this.centerY),this.stickCircle.setPosition(this.centerX,this.centerY),this.touchArea&&this.touchArea.setPosition(this.centerX,this.centerY)}updateStick(e,t){const a=e-this.centerX,s=t-this.centerY;let r=e,n=t;if(Math.sqrt(a*a+s*s)>this.maxDistance){const e=Math.atan2(s,a);r=this.centerX+Math.cos(e)*this.maxDistance,n=this.centerY+Math.sin(e)*this.maxDistance}this.stickCircle.x=r,this.stickCircle.y=n;const o=(r-this.centerX)/this.maxDistance,i=(n-this.centerY)/this.maxDistance;if(this.currentInput.x=o,this.currentInput.y=i,Math.sqrt(o*o+i*i)<.05)return void(this.player&&this.player.setVelocity&&this.player.setVelocity(0,0));const c=450*o,h=450*i;this.player&&this.player.setVelocity&&this.player.setVelocity(c,h)}resetStick(){this.stickCircle.x=this.centerX,this.stickCircle.y=this.centerY,this.currentInput.x=0,this.currentInput.y=0,this.player&&this.player.setVelocity&&this.player.setVelocity(0,0)}getCurrentInput(){return{...this.currentInput}}enableAreaSelection(e){this.areaSelectionManager=e,this.hideVirtualGamepad(),this.setupAreaSelectionTouch()}hideVirtualGamepad(){this.baseCircle&&this.baseCircle.setVisible(!1),this.stickCircle&&this.stickCircle.setVisible(!1)}showVirtualGamepad(){this.baseCircle&&this.baseCircle.setVisible(!0),this.stickCircle&&this.stickCircle.setVisible(!0)}setupAreaSelectionTouch(){this.scene.input.on("pointerdown",(e=>{this.handleAreaSelectionTouch(e)})),this.touchStartTime=0,this.longPressThreshold=500}handleAreaSelectionTouch(e){try{if(this.touchStartTime=Date.now(),!this.scene.cameras||!this.scene.cameras.main)return void console.error("TouchControlManager: Camera not available");const t=this.scene.cameras.main.getWorldPoint(e.x,e.y),a=t.x,s=t.y;this.areaSelectionManager&&this.areaSelectionManager.handleTouchAt(a,s),this.showTouchFeedback(a,s)}catch(e){console.error("TouchControlManager: Error in handleAreaSelectionTouch:",e)}}showTouchFeedback(e,t){try{this.visualFeedback.showTouchRipple(e,t),this.scene.audioManager&&this.scene.audioManager.playSe&&this.scene.audioManager.playSe(this.seKey,.3)}catch(e){console.warn("TouchControlManager: Error in showTouchFeedback:",e)}}disableAreaSelection(){this.areaSelectionManager=null,this.showVirtualGamepad(),this.scene.input.off("pointerdown")}destroy(){this.baseCircle&&this.baseCircle.destroy(),this.stickCircle&&this.stickCircle.destroy(),this.scene.scale.off("resize",this.handleResize,this)}updatePosition(e,t){if(this.baseCircle&&this.stickCircle){const a=120,s=e-a,r=t-a;this.baseCircle.setPosition(s,r),this.stickCircle.setPosition(s,r),this.centerX=s,this.centerY=r,this.touchArea&&this.touchArea.setPosition(s,r),this.isStickActive&&(this.stickCircle.setPosition(this.centerX,this.centerY),this.currentInput={x:0,y:0}),console.log("[TouchControlManager] 位置更新完了:",{width:e,height:t,padX:s,padY:r})}}}const w={mie_high_school:{stageKey:"mie_high_school",stageTitle:"三重中学校",folderName:"miemachi/mie_junior_highschool",mapId:"miemachi",bgm:{map:"assets/audio/bgm/Pollyanna.mp3"},se:{se_touch:"assets/audio/se/touch_7.mp3",se_floor_change:"assets/audio/se/touch_2.mp3"},floors:[{number:1,mapKey:"mie_high_school_1",mapFileName:"mie_highshool_1.tmj",title:"三重中学校 1階",implemented:!0,playerStartX:900,playerStartY:1600,fromFloor2StartX:800,fromFloor2StartY:200,bgm:{map:"assets/audio/bgm/enter13.mp3"},npcs:[{name:"tatuharu",displayName:"たつはる",eventId:"tatuharu",sprite:"制服2夏服_男_01.png"},{name:"npc_1",displayName:"生徒A",sprite:"制服1夏服_女_01.png"},{name:"npc_2",displayName:"生徒B",sprite:"制服1夏服_男_01.png"},{name:"npc_3",displayName:"生徒C",sprite:"制服1夏服_女_04.png"},{name:"npc_4",displayName:"生徒D",sprite:"制服1夏服_男_04.png"},{name:"npc_5",displayName:"生徒E",sprite:"制服1夏服_女_12.png"},{name:"npc_6",displayName:"生徒F",sprite:"制服1夏服_男_06.png"},{name:"npc_7",displayName:"生徒G",sprite:"制服1夏服_女_13.png"},{name:"npc_8",displayName:"生徒H",sprite:"制服1夏服_男_10.png"},{name:"npc_9",displayName:"生徒I",sprite:"制服1夏服_女_17.png"}],tilesets:["pika_nos_tiles03_A2","pika_nos_tiles03_A3","pika_nos_tiles03_A5","pika_nos_tiles03_B","pika_nos_tiles03_C","pika_nos_tiles03_D","pika_nos_in_tiles02_A2","pika_nos_in_tiles02_A4","pika_nos_in_tiles02_A5","pika_nos_in_tiles02_B","pika_nos_in_tiles02_C","pika_nos_in_tiles02_D","pika_nos_in_tiles02_E","pika_objset_school_01"]},{number:2,mapKey:"mie_high_school_2",mapFileName:"mie_highshool_2.tmj",title:"三重中学校 2階",implemented:!0,playerStartX:1600,playerStartY:500,fromFloor1StartX:1800,fromFloor1StartY:400,bgm:{map:"assets/audio/bgm/テクノトリス.mp3"},npcs:[{name:"uchida",displayName:"内田",sprite:"制服2夏服_男_12.png"},{name:"ootuka",displayName:"大塚",eventId:"otsuka_senpai",sprite:"制服2夏服_男_04.png"},{name:"okagami",displayName:"岡上",sprite:"先生_男_02.png"},{name:"だいち_2",displayName:"だいち",eventId:"daichi_conversation",sprite:"制服2夏服_男_04.png"},{name:"ひろかず_2",displayName:"ひろかず",sprite:"制服1冬服_男_01.png"},{name:"npc_1",displayName:"生徒A",sprite:"制服1夏服_男_12.png"},{name:"npc_2",displayName:"生徒B",sprite:"制服1夏服_女_01.png"},{name:"npc_3",displayName:"生徒C",sprite:"制服1夏服_男_01.png"},{name:"npc_4",displayName:"生徒D",sprite:"制服1夏服_女_04.png"},{name:"npc_5",displayName:"生徒E",sprite:"制服1夏服_男_04.png"},{name:"npc_6",displayName:"生徒F",sprite:"制服1夏服_女_12.png"},{name:"npc_7",displayName:"生徒G",sprite:"制服1夏服_男_06.png"},{name:"npc_8",displayName:"生徒H",sprite:"制服1夏服_女_13.png"},{name:"npc_9",displayName:"生徒I",sprite:"制服1夏服_男_10.png"},{name:"npc_10",displayName:"生徒J",sprite:"制服1夏服_女_17.png"},{name:"npc_11",displayName:"生徒K",sprite:"制服1夏服_男_12.png"},{name:"npc_12",displayName:"生徒L",sprite:"制服1夏服_女_01.png"},{name:"npc_13",displayName:"生徒M",sprite:"制服1夏服_男_01.png"},{name:"npc_14",displayName:"生徒N",sprite:"制服1夏服_女_04.png"},{name:"npc_15",displayName:"生徒O",sprite:"制服1夏服_男_04.png"},{name:"npc_16",displayName:"生徒P",sprite:"制服1夏服_女_12.png"},{name:"npc_17",displayName:"生徒Q",sprite:"制服1夏服_男_06.png"},{name:"npc_18",displayName:"生徒R",sprite:"制服1夏服_女_13.png"},{name:"npc_19",displayName:"生徒S",sprite:"制服1夏服_男_10.png"},{name:"npc_20",displayName:"生徒T",sprite:"制服1夏服_女_17.png"}],tilesets:["pika_nos_tiles03_A2","pika_nos_tiles03_A3","pika_nos_tiles03_A5","pika_nos_tiles03_B","pika_nos_tiles03_C","pika_nos_tiles03_D","pika_nos_in_tiles02_A2","pika_nos_in_tiles02_A4","pika_nos_in_tiles02_A5","pika_nos_in_tiles02_B","pika_nos_in_tiles02_C","pika_nos_in_tiles02_D","pika_nos_in_tiles02_E","pika_objset_school_01"]}]},taketa_highschool:{stageKey:"taketa_highschool",stageTitle:"竹田高校",folderName:"taketa/taketa_highschool",mapId:"taketa",bgm:{map:"assets/audio/bgm/Pollyanna.mp3"},se:{se_touch:"assets/audio/se/touch_7.mp3",se_floor_change:"assets/audio/se/touch_2.mp3"},floors:[{number:1,mapKey:"taketa_highschool_1",mapFileName:"taketa_highschool_1.tmj",title:"竹田高校 1階",implemented:!0,playerStartX:100,playerStartY:100,fromFloor2StartX:750,fromFloor2StartY:1e3,bgm:{map:"assets/audio/bgm/はるかなる故郷.mp3"},npcs:[{name:"ひろかず_1",displayName:"ひろかず",eventId:"climbing_injury",sprite:"制服1冬服_男_12.png"},{name:"おおや_1",displayName:"おおや",eventId:"wax_on",sprite:"制服2冬服_男_12.png"},{name:"npc_e_2",displayName:"生徒A",sprite:"制服2夏服_女_01.png"},{name:"npc_e_1",displayName:"生徒B",sprite:"制服2夏服_男_01.png"},{name:"npc_p_2",displayName:"生徒C",sprite:"制服2夏服_女_04.png"},{name:"npc_p_1",displayName:"生徒D",sprite:"制服2夏服_男_04.png"},{name:"npc_e_3",displayName:"生徒E",sprite:"制服2夏服_女_12.png"},{name:"npc_s_3",displayName:"生徒F",sprite:"制服2夏服_男_06.png"},{name:"npc_s_2",displayName:"生徒G",sprite:"制服2夏服_女_13.png"}],tilesets:["pika_nos_tiles03_A2","pika_nos_tiles03_A3","pika_nos_tiles03_A5","pika_nos_tiles03_B","pika_nos_tiles03_C","pika_nos_tiles03_D","pika_nos_in_tiles02_A2","pika_nos_in_tiles02_A4","pika_nos_in_tiles02_A5","pika_nos_in_tiles02_B","pika_nos_in_tiles02_C","pika_nos_in_tiles02_D","pika_nos_in_tiles02_E","pika_objset_school_01"]},{number:2,mapKey:"taketa_highschool_2",mapFileName:"taketa_highschool_2.tmj",title:"竹田高校 2階",implemented:!0,playerStartX:1650,playerStartY:800,fromFloor1StartX:1680,fromFloor1StartY:730,fromFloor3StartX:1750,fromFloor3StartY:800,bgm:{map:"assets/audio/bgm/field_of_hopes_and_dreams.mp3"},npcs:[{name:"anndou",displayName:"安藤",eventId:"classroom_lock_incident",sprite:"先生_男_02.png"},{name:"こうたろう_2",displayName:"こうたろう",eventId:"koutarou_toilet",sprite:"制服2夏服_男_01.png"},{name:"だいち_2",displayName:"だいち",eventId:"culture_festival_apology",sprite:"制服2夏服_男_04.png"},{name:"まみっち",displayName:"まみっち",eventId:"black_clothes",sprite:"先生_女_04.png"},{name:"ひろかず_2",displayName:"ひろかず",eventId:"broadcast",sprite:"制服1冬服_男_12.png"},{name:"かなと_2",displayName:"かなと",eventId:"valentine",sprite:"制服2夏服_男_01.png"},{name:"あべ",displayName:"あべ",sprite:"制服2冬服_男_04.png"},{name:"s-2",displayName:"生徒A",sprite:"制服2夏服_女_17.png"},{name:"s-3",displayName:"生徒B",sprite:"制服2夏服_男_10.png"},{name:"s-8",displayName:"えとう",sprite:"制服2冬服_男_04.png"},{name:"s-9",displayName:"生徒C",sprite:"制服2夏服_男_12.png"},{name:"s-11",displayName:"まさと",sprite:"制服2夏服_男_12.png"},{name:"s-12",displayName:"ふじた",sprite:"制服2夏服_男_01.png"},{name:"s-13",displayName:"かのん",sprite:"制服2夏服_女_12.png"},{name:"あめかわ",displayName:"あめかわ",sprite:"制服2夏服_男_12.png"},{name:"みやざー",displayName:"みやざー",sprite:"先生_男_04.png"}],tilesets:["pika_nos_tiles03_A2","pika_nos_tiles03_A3","pika_nos_tiles03_A5","pika_nos_tiles03_B","pika_nos_tiles03_C","pika_nos_tiles03_D","pika_nos_in_tiles02_A2","pika_nos_in_tiles02_A4","pika_nos_in_tiles02_A5","pika_nos_in_tiles02_B","pika_nos_in_tiles02_C","pika_nos_in_tiles02_D","pika_nos_in_tiles02_E","pika_objset_school_01"]},{number:3,mapKey:"taketa_highschool_3",mapFileName:"taketa_highschool_3.tmj",title:"竹田高校 3階",implemented:!0,playerStartX:1200,playerStartY:1400,fromFloor2StartX:1200,fromFloor2StartY:1400,bgm:{map:"assets/audio/bgm/Pollyanna.mp3"},npcs:[{name:"かなと_3",displayName:"かなと",eventId:"drama_filming",sprite:"制服2夏服_男_01.png"},{name:"ひろかず_3",displayName:"ひろかず",eventId:"videocamera_broken",sprite:"制服1冬服_男_12.png"},{name:"だいち_3",displayName:"だいち",eventId:"gospellers_song",sprite:"制服2夏服_男_04.png"},{name:"こうたろう_3",displayName:"こうたろう",eventId:"lunch_tag",sprite:"制服2夏服_男_01.png"},{name:"あきざわ",displayName:"あきざわ",sprite:"制服2冬服_男_01.png"},{name:"しゅうへい",displayName:"しゅうへい",sprite:"制服2冬服_男_04.png"},{name:"なおき",displayName:"なおき",sprite:"制服2冬服_男_06.png"},{name:"まさと",displayName:"まさと",sprite:"制服2冬服_男_10.png"}],tilesets:["pika_nos_tiles03_A2","pika_nos_tiles03_A3","pika_nos_tiles03_A5","pika_nos_tiles03_B","pika_nos_tiles03_C","pika_nos_tiles03_D","pika_nos_in_tiles02_A2","pika_nos_in_tiles02_A4","pika_nos_in_tiles02_A5","pika_nos_in_tiles02_B","pika_nos_in_tiles02_C","pika_nos_in_tiles02_D","pika_nos_in_tiles02_E","pika_objset_school_01"]}]}};var C=a(92);class B extends Phaser.Scene{constructor(e){super({key:e.stageKey}),this.stageConfig=e.stageConfig,this.stageKey=e.stageKey,this.mapManager=null,this.uiManager=null,this.cameraManager=null,this.audioManager=null,this.conversationTrigger=null,this.currentFloor=1,this.restoreState=!1,this.targetFloor=1,this.playerPosition=null,this.mapKey=null,this._isInConversation=!1}init(e){e&&e.restoreState?(this.restoreState=!0,this.targetFloor=e.targetFloor||1,this.playerPosition=e.playerPosition||null,this.mapKey=e.mapKey||null,console.log("[StageScene] 状態復元設定を受け取り:",{restoreState:this.restoreState,targetFloor:this.targetFloor,playerPosition:this.playerPosition,mapKey:this.mapKey})):(this.restoreState=!1,this.targetFloor=1,this.playerPosition=null,this.mapKey=null,console.log("[StageScene] 状態復元設定なし（通常起動）")),e&&e.nextFloorNumber&&(this.nextFloorNumber=e.nextFloorNumber,console.log(`[StageScene] nextFloorNumber を受け取り: ${this.nextFloorNumber}`)),e&&e.fromFloorNumber&&(this.fromFloorNumber=e.fromFloorNumber,console.log(`[StageScene] fromFloorNumber を受け取り: ${this.fromFloorNumber}`))}preload(){const e=this.stageConfig.folderName;this.stageConfig.floors.forEach((t=>{t.implemented&&this.load.tilemapTiledJSON(t.mapKey,`assets/maps/${e}/${t.mapFileName}`)})),this.stageConfig.floors.forEach((t=>{t.implemented&&t.tilesets.forEach((t=>{this.load.image(t,`assets/maps/${e}/${t}.png`)}))})),this.stageConfig.bgm&&"object"==typeof this.stageConfig.bgm&&Object.keys(this.stageConfig.bgm).forEach((e=>{this.load.audio(e,this.stageConfig.bgm[e])})),this.stageConfig.se&&Object.keys(this.stageConfig.se).forEach((e=>{this.load.audio(e,this.stageConfig.se[e])})),this.loadNPCSprites(),this.load.spritesheet("player_sprite","assets/characters/npcs/男_ギャング.png",{frameWidth:32,frameHeight:32,spacing:0,margin:0}),this.load.image("speech_bubble","assets/ui/speech_bubble.png")}loadNPCSprites(){this.stageConfig&&this.stageConfig.floors&&this.stageConfig.floors.forEach((e=>{e.npcs&&e.npcs.forEach((e=>{e.sprite&&this.load.spritesheet(e.name,`assets/characters/npcs/${e.sprite}`,{frameWidth:32,frameHeight:32,spacing:0,margin:0})}))}))}createNPCs(){this.stageConfig&&this.stageConfig.currentFloor&&this.stageConfig.currentFloor.npcs&&this.stageConfig.currentFloor.npcs.forEach((e=>{if(e.sprite){const t=this.mapManager.getNPCObjectData(e.name),s=t?t.x:100,r=t?t.y:100,n=this.add.sprite(s,r,e.name);n.setDisplaySize(32,32),this.physics.add.existing(n),n.body.setSize(32,32),n.body.setImmovable(!0),n.body.setCollideWorldBounds(!1),n.setData("npcId",e.name),n.setData("npcType","npc"),n.setData("objectType","npc"),n.setData("objectName",e.name),this.mapManager.objectGroup?this.mapManager.objectGroup.add(n):console.warn("[StageScene] objectGroupが初期化されていません"),e.eventId&&(n.setData("eventId",e.eventId),Promise.resolve().then(a.bind(a,863)).then((({ChoiceManager:t})=>{const a=t.getInstance().isEventCleared(e.eventId),s="true"===localStorage.getItem("event_completed_"+e.eventId);a||s||this.createSpeechBubble(e.name,n)}))),n.setInteractive(),n.on("pointerdown",(()=>{this.makeNPCLookAtPlayer(n),e.eventId?this.startConversation(e.eventId):this.dialogSystem&&this.dialogSystem.startDialog(e.name)}));const o=e.displayName||e.name,i=this.add.text(n.x,n.y-16,o,{fontSize:"12px",fill:"#ffffff",backgroundColor:"#000000",padding:{x:2,y:1}});i.setOrigin(.5,1),i.setDepth(1e3)}}))}createSpeechBubble(e,t){console.log("[StageScene] createSpeechBubble呼び出し:",{npcName:e,npcSpriteName:t.getData("objectName")});const a=this.add.image(t.x,t.y-35,"speech_bubble");return a.setScale(.9),a.setDepth(1001),a.setData("npcName",e),a.setData("bubbleType","speech"),console.log("[StageScene] 吹き出し作成完了:",{npcName:e,bubbleId:a.getData("npcName")}),this.tweens.add({targets:a,y:a.y-4,duration:800,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"}),a}removeSpeechBubbleByNpcName(e){console.log("[StageScene] removeSpeechBubbleByNpcName開始:",e);let t=!1,a=0;const s=this.children.list.filter((e=>e?.getData&&"speech"===e.getData("bubbleType"))).map((e=>({npcName:e.getData("npcName"),exists:!!e,active:e.active})));console.log("[StageScene] 削除前の吹き出し一覧:",s),this.children.list.forEach((s=>{s?.getData&&"speech"===s.getData("bubbleType")&&s.getData("npcName")===e&&(console.log("[StageScene] 吹き出し削除対象発見:",e,"child:",s),console.log("[StageScene] 削除前のchild状態:",{active:s.active,visible:s.visible,destroyed:s.destroyed}),s.setVisible(!1),s.setActive(!1),s.removeFromDisplayList(),s.destroy(),t=!0,a++,console.log("[StageScene] 削除後のchild状態:",{active:s.active,visible:s.visible,destroyed:s.destroyed}))}));const r=this.children.list.filter((e=>e?.getData&&"speech"===e.getData("bubbleType"))).map((e=>({npcName:e.getData("npcName"),exists:!!e,active:e.active})));console.log("[StageScene] 削除後の吹き出し一覧:",r),console.log("[StageScene] 削除された吹き出し数:",a),t||(console.log("[StageScene] 削除対象の吹き出しが見つかりませんでした:",e),console.log("[StageScene] 現在の吹き出し一覧:",this.children.list.filter((e=>e?.getData&&"speech"===e.getData("bubbleType"))).map((e=>({npcName:e.getData("npcName"),exists:!!e}))))),setTimeout((()=>{const e=this.children.list.filter((e=>e?.getData&&"speech"===e.getData("bubbleType"))).map((e=>({npcName:e.getData("npcName"),exists:!!e,active:e.active})));console.log("[StageScene] 削除処理完了後の最終吹き出し一覧:",e)}),100)}startConversation(e){this._isInConversation?console.log("[StageScene] 既に会話中です"):(console.log(`[StageScene] 会話開始: ${e}`),this._isInConversation=!0,this.scene.launch("DynamicConversationScene",{eventId:e,originalSceneKey:this.scene.key}))}create(){try{let e,t,s;if(console.log("[StageScene] create() 開始"),console.log("[StageScene] this.stageKey:",this.stageKey),console.log("[StageScene] this.stageConfig:",this.stageConfig),console.log("[StageScene] this.stageConfig.stageKey:",this.stageConfig.stageKey),console.log("[StageScene] this.stageKey === this.stageConfig.stageKey:",this.stageKey===this.stageConfig.stageKey),this.mapManager=new u(this),this.restoreState?(e=this.stageConfig.floors.find((e=>e.number===this.targetFloor)),this.currentFloor=this.targetFloor):this.nextFloorNumber?(e=this.stageConfig.floors.find((e=>e.number===this.nextFloorNumber)),this.currentFloor=this.nextFloorNumber,this.nextFloorNumber=null):(e=this.stageConfig.floors[0],this.currentFloor=1),this.mapManager.currentMapKey=e.mapKey,this.stageConfig.currentFloor=e,this.collisionManager=new f(this),this.collisionManager.setupCollisionGroups(),this.mapManager.createMap(),this.playerController=new M(this),this.restoreState&&this.playerPosition)t=this.playerPosition.x,s=this.playerPosition.y;else if(this.fromFloorNumber&&this.fromFloorNumber!==e.number){const a=`fromFloor${this.fromFloorNumber}Start`,r=e[`${a}X`],n=e[`${a}Y`];void 0!==r&&void 0!==n?(t=r,s=n):(t=e.playerStartX||100,s=e.playerStartY||100)}else t=e.playerStartX||100,s=e.playerStartY||100;this.playerController.createPlayer(t,s),this.createNPCs();try{this._onConversationEndedBound&&(console.log("[StageScene] 既存のイベントリスナーを削除"),this.events.off("conversation-ended",this._onConversationEndedBound))}catch(e){}console.log("[StageScene] conversation-endedイベントリスナー設定"),this._onConversationEndedBound=e=>{console.log("[StageScene] _onConversationEndedBound実行回数カウント"),console.log("[StageScene] conversation-ended受信:",e);const{eventId:t,cleared:a}=e||{};if(!t)return;const s=this.children.list.find((e=>e?.getData&&"npc"===e.getData("npcType")&&e.getData("eventId")===t));if(console.log("[StageScene] 対応NPC検索結果:",s?"見つかった":"見つからない",t),!s)return;const r=s.getData("objectName"),n=s.getData("npcName")||r;console.log("[StageScene] NPC名の詳細:",{objectName:r,npcName:n}),console.log("[StageScene] NPC名:",n,"cleared:",a);const o="true"===localStorage.getItem("event_completed_"+t),i=a||o;console.log("[StageScene] 吹き出し削除判定:",{cleared:a,noChoiceCompleted:o,shouldRemoveBubble:i}),i?(console.log("[StageScene] 吹き出し削除実行:",n),this.removeSpeechBubbleByNpcName(n),console.log("[StageScene] removeSpeechBubbleByNpcName呼び出し完了")):(console.log("[StageScene] 吹き出し作成実行:",n),this.createSpeechBubble(n,s))},this.events.on("conversation-ended",this._onConversationEndedBound),this.touchControlManager=new _(this,this.playerController,"se_touch"),this.cameraManager=new m(this),this.cameraManager.setBackgroundColor("#87CEEB"),this.cameraManager.setupCamera(this,this.mapManager.map,this.playerController.player),console.log("[StageScene] 現在のstageKey:",this.stageKey),console.log("[StageScene] stageKey === taketa_highschool:","taketa_highschool"===this.stageKey),console.log("[StageScene] stageKey === mie_high_school:","mie_high_school"===this.stageKey),"taketa_highschool"===this.stageKey?(console.log("[StageScene] 竹田高校用DialogSystem初期化開始"),a.e(424).then(a.bind(a,424)).then((({DialogSystem:e})=>{console.log("[StageScene] DialogSystemクラス読み込み完了"),a.e(191).then(a.bind(a,191)).then((({TaketaDialogData:t})=>{console.log("[StageScene] TaketaDialogData読み込み完了:",t),this.dialogSystem=new e(this,t),this.usedConversations=new Set,console.log("[StageScene] DialogSystem初期化完了（竹田高校用）"),console.log("[StageScene] 使用済み会話管理開始"),console.log("[StageScene] this.dialogSystem:",this.dialogSystem),console.log("[StageScene] this.usedConversations:",this.usedConversations),this.collisionManager&&(this.collisionManager.setDialogSystem(this.dialogSystem),console.log("[StageScene] CollisionManagerにDialogSystem参照を設定完了（竹田高校用）"))})).catch((e=>{console.error("[StageScene] TaketaDialogData読み込みエラー:",e)}))})).catch((e=>{console.error("[StageScene] DialogSystemクラス読み込みエラー:",e)}))):"mie_high_school"===this.stageKey?(console.log("[StageScene] 三重中学校用DialogSystem初期化開始"),console.log("[StageScene] mie_high_school 条件に一致しました！"),a.e(424).then(a.bind(a,424)).then((({DialogSystem:e})=>{console.log("[StageScene] DialogSystemクラス読み込み完了"),a.e(600).then(a.bind(a,600)).then((({Stage1DialogData:t})=>{console.log("[StageScene] Stage1DialogData読み込み完了:",t),console.log("[StageScene] Stage1DialogDataの内容:",t),this.dialogSystem=new e(this,t),this.usedConversations=new Set,console.log("[StageScene] DialogSystem初期化完了（三重中学校用）"),console.log("[StageScene] 使用済み会話管理開始"),console.log("[StageScene] this.dialogSystem:",this.dialogSystem),console.log("[StageScene] this.usedConversations:",this.usedConversations),this.collisionManager&&(this.collisionManager.setDialogSystem(this.dialogSystem),console.log("[StageScene] CollisionManagerにDialogSystem参照を設定完了（三重中学校用）"))})).catch((e=>{console.error("[StageScene] Stage1DialogData読み込みエラー:",e),console.error("[StageScene] エラーの詳細:",e.message)}))})).catch((e=>{console.error("[StageScene] DialogSystemクラス読み込みエラー:",e),console.error("[StageScene] エラーの詳細:",e.message)}))):(console.log("[StageScene] 竹田高校・三重中学校以外のため、DialogSystem初期化スキップ:",this.stageKey),console.log("[StageScene] スキップされたstageKeyの詳細:",this.stageKey)),this.audioManager=new d.AudioManager(this),window.returnToTaketaMap=()=>{window.startPhaserGame?window.startPhaserGame("taketa"):console.error("startPhaserGame not found")},window.returnToMiemachiMap=()=>{window.startPhaserGame?window.startPhaserGame("miemachi"):console.error("startPhaserGame not found")},this.stageConfig.bgm&&this.stageConfig.bgm.map?this.scene.sound&&this.scene.sound.context&&"suspended"===this.scene.sound.context.state?(console.log("[StageScene] 音声コンテキストが一時停止状態です。ユーザーインタラクションを待っています"),this.waitForAudioContext()):this.playBGM():console.warn("[StageScene] BGM設定が見つかりません"),this.setupTouchEvents(),this.conversationTrigger=new y(this);try{this.scene.manager.keys&&this.scene.manager.keys.ConversationScene||this.scene.add("ConversationScene",S)}catch(e){console.warn("[StageScene] ConversationScene登録エラー:",e)}try{this.scene.manager.keys&&this.scene.manager.keys.DynamicConversationScene||this.scene.add("DynamicConversationScene",C.DynamicConversationScene)}catch(e){console.warn("[StageScene] DynamicConversationScene登録エラー:",e)}this.collisionManager.setupAllCollisions(this.playerController.player,this.mapManager),this.uiManager=new g.UIManager,this.uiManager.createUI(this)}catch(e){console.error("[StageScene] create() エラー:",e)}}shutdown(){try{if(this._htmlBgm&&(this._htmlBgm.pause(),this._htmlBgm.currentTime=0,this._htmlBgm=null),this.audioManager&&this.audioManager.stopAll(),this.conversationTrigger&&(this.conversationTrigger.destroy(),this.conversationTrigger=null),this.sound&&(this.sound.stopAll(),this.sound.context&&(this.sound.context.state="suspended")),this.sound&&this.sound.context)try{this.sound.context.close&&this.sound.context.close(),this.sound.context=null}catch(e){console.warn("[StageScene] 音声コンテキストクリーンアップエラー:",e)}}catch(e){console.warn("[StageScene] 音声システムクリーンアップエラー:",e)}try{this.load&&this.load.reset&&this.load.reset()}catch(e){}try{this.load&&this.load.removeAllListeners&&this.load.removeAllListeners()}catch(e){}this.playerController&&(this.playerController.destroy(),this.playerController=null),this.touchControlManager&&(this.touchControlManager.destroy(),this.touchControlManager=null),this.cameraManager&&(this.cameraManager.destroy(),this.cameraManager=null),this.collisionManager&&(this.collisionManager.destroy(),this.collisionManager=null),this.audioManager&&(this.audioManager.destroy(),this.audioManager=null),this.events.off("shutdown",this.shutdown,this)}changeFloor(e){if(e!==this.currentFloor)try{const t=this.stageConfig.floors.find((t=>t.number===e));if(!t||!t.implemented)return void console.error(`[StageScene] フロア設定が見つからないか、未実装: ${e}`);this.restoreState=!1,this.targetFloor=1,this.playerPosition=null,this.mapKey=null,console.log("[StageScene] 状態復元設定をクリアしました（フロア変更時）"),this.nextFloorNumber=e,this.scene.settings&&(this.scene.settings.restoreState=!1,this.scene.settings.targetFloor=null,this.scene.settings.playerPosition=null,this.scene.settings.mapKey=null),this.scene.stop(),this.scene.start(this.scene.key,{nextFloorNumber:e,fromFloorNumber:this.currentFloor})}catch(e){console.error("[StageScene] フロア変更エラー:",e)}}setupTouchEvents(){this.input.on("pointerdown",(()=>{this.handleTouch()})),this.cameraManager.setupScrollControls(),this.cameraManager.setupPinchZoom()}handleTouch(){try{if(this.scene&&this.scene.sound&&this.scene.sound.context){const e=this.scene.sound.context;"suspended"===e.state&&e.resume()}}catch(e){console.warn("[StageScene] 音声コンテキスト処理エラー:",e)}}update(){this.cameraManager?.update(),this.playerController&&this.playerController.update()}destroy(){this.shutdown(),super.destroy()}resize(e){const{width:t,height:a}=e;this.cameras.resize(t,a),this.touchControlManager&&this.touchControlManager.updatePosition(t,a)}playBGM(){try{this.audioManager.stopAll(),this.scene.sound&&this.scene.sound.stopAll(),this._htmlBgm&&this._htmlBgm.pause();const e=this.stageConfig.floors.find((e=>e.number===this.currentFloor));if(e&&e.bgm&&e.bgm.map){const t=e.bgm.map;this._htmlBgm=new Audio(t),this._htmlBgm.loop=!0,this._htmlBgm.volume=.3,this._htmlBgm.play().catch((e=>{console.error(`[StageScene] BGM再生エラー: ${t}`,e),this.audioManager.playBgm("map")}))}else this.audioManager.playBgm("map")}catch(e){console.error("[StageScene] BGM再生エラー:",e),this.audioManager.playBgm("map")}}waitForAudioContext(){this.input.once("pointerdown",(()=>{if(this.scene.sound&&this.scene.sound.context){const e=this.scene.sound.context;"suspended"===e.state?e.resume().then((()=>{this.playBGM()})).catch((e=>{console.error("[StageScene] 音声コンテキスト復旧エラー:",e)})):this.playBGM()}}))}setConversationActive(e){this._isInConversation=e}isConversationActive(){return this._isInConversation}makeNPCLookAtPlayer(e){if(!this.playerController||!this.playerController.player)return;const t=this.playerController.player,a=e,s=t.x-a.x,r=t.y-a.y,n=Math.sqrt(s*s+r*r);if(n>0){const e=s/n,t=r/n;Math.abs(t)>Math.abs(e)?t<0?a.setFrame(9):a.setFrame(0):e<0?a.setFrame(3):a.setFrame(6)}}}function A(e){const t=w[e];return t?new B({stageKey:e,stageConfig:t}):(console.error(`Stage config not found for: ${e}`),null)}class D extends Phaser.Scene{constructor(){super({key:"EndingScene"}),this.choiceManager=null}preload(){console.log("[EndingScene] preload開始"),this.load.audio("ending_bgm","assets/audio/bgm/ending.mp3"),this.load.once("complete",(()=>{console.log("[EndingScene] preload完了")})),this.load.on("error",(e=>{console.error("[EndingScene] アセット読み込みエラー:",e)})),console.log("[EndingScene] preload - this.load.start()を実行"),this.load.start()}create(){console.log("[EndingScene] create開始"),console.log("[EndingScene] 画面サイズ:",this.sys.game.canvas.width,"x",this.sys.game.canvas.height),console.log("[EndingScene] ユーザーエージェント:",navigator.userAgent),console.log("[EndingScene] ゲームインスタンス:",window.game),console.log("[EndingScene] シーンマネージャー:",this.scene.manager),console.log("[EndingScene] 現在のシーンキー:",this.scene.key),console.log("[EndingScene] シーンがアクティブか:",this.scene.isActive()),this.choiceManager=new k.ChoiceManager,console.log("[EndingScene] ChoiceManager初期化完了"),console.log("[EndingScene] 初期化後のchoices:",this.choiceManager.choices),this.choiceManager.choices=this.choiceManager.loadChoices(),console.log("[EndingScene] 再読み込み後のchoices:",this.choiceManager.choices),this.cameras.main.setBackgroundColor("#000000"),console.log("[EndingScene] 背景色設定完了");try{this.sound.play("ending_bgm",{loop:!0,volume:.5}),console.log("[EndingScene] BGM再生開始")}catch(e){console.error("[EndingScene] BGM再生エラー:",e)}console.log("[EndingScene] showEndingContent呼び出し開始"),this.showEndingContent(),console.log("[EndingScene] showEndingContent呼び出し完了")}showEndingContent(){const e=this.sys.game.canvas.width,t=this.sys.game.canvas.height,a=this.getCorrectRate(),s=this.add.text(e/2,t/4,"エンディング",{fontSize:"48px",fill:"#FFFFFF",fontFamily:"Arial",fontStyle:"bold"}).setOrigin(.5),r=this.add.text(e/2,t/2,this.getEndingMessage(),{fontSize:"24px",fill:"#FFFFFF",fontFamily:"Arial",align:"center",wordWrap:{width:e-100}}).setOrigin(.5);let n=null;if(a>=80){n=this.add.container(e/2,3*t/4);const a=this.add.graphics();a.fillStyle(16739179,.9),a.fillRoundedRect(-120,-30,240,60,10),n.add(a);const s=this.add.text(0,0,"エンディング動画を見る",{fontSize:"18px",fill:"#FFFFFF",fontFamily:"Arial",fontStyle:"bold"}).setOrigin(.5);n.add(s),n.setInteractive(new Phaser.Geom.Rectangle(-120,-30,240,60),Phaser.Geom.Rectangle.Contains),n.on("pointerdown",(()=>{this.showYouTubeVideo()})),n.on("pointerover",(()=>{a.fillStyle(16748174,.9),a.fillRoundedRect(-120,-30,240,60,10)})),n.on("pointerout",(()=>{a.fillStyle(16739179,.9),a.fillRoundedRect(-120,-30,240,60,10)}))}else{n=this.add.container(e/2,3*t/4);const a=this.add.graphics();a.fillStyle(4886754,.9),a.fillRoundedRect(-100,-25,200,50,10),n.add(a);const s=this.add.text(0,0,"タイトルに戻る",{fontSize:"20px",fill:"#FFFFFF",fontFamily:"Arial",fontStyle:"bold"}).setOrigin(.5);n.add(s),n.setInteractive(new Phaser.Geom.Rectangle(-100,-25,200,50),Phaser.Geom.Rectangle.Contains),n.on("pointerdown",(()=>{this.returnToTitle()})),n.on("pointerover",(()=>{a.fillStyle(6004978,.9),a.fillRoundedRect(-100,-25,200,50,10)})),n.on("pointerout",(()=>{a.fillStyle(4886754,.9),a.fillRoundedRect(-100,-25,200,50,10)}))}const o=[s,r];n&&o.push(n),this.tweens.add({targets:o,alpha:{from:0,to:1},duration:2e3,ease:"Power2"})}getCorrectRate(){console.log("[EndingScene] getCorrectRate開始"),console.log("[EndingScene] this.choiceManager:",this.choiceManager),console.log("[EndingScene] this.choiceManager.choices:",this.choiceManager.choices);const e=this.choiceManager.choices;let t=0,a=0;for(const s in e){console.log("[EndingScene] conversationId:",s);for(const r in e[s])console.log("[EndingScene] choiceId:",r,"value:",e[s][r]),t++,"correct"===e[s][r]&&a++}const s=t>0?a/t*100:0;return console.log("[EndingScene] 正解率計算結果: 総選択数=",t,"正解数=",a,"正解率=",s+"%"),s}getEndingMessage(){const e=this.getCorrectRate();return e>=80?"素晴らしい判断力でした！\nあなたは正しい選択を続けることができました。\nこの経験を活かして、これからも良い判断を心がけてください。\n\nおめでとうございます！特別なエンディング動画をご覧ください！":e>=60?"良い判断ができました！\n多くの場面で正しい選択をすることができました。\nこれからも学びを続けてください。":e>=40?"まずまずの結果でした。\nいくつかの選択で改善の余地がありますが、\n学びの機会として活用してください。":"結果は思わしくありませんでしたが、\n失敗から学ぶことも大切です。\nもう一度挑戦してみてください。"}showYouTubeVideo(){console.log("[EndingScene] YouTube動画表示開始"),console.log("[EndingScene] エンディング動画表示開始"),console.log("[EndingScene] 直接YouTubeを開く方式でエンディング動画を表示します");try{console.log("[EndingScene] 包括的なBGM停止処理を開始"),this.sound.stopAll(),this._htmlBgm&&(this._htmlBgm.pause(),this._htmlBgm=null),window.game&&window.game.sound&&window.game.sound.stopAll();try{window.audioManager&&(console.log("[EndingScene] AudioManagerのBGM停止開始"),window.audioManager.stopAll&&window.audioManager.stopAll(),window.audioManager.stopBgm&&window.audioManager.stopBgm(),console.log("[EndingScene] AudioManagerのBGM停止完了"))}catch(e){console.error("[EndingScene] AudioManagerのBGM停止エラー:",e)}window.game&&window.game.scene&&window.game.scene.getScenes&&(window.game.scene.getScenes(!1)||[]).forEach((e=>{try{e.sound&&e.sound.stopAll&&e.sound.stopAll(),e._htmlBgm&&(e._htmlBgm.pause(),e._htmlBgm=null),e._eventHtmlBgm&&(e._eventHtmlBgm.pause(),e._eventHtmlBgm=null)}catch(e){}}));try{if(window.game&&window.game.scene&&window.game.scene.getScene){const e=window.game.scene.getScene("JapanStage");e&&(console.log("[EndingScene] JapanStageのBGM停止開始"),e.sound&&e.sound.stopAll&&e.sound.stopAll(),e._htmlBgm&&(e._htmlBgm.pause(),e._htmlBgm=null),e._eventHtmlBgm&&(e._eventHtmlBgm.pause(),e._eventHtmlBgm=null),console.log("[EndingScene] JapanStageのBGM停止完了"))}}catch(e){console.error("[EndingScene] JapanStageのBGM停止エラー:",e)}try{const e=document.querySelectorAll("audio");console.log("[EndingScene] 検出されたaudio要素数:",e.length),e.forEach(((e,t)=>{console.log(`[EndingScene] audio要素${t}を停止`),e.pause(),e.currentTime=0,e.src=""}));const t=document.querySelectorAll("video");console.log("[EndingScene] 検出されたvideo要素数:",t.length),t.forEach(((e,t)=>{console.log(`[EndingScene] video要素${t}を停止`),e.pause(),e.currentTime=0}))}catch(e){console.error("[EndingScene] 音声要素停止エラー:",e)}console.log("[EndingScene] 包括的なBGM停止処理完了");const e="https://youtu.be/GiJQxEIiGwQ";console.log("[EndingScene] YouTubeを開きます:",e),window.open(e,"_blank"),console.log("[EndingScene] エンディング動画（YouTube）を開きました"),console.log("[EndingScene] BGMは再開しません（動画視聴中）"),setTimeout((()=>{console.log("[EndingScene] タイトルに戻ります"),this.returnToTitle()}),3e3)}catch(e){console.error("[EndingScene] YouTubeを開く際のエラー:",e)}}returnToTitle(){console.log("[EndingScene] BGM停止開始"),this.sound.stopAll(),this._htmlBgm&&(this._htmlBgm.pause(),this._htmlBgm=null),window.game&&window.game.sound&&window.game.sound.stopAll();try{window.audioManager&&(console.log("[EndingScene] AudioManagerのBGM停止開始"),window.audioManager.stopAll&&window.audioManager.stopAll(),window.audioManager.stopBgm&&window.audioManager.stopBgm(),console.log("[EndingScene] AudioManagerのBGM停止完了"))}catch(e){console.error("[EndingScene] AudioManagerのBGM停止エラー:",e)}window.game&&window.game.scene&&window.game.scene.getScenes&&(window.game.scene.getScenes(!1)||[]).forEach((e=>{try{e.sound&&e.sound.stopAll&&e.sound.stopAll(),e._htmlBgm&&(e._htmlBgm.pause(),e._htmlBgm=null),e._eventHtmlBgm&&(e._eventHtmlBgm.pause(),e._eventHtmlBgm=null)}catch(e){}}));try{if(window.game&&window.game.scene&&window.game.scene.getScene){const e=window.game.scene.getScene("JapanStage");e&&(console.log("[EndingScene] JapanStageのBGM停止開始"),e.sound&&e.sound.stopAll&&e.sound.stopAll(),e._htmlBgm&&(e._htmlBgm.pause(),e._htmlBgm=null),e._eventHtmlBgm&&(e._eventHtmlBgm.pause(),e._eventHtmlBgm=null),console.log("[EndingScene] JapanStageのBGM停止完了"))}}catch(e){console.error("[EndingScene] JapanStageのBGM停止エラー:",e)}try{const e=document.querySelectorAll("audio");console.log("[EndingScene] 検出されたaudio要素数:",e.length),e.forEach(((e,t)=>{console.log(`[EndingScene] audio要素${t}を停止`),e.pause(),e.currentTime=0,e.src=""}));const t=document.querySelectorAll("video");console.log("[EndingScene] 検出されたvideo要素数:",t.length),t.forEach(((e,t)=>{console.log(`[EndingScene] video要素${t}を停止`),e.pause(),e.currentTime=0}))}catch(e){console.error("[EndingScene] 強制停止エラー:",e)}console.log("[EndingScene] BGM停止完了"),console.log("[EndingScene] 戻る処理開始"),window.LoadingManager&&window.LoadingManager.show("メインメニューに戻っています...",50);try{const e=document.getElementById("main-menu"),t=document.getElementById("stage-select");e&&t?(t.style.display="none",e.style.display="flex",console.log("[EndingScene] メインメニュー画面に直接遷移しました"),console.log("[EndingScene] メインメニューBGMは再生しません（動画視聴中）"),setTimeout((()=>{window.LoadingManager&&(window.LoadingManager.updateProgress(100,"完了！"),setTimeout((()=>{window.LoadingManager.hide()}),500))}),1e3)):(console.error("[EndingScene] メインメニュー要素が見つかりません"),window.showStageSelect&&(window.showStageSelect(),console.log("[EndingScene] フォールバック：showStageSelectを使用しました")),window.LoadingManager&&window.LoadingManager.hide())}catch(e){console.error("[EndingScene] メインメニュー画面への遷移エラー:",e),window.showStageSelect&&(window.showStageSelect(),console.log("[EndingScene] フォールバック：showStageSelectを使用しました")),window.LoadingManager&&window.LoadingManager.hide()}}}let T=null;function z(e){try{if(window.game&&window.game.scene&&window.game.scene.getScenes){const e=window.game.scene.getScenes(!1)||[];for(const t of e){try{t.load&&t.load.reset&&t.load.reset()}catch(e){}try{t.load&&t.load.removeAllListeners&&t.load.removeAllListeners()}catch(e){}try{t.sound&&t.sound.stopAll&&t.sound.stopAll()}catch(e){}try{t.audioManager&&t.audioManager.stopAll&&t.audioManager.stopAll()}catch(e){}try{t.scene&&t.scene.isActive&&t.scene.isActive()&&t.scene.stop()}catch(e){}try{t.scene&&t.scene.remove&&t.scene.remove()}catch(e){}}}}catch(e){}const t=function(){if(window.game)return window.game;const e={...n,scene:[]};T=new Phaser.Game(e),window.game=T,window.gameInstance=T;try{T.events.on("destroy",(()=>{try{T.isDestroyed=!0}catch(e){}}))}catch(e){}try{if(!window.__audioUnlockInstalled){const e=()=>{try{const t=window.gameInstance&&window.gameInstance.sound,a=t&&t.context;if(a){"running"!==a.state&&a.resume().catch((()=>{}));try{const e=a.createOscillator(),t=a.createGain();t.gain.value=1e-4,e.connect(t).connect(a.destination),e.start(),e.stop(a.currentTime+.05)}catch(e){}}t&&!t.locked&&(window.removeEventListener("pointerdown",e,!0),window.removeEventListener("touchstart",e,!0),window.removeEventListener("click",e,!0))}catch(e){}};window.addEventListener("pointerdown",e,!0),window.addEventListener("touchstart",e,!0),window.addEventListener("click",e,!0),window.__audioUnlockInstalled=!0}}catch(e){}return T}();let a,s;switch(e){case"miemachi":case"bunngo_mie_city":default:a=v("miemachistage","MiemachiStage"),s="MiemachiStage";break;case"taketa":case"taketa_city":a=v("taketastage","TaketastageStage"),s="TaketastageStage";break;case"japan":case"zenkoku":a=v("japanstage","JapanStage"),s="JapanStage";break;case"ending":a=D,s="EndingScene";break;case"taketa_highschool":a=A("taketa_highschool"),s="taketa_highschool";break;case"mie_high_school":a=A("mie_high_school"),s="mie_high_school"}try{t.sound&&t.sound.stopAll(),t.scene&&t.scene.getScenes&&(t.scene.getScenes(!0)||[]).forEach((e=>{try{e.sound&&e.sound.stopAll&&e.sound.stopAll()}catch(e){}try{e._htmlBgm&&(e._htmlBgm.pause(),e._htmlBgm=null)}catch(e){}try{e.scene&&e.scene.stop&&e.scene.stop()}catch(e){}}))}catch(e){}try{const e=t.scene&&(t.scene.scenes||t.scene.getScenes&&t.scene.getScenes(!1))||[];(Array.isArray(e)?e:[]).forEach((e=>{try{e&&e.sound&&e.sound.stopAll&&e.sound.stopAll()}catch(e){}try{e&&e._htmlBgm&&(e._htmlBgm.pause(),e._htmlBgm=null)}catch(e){}try{e&&e._eventHtmlBgm&&(e._eventHtmlBgm.pause(),e._eventHtmlBgm=null)}catch(e){}try{e&&e.scene&&e.scene.isActive&&e.scene.isActive()&&e.scene.stop()}catch(e){}try{e&&e.scene&&e.scene.remove&&e.scene.remove()}catch(e){}}))}catch(e){}try{t.scene.getScene&&t.scene.getScene(s)&&t.scene.remove(s),t.scene.getScene&&t.scene.getScene("ConversationScene")&&t.scene.remove("ConversationScene")}catch(e){}if(window.LoadingManager){const t={miemachi:"三重シティ",taketa:"竹田シティ",japan:"全国",taketa_highschool:"竹田高校",mie_high_school:"三重中学校",ending:"エンディング"}[e]||"ゲーム";window.LoadingManager.show(`${t}を読み込み中...`,0)}const r=t.scene.add(s,a,!0);if(window.LoadingManager&&r){if("miemachi"===e||"taketa"===e||"japan"===e)return void(r.load&&r.load.on?(r.load.on("progress",(e=>{window.LoadingManager&&window.LoadingManager.updateProgress(100*e)})),r.load.once("complete",(()=>{window.LoadingManager&&(window.LoadingManager.updateProgress(100,"完了！"),setTimeout((()=>{window.LoadingManager.hide()}),500))}))):setTimeout((()=>{window.LoadingManager&&(window.LoadingManager.updateProgress(100,"完了！"),setTimeout((()=>{window.LoadingManager.hide()}),500))}),2e3));if("ending"===e)return void(r.load&&r.load.on?(r.load.on("progress",(e=>{window.LoadingManager&&window.LoadingManager.updateProgress(100*e)})),r.load.once("complete",(()=>{window.LoadingManager&&(window.LoadingManager.updateProgress(100,"完了！"),setTimeout((()=>{window.LoadingManager.hide()}),500))}))):setTimeout((()=>{window.LoadingManager&&(window.LoadingManager.updateProgress(100,"完了！"),setTimeout((()=>{window.LoadingManager.hide()}),500))}),1e3));r.load&&r.load.on?(r.load.on("progress",(e=>{window.LoadingManager&&window.LoadingManager.updateProgress(100*e)})),r.load.once("complete",(()=>{window.LoadingManager&&(window.LoadingManager.updateProgress(100,"完了！"),setTimeout((()=>{window.LoadingManager.hide()}),500))}))):setTimeout((()=>{window.LoadingManager&&(window.LoadingManager.updateProgress(100,"完了！"),setTimeout((()=>{window.LoadingManager.hide()}),500))}),2e3),setTimeout((()=>{window.LoadingManager&&window.LoadingManager.hide()}),5e3)}}window.startPhaserGame=z},728:(e,t,a)=>{a.r(t),a.d(t,{UIManager:()=>s});class s{constructor(){this.playerPosText=null,this.backButton=null}createUI(e){this.createBackButton(e)}updateMapTitle(e,t){try{this.titleText?this.titleText.setText(e):t&&t.add&&(this.titleText=t.add.text(5,t.cameras.main.height-25,e,{fontSize:"18px",fill:"#FFD700",fontWeight:"bold"}).setOrigin(0,1))}catch(e){}}createBackButton(e){if(!e||!e.cameras||!e.cameras.main)return void console.warn("UIManager: Scene or camera is not available for back button");if(!e.input)return void console.warn("UIManager: Scene input system is not available for back button");this.backButtonGraphics=e.add.graphics(),this.backButtonGraphics.fillStyle(0,.3),this.backButtonGraphics.fillRoundedRect(4.5,4.5,155,30,8),this.backButtonGraphics.fillStyle(2763306,.95),this.backButtonGraphics.fillRoundedRect(2.5,2.5,155,30,8),this.backButtonGraphics.fillStyle(16777215,.1),this.backButtonGraphics.fillRoundedRect(2.5,2.5,155,15,8),this.backButtonGraphics.setDepth(1e3),this.backButtonGraphics.setScrollFactor(0),this.backButtonGraphics.setInteractive(new Phaser.Geom.Rectangle(5,5,150,40),Phaser.Geom.Rectangle.Contains);let t="戻る";e.scene&&e.scene.key&&("Stage1Scene"===e.scene.key||"Stage2Scene"===e.scene.key||"Stage3Scene"===e.scene.key?t="マップに戻る":"MiemachiStage"!==e.scene.key&&"TaketastageStage"!==e.scene.key&&"JapanStage"!==e.scene.key||(t="ステージ選択画面")),this.backButtonGraphics.on("pointerdown",((t,a,s,r)=>{try{r&&r.preventDefault&&r.preventDefault()}catch(e){}try{r&&r.stopImmediatePropagation&&r.stopImmediatePropagation()}catch(e){}if("Stage1Scene"===e.scene?.key||"Stage2Scene"===e.scene?.key||"Stage3Scene"===e.scene?.key){try{e.input&&e.input.removeAllListeners&&e.input.removeAllListeners("pointerdown")}catch(e){}try{e.sound&&e.sound.removeAllListeners&&e.sound.removeAllListeners("unlocked")}catch(e){}try{e.sound&&e.sound.stopAll&&e.sound.stopAll()}catch(e){}try{e.audioManager&&e.audioManager.stopAll&&e.audioManager.stopAll()}catch(e){}try{e._htmlBgm&&(e._htmlBgm.pause(),e._htmlBgm=null)}catch(e){}try{e._eventHtmlBgm&&(e._eventHtmlBgm.pause(),e._eventHtmlBgm=null)}catch(e){}try{e.load&&e.load.reset&&e.load.reset()}catch(e){}try{e.load&&e.load.removeAllListeners&&e.load.removeAllListeners()}catch(e){}try{e.scene&&e.scene.get&&e.scene.get("ConversationScene")&&e.scene.remove("ConversationScene")}catch(e){}const t=()=>{if(window.returnToMap)window.returnToMap();else if(window.returnToStageSelect)window.returnToStageSelect();else if(window.returnToMiemachi)window.returnToMiemachi();else{const e=document.getElementById("stage-select"),t=document.getElementById("game-container");e&&(e.style.display="flex"),t&&(t.style.display="none")}};try{requestAnimationFrame((()=>setTimeout(t,0)))}catch(e){t()}}else if("MiemachiStage"===e.scene?.key||"TaketastageStage"===e.scene?.key||"JapanStage"===e.scene?.key){window.returnToMap=null;try{e._suppressMapBgm=!0}catch(e){}try{e._bgmRetry&&e._bgmRetry.remove&&(e._bgmRetry.remove(!1),e._bgmRetry=null)}catch(e){}try{e.input&&e.input.removeAllListeners&&e.input.removeAllListeners("pointerdown")}catch(e){}try{e._htmlBgm&&(e._htmlBgm.pause(),e._htmlBgm=null)}catch(e){}try{e.audioManager&&e.audioManager.stopAll&&e.audioManager.stopAll()}catch(e){}try{e.sound&&e.sound.removeAllListeners&&e.sound.removeAllListeners("unlocked")}catch(e){}const t=()=>{try{if(window.returnToStageSelect)window.returnToStageSelect();else{const e=document.getElementById("stage-select"),t=document.getElementById("game-container");e&&(e.style.display="flex"),t&&(t.style.display="none")}}catch(e){}};try{requestAnimationFrame((()=>setTimeout(t,0)))}catch(e){t()}}else if("taketa_highschool"===e.scene?.key){try{e._htmlBgm&&(e._htmlBgm.pause(),e._htmlBgm=null)}catch(e){}try{e.audioManager&&e.audioManager.stopAll&&e.audioManager.stopAll()}catch(e){}try{e.sound&&e.sound.stopAll&&e.sound.stopAll()}catch(e){}const t=()=>{window.returnToTaketaMap?window.returnToTaketaMap():e.scene.start("TaketastageStage")};try{requestAnimationFrame((()=>setTimeout(t,0)))}catch(e){t()}}else if("mie_high_school"===e.scene?.key){try{e._htmlBgm&&(e._htmlBgm.pause(),e._htmlBgm=null)}catch(e){}try{e.audioManager&&e.audioManager.stopAll&&e.audioManager.stopAll()}catch(e){}try{e.sound&&e.sound.stopAll&&e.sound.stopAll()}catch(e){}const t=()=>{window.returnToMiemachiMap?window.returnToMiemachiMap():e.scene.start("MiemachiStage")};try{requestAnimationFrame((()=>setTimeout(t,0)))}catch(e){t()}}else{const e=()=>{if(window.returnToStageSelect)window.returnToStageSelect();else{const e=document.getElementById("stage-select"),t=document.getElementById("game-container");e&&(e.style.display="block"),t&&(t.style.display="none")}};try{requestAnimationFrame((()=>setTimeout(e,0)))}catch(t){e()}}})),e.input&&e.input.keyboard&&e.input.keyboard.on("keydown-ESC",(()=>{if(window.returnToStageSelect)window.returnToStageSelect();else{const e=document.getElementById("stage-select"),t=document.getElementById("game-container");e&&(e.style.display="block"),t&&(t.style.display="none")}})),this.backButtonGraphics.on("pointerover",(()=>{this.backButtonGraphics.clear(),this.backButtonGraphics.fillStyle(0,.4),this.backButtonGraphics.fillRoundedRect(4.5,4.5,155,30,8),this.backButtonGraphics.fillStyle(3815994,.98),this.backButtonGraphics.fillRoundedRect(2.5,2.5,155,30,8),this.backButtonGraphics.fillStyle(16777215,.15),this.backButtonGraphics.fillRoundedRect(2.5,2.5,155,15,8)})),this.backButtonGraphics.on("pointerout",(()=>{this.backButtonGraphics.clear(),this.backButtonGraphics.fillStyle(0,.3),this.backButtonGraphics.fillRoundedRect(4.5,4.5,155,30,8),this.backButtonGraphics.fillStyle(2763306,.95),this.backButtonGraphics.fillRoundedRect(2.5,2.5,155,30,8),this.backButtonGraphics.fillStyle(16777215,.1),this.backButtonGraphics.fillRoundedRect(2.5,2.5,155,15,8)})),this.backButtonText=e.add.text(80,25,t,{fontSize:"18px",fill:"#ffffff",fontWeight:"bold",fixedHeight:50,wordWrap:{width:150},align:"center",padding:{x:10,y:10}}),this.backButtonText.setOrigin(.5,.5),this.backButtonText.setScrollFactor(0),this.backButtonText.setDepth(1001),e.scale.on("resize",(()=>{e&&e.cameras&&e.cameras.main&&this.backButtonGraphics}))}updatePlayerPosition(e){(!this.lastPlayerX||!this.lastPlayerY||Math.abs(e.x-this.lastPlayerX)>1||Math.abs(e.y-this.lastPlayerY)>1)&&(this.lastPlayerX=e.x,this.lastPlayerY=e.y),this.playerPosText&&this.playerPosText.setText(`ひろかず位置: X=${Math.round(e.x)}, Y=${Math.round(e.y)}`)}createMapUI(e,t){this.titleText=e.add.text(5,e.cameras.main.height-25,t,{fontSize:"18px",fill:"#FFD700",fontWeight:"bold",backgroundColor:"rgba(0, 0, 0, 0.7)",padding:{x:12,y:6},borderRadius:8,stroke:"#FF6B35",strokeThickness:2,shadow:{offsetX:3,offsetY:3,color:"#000000",blur:6,fill:!0}}).setOrigin(0,1),this.instructionText=e.add.text(5,e.cameras.main.height-15,"場所をタップして移動！",{fontSize:"14px",fill:"#FF6B35",backgroundColor:"rgba(0, 0, 0, 0.3)",padding:{x:8,y:4},borderRadius:6,stroke:"#FF00FF",strokeThickness:2,shadow:{offsetX:3,offsetY:3,color:"#FF6B35",blur:8,fill:!0}}).setOrigin(0,1),this.updateMapUI({width:e.cameras.main.width,height:e.cameras.main.height}),"ステージ選択画面"===t&&this.createResetButton(e),this.selectedAreaText=e.add.text(e.cameras.main.centerX,e.cameras.main.height-50,"",{fontSize:"14px",fill:"#000000",backgroundColor:"transparent",padding:{x:8,y:4},borderRadius:8}).setOrigin(.5)}createResetButton(e){this.resetButton=e.add.text(10,10,"ゲームリセット",{fontSize:"14px",fill:"#FF0000",backgroundColor:"rgba(0, 0, 0, 0.8)",padding:{x:10,y:6},borderRadius:6,stroke:"#FFFFFF",strokeThickness:1}).setOrigin(0,0),this.resetButton.setInteractive(),this.resetButton.on("pointerdown",(()=>{if(e.areaSelectionManager&&(e.areaSelectionManager.resetAllCompletions(),console.log("完了状態をリセットしました")),window.returnToStageSelect)window.returnToStageSelect();else{const e=document.getElementById("stage-select"),t=document.getElementById("game-container");e&&(e.style.display="flex"),t&&(t.style.display="none")}})),this.resetButton.on("pointerover",(()=>{this.resetButton.setStyle({backgroundColor:"rgba(255, 0, 0, 0.9)"})})),this.resetButton.on("pointerout",(()=>{this.resetButton.setStyle({backgroundColor:"rgba(0, 0, 0, 0.8)"})}))}updateMapUI(e){const t=e.width/2;this.titleText&&this.titleText.setPosition(10,e.height-40),this.instructionText&&(this.instructionText.setPosition(10,e.height-15),console.log(`[UIManager] 説明テキストの位置を更新: (10, ${e.height-15})`)),this.selectedAreaText&&this.selectedAreaText.setPosition(t,e.height-50)}showSelectedArea(e,t){this.selectedAreaText&&this.selectedAreaText.setText(`エリア: ${e}\n${t}`)}createConversationBackButton(e){this.conversationBackButtonGraphics=e.add.graphics(),this.conversationBackButtonGraphics.fillStyle(0,.3),this.conversationBackButtonGraphics.fillRoundedRect(4.5,4.5,155,30,8),this.conversationBackButtonGraphics.fillStyle(2763306,.95),this.conversationBackButtonGraphics.fillRoundedRect(2.5,2.5,155,30,8),this.conversationBackButtonGraphics.fillStyle(16777215,.1),this.conversationBackButtonGraphics.fillRoundedRect(2.5,2.5,155,15,8),this.conversationBackButtonGraphics.setDepth(1e3),this.conversationBackButtonGraphics.setScrollFactor(0),this.conversationBackButtonGraphics.setInteractive(new Phaser.Geom.Rectangle(5,5,150,40),Phaser.Geom.Rectangle.Contains),this.conversationBackButtonGraphics.on("pointerdown",(()=>{e.interruptConversation&&e.interruptConversation()})),this.conversationBackButtonGraphics.on("pointerover",(()=>{this.conversationBackButtonGraphics.clear(),this.conversationBackButtonGraphics.fillStyle(0,.4),this.conversationBackButtonGraphics.fillRoundedRect(4.5,4.5,155,30,8),this.conversationBackButtonGraphics.fillStyle(3815994,.98),this.conversationBackButtonGraphics.fillRoundedRect(2.5,2.5,155,30,8),this.conversationBackButtonGraphics.fillStyle(16777215,.15),this.conversationBackButtonGraphics.fillRoundedRect(2.5,2.5,155,15,8)})),this.conversationBackButtonGraphics.on("pointerout",(()=>{this.conversationBackButtonGraphics.clear(),this.conversationBackButtonGraphics.fillStyle(0,.3),this.conversationBackButtonGraphics.fillRoundedRect(4.5,4.5,155,30,8),this.conversationBackButtonGraphics.fillStyle(2763306,.95),this.conversationBackButtonGraphics.fillRoundedRect(2.5,2.5,155,30,8),this.conversationBackButtonGraphics.fillStyle(16777215,.1),this.conversationBackButtonGraphics.fillRoundedRect(2.5,2.5,155,15,8)})),this.conversationBackButtonText=e.add.text(80,25,"会話を中断",{fontSize:"18px",fill:"#ffffff",fontWeight:"bold",fixedHeight:50,wordWrap:{width:150},align:"center",padding:{x:10,y:10}}),this.conversationBackButtonText.setOrigin(.5,.5),this.conversationBackButtonText.setScrollFactor(0),this.conversationBackButtonText.setDepth(1001),e.scale.on("resize",(()=>{this.conversationBackButtonGraphics}))}cleanupConversationBackButton(){this.conversationBackButtonGraphics&&(this.conversationBackButtonGraphics.destroy(),this.conversationBackButtonGraphics=null),this.conversationBackButtonText&&(this.conversationBackButtonText.destroy(),this.conversationBackButtonText=null)}destroy(){if(!this._destroyed){this._destroyed=!0;try{const e=e=>{this[e]&&"function"==typeof this[e].destroy&&(this[e].destroy(),this[e]=null)};e("playerPosText"),e("backButtonGraphics"),e("backButtonText"),e("titleText"),e("instructionText"),e("selectedAreaText"),e("resetButton"),this.cleanupConversationBackButton()}catch(e){console.error("Error during UIManager cleanup:",e)}}}}},863:(e,t,a)=>{a.r(t),a.d(t,{ChoiceManager:()=>s});class s{constructor(){this.choices=this.loadChoices(),this.storageKey="game_choices"}static getInstance(){return s._instance||(s._instance=new s),s._instance}loadChoices(){try{const e=localStorage.getItem(this.storageKey);return e?JSON.parse(e):{}}catch(e){return console.error("選択データの読み込みエラー:",e),{}}}saveChoice(e,t,a){console.log("[ChoiceManager] saveChoice呼び出し:",{conversationId:e,choiceId:t,selectedOption:a}),e?(this.choices[e]||(this.choices[e]={}),this.choices[e][t]=a,console.log("[ChoiceManager] 保存後のchoices:",this.choices),this.saveToStorage()):console.error("[ChoiceManager] conversationIdが未定義です！")}saveToStorage(){try{localStorage.setItem(this.storageKey,JSON.stringify(this.choices))}catch(e){console.error("選択データの保存エラー:",e)}}getChoice(e,t){return this.choices[e]?.[t]||null}isChoiceCorrect(e,t){const a=this.choices[e]?.[t];return"correct"===a}checkEndingCondition(){if(window.__justReset)return!1;const e=["breaking_car","wax_on","otsuka_senpai","drinking_dutu"];for(const t of e)if(!this.isEventCleared(t))return console.log("[ChoiceManager] エンディング条件未達成:",t,"が未クリア"),!1;return console.log("[ChoiceManager] エンディング条件達成: 全ての選択肢イベントがクリア済み"),!0}resetChoices(){this.choices={},this.saveToStorage()}debugChoices(){console.log("[ChoiceManager] 現在の選択データ:",this.choices)}isEventCleared(e){console.log("[ChoiceManager] isEventCleared呼び出し:",{eventId:e,choices:this.choices});const t=this.choices[e];if(console.log("[ChoiceManager] eventChoices:",t),!t)return console.log("[ChoiceManager] eventChoicesが存在しない、falseを返す"),!1;const a=Object.values(t);console.log("[ChoiceManager] eventChoicesの値:",a);const s=a.some((e=>"correct"===e));return console.log("[ChoiceManager] hasCorrect:",s),s}hasAnyChoiceRecorded(e){return!!this.choices[e]&&Object.keys(this.choices[e]).length>0}}"undefined"!=typeof window&&(window.ChoiceManager=s)}},s={};function r(e){var t=s[e];if(void 0!==t)return t.exports;var n=s[e]={exports:{}};return a[e](n,n.exports,r),n.exports}r.m=a,r.d=(e,t)=>{for(var a in t)r.o(t,a)&&!r.o(e,a)&&Object.defineProperty(e,a,{enumerable:!0,get:t[a]})},r.f={},r.e=e=>Promise.all(Object.keys(r.f).reduce(((t,a)=>(r.f[a](e,t),t)),[])),r.u=e=>e+".bundle.js",r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),e={},t="zosusoft-prj-hirokazu:",r.l=(a,s,n,o)=>{if(e[a])e[a].push(s);else{var i,c;if(void 0!==n)for(var h=document.getElementsByTagName("script"),l=0;l<h.length;l++){var p=h[l];if(p.getAttribute("src")==a||p.getAttribute("data-webpack")==t+n){i=p;break}}i||(c=!0,(i=document.createElement("script")).charset="utf-8",i.timeout=120,r.nc&&i.setAttribute("nonce",r.nc),i.setAttribute("data-webpack",t+n),i.src=a),e[a]=[s];var g=(t,s)=>{i.onerror=i.onload=null,clearTimeout(d);var r=e[a];if(delete e[a],i.parentNode&&i.parentNode.removeChild(i),r&&r.forEach((e=>e(s))),t)return t(s)},d=setTimeout(g.bind(null,void 0,{type:"timeout",target:i}),12e4);i.onerror=g.bind(null,i.onerror),i.onload=g.bind(null,i.onload),c&&document.head.appendChild(i)}},r.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.p="./",(()=>{var e={792:0};r.f.j=(t,a)=>{var s=r.o(e,t)?e[t]:void 0;if(0!==s)if(s)a.push(s[2]);else{var n=new Promise(((a,r)=>s=e[t]=[a,r]));a.push(s[2]=n);var o=r.p+r.u(t),i=new Error;r.l(o,(a=>{if(r.o(e,t)&&(0!==(s=e[t])&&(e[t]=void 0),s)){var n=a&&("load"===a.type?"missing":a.type),o=a&&a.target&&a.target.src;i.message="Loading chunk "+t+" failed.\n("+n+": "+o+")",i.name="ChunkLoadError",i.type=n,i.request=o,s[1](i)}}),"chunk-"+t,t)}};var t=(t,a)=>{var s,n,[o,i,c]=a,h=0;if(o.some((t=>0!==e[t]))){for(s in i)r.o(i,s)&&(r.m[s]=i[s]);c&&c(r)}for(t&&t(a);h<o.length;h++)n=o[h],r.o(e,n)&&e[n]&&e[n][0](),e[n]=0},a=self.webpackChunkzosusoft_prj_hirokazu=self.webpackChunkzosusoft_prj_hirokazu||[];a.forEach(t.bind(null,0)),a.push=t.bind(null,a.push.bind(a))})(),r(555);const n=new class{constructor(){this.deferredPrompt=null,this.init()}init(){console.log("PWAManager初期化開始"),this.registerEventListeners(),console.log("PWAManager初期化完了")}registerEventListeners(){window.addEventListener("beforeinstallprompt",(e=>{console.log("beforeinstallprompt event fired"),e.preventDefault(),this.deferredPrompt=e,this.enableInstallButton(),this.showInstallBanner()})),window.addEventListener("appinstalled",(()=>{console.log("PWAがインストールされました"),this.hideInstallBanner(),this.deferredPrompt=null})),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",(()=>{this.setupInstallButton()})):this.setupInstallButton()}setupInstallButton(){const e=document.getElementById("install-btn"),t=document.getElementById("close-install-btn");e&&e.addEventListener("click",(async e=>{e.preventDefault(),e.stopPropagation(),await this.handleInstallClick()})),t&&t.addEventListener("click",(e=>{e.preventDefault(),e.stopPropagation(),this.closeInstallBanner()}))}async handleInstallClick(){if(console.log("インストールボタンがクリックされました"),this.deferredPrompt)try{console.log("prompt()を呼び出します..."),await this.deferredPrompt.prompt();const{outcome:e}=await this.deferredPrompt.userChoice;console.log("インストール結果:",e),this.deferredPrompt=null,this.hideInstallBanner()}catch(e){console.error("インストールエラー:",e),this.deferredPrompt=null}else console.log("deferredPromptが利用できません。PWAのインストール条件が満たされていない可能性があります。")}showInstallBanner(){const e=document.getElementById("install-banner");e&&(e.style.display="block",console.log("インストールバナーを表示しました"))}hideInstallBanner(){const e=document.getElementById("install-banner");e&&(e.style.display="none",console.log("インストールバナーを非表示にしました"))}closeInstallBanner(){this.hideInstallBanner()}enableInstallButton(){const e=document.getElementById("install-btn");e&&(e.disabled=!1,e.style.opacity="1",e.style.cursor="pointer",console.log("インストールボタンを有効化しました"))}};window.pwaManager=n,window.addEventListener("orientationchange",(()=>{setTimeout((()=>{window.gameInstance&&window.gameInstance.scale&&window.gameInstance.scale.resize(window.innerWidth,window.innerHeight)}),500)}))})();